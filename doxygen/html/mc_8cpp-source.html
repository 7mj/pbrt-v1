<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: mc.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>mc.cpp</h1><a href="mc_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// mc.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="geometry_8h.html">geometry.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="shape_8h.html">shape.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="mc_8h.html">mc.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="volume_8h.html">volume.h</a>"</span>
00017 <span class="comment">// MC Function Definitions</span>
<a name="l00018"></a><a class="code" href="pbrt_8h.html#a89">00018</a> <span class="keywordtype">void</span> <a class="code" href="pbrt_8h.html#a89">ComputeStep1dCDF</a>(<span class="keywordtype">float</span> *f, <span class="keywordtype">int</span> nSteps, <span class="keywordtype">float</span> *c,
00019                 <span class="keywordtype">float</span> *cdf) {
00020         <span class="comment">// Compute integral of step function at $x_i$</span>
00021         <span class="keywordtype">int</span> i;
00022         cdf[0] = 0.;
00023         <span class="keywordflow">for</span> (i = 1; i &lt; nSteps+1; ++i)
00024                 cdf[i] = cdf[i-1] + f[i-1] / nSteps;
00025         <span class="comment">// Transform step function integral into cdf</span>
00026         *c = cdf[nSteps];
00027         <span class="keywordflow">for</span> (i = 1; i &lt; nSteps+1; ++i)
00028                 cdf[i] /= *c;
00029 }
<a name="l00030"></a><a class="code" href="pbrt_8h.html#a90">00030</a> <span class="keywordtype">float</span> <a class="code" href="pbrt_8h.html#a90">SampleStep1d</a>(<span class="keywordtype">float</span> *f, <span class="keywordtype">float</span> *cdf, <span class="keywordtype">float</span> c,
00031                 <span class="keywordtype">int</span> nSteps, <span class="keywordtype">float</span> u, <span class="keywordtype">float</span> *pdf) {
00032         <span class="comment">// Find surrounding cdf segments</span>
00033         <span class="keywordtype">float</span> *ptr = std::lower_bound(cdf, cdf+nSteps+1, u);
00034         <span class="keywordtype">int</span> offset = (<span class="keywordtype">int</span>) (ptr-cdf-1);
00035         <span class="comment">// Return offset along current cdf segment</span>
00036         u = (u - cdf[offset]) / (cdf[offset+1] - cdf[offset]);
00037         *pdf = f[offset] / c;
00038         <span class="keywordflow">return</span> (offset + u) / nSteps;
00039 }
<a name="l00040"></a><a class="code" href="mc_8cpp.html#a2">00040</a> <span class="keywordtype">void</span> <a class="code" href="mc_8h.html#a0">RejectionSampleDisk</a>(<span class="keywordtype">float</span> *x, <span class="keywordtype">float</span> *y) {
00041         <span class="keywordtype">float</span> sx, sy;
00042         <span class="keywordflow">do</span> {
00043                 sx = 1.f - 2.f * <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>();
00044                 sy = 1.f - 2.f * <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>();
00045         } <span class="keywordflow">while</span> (sx*sx + sy*sy &gt; 1.f);
00046         *x = sx;
00047         *y = sy;
00048 }
<a name="l00049"></a><a class="code" href="mc_8h.html#a1">00049</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="mc_8h.html#a1">UniformSampleHemisphere</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2) {
00050         <span class="keywordtype">float</span> z = u1;
00051         <span class="keywordtype">float</span> r = sqrtf(max(0.f, 1.f - z*z));
00052         <span class="keywordtype">float</span> phi = 2 * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * u2;
00053         <span class="keywordtype">float</span> x = r * cosf(phi);
00054         <span class="keywordtype">float</span> y = r * sinf(phi);
00055         <span class="keywordflow">return</span> <a class="code" href="classVector.html">Vector</a>(x, y, z);
00056 }
<a name="l00057"></a><a class="code" href="mc_8h.html#a2">00057</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">float</span> <a class="code" href="mc_8h.html#a2">UniformHemispherePdf</a>(<span class="keywordtype">float</span> theta, <span class="keywordtype">float</span> phi) {
00058         <span class="keywordflow">return</span> <a class="code" href="pbrt_8h.html#a8">INV_TWOPI</a>;
00059 }
<a name="l00060"></a><a class="code" href="mc_8h.html#a3">00060</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="mc_8h.html#a3">UniformSampleSphere</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2) {
00061         <span class="keywordtype">float</span> z = 1.f - 2.f * u1;
00062         <span class="keywordtype">float</span> r = sqrtf(max(0.f, 1.f - z*z));
00063         <span class="keywordtype">float</span> phi = 2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * u2;
00064         <span class="keywordtype">float</span> x = r * cosf(phi);
00065         <span class="keywordtype">float</span> y = r * sinf(phi);
00066         <span class="keywordflow">return</span> <a class="code" href="classVector.html">Vector</a>(x, y, z);
00067 }
<a name="l00068"></a><a class="code" href="mc_8h.html#a4">00068</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">float</span> <a class="code" href="mc_8cpp.html#a6">UniformSpherePdf</a>() {
00069         <span class="keywordflow">return</span> 1.f / (4.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>);
00070 }
<a name="l00071"></a><a class="code" href="mc_8h.html#a8">00071</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">void</span> <a class="code" href="mc_8h.html#a8">UniformSampleDisk</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
00072                 <span class="keywordtype">float</span> *x, <span class="keywordtype">float</span> *y) {
00073         <span class="keywordtype">float</span> r = sqrtf(u1);
00074         <span class="keywordtype">float</span> theta = 2.0f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * u2;
00075         *x = r * cosf(theta);
00076         *y = r * sinf(theta);
00077 }
<a name="l00078"></a><a class="code" href="pbrt_8h.html#a91">00078</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">void</span> <a class="code" href="pbrt_8h.html#a91">ConcentricSampleDisk</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
00079                 <span class="keywordtype">float</span> *dx, <span class="keywordtype">float</span> *dy) {
00080         <span class="keywordtype">float</span> r, theta;
00081         <span class="comment">// Map uniform random numbers to $[-1,1]^2$</span>
00082         <span class="keywordtype">float</span> sx = 2 * u1 - 1;
00083         <span class="keywordtype">float</span> sy = 2 * u2 - 1;
00084         <span class="comment">// Map square to $(r,\theta)$</span>
00085         <span class="comment">// Handle degeneracy at the origin</span>
00086         <span class="keywordflow">if</span> (sx == 0.0 &amp;&amp; sy == 0.0) {
00087                 *dx = 0.0;
00088                 *dy = 0.0;
00089                 <span class="keywordflow">return</span>;
00090         }
00091         <span class="keywordflow">if</span> (sx &gt;= -sy) {
00092                 <span class="keywordflow">if</span> (sx &gt; sy) {
00093                         <span class="comment">// Handle first region of disk</span>
00094                         r = sx;
00095                         <span class="keywordflow">if</span> (sy &gt; 0.0)
00096                                 theta = sy/r;
00097                         <span class="keywordflow">else</span>
00098                                 theta = 8.0f + sy/r;
00099                 }
00100                 <span class="keywordflow">else</span> {
00101                         <span class="comment">// Handle second region of disk</span>
00102                         r = sy;
00103                         theta = 2.0f - sx/r;
00104                 }
00105         }
00106         <span class="keywordflow">else</span> {
00107                 <span class="keywordflow">if</span> (sx &lt;= sy) {
00108                         <span class="comment">// Handle third region of disk</span>
00109                         r = -sx;
00110                         theta = 4.0f - sy/r;
00111                 }
00112                 <span class="keywordflow">else</span> {
00113                         <span class="comment">// Handle fourth region of disk</span>
00114                         r = -sy;
00115                         theta = 6.0f + sx/r;
00116                 }
00117         }
00118         theta *= <a class="code" href="pbrt_8h.html#a6">M_PI</a> / 4.f;
00119         *dx = r*cosf(theta);
00120         *dy = r*sinf(theta);
00121 }
<a name="l00122"></a><a class="code" href="pbrt_8h.html#a92">00122</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">void</span> <a class="code" href="pbrt_8h.html#a92">UniformSampleTriangle</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
00123                 <span class="keywordtype">float</span> *u, <span class="keywordtype">float</span> *v) {
00124         <span class="keywordtype">float</span> su1 = sqrtf(u1);
00125         *u = 1.f - su1;
00126         *v = u2 * su1;
00127 }
<a name="l00128"></a><a class="code" href="mc_8h.html#a7">00128</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">float</span> <a class="code" href="mc_8h.html#a7">UniformConePdf</a>(<span class="keywordtype">float</span> cosThetaMax) {
00129         <span class="keywordflow">return</span> 1.f / (2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * (1.f - cosThetaMax));
00130 }
<a name="l00131"></a><a class="code" href="mc_8h.html#a5">00131</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="mc_8h.html#a6">UniformSampleCone</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
00132                 <span class="keywordtype">float</span> costhetamax) {
00133         <span class="keywordtype">float</span> costheta = <a class="code" href="pbrt_8h.html#a94">Lerp</a>(u1, costhetamax, 1.f);
00134         <span class="keywordtype">float</span> sintheta = sqrtf(1.f - costheta*costheta);
00135         <span class="keywordtype">float</span> phi = u2 * 2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00136         <span class="keywordflow">return</span> <a class="code" href="classVector.html">Vector</a>(cosf(phi) * sintheta,
00137                       sinf(phi) * sintheta,
00138                           costheta);
00139 }
<a name="l00140"></a><a class="code" href="mc_8h.html#a6">00140</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="mc_8h.html#a6">UniformSampleCone</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> costhetamax,
00141                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;x, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;y, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;z) {
00142         <span class="keywordtype">float</span> costheta = <a class="code" href="pbrt_8h.html#a94">Lerp</a>(u1, costhetamax, 1.f);
00143         <span class="keywordtype">float</span> sintheta = sqrtf(1.f - costheta*costheta);
00144         <span class="keywordtype">float</span> phi = u2 * 2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00145         <span class="keywordflow">return</span> cosf(phi) * sintheta * x + sinf(phi) * sintheta * y +
00146                 costheta * z;
00147 }
<a name="l00148"></a><a class="code" href="mc_8h.html#a11">00148</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <a class="code" href="classVector.html">Vector</a> <a class="code" href="mc_8h.html#a11">SampleHG</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keywordtype">float</span> g,
00149                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2) {
00150         <span class="keywordtype">float</span> costheta;
00151         <span class="keywordflow">if</span> (fabsf(g) &lt; 1e-3)
00152                 costheta = 1.f - 2.f * u1;
00153         <span class="keywordflow">else</span>
00154                 costheta = -1.f / (2.f * g) *
00155                         (1.f + g*g - ((1.f-g*g) * (1.f-g+2.f*g*u1)));
00156         <span class="keywordtype">float</span> sintheta = sqrtf(max(0.f, 1.f-costheta*costheta));
00157         <span class="keywordtype">float</span> phi = 2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * u2;
00158         <a class="code" href="classVector.html">Vector</a> v1, v2;
00159         <a class="code" href="geometry_8h.html#a8">CoordinateSystem</a>(w, &amp;v1, &amp;v2);
00160         <span class="keywordflow">return</span> <a class="code" href="geometry_8h.html#a25">SphericalDirection</a>(sintheta, costheta,
00161                 phi, v1, v2, w);
00162 }
<a name="l00163"></a><a class="code" href="mc_8h.html#a12">00163</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">float</span> <a class="code" href="mc_8h.html#a12">HGPdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wp,
00164                 <span class="keywordtype">float</span> g) {
00165         <span class="keywordflow">return</span> <a class="code" href="volume_8h.html#a4">PhaseHG</a>(w, wp, g);
00166 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:22 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
