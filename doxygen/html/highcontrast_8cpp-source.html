<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: highcontrast.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>highcontrast.cpp</h1><a href="highcontrast_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// highcontrast.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="tonemap_8h.html">tonemap.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="mipmap_8h.html">mipmap.h</a>"</span>
00014 <span class="comment">// HighContrastOp Declarations</span>
<a name="l00015"></a><a class="code" href="classHighContrastOp.html">00015</a> <span class="keyword">class </span><a class="code" href="classHighContrastOp.html">HighContrastOp</a> : <span class="keyword">public</span> <a class="code" href="classToneMap.html">ToneMap</a> {
00016 <span class="keyword">public</span>:
00017         <span class="keywordtype">void</span> <a class="code" href="classHighContrastOp.html#a0">Map</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> *y,
00018                  <span class="keywordtype">int</span> xRes, <span class="keywordtype">int</span> yRes,
00019                          <span class="keywordtype">float</span> maxDisplayY, <span class="keywordtype">float</span> *scale) <span class="keyword">const</span>;
00020 <span class="keyword">private</span>:
00021         <span class="comment">// HighContrastOp Utility Methods</span>
<a name="l00022"></a><a class="code" href="classHighContrastOp.html#h0">00022</a>         <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="classHighContrastOp.html#h0">C</a>(<span class="keywordtype">float</span> y) {
00023                 <span class="keywordflow">if</span> (y &lt; 0.0034f)
00024                         <span class="keywordflow">return</span> y / 0.0014f;
00025                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y &lt; 1)
00026                         <span class="keywordflow">return</span> 2.4483f + log10f(y/0.0034f)/0.4027f;
00027                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y &lt; 7.2444f)
00028                         <span class="keywordflow">return</span> 16.563f + (y - 1)/0.4027f;
00029                 <span class="keywordflow">else</span>
00030                         <span class="keywordflow">return</span> 32.0693f + log10f(y / 7.2444f)/0.0556f;
00031         }
<a name="l00032"></a><a class="code" href="classHighContrastOp.html#h1">00032</a>         <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="classHighContrastOp.html#h1">T</a>(<span class="keywordtype">float</span> y, <span class="keywordtype">float</span> CYmin, <span class="keywordtype">float</span> CYmax,
00033                         <span class="keywordtype">float</span> maxDisplayY) {
00034                 <span class="keywordflow">return</span> maxDisplayY * (C(y) - CYmin) / (CYmax - CYmin);
00035         }
00036 };
00037 <span class="comment">// HighContrastOp Method Definitions</span>
<a name="l00038"></a><a class="code" href="classHighContrastOp.html#a0">00038</a> <span class="keywordtype">void</span> <a class="code" href="classHighContrastOp.html#a0">HighContrastOp::Map</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> *y, <span class="keywordtype">int</span> xRes, <span class="keywordtype">int</span> yRes,
00039                 <span class="keywordtype">float</span> maxDisplayY, <span class="keywordtype">float</span> *scale)<span class="keyword"> const </span>{
00040         <span class="comment">// Find minimum and maximum image luminances</span>
00041         <span class="keywordtype">float</span> minY = y[0], maxY = y[0];
00042         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; xRes * yRes; ++i) {
00043                 minY = min(minY, y[i]);
00044                 maxY = max(maxY, y[i]);
00045         }
00046         <span class="keywordtype">float</span> CYmin = <a class="code" href="classHighContrastOp.html#h0">C</a>(minY), CYmax = C(maxY);
00047         <span class="comment">// Build luminance image pyramid</span>
00048         <a class="code" href="classMIPMap.html">MIPMap&lt;float&gt;</a> pyramid(xRes, yRes,
00049                               y, <span class="keyword">false</span>,
00050                                                   4.f, <a class="code" href="mipmap_8h.html#a4a3">TEXTURE_CLAMP</a>);
00051         <span class="comment">// Apply high contrast tone mapping operator</span>
00052         <a class="code" href="structProgressReporter.html">ProgressReporter</a> progress(xRes*yRes, <span class="stringliteral">"Tone Mapping"</span>); <span class="comment">// NOBOOK</span>
00053         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; yRes; ++y) {
00054                 <span class="keywordtype">float</span> yc = (float(y) + .5f) / float(yRes);
00055                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; xRes; ++x) {
00056                         <span class="keywordtype">float</span> xc = (float(x) + .5f) / float(xRes);
00057                         <span class="comment">// Compute local adaptation luminance at $(x,y)$</span>
00058                         <span class="keywordtype">float</span> dwidth = 1.f / float(max(xRes, yRes));
00059                         <span class="keywordtype">float</span> maxWidth = 32.f / float(max(xRes, yRes));
00060                         <span class="keywordtype">float</span> width = dwidth, prevWidth = 0.f;
00061                         <span class="keywordtype">float</span> Yadapt;
00062                         <span class="keywordtype">float</span> prevlc = 0.f;
00063                         <span class="keyword">const</span> <span class="keywordtype">float</span> maxLocalContrast = .5f;
00064                         <span class="keywordflow">while</span> (1) {
00065                                 <span class="comment">// Compute local contrast at $(x,y)$</span>
00066                                 <span class="keywordtype">float</span> b0 = pyramid.<a class="code" href="classMIPMap.html#a2">Lookup</a>(xc, yc, width,
00067                                                           0.f, 0.f, width);
00068                                 <span class="keywordtype">float</span> b1 = pyramid.<a class="code" href="classMIPMap.html#a2">Lookup</a>(xc, yc, 2.f*width,
00069                                                           0.f, 0.f, 2.f*width);
00070                                 <span class="keywordtype">float</span> lc = fabsf((b0 - b1) / b0);
00071                                 <span class="comment">// If maximum contrast is exceeded, compute adaptation luminance</span>
00072                                 <span class="keywordflow">if</span> (lc &gt; maxLocalContrast) {
00073                                         <span class="keywordtype">float</span> t = (maxLocalContrast - prevlc) / (lc - prevlc);
00074                                         <span class="keywordtype">float</span> w = <a class="code" href="pbrt_8h.html#a94">Lerp</a>(t, prevWidth, width);
00075                                         Yadapt = pyramid.<a class="code" href="classMIPMap.html#a2">Lookup</a>(xc, yc, w,
00076                                                                 0.f, 0.f, w);
00077                                         <span class="keywordflow">break</span>;
00078                                 }
00079                                 <span class="comment">// Increase search region and prepare to compute contrast again</span>
00080                                 prevlc = lc;
00081                                 prevWidth = width;
00082                                 width += dwidth;
00083                                 <span class="keywordflow">if</span> (width &gt;= maxWidth) {
00084                                         Yadapt = pyramid.<a class="code" href="classMIPMap.html#a2">Lookup</a>(xc, yc, maxWidth,
00085                                                                 0.f, 0.f, maxWidth);
00086                                         <span class="keywordflow">break</span>;
00087                                 }
00088                         }
00089                         <span class="comment">// Apply tone mapping based on local adaptation luminance</span>
00090                         scale[x + y*xRes] = <a class="code" href="classHighContrastOp.html#h1">T</a>(Yadapt, CYmin, CYmax, maxDisplayY) /
00091                                 Yadapt;
00092                 }
00093                 progress.<a class="code" href="structProgressReporter.html#a2">Update</a>(xRes); <span class="comment">// NOBOOK</span>
00094         }
00095         progress.<a class="code" href="structProgressReporter.html#a3">Done</a>(); <span class="comment">// NOBOOK</span>
00096 }
<a name="l00097"></a><a class="code" href="highcontrast_8cpp.html#a0">00097</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classToneMap.html">ToneMap</a> *<a class="code" href="nonlinear_8cpp.html#a0">CreateToneMap</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;ps) {
00098         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classHighContrastOp.html">HighContrastOp</a>;
00099 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:21 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
