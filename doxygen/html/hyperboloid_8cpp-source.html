<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: hyperboloid.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>hyperboloid.cpp</h1><a href="hyperboloid_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// hyperboloid.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="shape_8h.html">shape.h</a>"</span>
00013 <span class="comment">// Hyperboloid Declarations</span>
<a name="l00014"></a><a class="code" href="classHyperboloid.html">00014</a> <span class="keyword">class </span><a class="code" href="classHyperboloid.html">Hyperboloid</a>: <span class="keyword">public</span> <a class="code" href="classShape.html">Shape</a> {
00015 <span class="keyword">public</span>:
00016         <span class="comment">// Hyperboloid Public Methods</span>
00017         <a class="code" href="classHyperboloid.html">Hyperboloid</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro,
00018                     <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;point1, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;point2,
00019                     <span class="keywordtype">float</span> tm);
00020         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classHyperboloid.html#a1">ObjectBound</a>() <span class="keyword">const</span>;
00021         <span class="keywordtype">bool</span> <a class="code" href="classHyperboloid.html#a2">Intersect</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keywordtype">float</span> *tHit,
00022                        <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> *dg) <span class="keyword">const</span>;
00023         <span class="keywordtype">bool</span> <a class="code" href="classHyperboloid.html#a3">IntersectP</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray) <span class="keyword">const</span>;
00024         <span class="keywordtype">float</span> <a class="code" href="classHyperboloid.html#a4">Area</a>() <span class="keyword">const</span>;
00025 <span class="keyword">protected</span>:
00026         <span class="comment">// Hyperboloid Data</span>
<a name="l00027"></a><a class="code" href="classHyperboloid.html#p1">00027</a>         <a class="code" href="classPoint.html">Point</a> <a class="code" href="classHyperboloid.html#p0">p1</a>, <a class="code" href="classHyperboloid.html#p1">p2</a>;
<a name="l00028"></a><a class="code" href="classHyperboloid.html#p2">00028</a>         <span class="keywordtype">float</span> <a class="code" href="classHyperboloid.html#p2">zmin</a>, <a class="code" href="classHyperboloid.html#p3">zmax</a>;
<a name="l00029"></a><a class="code" href="classHyperboloid.html#p4">00029</a>         <span class="keywordtype">float</span> <a class="code" href="classHyperboloid.html#p4">phiMax</a>;
<a name="l00030"></a><a class="code" href="classHyperboloid.html#p5">00030</a>         <span class="keywordtype">float</span> <a class="code" href="classHyperboloid.html#p5">rmax</a>;
<a name="l00031"></a><a class="code" href="classHyperboloid.html#p7">00031</a>         <span class="keywordtype">float</span> <a class="code" href="classHyperboloid.html#p6">a</a>, <a class="code" href="classHyperboloid.html#p7">c</a>;
00032 };
00033 <span class="comment">// Hyperboloid Method Definitions</span>
<a name="l00034"></a><a class="code" href="classHyperboloid.html#a0">00034</a> <a class="code" href="classHyperboloid.html#a0">Hyperboloid::Hyperboloid</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro,
00035                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;point1, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;point2, <span class="keywordtype">float</span> tm)
00036         : <a class="code" href="classShape.html">Shape</a>(o2w, ro) {
00037         <a class="code" href="classHyperboloid.html#p0">p1</a> = point1;
00038         <a class="code" href="classHyperboloid.html#p1">p2</a> = point2;
00039         <a class="code" href="classHyperboloid.html#p4">phiMax</a> = <a class="code" href="pbrt_8h.html#a98">Radians</a>(<a class="code" href="pbrt_8h.html#a96">Clamp</a>(tm, 0.0f, 360.0f));
00040         <span class="keywordtype">float</span> rad1 = sqrtf(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a> + <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>);
00041         <span class="keywordtype">float</span> rad2 = sqrtf(<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o0">x</a>*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o0">x</a> + <a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o1">y</a>*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o1">y</a>);
00042         <a class="code" href="classHyperboloid.html#p5">rmax</a> = max(rad1,rad2);
00043         <a class="code" href="classHyperboloid.html#p2">zmin</a> = min(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>,<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a>);
00044         <a class="code" href="classHyperboloid.html#p3">zmax</a> = max(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>,<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a>);
00045         <span class="comment">// Compute implicit function coefficients for hyperboloid</span>
00046         <span class="keywordflow">if</span> (<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a> == 0.) swap(<a class="code" href="classHyperboloid.html#p0">p1</a>, <a class="code" href="classHyperboloid.html#p1">p2</a>);
00047         <a class="code" href="classPoint.html">Point</a> pp = <a class="code" href="classHyperboloid.html#p0">p1</a>;
00048         <span class="keywordtype">float</span> xy1, xy2;
00049         <span class="keywordflow">do</span> {
00050                 pp += 2.f * (<a class="code" href="classHyperboloid.html#p1">p2</a>-p1);
00051                 xy1 = pp.<a class="code" href="classPoint.html#o0">x</a>*pp.<a class="code" href="classPoint.html#o0">x</a> + pp.<a class="code" href="classPoint.html#o1">y</a>*pp.<a class="code" href="classPoint.html#o1">y</a>;
00052                 xy2 = <a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o0">x</a>*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o0">x</a> + <a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o1">y</a>*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o1">y</a>;
00053                 <a class="code" href="classHyperboloid.html#p6">a</a> = (1.f/xy1 - (pp.<a class="code" href="classPoint.html#o2">z</a>*pp.<a class="code" href="classPoint.html#o2">z</a>)/(xy1*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a>*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a>)) /
00054                     (1 - (xy2*pp.<a class="code" href="classPoint.html#o2">z</a>*pp.<a class="code" href="classPoint.html#o2">z</a>)/(xy1*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a>*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a>));
00055                 <a class="code" href="classHyperboloid.html#p7">c</a> = (<a class="code" href="classHyperboloid.html#p6">a</a> * xy2 - 1) / (<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a>*<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a>);
00056         } <span class="keywordflow">while</span> (isinf(<a class="code" href="classHyperboloid.html#p6">a</a>) || isnan(<a class="code" href="classHyperboloid.html#p6">a</a>));
00057 }
<a name="l00058"></a><a class="code" href="classHyperboloid.html#a1">00058</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classHyperboloid.html#a1">Hyperboloid::ObjectBound</a>()<span class="keyword"> const </span>{
00059         <a class="code" href="classPoint.html">Point</a> <a class="code" href="classHyperboloid.html#p0">p1</a> = <a class="code" href="classPoint.html">Point</a>( -<a class="code" href="classHyperboloid.html#p5">rmax</a>, -<a class="code" href="classHyperboloid.html#p5">rmax</a>, <a class="code" href="classHyperboloid.html#p2">zmin</a> );
00060         Point <a class="code" href="classHyperboloid.html#p1">p2</a> = Point(  <a class="code" href="classHyperboloid.html#p5">rmax</a>,  <a class="code" href="classHyperboloid.html#p5">rmax</a>, <a class="code" href="classHyperboloid.html#p3">zmax</a> );
00061         <span class="keywordflow">return</span> <a class="code" href="classBBox.html">BBox</a>( p1, p2 );
00062 }
<a name="l00063"></a><a class="code" href="classHyperboloid.html#a2">00063</a> <span class="keywordtype">bool</span> <a class="code" href="classHyperboloid.html#a2">Hyperboloid::Intersect</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;r, <span class="keywordtype">float</span> *tHit,
00064                 <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> *dg)<span class="keyword"> const </span>{
00065         <span class="keywordtype">float</span> phi, v;
00066         <a class="code" href="classPoint.html">Point</a> phit;
00067         <span class="comment">// Transform _Ray_ to object space</span>
00068         <a class="code" href="classRay.html">Ray</a> ray;
00069         WorldToObject(r, &amp;ray);
00070         <span class="comment">// Compute quadratic hyperboloid coefficients</span>
00071         <span class="keywordtype">float</span> A = <a class="code" href="classHyperboloid.html#p6">a</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o0">x</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o0">x</a> +
00072                   <a class="code" href="classHyperboloid.html#p6">a</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o1">y</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o1">y</a> -
00073                   <a class="code" href="classHyperboloid.html#p7">c</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o2">z</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o2">z</a>;
00074         <span class="keywordtype">float</span> B = 2.f * (<a class="code" href="classHyperboloid.html#p6">a</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o0">x</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o0">x</a> +
00075                          <a class="code" href="classHyperboloid.html#p6">a</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o1">y</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o1">y</a> -
00076                          <a class="code" href="classHyperboloid.html#p7">c</a>*ray.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o2">z</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o2">z</a>);
00077         <span class="keywordtype">float</span> C = <a class="code" href="classHyperboloid.html#p6">a</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o0">x</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o0">x</a> +
00078                   <a class="code" href="classHyperboloid.html#p6">a</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o1">y</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o1">y</a> -
00079                   <a class="code" href="classHyperboloid.html#p7">c</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o2">z</a>*ray.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o2">z</a> - 1;
00080         <span class="comment">// Solve quadratic equation for _t_ values</span>
00081         <span class="keywordtype">float</span> t0, t1;
00082         <span class="keywordflow">if</span> (!<a class="code" href="pbrt_8h.html#a110">Quadratic</a>(A, B, C, &amp;t0, &amp;t1))
00083                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00084         <span class="comment">// Compute intersection distance along ray</span>
00085         <span class="keywordflow">if</span> (t0 &gt; ray.<a class="code" href="classRay.html#o3">maxt</a> || t1 &lt; ray.<a class="code" href="classRay.html#o2">mint</a>)
00086                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00087         <span class="keywordtype">float</span> thit = t0;
00088         <span class="keywordflow">if</span> (t0 &lt; ray.<a class="code" href="classRay.html#o2">mint</a>) {
00089                 thit = t1;
00090                 <span class="keywordflow">if</span> (thit &gt; ray.<a class="code" href="classRay.html#o3">maxt</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00091         }
00092         <span class="comment">// Compute hyperboloid inverse mapping</span>
00093         phit = ray(thit);
00094         v = (phit.<a class="code" href="classPoint.html#o2">z</a> - <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>)/(<a class="code" href="classHyperboloid.html#p1">p2</a>.<a class="code" href="classPoint.html#o2">z</a> - <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>);
00095         <a class="code" href="classPoint.html">Point</a> pr = (1.f-v) * <a class="code" href="classHyperboloid.html#p0">p1</a> + v * <a class="code" href="classHyperboloid.html#p1">p2</a>;
00096         phi = atan2f(pr.<a class="code" href="classPoint.html#o0">x</a>*phit.<a class="code" href="classPoint.html#o1">y</a> - phit.<a class="code" href="classPoint.html#o0">x</a>*pr.<a class="code" href="classPoint.html#o1">y</a>,
00097                 phit.<a class="code" href="classPoint.html#o0">x</a>*pr.<a class="code" href="classPoint.html#o0">x</a> + phit.<a class="code" href="classPoint.html#o1">y</a>*pr.<a class="code" href="classPoint.html#o1">y</a>);
00098         <span class="keywordflow">if</span> (phi &lt; 0)
00099                 phi += 2*<a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00100         <span class="comment">// Test hyperboloid intersection against clipping parameters</span>
00101         <span class="keywordflow">if</span> (phit.<a class="code" href="classPoint.html#o2">z</a> &lt; <a class="code" href="classHyperboloid.html#p2">zmin</a> || phit.<a class="code" href="classPoint.html#o2">z</a> &gt; <a class="code" href="classHyperboloid.html#p3">zmax</a> || phi &gt; <a class="code" href="classHyperboloid.html#p4">phiMax</a>) {
00102                 <span class="keywordflow">if</span> (thit == t1) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00103                 thit = t1;
00104                 <span class="keywordflow">if</span> (t1 &gt; ray.maxt) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00105                 <span class="comment">// Compute hyperboloid inverse mapping</span>
00106                 phit = ray(thit);
00107                 v = (phit.<a class="code" href="classPoint.html#o2">z</a> - <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>)/(p2.z - <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>);
00108                 <a class="code" href="classPoint.html">Point</a> pr = (1.f-v) * <a class="code" href="classHyperboloid.html#p0">p1</a> + v * p2;
00109                 phi = atan2f(pr.<a class="code" href="classPoint.html#o0">x</a>*phit.<a class="code" href="classPoint.html#o1">y</a> - phit.<a class="code" href="classPoint.html#o0">x</a>*pr.<a class="code" href="classPoint.html#o1">y</a>,
00110                         phit.<a class="code" href="classPoint.html#o0">x</a>*pr.<a class="code" href="classPoint.html#o0">x</a> + phit.<a class="code" href="classPoint.html#o1">y</a>*pr.<a class="code" href="classPoint.html#o1">y</a>);
00111                 <span class="keywordflow">if</span> (phi &lt; 0)
00112                         phi += 2*<a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00113                 <span class="keywordflow">if</span> (phit.<a class="code" href="classPoint.html#o2">z</a> &lt; <a class="code" href="classHyperboloid.html#p2">zmin</a> || phit.<a class="code" href="classPoint.html#o2">z</a> &gt; <a class="code" href="classHyperboloid.html#p3">zmax</a> || phi &gt; <a class="code" href="classHyperboloid.html#p4">phiMax</a>)
00114                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00115         }
00116         <span class="comment">// Compute parametric representation of hyperboloid hit</span>
00117         <span class="keywordtype">float</span> u = phi / <a class="code" href="classHyperboloid.html#p4">phiMax</a>;
00118         <span class="comment">// Compute hyperboloid \dpdu and \dpdv</span>
00119         <span class="keywordtype">float</span> cosphi = cosf(phi), sinphi = sinf(phi);
00120         <a class="code" href="classVector.html">Vector</a> dpdu(-<a class="code" href="classHyperboloid.html#p4">phiMax</a> * phit.<a class="code" href="classPoint.html#o1">y</a>, <a class="code" href="classHyperboloid.html#p4">phiMax</a> * phit.<a class="code" href="classPoint.html#o0">x</a>, 0.);
00121         <a class="code" href="classVector.html">Vector</a> dpdv((p2.x-<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>) * cosphi - (p2.y-<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>) * sinphi,
00122                 (p2.x-<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>) * sinphi + (p2.y-<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>) * cosphi,
00123                 p2.<a class="code" href="classVector.html#o2">z</a>-<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>);
00124         <span class="comment">// Compute hyperboloid \dndu and \dndv</span>
00125         <a class="code" href="classVector.html">Vector</a> d2Pduu = -<a class="code" href="classHyperboloid.html#p4">phiMax</a> * <a class="code" href="classHyperboloid.html#p4">phiMax</a> *
00126                         <a class="code" href="classVector.html">Vector</a>(phit.<a class="code" href="classPoint.html#o0">x</a>, phit.<a class="code" href="classPoint.html#o1">y</a>, 0);
00127         <a class="code" href="classVector.html">Vector</a> d2Pduv = phiMax *
00128                         <a class="code" href="classVector.html">Vector</a>(-dpdv.y, dpdv.x, 0.);
00129         <a class="code" href="classVector.html">Vector</a> d2Pdvv(0, 0, 0);
00130         <span class="comment">// Compute coefficients for fundamental forms</span>
00131         <span class="keywordtype">float</span> E = <a class="code" href="geometry_8h.html#a17">Dot</a>(dpdu, dpdu);
00132         <span class="keywordtype">float</span> F = <a class="code" href="geometry_8h.html#a17">Dot</a>(dpdu, dpdv);
00133         <span class="keywordtype">float</span> G = <a class="code" href="geometry_8h.html#a17">Dot</a>(dpdv, dpdv);
00134         <a class="code" href="classVector.html">Vector</a> <a class="code" href="util_8cpp.html#a3">N</a> = <a class="code" href="geometry_8h.html#a14">Normalize</a>(<a class="code" href="geometry_8h.html#a6">Cross</a>(dpdu, dpdv));
00135         <span class="keywordtype">float</span> e = <a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="util_8cpp.html#a3">N</a>, d2Pduu);
00136         <span class="keywordtype">float</span> f = <a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="util_8cpp.html#a3">N</a>, d2Pduv);
00137         <span class="keywordtype">float</span> g = <a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="util_8cpp.html#a3">N</a>, d2Pdvv);
00138         <span class="comment">// Compute \dndu and \dndv from fundamental form coefficients</span>
00139         <span class="keywordtype">float</span> invEGF2 = 1.f / (E*G - F*F);
00140         <a class="code" href="classVector.html">Vector</a> dndu = (f*F - e*G) * invEGF2 * dpdu +
00141                 (e*F - f*E) * invEGF2 * dpdv;
00142         <a class="code" href="classVector.html">Vector</a> dndv = (g*F - f*G) * invEGF2 * dpdu +
00143                 (f*F - g*E) * invEGF2 * dpdv;
00144         <span class="comment">// Initialize _DifferentialGeometry_ from parametric information</span>
00145         *dg = <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a>(ObjectToWorld(phit),
00146                                    ObjectToWorld(dpdu),
00147                                                            ObjectToWorld(dpdv),
00148                                    ObjectToWorld(dndu),
00149                                                            ObjectToWorld(dndv),
00150                                    u, v, <span class="keyword">this</span>);
00151         <span class="comment">// Update _tHit_ for quadric intersection</span>
00152         *tHit = thit;
00153         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00154 }
<a name="l00155"></a><a class="code" href="classHyperboloid.html#a3">00155</a> <span class="keywordtype">bool</span> Hyperboloid::IntersectP(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;r) <span class="keyword">const</span> {
00156         <span class="keywordtype">float</span> phi, v;
00157         <a class="code" href="classPoint.html">Point</a> phit;
00158         <span class="comment">// Transform _Ray_ to object space</span>
00159         <a class="code" href="classRay.html">Ray</a> ray;
00160         WorldToObject(r, &amp;ray);
00161         <span class="comment">// Compute quadratic hyperboloid coefficients</span>
00162         <span class="keywordtype">float</span> A = a*ray.d.x*ray.d.x +
00163                   a*ray.d.y*ray.d.y -
00164                   c*ray.d.z*ray.d.z;
00165         <span class="keywordtype">float</span> B = 2.f * (a*ray.d.x*ray.o.x +
00166                          a*ray.d.y*ray.o.y -
00167                          c*ray.d.z*ray.o.z);
00168         <span class="keywordtype">float</span> C = a*ray.o.x*ray.o.x +
00169                   a*ray.o.y*ray.o.y -
00170                   c*ray.o.z*ray.o.z - 1;
00171         <span class="comment">// Solve quadratic equation for _t_ values</span>
00172         <span class="keywordtype">float</span> t0, t1;
00173         <a class="code" href="pbrtparse_8y.html#a41">if</a> (!<a class="code" href="pbrt_8h.html#a110">Quadratic</a>(A, B, C, &amp;t0, &amp;t1))
00174                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00175         <span class="comment">// Compute intersection distance along ray</span>
00176         <span class="keywordflow">if</span> (t0 &gt; ray.maxt || t1 &lt; ray.mint)
00177                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00178         <span class="keywordtype">float</span> thit = t0;
00179         <a class="code" href="pbrtparse_8y.html#a41">if</a> (t0 &lt; ray.mint) {
00180                 thit = t1;
00181                 <a class="code" href="pbrtparse_8y.html#a41">if</a> (thit &gt; ray.maxt) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00182         }
00183         <span class="comment">// Compute hyperboloid inverse mapping</span>
00184         phit = ray(thit);
00185         v = (phit.z - p1.z)/(p2.z - p1.z);
00186         <a class="code" href="classPoint.html">Point</a> pr = (1.f-v) * p1 + v * p2;
00187         phi = atan2f(pr.<a class="code" href="classPoint.html#o0">x</a>*phit.y - phit.x*pr.<a class="code" href="classPoint.html#o1">y</a>,
00188                 phit.x*pr.<a class="code" href="classPoint.html#o0">x</a> + phit.y*pr.<a class="code" href="classPoint.html#o1">y</a>);
00189         <span class="keywordflow">if</span> (phi &lt; 0)
00190                 phi += 2*<a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00191         <span class="comment">// Test hyperboloid intersection against clipping parameters</span>
00192         <span class="keywordflow">if</span> (phit.z &lt; zmin || phit.z &gt; zmax || phi &gt; phiMax) {
00193                 <span class="keywordflow">if</span> (thit == t1) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00194                 thit = t1;
00195                 <span class="keywordflow">if</span> (t1 &gt; ray.maxt) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00196                 <span class="comment">// Compute hyperboloid inverse mapping</span>
00197                 phit = ray(thit);
00198                 v = (phit.z - p1.z)/(p2.z - p1.z);
00199                 <a class="code" href="classPoint.html">Point</a> pr = (1.f-v) * p1 + v * p2;
00200                 phi = atan2f(pr.<a class="code" href="classPoint.html#o0">x</a>*phit.y - phit.x*pr.<a class="code" href="classPoint.html#o1">y</a>,
00201                         phit.x*pr.<a class="code" href="classPoint.html#o0">x</a> + phit.y*pr.<a class="code" href="classPoint.html#o1">y</a>);
00202                 <span class="keywordflow">if</span> (phi &lt; 0)
00203                         phi += 2*<a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00204                 <span class="keywordflow">if</span> (phit.z &lt; zmin || phit.z &gt; zmax || phi &gt; phiMax)
00205                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00206         }
00207         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00208 }
<a name="l00209"></a><a class="code" href="hyperboloid_8cpp.html#a0">00209</a> <span class="preprocessor">#define SQR(a) ((a)*(a))</span>
<a name="l00210"></a><a class="code" href="hyperboloid_8cpp.html#a1">00210</a> <span class="preprocessor"></span><span class="preprocessor">#define QUAD(a) ((SQR(a))*(SQR(a)))</span>
<a name="l00211"></a><a class="code" href="classHyperboloid.html#a4">00211</a> <span class="preprocessor"></span><span class="keywordtype">float</span> <a class="code" href="classHyperboloid.html#a4">Hyperboloid::Area</a>()<span class="keyword"> const </span>{
00212         <span class="keywordflow">return</span> phiMax/6.f *
00213            (2.f*<a class="code" href="hyperboloid_8cpp.html#a1">QUAD</a>(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>) - 2.f*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>*p2.x +
00214                  2.f*<a class="code" href="hyperboloid_8cpp.html#a1">QUAD</a>(p2.x) +
00215                     2.f*(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a> + <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*p2.y + p2.y*p2.y)*
00216                         (<a class="code" href="hyperboloid_8cpp.html#a0">SQR</a>(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a> - p2.y) + <a class="code" href="hyperboloid_8cpp.html#a0">SQR</a>(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a> - p2.z)) +
00217                    p2.x*p2.x*(5.f*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a> + 2.f*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*p2.y -
00218                       4.f*p2.y*p2.y + 2.f*<a class="code" href="hyperboloid_8cpp.html#a0">SQR</a>(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a> - p2.z)) +
00219                    <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>*(-4.f*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a> + 2.f*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*p2.y +
00220                       5.f*p2.y*p2.y + 2.f*<a class="code" href="hyperboloid_8cpp.html#a0">SQR</a>(<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a> - p2.z)) -
00221                    2.f*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o0">x</a>*p2.x*(p2.x*p2.x - <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a> +
00222                       5.f*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o1">y</a>*p2.y - p2.y*p2.y - <a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a> +
00223                           2.f*<a class="code" href="classHyperboloid.html#p0">p1</a>.<a class="code" href="classPoint.html#o2">z</a>*p2.z - p2.z*p2.z));
00224 }
00225 <span class="preprocessor">#undef SQR</span>
00226 <span class="preprocessor"></span><span class="preprocessor">#undef QUAD</span>
<a name="l00227"></a><a class="code" href="hyperboloid_8cpp.html#a2">00227</a> <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classShape.html">Shape</a> *<a class="code" href="trianglemesh_8cpp.html#a0">CreateShape</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w,
00228                 <span class="keywordtype">bool</span> reverseOrientation, <span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params) {
00229         <a class="code" href="classPoint.html">Point</a> p1 = params.<a class="code" href="classParamSet.html#a24">FindOnePoint</a>( <span class="stringliteral">"p1"</span>, <a class="code" href="classPoint.html">Point</a>(0,0,0) );
00230         <a class="code" href="classPoint.html">Point</a> p2 = params.<a class="code" href="classParamSet.html#a24">FindOnePoint</a>( <span class="stringliteral">"p2"</span>, <a class="code" href="classPoint.html">Point</a>(1,1,1) );
00231         <span class="keywordtype">float</span> phimax = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>( <span class="stringliteral">"phimax"</span>, 360 );
00232         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classHyperboloid.html">Hyperboloid</a>(o2w, reverseOrientation, p1, p2, phimax);
00233 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:21 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
