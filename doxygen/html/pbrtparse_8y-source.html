<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: pbrtparse.y Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>pbrtparse.y</h1><a href="pbrtparse_8y.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 %{
00012 <span class="preprocessor">#include "<a class="code" href="api_8h.html">api.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
00015 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00016 
00017 <span class="keyword">extern</span> <span class="keywordtype">int</span> yylex( <span class="keywordtype">void</span> );
00018 <span class="keywordtype">int</span> <a class="code" href="core_2samplepat_8cpp.html#a2">line_num</a> = 0;
00019 string <a class="code" href="core_2samplepat_8cpp.html#a3">current_file</a>;
00020 
00021 <span class="preprocessor">#define YYMAXDEPTH 100000000</span>
00022 <span class="preprocessor"></span>
00023 <span class="keywordtype">void</span> yyerror( <span class="keywordtype">char</span> *str ) {
00024         <a class="code" href="util_8cpp.html#a17">Severe</a>( <span class="stringliteral">"Parsing error: %s"</span>, str);
00025 }
00026 
00027 <span class="keywordtype">void</span> ParseError( <span class="keyword">const</span> <span class="keywordtype">char</span> *format, ... ) PRINTF_FUNC;
00028 
00029 <span class="keywordtype">void</span> ParseError( const <span class="keywordtype">char</span> *format, ... ) {
00030         <span class="keywordtype">char</span> error[4096];
00031         va_list args;
00032         va_start( args, format );
00033         vsprintf( error, format, args );
00034         yyerror(error);
00035         va_end( args );
00036 }
00037 
00038 <span class="keywordtype">int</span> cur_paramlist_allocated = 0;
00039 <span class="keywordtype">int</span> cur_paramlist_size = 0;
00040 <span class="keyword">const</span> <span class="keywordtype">char</span> **<a class="code" href="pbrtparse_8y.html#a33">cur_paramlist_tokens</a> = NULL;
00041 <span class="keywordtype">void</span> **<a class="code" href="pbrtparse_8y.html#a36">cur_paramlist_args</a> = NULL;
00042 <span class="keywordtype">int</span> *<a class="code" href="pbrtparse_8y.html#a34">cur_paramlist_sizes</a> = NULL;
00043 <span class="keywordtype">bool</span> *<a class="code" href="pbrtparse_8y.html#a35">cur_paramlist_texture_helper</a> = NULL;
00044 
00045 <span class="preprocessor">#define CPS cur_paramlist_size</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define CPT cur_paramlist_tokens</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#define CPA cur_paramlist_args</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define CPTH cur_paramlist_texture_helper</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#define CPSZ cur_paramlist_sizes</span>
00050 <span class="preprocessor"></span>
00051 <span class="keyword">typedef</span> <span class="keyword">struct </span>ParamArray {
00052         <span class="keywordtype">int</span> element_size;
00053         <span class="keywordtype">int</span> <a class="code" href="pbrtparse_8y.html#a12">allocated</a>;
00054         <span class="keywordtype">int</span> <a class="code" href="pbrtparse_8y.html#a13">nelems</a>;
00055         <span class="keywordtype">void</span> *<a class="code" href="pbrtparse_8y.html#a14">array</a>;
00056 } ParamArray;
00057 
00058 ParamArray *<a class="code" href="pbrtparse_8y.html#a11">cur_array</a> = NULL;
00059 <span class="keywordtype">bool</span> <a class="code" href="pbrtparse_8y.html#a15">array_is_single_string</a> = <span class="keyword">false</span>;
00060 
00061 <span class="preprocessor">#define NA(r) ((float *) r-&gt;array)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#define SA(r) ((const char **) r-&gt;array)</span>
00063 <span class="preprocessor"></span>
00064 <span class="keywordtype">void</span> <a class="code" href="pbrtparse_8y.html#a39">AddArrayElement</a>( <span class="keywordtype">void</span> *elem ) {
00065         <span class="keywordflow">if</span> (<a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;nelems &gt;= <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;allocated) {
00066                 <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;allocated = 2*<a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;allocated + 1;
00067                 <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;array = realloc( <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;array,
00068                         <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;allocated*<a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;element_size );
00069         }
00070         <span class="keywordtype">char</span> *next = ((<span class="keywordtype">char</span> *)<a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;array) + <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;nelems *
00071                 <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;element_size;
00072         <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>( next, elem, <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;element_size );
00073         <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;nelems++;
00074 }
00075 
00076 ParamArray *ArrayDup( ParamArray *ra )
00077 {
00078         ParamArray *ret = <span class="keyword">new</span> ParamArray;
00079         ret-&gt;element_size = ra-&gt;element_size;
00080         ret-&gt;allocated = ra-&gt;allocated;
00081         ret-&gt;nelems = ra-&gt;nelems;
00082         ret-&gt;array = malloc(ra-&gt;nelems * ra-&gt;element_size);
00083         <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>( ret-&gt;array, ra-&gt;array, ra-&gt;nelems * ra-&gt;element_size );
00084         <span class="keywordflow">return</span> ret;
00085 }
00086 
00087 <span class="keywordtype">void</span> <a class="code" href="pbrtparse_8y.html#a42">ArrayFree</a>( ParamArray *ra )
00088 {
00089         free(ra-&gt;array);
00090         <span class="keyword">delete</span> ra;
00091 }
00092 
00093 <span class="keywordtype">void</span> <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>()
00094 {
00095         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; cur_paramlist_size; ++i)
00096                 <span class="keyword">delete</span>[] ((<span class="keywordtype">char</span> *)<a class="code" href="pbrtparse_8y.html#a36">cur_paramlist_args</a>[i]);
00097 }
00098 
00099 <span class="keyword">static</span> <span class="keywordtype">bool</span> VerifyArrayLength( ParamArray *arr, <span class="keywordtype">int</span> required,
00100         <span class="keyword">const</span> <span class="keywordtype">char</span> *command ) {
00101         <span class="keywordflow">if</span> (arr-&gt;nelems != required) {
00102                 ParseError( <span class="stringliteral">"%s requires a(n) %d element array!"</span>, command, required);
00103                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00104         }
00105         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00106 }
00107 <span class="keyword">enum</span> { PARAM_TYPE_INT, PARAM_TYPE_BOOL, PARAM_TYPE_FLOAT, PARAM_TYPE_POINT,
00108         PARAM_TYPE_VECTOR, PARAM_TYPE_NORMAL, PARAM_TYPE_COLOR,
00109         PARAM_TYPE_STRING, PARAM_TYPE_TEXTURE };
00110 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(<a class="code" href="classParamSet.html">ParamSet</a> &amp;ps, <span class="keywordtype">int</span> count, <span class="keyword">const</span> <span class="keywordtype">char</span> **tokens,
00111         <span class="keywordtype">void</span> **args, <span class="keywordtype">int</span> *sizes, <span class="keywordtype">bool</span> *texture_helper);
00112 <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="pbrtparse_8y.html#a47">lookupType</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class="keywordtype">int</span> *type, string &amp;name);
00113 <span class="preprocessor">#define YYPRINT(file, type, value)  \</span>
00114 <span class="preprocessor">{ \</span>
00115 <span class="preprocessor">        if ((type) == ID || (type) == STRING) \</span>
00116 <span class="preprocessor">                fprintf ((file), " %s", (value).string); \</span>
00117 <span class="preprocessor">        else if ((type) == NUM) \</span>
00118 <span class="preprocessor">                fprintf ((file), " %f", (value).num); \</span>
00119 <span class="preprocessor">}</span>
00120 <span class="preprocessor"></span>%}
00121 
00122 %<span class="keyword">union </span>{
00123 <span class="keywordtype">char</span> string[1024];
00124 <span class="keywordtype">float</span> num;
00125 ParamArray *ribarray;
00126 }
00127 %token &lt;string&gt; <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> <a class="codeRef" doxygen=":" href="dummy.html">ID</a>
00128 %token &lt;num&gt; <a class="codeRef" doxygen=":" href="dummy.html">NUM</a>
00129 %token <a class="codeRef" doxygen=":" href="dummy.html">LBRACK</a> <a class="codeRef" doxygen=":" href="dummy.html">RBRACK</a>
00130 
00131 %token <a class="codeRef" doxygen=":" href="dummy.html">ACCELERATOR</a> <a class="codeRef" doxygen=":" href="dummy.html">AREALIGHTSOURCE</a> <a class="codeRef" doxygen=":" href="dummy.html">ATTRIBUTEBEGIN</a> <a class="codeRef" doxygen=":" href="dummy.html">ATTRIBUTEEND</a>
00132 %token <a class="codeRef" doxygen=":" href="dummy.html">CAMERA</a> <a class="codeRef" doxygen=":" href="dummy.html">CONCATTRANSFORM</a> <a class="codeRef" doxygen=":" href="dummy.html">COORDINATESYSTEM</a> <a class="codeRef" doxygen=":" href="dummy.html">COORDSYSTRANSFORM</a>
00133 %token <a class="codeRef" doxygen=":" href="dummy.html">FILM</a> <a class="codeRef" doxygen=":" href="dummy.html">IDENTITY</a> <a class="codeRef" doxygen=":" href="dummy.html">LIGHTSOURCE</a> <a class="codeRef" doxygen=":" href="dummy.html">LOOKAT</a> <a class="codeRef" doxygen=":" href="dummy.html">MATERIAL</a>
00134 %token <a class="codeRef" doxygen=":" href="dummy.html">OBJECTBEGIN</a> <a class="codeRef" doxygen=":" href="dummy.html">OBJECTEND</a> <a class="codeRef" doxygen=":" href="dummy.html">OBJECTINSTANCE</a>
00135 %token <a class="codeRef" doxygen=":" href="dummy.html">PIXELFILTER</a> <a class="codeRef" doxygen=":" href="dummy.html">REVERSEORIENTATION</a> <a class="codeRef" doxygen=":" href="dummy.html">ROTATE</a> <a class="codeRef" doxygen=":" href="dummy.html">SAMPLER</a> <a class="codeRef" doxygen=":" href="dummy.html">SCALE</a>
00136 %token <a class="codeRef" doxygen=":" href="dummy.html">SEARCHPATH</a> <a class="codeRef" doxygen=":" href="dummy.html">SHAPE</a> <a class="codeRef" doxygen=":" href="dummy.html">SURFACEINTEGRATOR</a> <a class="codeRef" doxygen=":" href="dummy.html">TEXTURE</a> <a class="codeRef" doxygen=":" href="dummy.html">TRANSFORMBEGIN</a> <a class="codeRef" doxygen=":" href="dummy.html">TRANSFORMEND</a>
00137 %token <a class="codeRef" doxygen=":" href="dummy.html">TRANSFORM</a> <a class="codeRef" doxygen=":" href="dummy.html">TRANSLATE</a> <a class="codeRef" doxygen=":" href="dummy.html">VOLUME</a> <a class="codeRef" doxygen=":" href="dummy.html">VOLUMEINTEGRATOR</a> <a class="codeRef" doxygen=":" href="dummy.html">WORLDBEGIN</a> <a class="codeRef" doxygen=":" href="dummy.html">WORLDEND</a>
00138 
00139 %token <a class="codeRef" doxygen=":" href="dummy.html">HIGH_PRECEDENCE</a>
00140 
00141 %type&lt;ribarray&gt; <a class="code" href="pbrtparse_8y.html#a14">array</a> num_array string_array
00142 %type&lt;ribarray&gt; real_num_array real_string_array
00143 %%
00144 start: ri_stmt_list
00145 {
00146 };
00147 
00148 array_init: %prec <a class="codeRef" doxygen=":" href="dummy.html">HIGH_PRECEDENCE</a>
00149 {
00150         <span class="keywordflow">if</span> (<a class="code" href="pbrtparse_8y.html#a11">cur_array</a>) <a class="code" href="pbrtparse_8y.html#a42">ArrayFree</a>( cur_array );
00151         <a class="code" href="pbrtparse_8y.html#a11">cur_array</a> = <span class="keyword">new</span> ParamArray;
00152         <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;allocated = 0;
00153         <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;nelems = 0;
00154         <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;array = NULL;
00155         <a class="code" href="pbrtparse_8y.html#a15">array_is_single_string</a> = <span class="keyword">false</span>;
00156 };
00157 
00158 string_array_init: %prec <a class="codeRef" doxygen=":" href="dummy.html">HIGH_PRECEDENCE</a>
00159 {
00160         <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;element_size = <span class="keyword">sizeof</span>( <span class="keyword">const</span> <span class="keywordtype">char</span> * );
00161 };
00162 
00163 num_array_init: %prec <a class="codeRef" doxygen=":" href="dummy.html">HIGH_PRECEDENCE</a>
00164 {
00165         <a class="code" href="pbrtparse_8y.html#a11">cur_array</a>-&gt;element_size = <span class="keyword">sizeof</span>( <span class="keywordtype">float</span> );
00166 };
00167 
00168 <a class="code" href="pbrtparse_8y.html#a14">array</a>: string_array
00169 {
00170         $$ = $1;
00171 }
00172 | num_array
00173 {
00174         $$ = $1;
00175 };
00176 
00177 string_array: real_string_array
00178 {
00179         $$ = $1;
00180 }
00181 | single_element_string_array
00182 {
00183         $$ = ArrayDup(cur_array);
00184         <a class="code" href="pbrtparse_8y.html#a15">array_is_single_string</a> = <span class="keyword">true</span>;
00185 };
00186 
00187 real_string_array: array_init <a class="codeRef" doxygen=":" href="dummy.html">LBRACK</a> string_list <a class="codeRef" doxygen=":" href="dummy.html">RBRACK</a>
00188 {
00189         $$ = ArrayDup(cur_array);
00190 };
00191 
00192 single_element_string_array: array_init string_list_entry
00193 {
00194 };
00195 
00196 string_list: string_list string_list_entry
00197 {
00198 }
00199 | string_list_entry
00200 {
00201 };
00202 
00203 string_list_entry: string_array_init <a class="codeRef" doxygen=":" href="dummy.html">STRING</a>
00204 {
00205         <span class="keywordtype">char</span> *to_add = strdup($2);
00206         <a class="code" href="pbrtparse_8y.html#a39">AddArrayElement</a>( &amp;to_add );
00207 };
00208 
00209 num_array: real_num_array
00210 {
00211         $$ = $1;
00212 }
00213 | single_element_num_array
00214 {
00215         $$ = ArrayDup(cur_array);
00216 };
00217 
00218 real_num_array: array_init <a class="codeRef" doxygen=":" href="dummy.html">LBRACK</a> num_list <a class="codeRef" doxygen=":" href="dummy.html">RBRACK</a>
00219 {
00220         $$ = ArrayDup(cur_array);
00221 };
00222 
00223 single_element_num_array: array_init num_list_entry
00224 {
00225 };
00226 
00227 num_list: num_list num_list_entry
00228 {
00229 }
00230 | num_list_entry
00231 {
00232 };
00233 
00234 num_list_entry: num_array_init <a class="codeRef" doxygen=":" href="dummy.html">NUM</a>
00235 {
00236         <span class="keywordtype">float</span> to_add = $2;
00237         <a class="code" href="pbrtparse_8y.html#a39">AddArrayElement</a>( &amp;to_add );
00238 };
00239 
00240 paramlist: paramlist_init paramlist_contents
00241 {
00242 };
00243 
00244 paramlist_init: %prec <a class="codeRef" doxygen=":" href="dummy.html">HIGH_PRECEDENCE</a>
00245 {
00246         cur_paramlist_size = 0;
00247 };
00248 
00249 paramlist_contents: paramlist_entry paramlist_contents
00250 {
00251 }
00252 |
00253 {
00254 };
00255 
00256 paramlist_entry: <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> <a class="code" href="pbrtparse_8y.html#a14">array</a>
00257 {
00258         <span class="keywordtype">void</span> *arg = <span class="keyword">new</span> <span class="keywordtype">char</span>[ $2-&gt;nelems * $2-&gt;element_size ];
00259         <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>(arg, $2-&gt;array, $2-&gt;nelems * $2-&gt;element_size);
00260         <span class="keywordflow">if</span> (cur_paramlist_size &gt;= cur_paramlist_allocated) {
00261                 cur_paramlist_allocated = 2*cur_paramlist_allocated + 1;
00262                 <a class="code" href="pbrtparse_8y.html#a33">cur_paramlist_tokens</a> = (<span class="keyword">const</span> <span class="keywordtype">char</span> **) realloc(cur_paramlist_tokens, cur_paramlist_allocated*<span class="keyword">sizeof</span>(<span class="keyword">const</span> <span class="keywordtype">char</span> *) );
00263                 <a class="code" href="pbrtparse_8y.html#a36">cur_paramlist_args</a> = (<span class="keywordtype">void</span> * *) realloc( cur_paramlist_args, cur_paramlist_allocated*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *) );
00264                 <a class="code" href="pbrtparse_8y.html#a34">cur_paramlist_sizes</a> = (<span class="keywordtype">int</span> *) realloc( cur_paramlist_sizes, cur_paramlist_allocated*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );
00265                 <a class="code" href="pbrtparse_8y.html#a35">cur_paramlist_texture_helper</a> = (<span class="keywordtype">bool</span> *) realloc( cur_paramlist_texture_helper, cur_paramlist_allocated*<span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>) );
00266         }
00267         <a class="code" href="pbrtparse_8y.html#a33">cur_paramlist_tokens</a>[cur_paramlist_size] = $1;
00268         <a class="code" href="pbrtparse_8y.html#a34">cur_paramlist_sizes</a>[cur_paramlist_size] = $2-&gt;nelems;
00269         <a class="code" href="pbrtparse_8y.html#a35">cur_paramlist_texture_helper</a>[cur_paramlist_size] = <a class="code" href="pbrtparse_8y.html#a15">array_is_single_string</a>;
00270         <a class="code" href="pbrtparse_8y.html#a36">cur_paramlist_args</a>[cur_paramlist_size++] = arg;
00271         <a class="code" href="pbrtparse_8y.html#a42">ArrayFree</a>( $2 );
00272 };
00273 
00274 ri_stmt_list: ri_stmt_list ri_stmt
00275 {
00276 }
00277 | ri_stmt
00278 {
00279 };
00280 
00281 ri_stmt: <a class="codeRef" doxygen=":" href="dummy.html">ACCELERATOR</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00282 {
00283         <a class="code" href="classParamSet.html">ParamSet</a> params;
00284         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00285         <a class="code" href="pbrtparse_8y.html#a44">pbrtAccelerator</a>($2, params);
00286         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00287 }
00288 | <a class="codeRef" doxygen=":" href="dummy.html">AREALIGHTSOURCE</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00289 {
00290         <a class="code" href="classParamSet.html">ParamSet</a> params;
00291         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00292         <a class="code" href="api_8h.html#a25">pbrtAreaLightSource</a>($2, params);
00293         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00294 }
00295 | <a class="codeRef" doxygen=":" href="dummy.html">ATTRIBUTEBEGIN</a>
00296 {
00297         <a class="code" href="api_8cpp.html#a33">pbrtAttributeBegin</a>();
00298 }
00299 | <a class="codeRef" doxygen=":" href="dummy.html">ATTRIBUTEEND</a>
00300 {
00301         <a class="code" href="api_8cpp.html#a34">pbrtAttributeEnd</a>();
00302 }
00303 | <a class="codeRef" doxygen=":" href="dummy.html">CAMERA</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00304 {
00305         <a class="code" href="classParamSet.html">ParamSet</a> params;
00306         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00307         <a class="code" href="api_8h.html#a15">pbrtCamera</a>($2, params);
00308         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00309 }
00310 | <a class="codeRef" doxygen=":" href="dummy.html">CONCATTRANSFORM</a> num_array
00311 {
00312         <span class="keywordflow">if</span> (VerifyArrayLength( $2, 16, <span class="stringliteral">"ConcatTransform"</span> ))
00313                 <a class="code" href="api_8h.html#a5">pbrtConcatTransform</a>( (<span class="keywordtype">float</span> *) $2-&gt;array );
00314         <a class="code" href="pbrtparse_8y.html#a42">ArrayFree</a>( $2 );
00315 }
00316 | <a class="codeRef" doxygen=":" href="dummy.html">COORDINATESYSTEM</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a>
00317 {
00318         <a class="code" href="api_8h.html#a7">pbrtCoordinateSystem</a>( $2 );
00319 }
00320 | <a class="codeRef" doxygen=":" href="dummy.html">COORDSYSTRANSFORM</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a>
00321 {
00322         <a class="code" href="api_8h.html#a8">pbrtCoordSysTransform</a>( $2 );
00323 }
00324 | <a class="codeRef" doxygen=":" href="dummy.html">FILM</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00325 {
00326         <a class="code" href="classParamSet.html">ParamSet</a> params;
00327         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00328         <a class="code" href="api_8h.html#a10">pbrtFilm</a>($2, params);
00329         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00330 }
00331 | <a class="codeRef" doxygen=":" href="dummy.html">IDENTITY</a>
00332 {
00333         <a class="code" href="api_8cpp.html#a15">pbrtIdentity</a>();
00334 }
00335 | <a class="codeRef" doxygen=":" href="dummy.html">LIGHTSOURCE</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00336 {
00337         <a class="code" href="classParamSet.html">ParamSet</a> params;
00338         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00339         <a class="code" href="api_8h.html#a24">pbrtLightSource</a>($2, params);
00340         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00341 }
00342 | <a class="codeRef" doxygen=":" href="dummy.html">LOOKAT</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a>
00343 {
00344         <a class="code" href="api_8h.html#a4">pbrtLookAt</a>($2, $3, $4, $5, $6, $7, $8, $9, $10);
00345 }
00346 | <a class="codeRef" doxygen=":" href="dummy.html">MATERIAL</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00347 {
00348         <a class="code" href="classParamSet.html">ParamSet</a> params;
00349         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00350         <a class="code" href="api_8h.html#a23">pbrtMaterial</a>($2, params);
00351         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00352 }
00353 | <a class="codeRef" doxygen=":" href="dummy.html">OBJECTBEGIN</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a>
00354 {
00355         <a class="code" href="api_8h.html#a29">pbrtObjectBegin</a>($2);
00356 }
00357 | <a class="codeRef" doxygen=":" href="dummy.html">OBJECTEND</a>
00358 {
00359         <a class="code" href="api_8cpp.html#a45">pbrtObjectEnd</a>();
00360 }
00361 | <a class="codeRef" doxygen=":" href="dummy.html">OBJECTINSTANCE</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a>
00362 {
00363         <a class="code" href="api_8h.html#a31">pbrtObjectInstance</a>($2);
00364 }
00365 | <a class="codeRef" doxygen=":" href="dummy.html">PIXELFILTER</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00366 {
00367         <a class="code" href="classParamSet.html">ParamSet</a> params;
00368         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00369         <a class="code" href="api_8h.html#a9">pbrtPixelFilter</a>($2, params);
00370         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00371 }
00372 | <a class="codeRef" doxygen=":" href="dummy.html">REVERSEORIENTATION</a>
00373 {
00374         <a class="code" href="api_8cpp.html#a42">pbrtReverseOrientation</a>();
00375 }
00376 | <a class="codeRef" doxygen=":" href="dummy.html">ROTATE</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a>
00377 {
00378         <a class="code" href="api_8h.html#a2">pbrtRotate</a>($2, $3, $4, $5);
00379 }
00380 | <a class="codeRef" doxygen=":" href="dummy.html">SAMPLER</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00381 {
00382         <a class="code" href="classParamSet.html">ParamSet</a> params;
00383         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00384         <a class="code" href="api_8h.html#a11">pbrtSampler</a>($2, params);
00385         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00386 }
00387 | <a class="codeRef" doxygen=":" href="dummy.html">SCALE</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a>
00388 {
00389         <a class="code" href="api_8h.html#a3">pbrtScale</a>($2, $3, $4);
00390 }
00391 | <a class="codeRef" doxygen=":" href="dummy.html">SEARCHPATH</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a>
00392 {
00393         <a class="code" href="api_8h.html#a16">pbrtSearchPath</a>($2);
00394 }
00395 | <a class="codeRef" doxygen=":" href="dummy.html">SHAPE</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00396 {
00397         <a class="code" href="classParamSet.html">ParamSet</a> params;
00398         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00399         <a class="code" href="api_8h.html#a26">pbrtShape</a>($2, params);
00400         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00401 }
00402 | <a class="codeRef" doxygen=":" href="dummy.html">SURFACEINTEGRATOR</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00403 {
00404         <a class="code" href="classParamSet.html">ParamSet</a> params;
00405         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00406         <a class="code" href="api_8h.html#a13">pbrtSurfaceIntegrator</a>($2, params);
00407         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00408 }
00409 | <a class="codeRef" doxygen=":" href="dummy.html">TEXTURE</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00410 {
00411         <a class="code" href="classParamSet.html">ParamSet</a> params;
00412         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00413         <a class="code" href="api_8h.html#a22">pbrtTexture</a>($2, $3, $4, params);
00414         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00415 }
00416 | <a class="codeRef" doxygen=":" href="dummy.html">TRANSFORMBEGIN</a>
00417 {
00418         <a class="code" href="api_8cpp.html#a35">pbrtTransformBegin</a>();
00419 }
00420 | <a class="codeRef" doxygen=":" href="dummy.html">TRANSFORMEND</a>
00421 {
00422         <a class="code" href="api_8cpp.html#a36">pbrtTransformEnd</a>();
00423 }
00424 | <a class="codeRef" doxygen=":" href="dummy.html">TRANSFORM</a> real_num_array
00425 {
00426         <span class="keywordflow">if</span> (VerifyArrayLength( $2, 16, <span class="stringliteral">"Transform"</span> ))
00427                 <a class="code" href="api_8h.html#a6">pbrtTransform</a>( (<span class="keywordtype">float</span> *) $2-&gt;array );
00428         <a class="code" href="pbrtparse_8y.html#a42">ArrayFree</a>( $2 );
00429 }
00430 | <a class="codeRef" doxygen=":" href="dummy.html">TRANSLATE</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a> <a class="codeRef" doxygen=":" href="dummy.html">NUM</a>
00431 {
00432         <a class="code" href="api_8h.html#a1">pbrtTranslate</a>($2, $3, $4);
00433 }
00434 | <a class="codeRef" doxygen=":" href="dummy.html">VOLUMEINTEGRATOR</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00435 {
00436         <a class="code" href="classParamSet.html">ParamSet</a> params;
00437         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00438         <a class="code" href="api_8h.html#a14">pbrtVolumeIntegrator</a>($2, params);
00439         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00440 }
00441 | <a class="codeRef" doxygen=":" href="dummy.html">VOLUME</a> <a class="codeRef" doxygen=":" href="dummy.html">STRING</a> paramlist
00442 {
00443         <a class="code" href="classParamSet.html">ParamSet</a> params;
00444         <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(params, CPS, CPT, CPA, CPSZ, CPTH);
00445         <a class="code" href="api_8h.html#a28">pbrtVolume</a>($2, params);
00446         <a class="code" href="pbrtparse_8y.html#a45">FreeArgs</a>();
00447 }
00448 | <a class="codeRef" doxygen=":" href="dummy.html">WORLDBEGIN</a>
00449 {
00450         <a class="code" href="api_8cpp.html#a32">pbrtWorldBegin</a>();
00451 }
00452 | <a class="codeRef" doxygen=":" href="dummy.html">WORLDEND</a>
00453 {
00454         <a class="code" href="api_8cpp.html#a47">pbrtWorldEnd</a>();
00455 };
00456 %%
00457 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbrtparse_8y.html#a46">InitParamSet</a>(<a class="code" href="classParamSet.html">ParamSet</a> &amp;ps, <span class="keywordtype">int</span> count, <span class="keyword">const</span> <span class="keywordtype">char</span> **tokens,
00458                 <span class="keywordtype">void</span> **args, <span class="keywordtype">int</span> *sizes, <span class="keywordtype">bool</span> *texture_helper) {
00459         ps.<a class="code" href="classParamSet.html#a40">Clear</a>();
00460         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; count; ++i) {
00461                 <span class="keywordtype">int</span> type;
00462                 string name;
00463                 <span class="keywordflow">if</span> (<a class="code" href="pbrtparse_8y.html#a47">lookupType</a>(tokens[i], &amp;type, name)) {
00464                         <span class="keywordflow">if</span> (texture_helper &amp;&amp; texture_helper[i] &amp;&amp; type != PARAM_TYPE_TEXTURE &amp;&amp; type != PARAM_TYPE_STRING)
00465                         {
00466                                 <a class="code" href="util_8cpp.html#a15">Warning</a>( <span class="stringliteral">"Bad type for %s. Changing it to a texture."</span>, name.c_str());
00467                                 type = PARAM_TYPE_TEXTURE;
00468                         }
00469                         <span class="keywordtype">void</span> *data = args[i];
00470                         <span class="keywordtype">int</span> nItems = sizes[i];
00471                         <span class="keywordflow">if</span> (type == PARAM_TYPE_INT) {
00472                                 <span class="comment">// parser doesn't handle ints, so convert from floats here....</span>
00473                                 <span class="keywordtype">int</span> nAlloc = sizes[i];
00474                                 <span class="keywordtype">int</span> *idata = <span class="keyword">new</span> <span class="keywordtype">int</span>[nAlloc];
00475                                 <span class="keywordtype">float</span> *fdata = (<span class="keywordtype">float</span> *)data;
00476                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; nAlloc; ++j)
00477                                         idata[j] = int(fdata[j]);
00478                                 ps.<a class="code" href="classParamSet.html#a4">AddInt</a>(name, idata, nItems);
00479                                 <span class="keyword">delete</span>[] idata;
00480                         }
00481                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == PARAM_TYPE_BOOL) {
00482                                 <span class="comment">// strings -&gt; bools</span>
00483                                 <span class="keywordtype">int</span> nAlloc = sizes[i];
00484                                 <span class="keywordtype">bool</span> *bdata = <span class="keyword">new</span> <span class="keywordtype">bool</span>[nAlloc];
00485                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; nAlloc; ++j) {
00486                                         string s(*((<span class="keyword">const</span> <span class="keywordtype">char</span> **)data));
00487                                         <span class="keywordflow">if</span> (s == <span class="stringliteral">"true"</span>) bdata[j] = <span class="keyword">true</span>;
00488                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"false"</span>) bdata[j] = <span class="keyword">false</span>;
00489                                         <span class="keywordflow">else</span> {
00490                                                 <a class="code" href="util_8cpp.html#a15">Warning</a>(<span class="stringliteral">"Value \"%s\" unknown for boolean parameter \"%s\"."</span>
00491                                                         <span class="stringliteral">"Using \"false\"."</span>, s.c_str(), tokens[i]);
00492                                                 bdata[j] = <span class="keyword">false</span>;
00493                                         }
00494                                 }
00495                                 ps.<a class="code" href="classParamSet.html#a5">AddBool</a>(name, bdata, nItems);
00496                                 <span class="keyword">delete</span>[] bdata;
00497                         }
00498                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == PARAM_TYPE_FLOAT) {
00499                                 ps.<a class="code" href="classParamSet.html#a3">AddFloat</a>(name, (<span class="keywordtype">float</span> *)data, nItems);
00500                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == PARAM_TYPE_POINT) {
00501                                 ps.<a class="code" href="classParamSet.html#a6">AddPoint</a>(name, (<a class="code" href="classPoint.html">Point</a> *)data, nItems / 3);
00502                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == PARAM_TYPE_VECTOR) {
00503                                 ps.<a class="code" href="classParamSet.html#a7">AddVector</a>(name, (<a class="code" href="classVector.html">Vector</a> *)data, nItems / 3);
00504                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == PARAM_TYPE_NORMAL) {
00505                                 ps.<a class="code" href="classParamSet.html#a8">AddNormal</a>(name, (<a class="code" href="classNormal.html">Normal</a> *)data, nItems / 3);
00506                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == PARAM_TYPE_COLOR) {
00507                                 ps.<a class="code" href="classParamSet.html#a9">AddSpectrum</a>(name, (<a class="code" href="classSpectrum.html">Spectrum</a> *)data, nItems / COLOR_SAMPLES);
00508                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == PARAM_TYPE_STRING) {
00509                                 string *strings = <span class="keyword">new</span> string[nItems];
00510                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; nItems; ++j)
00511                                         strings[j] = string(*((<span class="keyword">const</span> <span class="keywordtype">char</span> **)data+j));
00512                                 ps.<a class="code" href="classParamSet.html#a10">AddString</a>(name, strings, nItems);
00513                                 <span class="keyword">delete</span>[] strings;
00514                         }
00515                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == PARAM_TYPE_TEXTURE) {
00516                                 <span class="keywordflow">if</span> (nItems == 1) {
00517                                         string val(*((<span class="keyword">const</span> <span class="keywordtype">char</span> **)data));
00518                                         ps.<a class="code" href="classParamSet.html#a11">AddTexture</a>(name, val);
00519                                 }
00520                                 <span class="keywordflow">else</span>
00521                                         <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"Only one string allowed for \"texture\" parameter \"%s\""</span>,
00522                                                 name.c_str());
00523                         }
00524                 }
00525                 <span class="keywordflow">else</span>
00526                         <a class="code" href="util_8cpp.html#a15">Warning</a>(<span class="stringliteral">"Type of parameter \"%s\" is unknown"</span>,
00527                                 tokens[i]);
00528         }
00529 }
00530 <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="pbrtparse_8y.html#a47">lookupType</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class="keywordtype">int</span> *type, string &amp;name) {
00531         <a class="code" href="pbrt_8h.html#a14">Assert</a>(token != NULL);
00532         *type = 0;
00533         <span class="keyword">const</span> <span class="keywordtype">char</span> *strp = token;
00534         <span class="keywordflow">while</span> (*strp &amp;&amp; isspace(*strp))
00535                 ++strp;
00536         <span class="keywordflow">if</span> (!*strp) {
00537                 <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"Parameter \"%s\" doesn't have a type declaration?!"</span>, token);
00538                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00539         }
00540 <span class="preprocessor">        #define TRY_DECODING_TYPE(name, mask) \</span>
00541 <span class="preprocessor">                if (strncmp(name, strp, strlen(name)) == 0) { \</span>
00542 <span class="preprocessor">                        *type = mask; strp += strlen(name); \</span>
00543 <span class="preprocessor">                }</span>
00544 <span class="preprocessor"></span>             <a class="code" href="pbrtparse_8y.html#a9">TRY_DECODING_TYPE</a>(<span class="stringliteral">"float"</span>,    PARAM_TYPE_FLOAT)
00545         else TRY_DECODING_TYPE("integer",  PARAM_TYPE_INT)
00546         else TRY_DECODING_TYPE("<span class="keywordtype">bool</span>",     PARAM_TYPE_BOOL)
00547         else TRY_DECODING_TYPE("point",    PARAM_TYPE_POINT)
00548         else TRY_DECODING_TYPE("vector",   PARAM_TYPE_VECTOR)
00549         else TRY_DECODING_TYPE("normal",   PARAM_TYPE_NORMAL)
00550         else TRY_DECODING_TYPE("string",   PARAM_TYPE_STRING)
00551         else TRY_DECODING_TYPE("texture",  PARAM_TYPE_TEXTURE)
00552         else TRY_DECODING_TYPE("color",    PARAM_TYPE_COLOR)
00553         else {
00554                 <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"Unable to decode type for token \"%s\""</span>, token);
00555                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00556         }
00557         <span class="keywordflow">while</span> (*strp &amp;&amp; isspace(*strp))
00558                 ++strp;
00559         name = string(strp);
00560         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00561 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:23 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
