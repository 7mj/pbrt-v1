<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: reflection.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>reflection.cpp</h1><a href="reflection_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// reflection.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="reflection_8h.html">reflection.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="color_8h.html">color.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="mc_8h.html">mc.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="sampling_8h.html">sampling.h</a>"</span>
00016 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00017 <span class="comment">// BxDF Utility Functions</span>
<a name="l00018"></a><a class="code" href="reflection_8cpp.html#a0">00018</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="reflection_8cpp.html#a0">FrDiel</a>(<span class="keywordtype">float</span> cosi, <span class="keywordtype">float</span> cost,
00019                         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;etai,
00020                                                 <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;etat) {
00021         <a class="code" href="classSpectrum.html">Spectrum</a> Rparl = ((etat * cosi) - (etai * cost)) /
00022                          ((etat * cosi) + (etai * cost));
00023         <a class="code" href="classSpectrum.html">Spectrum</a> Rperp = ((etai * cosi) - (etat * cost)) /
00024                          ((etai * cosi) + (etat * cost));
00025         <span class="keywordflow">return</span> (Rparl*Rparl + Rperp*Rperp) / 2.f;
00026 }
<a name="l00027"></a><a class="code" href="reflection_8cpp.html#a1">00027</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="reflection_8cpp.html#a1">FrCond</a>(<span class="keywordtype">float</span> cosi,
00028                          <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;eta,
00029                                              <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;k) {
00030     <a class="code" href="classSpectrum.html">Spectrum</a> tmp = (eta*eta + k*k) * cosi*cosi;
00031     <a class="code" href="classSpectrum.html">Spectrum</a> Rparl2 = (tmp - (2.f * eta * cosi) + 1) /
00032         (tmp + (2.f * eta * cosi) + 1);
00033     <a class="code" href="classSpectrum.html">Spectrum</a> tmp_f = eta*eta + k*k;
00034     <a class="code" href="classSpectrum.html">Spectrum</a> Rperp2 =
00035                 (tmp_f - (2.f * eta * cosi) + cosi*cosi) /
00036             (tmp_f + (2.f * eta * cosi) + cosi*cosi);
00037     <span class="keywordflow">return</span> (Rparl2 + Rperp2) / 2.f;
00038 }
<a name="l00039"></a><a class="code" href="reflection_8cpp.html#a2">00039</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="reflection_8cpp.html#a2">FresnelApproxEta</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;Fr) {
00040         <a class="code" href="classSpectrum.html">Spectrum</a> reflectance = Fr.<a class="code" href="classSpectrum.html#a19">Clamp</a>(0.f, .999f);
00041         <span class="keywordflow">return</span> (<a class="code" href="classSpectrum.html">Spectrum</a>(1.) + reflectance.<a class="code" href="classSpectrum.html#a16">Sqrt</a>()) /
00042                 (<a class="code" href="classSpectrum.html">Spectrum</a>(1.) - reflectance.<a class="code" href="classSpectrum.html#a16">Sqrt</a>());
00043 }
<a name="l00044"></a><a class="code" href="reflection_8cpp.html#a3">00044</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="reflection_8cpp.html#a3">FresnelApproxK</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;Fr) {
00045         <a class="code" href="classSpectrum.html">Spectrum</a> reflectance = Fr.<a class="code" href="classSpectrum.html#a19">Clamp</a>(0.f, .999f);
00046         <span class="keywordflow">return</span> 2.f * (reflectance /
00047                       (<a class="code" href="classSpectrum.html">Spectrum</a>(1.) - reflectance)).Sqrt();
00048 }
00049 <span class="comment">// BxDF Method Definitions</span>
<a name="l00050"></a><a class="code" href="classBRDFToBTDF.html#a3">00050</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBRDFToBTDF.html#a3">BRDFToBTDF::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00051                        <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00052         <span class="keywordflow">return</span> <a class="code" href="classBRDFToBTDF.html#r0">brdf</a>-&gt;<a class="code" href="classBxDF.html#a3">f</a>(wo, <a class="code" href="classBRDFToBTDF.html#e0">otherHemisphere</a>(wi));
00053 }
<a name="l00054"></a><a class="code" href="classBRDFToBTDF.html#a4">00054</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBRDFToBTDF.html#a4">BRDFToBTDF::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
00055                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00056         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBRDFToBTDF.html#a3">f</a> = <a class="code" href="classBRDFToBTDF.html#r0">brdf</a>-&gt;<a class="code" href="classBxDF.html#a4">Sample_f</a>(wo, wi, u1, u2, pdf);
00057         *wi = <a class="code" href="classBRDFToBTDF.html#e0">otherHemisphere</a>(*wi);
00058         <span class="keywordflow">return</span> f;
00059 }
<a name="l00060"></a><a class="code" href="classFresnel.html#a0">00060</a> <a class="code" href="classFresnel.html#a0">Fresnel::~Fresnel</a>() { }
<a name="l00061"></a><a class="code" href="classFresnelConductor.html#a0">00061</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classFresnelConductor.html#a0">FresnelConductor::Evaluate</a>(<span class="keywordtype">float</span> cosi)<span class="keyword"> const </span>{
00062         <span class="keywordflow">return</span> <a class="code" href="reflection_8cpp.html#a1">FrCond</a>(fabsf(cosi), <a class="code" href="classFresnelConductor.html#r0">eta</a>, <a class="code" href="classFresnelConductor.html#r1">k</a>);
00063 }
<a name="l00064"></a><a class="code" href="classFresnelDielectric.html#a0">00064</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classFresnelDielectric.html#a0">FresnelDielectric::Evaluate</a>(<span class="keywordtype">float</span> cosi)<span class="keyword"> const </span>{
00065         <span class="comment">// Compute Fresnel reflectance for dielectric</span>
00066         cosi = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(cosi, -1.f, 1.f);
00067         <span class="comment">// Compute indices of refraction for dielectric</span>
00068         <span class="keywordtype">bool</span> entering = cosi &gt; 0.;
00069         <span class="keywordtype">float</span> ei = <a class="code" href="classFresnelDielectric.html#r0">eta_i</a>, et = <a class="code" href="classFresnelDielectric.html#r1">eta_t</a>;
00070         <span class="keywordflow">if</span> (!entering)
00071                 swap(ei, et);
00072         <span class="comment">// Compute _sint_ using Snell's law</span>
00073         <span class="keywordtype">float</span> sint = ei/et * sqrtf(max(0.f, 1.f - cosi*cosi));
00074         <span class="keywordflow">if</span> (sint &gt; 1.) {
00075                 <span class="comment">// Handle total internal reflection</span>
00076                 <span class="keywordflow">return</span> 1.;
00077         }
00078         <span class="keywordflow">else</span> {
00079                 <span class="keywordtype">float</span> cost = sqrtf(max(0.f, 1.f - sint*sint));
00080                 <span class="keywordflow">return</span> <a class="code" href="reflection_8cpp.html#a0">FrDiel</a>(fabsf(cosi), cost, ei, et);
00081         }
00082 }
<a name="l00083"></a><a class="code" href="classSpecularReflection.html#a2">00083</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classSpecularReflection.html#a2">SpecularReflection::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00084                 <a class="code" href="classVector.html">Vector</a> *wi, <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00085         <span class="comment">// Compute perfect specular reflection direction</span>
00086         *wi = <a class="code" href="classVector.html">Vector</a>(-wo.<a class="code" href="classVector.html#o0">x</a>, -wo.<a class="code" href="classVector.html#o1">y</a>, wo.<a class="code" href="classVector.html#o2">z</a>);
00087         *pdf = 1.f;
00088         <span class="keywordflow">return</span> <a class="code" href="classSpecularReflection.html#r1">fresnel</a>-&gt;<a class="code" href="classFresnel.html#a1">Evaluate</a>(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wo)) * <a class="code" href="classSpecularReflection.html#r0">R</a> /
00089                 fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(*wi));
00090 }
<a name="l00091"></a><a class="code" href="classSpecularTransmission.html#a2">00091</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classSpecularTransmission.html#a2">SpecularTransmission::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00092                 <a class="code" href="classVector.html">Vector</a> *wi, <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00093         <span class="comment">// Figure out which $\eta$ is incident and which is transmitted</span>
00094         <span class="keywordtype">bool</span> entering = <a class="code" href="reflection_8h.html#a11">CosTheta</a>(wo) &gt; 0.;
00095         <span class="keywordtype">float</span> ei = <a class="code" href="classSpecularTransmission.html#r1">etai</a>, et = <a class="code" href="classSpecularTransmission.html#r2">etat</a>;
00096         <span class="keywordflow">if</span> (!entering)
00097                 swap(ei, et);
00098         <span class="comment">// Compute transmitted ray direction</span>
00099         <span class="keywordtype">float</span> sini2 = <a class="code" href="reflection_8h.html#a13">SinTheta2</a>(wo);
00100         <span class="keywordtype">float</span> eta = ei / et;
00101         <span class="keywordtype">float</span> sint2 = eta * eta * sini2;
00102         <span class="comment">// Handle total internal reflection for transmission</span>
00103         <span class="keywordflow">if</span> (sint2 &gt; 1.) <span class="keywordflow">return</span> 0.;
00104         <span class="keywordtype">float</span> cost = sqrtf(max(0.<a class="code" href="classSpecularTransmission.html#a1">f</a>, 1.<a class="code" href="classSpecularTransmission.html#a1">f</a> - sint2));
00105         <span class="keywordflow">if</span> (entering) cost = -cost;
00106         <span class="keywordtype">float</span> sintOverSini = eta;
00107         *wi = <a class="code" href="classVector.html">Vector</a>(sintOverSini * -wo.<a class="code" href="classVector.html#o0">x</a>,
00108                      sintOverSini * -wo.<a class="code" href="classVector.html#o1">y</a>,
00109                                  cost);
00110         *pdf = 1.f;
00111         <a class="code" href="classSpectrum.html">Spectrum</a> F = <a class="code" href="classSpecularTransmission.html#r3">fresnel</a>.<a class="code" href="classFresnelDielectric.html#a0">Evaluate</a>(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wo));
00112         <span class="keywordflow">return</span> (ei*ei)/(et*et) * (<a class="code" href="classSpectrum.html">Spectrum</a>(1.)-F) * <a class="code" href="classSpecularTransmission.html#r0">T</a> /
00113                 fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(*wi));
00114 }
<a name="l00115"></a><a class="code" href="classLambertian.html#a1">00115</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classLambertian.html#a1">Lambertian::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00116                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00117         <span class="keywordflow">return</span> <a class="code" href="classLambertian.html#r1">RoverPI</a>;
00118 }
<a name="l00119"></a><a class="code" href="classOrenNayar.html#a0">00119</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classOrenNayar.html#a0">OrenNayar::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00120                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00121         <span class="keywordtype">float</span> sinthetai = <a class="code" href="reflection_8h.html#a12">SinTheta</a>(wi);
00122         <span class="keywordtype">float</span> sinthetao = <a class="code" href="reflection_8h.html#a12">SinTheta</a>(wo);
00123         <span class="comment">// Compute cosine term of Oren--Nayar model</span>
00124         <span class="keywordtype">float</span> sinphii = <a class="code" href="reflection_8h.html#a15">SinPhi</a>(wi), cosphii = <a class="code" href="reflection_8h.html#a14">CosPhi</a>(wi);
00125         <span class="keywordtype">float</span> sinphio = <a class="code" href="reflection_8h.html#a15">SinPhi</a>(wo), cosphio = <a class="code" href="reflection_8h.html#a14">CosPhi</a>(wo);
00126         <span class="keywordtype">float</span> dcos = cosphii * cosphio + sinphii * sinphio;
00127         <span class="keywordtype">float</span> maxcos = max(0.<a class="code" href="classOrenNayar.html#a0">f</a>, dcos);
00128         <span class="comment">// Compute sine and tangent terms of Oren--Nayar model</span>
00129         <span class="keywordtype">float</span> sinalpha, tanbeta;
00130         <span class="keywordflow">if</span> (fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wi)) &gt; fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wo))) {
00131                 sinalpha = sinthetao;
00132                 tanbeta = sinthetai / fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wi));
00133         }
00134         <span class="keywordflow">else</span> {
00135                 sinalpha = sinthetai;
00136                 tanbeta = sinthetao / fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wo));
00137         }
00138         <span class="keywordflow">return</span> <a class="code" href="classOrenNayar.html#r0">R</a> * <a class="code" href="pbrt_8h.html#a7">INV_PI</a> *
00139                (<a class="code" href="classOrenNayar.html#r1">A</a> + <a class="code" href="classOrenNayar.html#r2">B</a> * maxcos * sinalpha * tanbeta);
00140 }
<a name="l00141"></a><a class="code" href="classMicrofacet.html#a0">00141</a> <a class="code" href="classMicrofacet.html#a0">Microfacet::Microfacet</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;reflectance,
00142                        <a class="code" href="classFresnel.html">Fresnel</a> *f,
00143                                            <a class="code" href="classMicrofacetDistribution.html">MicrofacetDistribution</a> *d)
00144         : <a class="code" href="classBxDF.html">BxDF</a>(<a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a> | <a class="code" href="reflection_8h.html#a17a5">BSDF_GLOSSY</a>)),
00145          R(reflectance), distribution(d), fresnel(f) {
00146 }
<a name="l00147"></a><a class="code" href="classMicrofacet.html#a1">00147</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classMicrofacet.html#a1">Microfacet::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00148                        <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00149         <span class="keywordtype">float</span> cosThetaO = fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wo));
00150         <span class="keywordtype">float</span> cosThetaI = fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wi));
00151         <a class="code" href="classVector.html">Vector</a> wh = <a class="code" href="geometry_8h.html#a14">Normalize</a>(wi + wo);
00152         <span class="keywordtype">float</span> cosThetaH = <a class="code" href="geometry_8h.html#a17">Dot</a>(wi, wh);
00153         <a class="code" href="classSpectrum.html">Spectrum</a> F = <a class="code" href="classMicrofacet.html#r2">fresnel</a>-&gt;<a class="code" href="classFresnel.html#a1">Evaluate</a>(cosThetaH);
00154         <span class="keywordflow">return</span> <a class="code" href="classMicrofacet.html#r0">R</a> * <a class="code" href="classMicrofacet.html#r1">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#a1">D</a>(wh) * <a class="code" href="classMicrofacet.html#a2">G</a>(wo, wi, wh) * F /
00155                  (4.f * cosThetaI * cosThetaO);
00156 }
<a name="l00157"></a><a class="code" href="classLafortune.html#a0">00157</a> <a class="code" href="classLafortune.html#a0">Lafortune::Lafortune</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;r, u_int nl,
00158         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> *xx,
00159         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> *yy,
00160         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> *zz,
00161         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> *e, BxDFType t)
00162         : <a class="code" href="classBxDF.html">BxDF</a>(t), R(r) {
00163         <a class="code" href="classLafortune.html#r1">nLobes</a> = nl;
00164         <a class="code" href="classLafortune.html#r2">x</a> = xx;
00165         <a class="code" href="classLafortune.html#r3">y</a> = yy;
00166         <a class="code" href="classLafortune.html#r4">z</a> = zz;
00167         <a class="code" href="classLafortune.html#r5">exponent</a> = e;
00168 }
<a name="l00169"></a><a class="code" href="classLafortune.html#a1">00169</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classLafortune.html#a1">Lafortune::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00170                       <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00171         <a class="code" href="classSpectrum.html">Spectrum</a> ret = <a class="code" href="classLafortune.html#r0">R</a> * <a class="code" href="pbrt_8h.html#a7">INV_PI</a>;
00172         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classLafortune.html#r1">nLobes</a>; ++i) {
00173                 <span class="comment">// Add contribution for $i$th Phong lobe</span>
00174                 <a class="code" href="classSpectrum.html">Spectrum</a> v = <a class="code" href="classLafortune.html#r2">x</a>[i] * wo.<a class="code" href="classVector.html#o0">x</a> * wi.<a class="code" href="classVector.html#o0">x</a> + <a class="code" href="classLafortune.html#r3">y</a>[i] * wo.<a class="code" href="classVector.html#o1">y</a> * wi.<a class="code" href="classVector.html#o1">y</a> +
00175                         <a class="code" href="classLafortune.html#r4">z</a>[i] * wo.<a class="code" href="classVector.html#o2">z</a> * wi.<a class="code" href="classVector.html#o2">z</a>;
00176                 ret += v.<a class="code" href="classSpectrum.html#a17">Pow</a>(<a class="code" href="classLafortune.html#r5">exponent</a>[i]);
00177         }
00178         <span class="keywordflow">return</span> ret;
00179 }
<a name="l00180"></a><a class="code" href="classFresnelBlend.html#a0">00180</a> <a class="code" href="classFresnelBlend.html#a0">FresnelBlend::FresnelBlend</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;d,
00181                            <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;s,
00182                                                    <a class="code" href="classMicrofacetDistribution.html">MicrofacetDistribution</a> *dist)
00183         : <a class="code" href="classBxDF.html">BxDF</a>(<a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a> | <a class="code" href="reflection_8h.html#a17a5">BSDF_GLOSSY</a>)),
00184           Rd(d), Rs(s) {
00185         <a class="code" href="classFresnelBlend.html#r2">distribution</a> = dist;
00186 }
<a name="l00187"></a><a class="code" href="classFresnelBlend.html#a1">00187</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classFresnelBlend.html#a1">FresnelBlend::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00188                          <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00189         <a class="code" href="classSpectrum.html">Spectrum</a> diffuse = (28.f/(23.f*<a class="code" href="pbrt_8h.html#a6">M_PI</a>)) * <a class="code" href="classFresnelBlend.html#r0">Rd</a> *
00190                 (<a class="code" href="classSpectrum.html">Spectrum</a>(1.) - <a class="code" href="classFresnelBlend.html#r1">Rs</a>) *
00191                 (1 - powf(1 - .5<a class="code" href="classFresnelBlend.html#a1">f</a> * fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wi)), 5)) *
00192                 (1 - powf(1 - .5<a class="code" href="classFresnelBlend.html#a1">f</a> * fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wo)), 5));
00193         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#a14">Normalize</a>(wi + wo);
00194         Spectrum specular = <a class="code" href="classFresnelBlend.html#r2">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#a1">D</a>(H) /
00195                 (8.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, H) *
00196                 max(fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wi)), fabsf(<a class="code" href="reflection_8h.html#a11">CosTheta</a>(wo)))) *
00197                 <a class="code" href="classFresnelBlend.html#a2">SchlickFresnel</a>(<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, H));
00198         <span class="keywordflow">return</span> diffuse + specular;
00199 }
<a name="l00200"></a><a class="code" href="classBxDF.html#a4">00200</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#a4">BxDF::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
00201                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00202         <span class="comment">// Cosine-sample the hemisphere, flipping the direction if necessary</span>
00203         *wi = <a class="code" href="mc_8h.html#a9">CosineSampleHemisphere</a>(u1, u2);
00204         <span class="keywordflow">if</span> (wo.<a class="code" href="classVector.html#o2">z</a> &lt; 0.) wi-&gt;<a class="code" href="classVector.html#o2">z</a> *= -1.f;
00205         *pdf = <a class="code" href="classBxDF.html#a7">Pdf</a>(wo, *wi);
00206         <span class="keywordflow">return</span> <a class="code" href="classBxDF.html#a3">f</a>(wo, *wi);
00207 }
<a name="l00208"></a><a class="code" href="classBxDF.html#a7">00208</a> <span class="keywordtype">float</span> <a class="code" href="classBxDF.html#a7">BxDF::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00209         <span class="keywordflow">return</span>
00210                 <a class="code" href="reflection_8h.html#a16">SameHemisphere</a>(wo, wi) ? fabsf(wi.<a class="code" href="classVector.html#o2">z</a>) * <a class="code" href="pbrt_8h.html#a7">INV_PI</a> : 0.f;
00211 }
<a name="l00212"></a><a class="code" href="classBRDFToBTDF.html#a5">00212</a> <span class="keywordtype">float</span> <a class="code" href="classBRDFToBTDF.html#a5">BRDFToBTDF::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00213                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00214         <span class="keywordflow">return</span> <a class="code" href="classBRDFToBTDF.html#r0">brdf</a>-&gt;<a class="code" href="classBxDF.html#a7">Pdf</a>(wo, -wi);
00215 }
<a name="l00216"></a><a class="code" href="classMicrofacet.html#a3">00216</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classMicrofacet.html#a3">Microfacet::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
00217                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00218         <a class="code" href="classMicrofacet.html#r1">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#a2">Sample_f</a>(wo, wi, u1, u2, pdf);
00219         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#a16">SameHemisphere</a>(wo, *wi)) <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.<a class="code" href="classMicrofacet.html#a1">f</a>);
00220         <span class="keywordflow">return</span> <a class="code" href="classMicrofacet.html#a1">f</a>(wo, *wi);
00221 }
<a name="l00222"></a><a class="code" href="classMicrofacet.html#a4">00222</a> <span class="keywordtype">float</span> <a class="code" href="classMicrofacet.html#a4">Microfacet::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00223                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00224         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#a16">SameHemisphere</a>(wo, wi)) <span class="keywordflow">return</span> 0.f;
00225         <span class="keywordflow">return</span> <a class="code" href="classMicrofacet.html#r1">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#a3">Pdf</a>(wo, wi);
00226 }
<a name="l00227"></a><a class="code" href="classBlinn.html#a2">00227</a> <span class="keywordtype">void</span> <a class="code" href="classBlinn.html#a2">Blinn::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
00228                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00229         <span class="comment">// Compute sampled half-angle vector $\wh$ for Blinn distribution</span>
00230         <span class="keywordtype">float</span> costheta = powf(u1, 1.f / (<a class="code" href="classBlinn.html#r0">exponent</a>+1));
00231         <span class="keywordtype">float</span> sintheta = sqrtf(max(0.f, 1.f - costheta*costheta));
00232         <span class="keywordtype">float</span> phi = u2 * 2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00233         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#a25">SphericalDirection</a>(sintheta, costheta, phi);
00234         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, H) &lt; 0.f) H = -H;
00235         <span class="comment">// Compute incident direction by reflecting about $\wh$</span>
00236         *wi = -wo + 2.f * <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, H) * H;
00237         <span class="comment">// Compute PDF for \wi from Blinn distribution</span>
00238         <span class="keywordtype">float</span> blinn_pdf = ((exponent + 2.f) *
00239                            powf(costheta, exponent)) /
00240                 (2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * 4.f * <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, H));
00241         *pdf = blinn_pdf;
00242 }
<a name="l00243"></a><a class="code" href="classBlinn.html#a3">00243</a> <span class="keywordtype">float</span> <a class="code" href="classBlinn.html#a3">Blinn::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00244         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#a14">Normalize</a>(wo + wi);
00245         <span class="keywordtype">float</span> costheta = fabsf(H.<a class="code" href="classVector.html#o2">z</a>);
00246         <span class="comment">// Compute PDF for \wi from Blinn distribution</span>
00247         <span class="keywordtype">float</span> blinn_pdf = ((<a class="code" href="classBlinn.html#r0">exponent</a> + 2.f) *
00248                            powf(costheta, <a class="code" href="classBlinn.html#r0">exponent</a>)) /
00249                 (2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * 4.f * <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, H));
00250         <span class="keywordflow">return</span> blinn_pdf;
00251 }
<a name="l00252"></a><a class="code" href="classAnisotropic.html#a2">00252</a> <span class="keywordtype">void</span> <a class="code" href="classAnisotropic.html#a2">Anisotropic::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
00253                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00254         <span class="comment">// Sample from first quadrant and remap to hemisphere to sample \wh</span>
00255         <span class="keywordtype">float</span> phi, costheta;
00256         <span class="keywordflow">if</span> (u1 &lt; .25f) {
00257                 <a class="code" href="classAnisotropic.html#a4">sampleFirstQuadrant</a>(4.f * u1, u2, &amp;phi, &amp;costheta);
00258         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u1 &lt; .5f) {
00259                 u1 = 4.f * (.5f - u1);
00260                 <a class="code" href="classAnisotropic.html#a4">sampleFirstQuadrant</a>(u1, u2, &amp;phi, &amp;costheta);
00261                 phi = <a class="code" href="pbrt_8h.html#a6">M_PI</a> - phi;
00262         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u1 &lt; .75f) {
00263                 u1 = 4.f * (u1 - .5f);
00264                 <a class="code" href="classAnisotropic.html#a4">sampleFirstQuadrant</a>(u1, u2, &amp;phi, &amp;costheta);
00265                 phi += <a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00266         } <span class="keywordflow">else</span> {
00267                 u1 = 4.f * (1.f - u1);
00268                 <a class="code" href="classAnisotropic.html#a4">sampleFirstQuadrant</a>(u1, u2, &amp;phi, &amp;costheta);
00269                 phi = 2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> - phi;
00270         }
00271         <span class="keywordtype">float</span> sintheta = sqrtf(max(0.f, 1.f - costheta*costheta));
00272         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#a25">SphericalDirection</a>(sintheta, costheta, phi);
00273         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, H) &lt; 0.f) H = -H;
00274         <span class="comment">// Compute incident direction by reflecting about $\wh$</span>
00275         *wi = -wo + 2.f * <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, H) * H;
00276         <span class="comment">// Compute PDF for \wi from Anisotropic distribution</span>
00277         <span class="keywordtype">float</span> anisotropic_pdf = <a class="code" href="classAnisotropic.html#a1">D</a>(H) / (4.f * <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, H));
00278         *pdf = anisotropic_pdf;
00279 }
<a name="l00280"></a><a class="code" href="classAnisotropic.html#a4">00280</a> <span class="keywordtype">void</span> <a class="code" href="classAnisotropic.html#a4">Anisotropic::sampleFirstQuadrant</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
00281                 <span class="keywordtype">float</span> *phi, <span class="keywordtype">float</span> *costheta)<span class="keyword"> const </span>{
00282         <span class="keywordflow">if</span> (<a class="code" href="classAnisotropic.html#r0">ex</a> == <a class="code" href="classAnisotropic.html#r1">ey</a>)
00283                 *phi = <a class="code" href="pbrt_8h.html#a6">M_PI</a> * u1 * 0.5f;
00284         <span class="keywordflow">else</span>
00285                 *phi = atanf(sqrtf((<a class="code" href="classAnisotropic.html#r0">ex</a>+1)/(<a class="code" href="classAnisotropic.html#r1">ey</a>+1)) *
00286                         tanf(<a class="code" href="pbrt_8h.html#a6">M_PI</a> * u1 * 0.5f));
00287         <span class="keywordtype">float</span> cosphi = cosf(*phi), sinphi = sinf(*phi);
00288         *costheta = powf(u2, 1.f/(<a class="code" href="classAnisotropic.html#r0">ex</a> * cosphi * cosphi +
00289                 ey * sinphi * sinphi + 1));
00290 }
<a name="l00291"></a><a class="code" href="classAnisotropic.html#a3">00291</a> <span class="keywordtype">float</span> <a class="code" href="classAnisotropic.html#a3">Anisotropic::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00292                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00293         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#a14">Normalize</a>(wo + wi);
00294         <span class="comment">// Compute PDF for \wi from Anisotropic distribution</span>
00295         <span class="keywordtype">float</span> anisotropic_pdf = <a class="code" href="classAnisotropic.html#a1">D</a>(H) / (4.f * <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, H));
00296         <span class="keywordflow">return</span> anisotropic_pdf;
00297 }
<a name="l00298"></a><a class="code" href="classLafortune.html#a2">00298</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classLafortune.html#a2">Lafortune::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
00299                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00300         <a class="code" href="pbrt_8h.html#a51">u_int</a> comp = <a class="code" href="pbrt_8h.html#a109">RandomUInt</a>() % (<a class="code" href="classLafortune.html#r1">nLobes</a>+1);
00301         <span class="keywordflow">if</span> (comp == <a class="code" href="classLafortune.html#r1">nLobes</a>) {
00302                 <span class="comment">// Cosine-sample the hemisphere, flipping the direction if necessary</span>
00303                 *wi = <a class="code" href="mc_8h.html#a9">CosineSampleHemisphere</a>(u1, u2);
00304                 <span class="keywordflow">if</span> (wo.<a class="code" href="classVector.html#o2">z</a> &lt; 0.) wi-&gt;<a class="code" href="classVector.html#o2">z</a> *= -1.f;
00305         }
00306         <span class="keywordflow">else</span> {
00307                 <span class="comment">// Sample lobe _comp_ for Lafortune BRDF</span>
00308                 <span class="keywordtype">float</span> xlum = <a class="code" href="classLafortune.html#r2">x</a>[comp].<a class="code" href="classSpectrum.html#a23">y</a>();
00309                 <span class="keywordtype">float</span> ylum = <a class="code" href="classLafortune.html#r3">y</a>[comp].<a class="code" href="classSpectrum.html#a23">y</a>();
00310                 <span class="keywordtype">float</span> zlum = <a class="code" href="classLafortune.html#r4">z</a>[comp].<a class="code" href="classSpectrum.html#a23">y</a>();
00311                 <span class="keywordtype">float</span> costheta = powf(u1, 1.<a class="code" href="classLafortune.html#a1">f</a> / (.8<a class="code" href="classLafortune.html#a1">f</a> * <a class="code" href="classLafortune.html#r5">exponent</a>[comp].y() + 1));
00312                 <span class="keywordtype">float</span> sintheta = sqrtf(max(0.<a class="code" href="classLafortune.html#a1">f</a>, 1.<a class="code" href="classLafortune.html#a1">f</a> - costheta*costheta));
00313                 <span class="keywordtype">float</span> phi = u2 * 2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00314                 <a class="code" href="classVector.html">Vector</a> lobeCenter = <a class="code" href="geometry_8h.html#a14">Normalize</a>(<a class="code" href="classVector.html">Vector</a>(xlum * wo.<a class="code" href="classVector.html#o0">x</a>, ylum * wo.<a class="code" href="classVector.html#o1">y</a>, zlum * wo.<a class="code" href="classVector.html#o2">z</a>));
00315                 <a class="code" href="classVector.html">Vector</a> lobeX, lobeY;
00316                 <a class="code" href="geometry_8h.html#a8">CoordinateSystem</a>(lobeCenter, &amp;lobeX, &amp;lobeY);
00317                 *wi = <a class="code" href="geometry_8h.html#a25">SphericalDirection</a>(sintheta, costheta, phi, lobeX, lobeY,
00318                         lobeCenter);
00319         }
00320         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#a16">SameHemisphere</a>(wo, *wi)) <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.<a class="code" href="classLafortune.html#a1">f</a>);
00321         *pdf = <a class="code" href="classLafortune.html#a3">Pdf</a>(wo, *wi);
00322         <span class="keywordflow">return</span> <a class="code" href="classLafortune.html#a1">f</a>(wo, *wi);
00323 }
<a name="l00324"></a><a class="code" href="classLafortune.html#a3">00324</a> <span class="keywordtype">float</span> <a class="code" href="classLafortune.html#a3">Lafortune::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00325         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#a16">SameHemisphere</a>(wo, wi)) <span class="keywordflow">return</span> 0.f;
00326         <span class="keywordtype">float</span> pdfSum = fabsf(wi.<a class="code" href="classVector.html#o2">z</a>) * <a class="code" href="pbrt_8h.html#a7">INV_PI</a>;
00327         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classLafortune.html#r1">nLobes</a>; ++i) {
00328                 <span class="keywordtype">float</span> xlum = <a class="code" href="classLafortune.html#r2">x</a>[i].<a class="code" href="classSpectrum.html#a23">y</a>();
00329                 <span class="keywordtype">float</span> ylum = <a class="code" href="classLafortune.html#r3">y</a>[i].<a class="code" href="classSpectrum.html#a23">y</a>();
00330                 <span class="keywordtype">float</span> zlum = <a class="code" href="classLafortune.html#r4">z</a>[i].<a class="code" href="classSpectrum.html#a23">y</a>();
00331                 <a class="code" href="classVector.html">Vector</a> lobeCenter =
00332                         <a class="code" href="geometry_8h.html#a14">Normalize</a>(<a class="code" href="classVector.html">Vector</a>(wo.<a class="code" href="classVector.html#o0">x</a> * xlum, wo.<a class="code" href="classVector.html#o1">y</a> * ylum, wo.<a class="code" href="classVector.html#o2">z</a> * zlum));
00333                 <span class="keywordtype">float</span> e = .8f * <a class="code" href="classLafortune.html#r5">exponent</a>[i].<a class="code" href="classSpectrum.html#a23">y</a>();
00334                 pdfSum += (e + 1.f) * powf(max(0.<a class="code" href="classLafortune.html#a1">f</a>, <a class="code" href="geometry_8h.html#a17">Dot</a>(wi, lobeCenter)), e);
00335         }
00336         <span class="keywordflow">return</span> pdfSum / (1.f + nLobes);
00337 }
<a name="l00338"></a><a class="code" href="classFresnelBlend.html#a3">00338</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classFresnelBlend.html#a3">FresnelBlend::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00339                 <a class="code" href="classVector.html">Vector</a> *wi, <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00340         <span class="keywordflow">if</span> (u1 &lt; .5) {
00341                 u1 = 2.f * u1;
00342                 <span class="comment">// Cosine-sample the hemisphere, flipping the direction if necessary</span>
00343                 *wi = <a class="code" href="mc_8h.html#a9">CosineSampleHemisphere</a>(u1, u2);
00344                 <span class="keywordflow">if</span> (wo.<a class="code" href="classVector.html#o2">z</a> &lt; 0.) wi-&gt;<a class="code" href="classVector.html#o2">z</a> *= -1.f;
00345         }
00346         <span class="keywordflow">else</span> {
00347                 u1 = 2.f * (u1 - .5f);
00348                 <a class="code" href="classFresnelBlend.html#r2">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#a2">Sample_f</a>(wo, wi, u1, u2, pdf);
00349                 <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#a16">SameHemisphere</a>(wo, *wi)) <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.<a class="code" href="classFresnelBlend.html#a1">f</a>);
00350         }
00351         *pdf = <a class="code" href="classFresnelBlend.html#a4">Pdf</a>(wo, *wi);
00352         <span class="keywordflow">return</span> <a class="code" href="classFresnelBlend.html#a1">f</a>(wo, *wi);
00353 }
<a name="l00354"></a><a class="code" href="classFresnelBlend.html#a4">00354</a> <span class="keywordtype">float</span> <a class="code" href="classFresnelBlend.html#a4">FresnelBlend::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
00355                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00356         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#a16">SameHemisphere</a>(wo, wi)) <span class="keywordflow">return</span> 0.f;
00357         <span class="keywordflow">return</span> .5f * (fabsf(wi.<a class="code" href="classVector.html#o2">z</a>) * <a class="code" href="pbrt_8h.html#a7">INV_PI</a> +
00358                 <a class="code" href="classFresnelBlend.html#r2">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#a3">Pdf</a>(wo, wi));
00359 }
<a name="l00360"></a><a class="code" href="classBxDF.html#a5">00360</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#a5">BxDF::rho</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keywordtype">int</span> nSamples,
00361                 <span class="keywordtype">float</span> *samples)<span class="keyword"> const </span>{
00362         <span class="keywordflow">if</span> (!samples) {
00363                 samples =
00364                         (<span class="keywordtype">float</span> *)alloca(2 * nSamples * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00365                 <a class="code" href="sampling_8h.html#a3">LatinHypercube</a>(samples, nSamples, 2);
00366         }
00367         <a class="code" href="classSpectrum.html">Spectrum</a> r = 0.;
00368         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSamples; ++i) {
00369                 <span class="comment">// Estimate one term of $\rho_{dh}$</span>
00370                 <a class="code" href="classVector.html">Vector</a> wi;
00371                 <span class="keywordtype">float</span> pdf = 0.f;
00372                 <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#a3">f</a> =
00373                         <a class="code" href="classBxDF.html#a4">Sample_f</a>(w, &amp;wi, samples[2*i], samples[2*i+1], &amp;pdf);
00374                 <span class="keywordflow">if</span> (pdf &gt; 0.) r += f * fabsf(wi.<a class="code" href="classVector.html#o2">z</a>) / pdf;
00375         }
00376         <span class="keywordflow">return</span> r / nSamples;
00377 }
<a name="l00378"></a><a class="code" href="classBxDF.html#a6">00378</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#a5">BxDF::rho</a>(<span class="keywordtype">int</span> nSamples, <span class="keywordtype">float</span> *samples)<span class="keyword"> const </span>{
00379         <span class="keywordflow">if</span> (!samples) {
00380                 samples =
00381                         (<span class="keywordtype">float</span> *)alloca(4 * nSamples * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00382                 <a class="code" href="sampling_8h.html#a3">LatinHypercube</a>(samples, nSamples, 4);
00383         }
00384         <a class="code" href="classSpectrum.html">Spectrum</a> r = 0.;
00385         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSamples; ++i) {
00386                 <span class="comment">// Estimate one term of $\rho_{hh}$</span>
00387                 <a class="code" href="classVector.html">Vector</a> wo, wi;
00388                 wo = <a class="code" href="mc_8h.html#a1">UniformSampleHemisphere</a>(samples[4*i], samples[4*i+1]);
00389                 <span class="keywordtype">float</span> pdf_o = <a class="code" href="pbrt_8h.html#a8">INV_TWOPI</a>, pdf_i = 0.f;
00390                 <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#a3">f</a> =
00391                         <a class="code" href="classBxDF.html#a4">Sample_f</a>(wo, &amp;wi, samples[4*i+2], samples[4*i+3],
00392                                 &amp;pdf_i);
00393                 <span class="keywordflow">if</span> (pdf_i &gt; 0.)
00394                         r += f * fabsf(wi.<a class="code" href="classVector.html#o2">z</a> * wo.<a class="code" href="classVector.html#o2">z</a>) / (pdf_o * pdf_i);
00395         }
00396         <span class="keywordflow">return</span> r / (<a class="code" href="pbrt_8h.html#a6">M_PI</a>*nSamples);
00397 }
00398 <span class="comment">// BSDF Method Definitions</span>
<a name="l00399"></a><a class="code" href="classBSDF.html#a1">00399</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#a0">BSDF::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi, BxDFType flags,
00400         BxDFType *sampledType)<span class="keyword"> const </span>{
00401         <span class="keywordtype">float</span> pdf;
00402         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#a10">f</a> = <a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, wi, <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(), <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(),
00403                 <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(), &amp;pdf, flags, sampledType);
00404         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>() &amp;&amp; pdf &gt; 0.) f /= pdf;
00405         <span class="keywordflow">return</span> f;
00406 }
<a name="l00407"></a><a class="code" href="classBSDF.html#a0">00407</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#a0">BSDF::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;woW, <a class="code" href="classVector.html">Vector</a> *wiW,
00408                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> u3, <span class="keywordtype">float</span> *pdf,
00409                 BxDFType flags, BxDFType *sampledType)<span class="keyword"> const </span>{
00410         <span class="comment">// Choose which _BxDF_ to sample</span>
00411         <span class="keywordtype">int</span> matchingComps = <a class="code" href="classBSDF.html#a5">NumComponents</a>(flags);
00412         <span class="keywordflow">if</span> (matchingComps == 0) {
00413                 *pdf = 0.f;
00414                 <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.<a class="code" href="classBSDF.html#a10">f</a>);
00415         }
00416         <span class="keywordtype">int</span> which = min(<a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(u3 * matchingComps),
00417                 matchingComps-1);
00418         <a class="code" href="classBxDF.html">BxDF</a> *bxdf = NULL;
00419         <span class="keywordtype">int</span> count = which;
00420         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#r4">nBxDFs</a>; ++i)
00421                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a2">MatchesFlags</a>(flags))
00422                         <span class="keywordflow">if</span> (count-- == 0) {
00423                                 bxdf = <a class="code" href="classBSDF.html#r5">bxdfs</a>[i];
00424                                 <span class="keywordflow">break</span>;
00425                         }
00426         <a class="code" href="pbrt_8h.html#a14">Assert</a>(bxdf); <span class="comment">// NOBOOK</span>
00427         <span class="comment">// Sample chosen _BxDF_</span>
00428         <a class="code" href="classVector.html">Vector</a> wi;
00429         <a class="code" href="classVector.html">Vector</a> wo = <a class="code" href="classBSDF.html#a8">WorldToLocal</a>(woW);
00430         *pdf = 0.f;
00431         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#a10">f</a> = bxdf-&gt;<a class="code" href="classBxDF.html#a4">Sample_f</a>(wo, &amp;wi, u1, u2, pdf);
00432         <span class="keywordflow">if</span> (*pdf == 0.f) <span class="keywordflow">return</span> 0.f;
00433         <span class="keywordflow">if</span> (sampledType) *sampledType = bxdf-&gt;<a class="code" href="classBxDF.html#o0">type</a>;
00434         *wiW = <a class="code" href="classBSDF.html#a9">LocalToWorld</a>(wi);
00435         <span class="comment">// Compute overall PDF with all matching _BxDF_s</span>
00436         <span class="keywordflow">if</span> (!(bxdf-&gt;<a class="code" href="classBxDF.html#o0">type</a> &amp; <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>) &amp;&amp; matchingComps &gt; 1) {
00437                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nBxDFs; ++i) {
00438                         <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#r5">bxdfs</a>[i] != bxdf &amp;&amp;
00439                             <a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a2">MatchesFlags</a>(flags))
00440                                 *pdf += bxdfs[i]-&gt;Pdf(wo, wi);
00441                 }
00442         }
00443         <span class="keywordflow">if</span> (matchingComps &gt; 1) *pdf /= matchingComps;
00444         <span class="comment">// Compute value of BSDF for sampled direction</span>
00445         <span class="keywordflow">if</span> (!(bxdf-&gt;<a class="code" href="classBxDF.html#o0">type</a> &amp; <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>)) {
00446                 f = 0.;
00447                 <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(*wiW, <a class="code" href="classBSDF.html#r1">ng</a>) * <a class="code" href="geometry_8h.html#a17">Dot</a>(woW, <a class="code" href="classBSDF.html#r1">ng</a>) &gt; 0)
00448                         <span class="comment">// ignore BTDFs</span>
00449                         flags = <a class="code" href="reflection_8h.html#a17">BxDFType</a>(flags &amp; ~<a class="code" href="reflection_8h.html#a17a3">BSDF_TRANSMISSION</a>);
00450                 <span class="keywordflow">else</span>
00451                         <span class="comment">// ignore BRDFs</span>
00452                         flags = <a class="code" href="reflection_8h.html#a17">BxDFType</a>(flags &amp; ~<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a>);
00453                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nBxDFs; ++i)
00454                         <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a2">MatchesFlags</a>(flags))
00455                                 f += <a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a3">f</a>(wo, wi);
00456         }
00457         <span class="keywordflow">return</span> f;
00458 }
<a name="l00459"></a><a class="code" href="classBSDF.html#a2">00459</a> <span class="keywordtype">float</span> <a class="code" href="classBSDF.html#a2">BSDF::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;woW, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wiW,
00460                 BxDFType flags)<span class="keyword"> const </span>{
00461         <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#r4">nBxDFs</a> == 0.) <span class="keywordflow">return</span> 0.;
00462         <a class="code" href="classVector.html">Vector</a> wo = <a class="code" href="classBSDF.html#a8">WorldToLocal</a>(woW), wi = WorldToLocal(wiW);
00463         <span class="keywordtype">float</span> pdf = 0.f;
00464         <span class="keywordtype">int</span> matchingComps = 0;
00465         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#r4">nBxDFs</a>; ++i)
00466                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a2">MatchesFlags</a>(flags)) {
00467                         ++matchingComps;
00468                         pdf += <a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a7">Pdf</a>(wo, wi);
00469                 }
00470         <span class="keywordflow">return</span> matchingComps &gt; 0 ? pdf / matchingComps : 0.f;
00471 }
<a name="l00472"></a><a class="code" href="classBSDF.html#a3">00472</a> <a class="code" href="classBSDF.html#a3">BSDF::BSDF</a>(<span class="keyword">const</span> <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> &amp;dg,
00473            <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;ngeom, <span class="keywordtype">float</span> e)
00474         : dgShading(dg), eta(e) {
00475         <a class="code" href="classBSDF.html#r1">ng</a> = ngeom;
00476         <a class="code" href="classBSDF.html#r0">nn</a> = <a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00477         <a class="code" href="classBSDF.html#r2">sn</a> = <a class="code" href="geometry_8h.html#a14">Normalize</a>(<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o5">dpdu</a>);
00478         <a class="code" href="classBSDF.html#r3">tn</a> = <a class="code" href="geometry_8h.html#a6">Cross</a>(<a class="code" href="classBSDF.html#r0">nn</a>, <a class="code" href="classBSDF.html#r2">sn</a>);
00479         <a class="code" href="classBSDF.html#r4">nBxDFs</a> = 0;
00480 }
<a name="l00481"></a><a class="code" href="classBSDF.html#a10">00481</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#a10">BSDF::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;woW,
00482                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wiW, BxDFType flags)<span class="keyword"> const </span>{
00483         <a class="code" href="classVector.html">Vector</a> wi = <a class="code" href="classBSDF.html#a8">WorldToLocal</a>(wiW), wo = WorldToLocal(woW);
00484         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(wiW, <a class="code" href="classBSDF.html#r1">ng</a>) * <a class="code" href="geometry_8h.html#a17">Dot</a>(woW, <a class="code" href="classBSDF.html#r1">ng</a>) &gt; 0)
00485                 <span class="comment">// ignore BTDFs</span>
00486                 flags = <a class="code" href="reflection_8h.html#a17">BxDFType</a>(flags &amp; ~<a class="code" href="reflection_8h.html#a17a3">BSDF_TRANSMISSION</a>);
00487         <span class="keywordflow">else</span>
00488                 <span class="comment">// ignore BRDFs</span>
00489                 flags = <a class="code" href="reflection_8h.html#a17">BxDFType</a>(flags &amp; ~<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a>);
00490         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#a10">f</a> = 0.;
00491         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#r4">nBxDFs</a>; ++i)
00492                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a2">MatchesFlags</a>(flags))
00493                         f += <a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a3">f</a>(wo, wi);
00494         <span class="keywordflow">return</span> f;
00495 }
<a name="l00496"></a><a class="code" href="classBSDF.html#a11">00496</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#a11">BSDF::rho</a>(BxDFType flags)<span class="keyword"> const </span>{
00497         <a class="code" href="classSpectrum.html">Spectrum</a> ret(0.);
00498         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#r4">nBxDFs</a>; ++i)
00499                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a2">MatchesFlags</a>(flags))
00500                         ret += <a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a5">rho</a>();
00501         <span class="keywordflow">return</span> ret;
00502 }
<a name="l00503"></a><a class="code" href="classBSDF.html#a12">00503</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#a11">BSDF::rho</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, BxDFType flags)<span class="keyword"> const </span>{
00504         <a class="code" href="classSpectrum.html">Spectrum</a> ret(0.);
00505         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#r4">nBxDFs</a>; ++i)
00506                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a2">MatchesFlags</a>(flags))
00507                         ret += <a class="code" href="classBSDF.html#r5">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#a5">rho</a>(wo);
00508         <span class="keywordflow">return</span> ret;
00509 }
<a name="l00510"></a><a class="code" href="classBSDF.html#v0">00510</a> <a class="code" href="classMemoryArena.html">MemoryArena</a> <a class="code" href="classBSDF.html#v0">BSDF::arena</a>;
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:24 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
