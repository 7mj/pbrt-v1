<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: bestcandidate.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>bestcandidate.cpp</h1><a href="bestcandidate_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// bestcandidate.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="sampling_8h.html">sampling.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="film_8h.html">film.h</a>"</span>
00015 <span class="comment">// BestCandidate Sampling Constants</span>
<a name="l00016"></a><a class="code" href="bestcandidate_8cpp.html#a0">00016</a> <span class="preprocessor">#define SQRT_SAMPLE_TABLE_SIZE 64</span>
<a name="l00017"></a><a class="code" href="bestcandidate_8cpp.html#a1">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define SAMPLE_TABLE_SIZE (SQRT_SAMPLE_TABLE_SIZE * \</span>
00018 <span class="preprocessor">                           SQRT_SAMPLE_TABLE_SIZE)</span>
00019 <span class="preprocessor"></span><span class="comment">// BestCandidateSampler Declarations</span>
<a name="l00020"></a><a class="code" href="classBestCandidateSampler.html">00020</a> <span class="keyword">class </span><a class="code" href="classBestCandidateSampler.html">BestCandidateSampler</a> : <span class="keyword">public</span> <a class="code" href="classSampler.html">Sampler</a> {
00021 <span class="keyword">public</span>:
00022         <span class="comment">// BestCandidateSampler Public Methods</span>
00023         <a class="code" href="classBestCandidateSampler.html">BestCandidateSampler</a>(<span class="keywordtype">int</span> xstart, <span class="keywordtype">int</span> xend,
00024                              <span class="keywordtype">int</span> ystart, <span class="keywordtype">int</span> yend,
00025                                                  <span class="keywordtype">int</span> pixelsamples);
<a name="l00026"></a><a class="code" href="classBestCandidateSampler.html#a1">00026</a>         <a class="code" href="classBestCandidateSampler.html#a1">~BestCandidateSampler</a>() {
00027                 <span class="keyword">delete</span>[] <a class="code" href="classBestCandidateSampler.html#r6">strat2D</a>;
00028                 <span class="comment">// so we leak on the individual elements of these arrays.  so it goes...</span>
00029                 <span class="keyword">delete</span>[] <a class="code" href="classBestCandidateSampler.html#r4">oneDSamples</a>;
00030                 <span class="keyword">delete</span>[] <a class="code" href="classBestCandidateSampler.html#r5">twoDSamples</a>;
00031         }
<a name="l00032"></a><a class="code" href="classBestCandidateSampler.html#a2">00032</a>         <span class="keywordtype">int</span> <a class="code" href="classBestCandidateSampler.html#a2">RoundSize</a>(<span class="keywordtype">int</span> size)<span class="keyword"> const </span>{
00033                 <span class="keywordtype">int</span> root = <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a>(sqrtf((<span class="keywordtype">float</span>)size - .5f));
00034                 <span class="keywordflow">return</span> root*root;
00035         }
00036         <span class="keywordtype">bool</span> GetNextSample(<a class="code" href="structSample.html">Sample</a> *sample);
00037 <span class="keyword">private</span>:
00038         <span class="comment">// BestCandidateSampler Private Data</span>
<a name="l00039"></a><a class="code" href="classBestCandidateSampler.html#r0">00039</a>         <span class="keywordtype">int</span> <a class="code" href="classBestCandidateSampler.html#r0">tableOffset</a>;
<a name="l00040"></a><a class="code" href="classBestCandidateSampler.html#r2">00040</a>         <span class="keywordtype">float</span> <a class="code" href="classBestCandidateSampler.html#r1">xTableCorner</a>, <a class="code" href="classBestCandidateSampler.html#r2">yTableCorner</a>, <a class="code" href="classBestCandidateSampler.html#r3">tableWidth</a>;
00041         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="classBestCandidateSampler.html#v0">sampleTable</a>[<a class="code" href="core_2samplepat_8cpp.html#a1">SAMPLE_TABLE_SIZE</a>][5];
<a name="l00042"></a><a class="code" href="classBestCandidateSampler.html#r5">00042</a>         <span class="keywordtype">float</span> **<a class="code" href="classBestCandidateSampler.html#r4">oneDSamples</a>, **<a class="code" href="classBestCandidateSampler.html#r5">twoDSamples</a>;
<a name="l00043"></a><a class="code" href="classBestCandidateSampler.html#r6">00043</a>         <span class="keywordtype">int</span> *<a class="code" href="classBestCandidateSampler.html#r6">strat2D</a>;
<a name="l00044"></a><a class="code" href="classBestCandidateSampler.html#r7">00044</a>         <span class="keywordtype">float</span> <a class="code" href="classBestCandidateSampler.html#r7">sampleOffsets</a>[3];
00045 };
00046 <span class="comment">// BestCandidateSampler Method Definitions</span>
00047 BestCandidateSampler::
<a name="l00048"></a><a class="code" href="classBestCandidateSampler.html#a0">00048</a>     BestCandidateSampler(<span class="keywordtype">int</span> xstart, <span class="keywordtype">int</span> xend,
00049                                  <span class="keywordtype">int</span> ystart, <span class="keywordtype">int</span> yend,
00050                                                  <span class="keywordtype">int</span> pixelSamples)
00051         : <a class="code" href="classSampler.html">Sampler</a>(xstart, xend, ystart, yend, pixelSamples) {
00052         <a class="code" href="classBestCandidateSampler.html#r3">tableWidth</a> =
00053                 (<span class="keywordtype">float</span>)<a class="code" href="core_2samplepat_8cpp.html#a0">SQRT_SAMPLE_TABLE_SIZE</a> / sqrtf(pixelSamples);
00054         <a class="code" href="classBestCandidateSampler.html#r1">xTableCorner</a> = float(xPixelStart) - <a class="code" href="classBestCandidateSampler.html#r3">tableWidth</a>;
00055         <a class="code" href="classBestCandidateSampler.html#r2">yTableCorner</a> = float(yPixelStart);
00056         <a class="code" href="classBestCandidateSampler.html#r0">tableOffset</a> = <a class="code" href="core_2samplepat_8cpp.html#a1">SAMPLE_TABLE_SIZE</a>;
00057         <span class="comment">// _BestCandidateSampler_ constructor implementation</span>
00058         <a class="code" href="classBestCandidateSampler.html#r4">oneDSamples</a> = <a class="code" href="classBestCandidateSampler.html#r5">twoDSamples</a> = NULL;
00059         <a class="code" href="classBestCandidateSampler.html#r6">strat2D</a> = NULL;
00060 }
00061 <span class="preprocessor">#include "<a class="code" href="sampledata_8cpp.html">samplers/sampledata.cpp</a>"</span>
<a name="l00062"></a><a class="code" href="classBestCandidateSampler.html#a3">00062</a> <span class="keywordtype">bool</span> <a class="code" href="classBestCandidateSampler.html#a3">BestCandidateSampler::GetNextSample</a>(<a class="code" href="structSample.html">Sample</a> *sample) {
00063 again:
00064         <span class="keywordflow">if</span> (<a class="code" href="classBestCandidateSampler.html#r0">tableOffset</a> == <a class="code" href="core_2samplepat_8cpp.html#a1">SAMPLE_TABLE_SIZE</a>) {
00065                 <span class="comment">// Advance to next best-candidate sample table position</span>
00066                 <a class="code" href="classBestCandidateSampler.html#r0">tableOffset</a> = 0;
00067                 <a class="code" href="classBestCandidateSampler.html#r1">xTableCorner</a> += <a class="code" href="classBestCandidateSampler.html#r3">tableWidth</a>;
00068                 <span class="keywordflow">if</span> (<a class="code" href="classBestCandidateSampler.html#r1">xTableCorner</a> &gt;= xPixelEnd) {
00069                         <a class="code" href="classBestCandidateSampler.html#r1">xTableCorner</a> = float(xPixelStart);
00070                         <a class="code" href="classBestCandidateSampler.html#r2">yTableCorner</a> += tableWidth;
00071                         <span class="keywordflow">if</span> (<a class="code" href="classBestCandidateSampler.html#r2">yTableCorner</a> &gt;= yPixelEnd)
00072                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00073                 }
00074                 <span class="keywordflow">if</span> (!<a class="code" href="classBestCandidateSampler.html#r4">oneDSamples</a>) {
00075                         <span class="comment">// Initialize sample tables and precompute _strat2D_ values</span>
00076                         <a class="code" href="classBestCandidateSampler.html#r4">oneDSamples</a> = <span class="keyword">new</span> <span class="keywordtype">float</span> *[sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size()];
00077                         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size(); ++i) {
00078                                 <a class="code" href="classBestCandidateSampler.html#r4">oneDSamples</a>[i] = (sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>[i] == 1) ?
00079                                         <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="core_2samplepat_8cpp.html#a1">SAMPLE_TABLE_SIZE</a>] : NULL;
00080                         }
00081                         <a class="code" href="classBestCandidateSampler.html#r5">twoDSamples</a> = <span class="keyword">new</span> <span class="keywordtype">float</span> *[sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size()];
00082                         <a class="code" href="classBestCandidateSampler.html#r6">strat2D</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size()];
00083                         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size(); ++i) {
00084                                 <a class="code" href="classBestCandidateSampler.html#r5">twoDSamples</a>[i] = (sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>[i] == 1) ?
00085                                         <span class="keyword">new</span> <span class="keywordtype">float</span>[2 * <a class="code" href="core_2samplepat_8cpp.html#a1">SAMPLE_TABLE_SIZE</a>] : NULL;
00086                                 <a class="code" href="classBestCandidateSampler.html#r6">strat2D</a>[i] =
00087                                         <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a>(sqrtf((<span class="keywordtype">float</span>)sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>[i] - .5f));
00088                         }
00089                 }
00090                 <span class="comment">// Update sample shifts</span>
00091                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 3; ++i)
00092                         <a class="code" href="classBestCandidateSampler.html#r7">sampleOffsets</a>[i] = <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>();
00093                 <span class="comment">// Generate _SAMPLE\_TABLE\_SIZE_-sized tables for single samples</span>
00094                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size(); ++i)
00095                         <span class="keywordflow">if</span> (sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>[i] == 1)
00096                                 <a class="code" href="sampling_8h.html#a10">LDShuffleScrambled1D</a>(<a class="code" href="core_2samplepat_8cpp.html#a1">SAMPLE_TABLE_SIZE</a>, 1,
00097                                                      <a class="code" href="classBestCandidateSampler.html#r4">oneDSamples</a>[i]);
00098                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size(); ++i)
00099                         <span class="keywordflow">if</span> (sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>[i] == 1)
00100                                 <a class="code" href="sampling_8h.html#a11">LDShuffleScrambled2D</a>(<a class="code" href="core_2samplepat_8cpp.html#a1">SAMPLE_TABLE_SIZE</a>, 1,
00101                                                      <a class="code" href="classBestCandidateSampler.html#r5">twoDSamples</a>[i]);
00102         }
00103         <span class="comment">// Compute raster sample from table</span>
00104 <span class="preprocessor">        #define WRAP(x) ((x) &gt; 1 ? ((x)-1) : (x))</span>
00105 <span class="preprocessor"></span>        sample-&gt;<a class="code" href="structSample.html#o0">imageX</a> = <a class="code" href="classBestCandidateSampler.html#r1">xTableCorner</a> + <a class="code" href="classBestCandidateSampler.html#r3">tableWidth</a> *
00106                 <a class="code" href="classBestCandidateSampler.html#v0">sampleTable</a>[<a class="code" href="classBestCandidateSampler.html#r0">tableOffset</a>][0];
00107         sample-&gt;<a class="code" href="structSample.html#o1">imageY</a> = <a class="code" href="classBestCandidateSampler.html#r2">yTableCorner</a> + <a class="code" href="classBestCandidateSampler.html#r3">tableWidth</a> *
00108                 sampleTable[<a class="code" href="classBestCandidateSampler.html#r0">tableOffset</a>][1];
00109         sample-&gt;<a class="code" href="structSample.html#o4">time</a>  = <a class="code" href="bestcandidate_8cpp.html#a2">WRAP</a>(<a class="code" href="classBestCandidateSampler.html#r7">sampleOffsets</a>[0] +
00110                 sampleTable[<a class="code" href="classBestCandidateSampler.html#r0">tableOffset</a>][2]);
00111         sample-&gt;<a class="code" href="structSample.html#o2">lensU</a> = <a class="code" href="bestcandidate_8cpp.html#a2">WRAP</a>(<a class="code" href="classBestCandidateSampler.html#r7">sampleOffsets</a>[1] +
00112                 sampleTable[tableOffset][3]);
00113         sample-&gt;<a class="code" href="structSample.html#o3">lensV</a> = <a class="code" href="bestcandidate_8cpp.html#a2">WRAP</a>(<a class="code" href="classBestCandidateSampler.html#r7">sampleOffsets</a>[2] +
00114                 sampleTable[tableOffset][4]);
00115         <span class="comment">// Check sample against crop window, goto _again_ if outside</span>
00116         <span class="keywordflow">if</span> (sample-&gt;<a class="code" href="structSample.html#o0">imageX</a> &lt;  xPixelStart ||
00117             sample-&gt;<a class="code" href="structSample.html#o0">imageX</a> &gt;= xPixelEnd   ||
00118             sample-&gt;<a class="code" href="structSample.html#o1">imageY</a> &lt;  yPixelStart ||
00119             sample-&gt;<a class="code" href="structSample.html#o1">imageY</a> &gt;= yPixelEnd) {
00120                 ++tableOffset;
00121                 <span class="keywordflow">goto</span> again;
00122         }
00123         <span class="comment">// Compute integrator samples for best-candidate sample</span>
00124         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size(); ++i) {
00125                 <span class="keywordflow">if</span> (sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>[i] == 1)
00126                         sample-&gt;<a class="code" href="structSample.html#o7">oneD</a>[i][0] = <a class="code" href="classBestCandidateSampler.html#r4">oneDSamples</a>[i][tableOffset];
00127                 <span class="keywordflow">else</span>
00128                         <a class="code" href="sampling_8h.html#a0">StratifiedSample1D</a>(sample-&gt;<a class="code" href="structSample.html#o7">oneD</a>[i], sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>[i]);
00129         }
00130         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size(); ++i) {
00131                 <span class="keywordflow">if</span> (sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>[i] == 1) {
00132                    sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[i][0] = <a class="code" href="classBestCandidateSampler.html#r5">twoDSamples</a>[i][2*tableOffset];
00133                    sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[i][1] = <a class="code" href="classBestCandidateSampler.html#r5">twoDSamples</a>[i][2*tableOffset+1];
00134                 }
00135                 <span class="keywordflow">else</span> {
00136                         <a class="code" href="sampling_8h.html#a1">StratifiedSample2D</a>(sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[i],
00137                                            <a class="code" href="classBestCandidateSampler.html#r6">strat2D</a>[i],
00138                                                            <a class="code" href="classBestCandidateSampler.html#r6">strat2D</a>[i]);
00139                 }
00140         }
00141         ++tableOffset;
00142         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00143 }
<a name="l00144"></a><a class="code" href="bestcandidate_8cpp.html#a3">00144</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classSampler.html">Sampler</a> *<a class="code" href="stratified_8cpp.html#a0">CreateSampler</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params, <span class="keyword">const</span> <a class="code" href="classFilm.html">Film</a> *film) {
00145         <span class="comment">// Initialize common sampler parameters</span>
00146         <span class="keywordtype">int</span> xstart, xend, ystart, yend;
00147         film-&gt;<a class="code" href="classFilm.html#a4">GetSampleExtent</a>(&amp;xstart, &amp;xend, &amp;ystart, &amp;yend);
00148         <span class="keywordtype">int</span> nsamp = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"pixelsamples"</span>, 4);
00149         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classBestCandidateSampler.html">BestCandidateSampler</a>(xstart, xend, ystart, yend, nsamp);
00150 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:19 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
