<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: directlighting.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>directlighting.cpp</h1><a href="directlighting_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// directlighting.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="transport_8h.html">transport.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="scene_8h.html">scene.h</a>"</span>
00015 <span class="comment">// DirectLighting Declarations</span>
<a name="l00016"></a><a class="code" href="directlighting_8cpp.html#a4">00016</a> <span class="keyword">enum</span> <a class="code" href="directlighting_8cpp.html#a4">LightStrategy</a> { <a class="code" href="directlighting_8cpp.html#a4a0">SAMPLE_ALL_UNIFORM</a>, <a class="code" href="directlighting_8cpp.html#a4a1">SAMPLE_ONE_UNIFORM</a>,
00017         <a class="code" href="directlighting_8cpp.html#a4a2">SAMPLE_ONE_WEIGHTED</a>  <span class="comment">// NOBOOK</span>
00018 };
<a name="l00019"></a><a class="code" href="classDirectLighting.html">00019</a> <span class="keyword">class </span><a class="code" href="classDirectLighting.html">DirectLighting</a> : <span class="keyword">public</span> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> {
00020 <span class="keyword">public</span>:
00021         <span class="comment">// DirectLighting Public Methods</span>
00022         <a class="code" href="classDirectLighting.html">DirectLighting</a>(<a class="code" href="directlighting_8cpp.html#a4">LightStrategy</a> ls, <span class="keywordtype">int</span> md);
00023         <a class="code" href="classDirectLighting.html#a1">~DirectLighting</a>();
00024         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classDirectLighting.html#a2">Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray, <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample,
00025                 <span class="keywordtype">float</span> *alpha) <span class="keyword">const</span>;
<a name="l00026"></a><a class="code" href="classDirectLighting.html#a3">00026</a>         <span class="keywordtype">void</span> <a class="code" href="classDirectLighting.html#a3">RequestSamples</a>(<a class="code" href="structSample.html">Sample</a> *sample, <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene) {
00027                 <span class="keywordflow">if</span> (<a class="code" href="classDirectLighting.html#r0">strategy</a> == <a class="code" href="directlighting_8cpp.html#a4a0">SAMPLE_ALL_UNIFORM</a>) {
00028                         <span class="comment">// Allocate and request samples for sampling all lights</span>
00029                         <a class="code" href="pbrt_8h.html#a51">u_int</a> nLights = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size();
00030                         <a class="code" href="classDirectLighting.html#r3">lightSampleOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00031                         <a class="code" href="classDirectLighting.html#r5">bsdfSampleOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00032                         <a class="code" href="classDirectLighting.html#r6">bsdfComponentOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00033                         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; nLights; ++i) {
00034                                 <span class="keyword">const</span> <a class="code" href="classLight.html">Light</a> *light = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i];
00035                                 <span class="keywordtype">int</span> lightSamples =
00036                                         scene-&gt;<a class="code" href="classScene.html#o6">sampler</a>-&gt;<a class="code" href="classSampler.html#a4">RoundSize</a>(light-&gt;<a class="code" href="classLight.html#o0">nSamples</a>);
00037                                 <a class="code" href="classDirectLighting.html#r3">lightSampleOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(lightSamples);
00038                                 <a class="code" href="classDirectLighting.html#r5">bsdfSampleOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(lightSamples);
00039                                 <a class="code" href="classDirectLighting.html#r6">bsdfComponentOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(lightSamples);
00040                         }
00041                         <a class="code" href="classDirectLighting.html#r4">lightNumOffset</a> = -1;
00042                 }
00043                 <span class="keywordflow">else</span> {
00044                         <span class="comment">// Allocate and request samples for sampling one light</span>
00045                         <a class="code" href="classDirectLighting.html#r3">lightSampleOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[1];
00046                         <a class="code" href="classDirectLighting.html#r3">lightSampleOffset</a>[0] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00047                         <a class="code" href="classDirectLighting.html#r4">lightNumOffset</a> = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(1);
00048                         <a class="code" href="classDirectLighting.html#r5">bsdfSampleOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[1];
00049                         <a class="code" href="classDirectLighting.html#r5">bsdfSampleOffset</a>[0] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00050                         <a class="code" href="classDirectLighting.html#r6">bsdfComponentOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[1];
00051                         <a class="code" href="classDirectLighting.html#r6">bsdfComponentOffset</a>[0] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00052                 }
00053         }
00054 <span class="keyword">private</span>:
00055         <span class="comment">// DirectLighting Private Data</span>
<a name="l00056"></a><a class="code" href="classDirectLighting.html#r0">00056</a>         <a class="code" href="directlighting_8cpp.html#a4">LightStrategy</a> <a class="code" href="classDirectLighting.html#r0">strategy</a>;
<a name="l00057"></a><a class="code" href="classDirectLighting.html#r1">00057</a>         <span class="keyword">mutable</span> <span class="keywordtype">int</span> <a class="code" href="classDirectLighting.html#r1">rayDepth</a>; <span class="comment">// NOBOOK</span>
<a name="l00058"></a><a class="code" href="classDirectLighting.html#r2">00058</a>         <span class="keywordtype">int</span> <a class="code" href="classDirectLighting.html#r2">maxDepth</a>; <span class="comment">// NOBOOK</span>
00059         <span class="comment">// Declare sample parameters for light source sampling</span>
<a name="l00060"></a><a class="code" href="classDirectLighting.html#r3">00060</a>         <span class="keywordtype">int</span> *<a class="code" href="classDirectLighting.html#r3">lightSampleOffset</a>, <a class="code" href="classDirectLighting.html#r4">lightNumOffset</a>;
<a name="l00061"></a><a class="code" href="classDirectLighting.html#r5">00061</a>         <span class="keywordtype">int</span> *<a class="code" href="classDirectLighting.html#r5">bsdfSampleOffset</a>, *<a class="code" href="classDirectLighting.html#r6">bsdfComponentOffset</a>;
<a name="l00062"></a><a class="code" href="classDirectLighting.html#r9">00062</a>         <span class="keyword">mutable</span> <span class="keywordtype">float</span> *<a class="code" href="classDirectLighting.html#r7">avgY</a>, *<a class="code" href="classDirectLighting.html#r8">avgYsample</a>, *<a class="code" href="classDirectLighting.html#r9">cdf</a>;
<a name="l00063"></a><a class="code" href="classDirectLighting.html#r10">00063</a>         <span class="keyword">mutable</span> <span class="keywordtype">float</span> <a class="code" href="classDirectLighting.html#r10">overallAvgY</a>;
00064 };
00065 <span class="comment">// DirectLighting Method Definitions</span>
<a name="l00066"></a><a class="code" href="classDirectLighting.html#a1">00066</a> <a class="code" href="classDirectLighting.html#a1">DirectLighting::~DirectLighting</a>() {
00067         <span class="keyword">delete</span>[] <a class="code" href="classDirectLighting.html#r7">avgY</a>;
00068         <span class="keyword">delete</span>[] <a class="code" href="classDirectLighting.html#r8">avgYsample</a>;
00069         <span class="keyword">delete</span>[] <a class="code" href="classDirectLighting.html#r9">cdf</a>;
00070 }
<a name="l00071"></a><a class="code" href="classDirectLighting.html#a0">00071</a> <a class="code" href="classDirectLighting.html#a0">DirectLighting::DirectLighting</a>(LightStrategy st, <span class="keywordtype">int</span> md) {
00072         <a class="code" href="classDirectLighting.html#r2">maxDepth</a> = md;
00073         <a class="code" href="classDirectLighting.html#r1">rayDepth</a> = 0;
00074         <a class="code" href="classDirectLighting.html#r0">strategy</a> = st;
00075         <a class="code" href="classDirectLighting.html#r7">avgY</a> = <a class="code" href="classDirectLighting.html#r8">avgYsample</a> = <a class="code" href="classDirectLighting.html#r9">cdf</a> = NULL;
00076         <a class="code" href="classDirectLighting.html#r10">overallAvgY</a> = 0.;
00077 }
<a name="l00078"></a><a class="code" href="classDirectLighting.html#a2">00078</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classDirectLighting.html#a2">DirectLighting::Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene,
00079                 <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray, <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample,
00080                 <span class="keywordtype">float</span> *alpha)<span class="keyword"> const </span>{
00081         <a class="code" href="structIntersection.html">Intersection</a> isect;
00082         <a class="code" href="classSpectrum.html">Spectrum</a> L(0.);
00083         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="classScene.html#a3">Intersect</a>(ray, &amp;isect)) {
00084                 <span class="keywordflow">if</span> (alpha) *alpha = 1.;
00085                 <span class="comment">// Evaluate BSDF at hit point</span>
00086                 <a class="code" href="classBSDF.html">BSDF</a> *bsdf = isect.<a class="code" href="structIntersection.html#a1">GetBSDF</a>(ray);
00087                 <a class="code" href="classVector.html">Vector</a> wo = -ray.<a class="code" href="classRay.html#o1">d</a>;
00088                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o0">p</a>;
00089                 <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00090                 <span class="comment">// Compute emitted light if ray hit an area light source</span>
00091                 L += isect.<a class="code" href="structIntersection.html#a2">Le</a>(wo);
00092                 <span class="comment">// Compute direct lighting for _DirectLighting_ integrator</span>
00093                 <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size() &gt; 0) {
00094                         <span class="comment">// Apply direct lighting strategy</span>
00095                         <span class="keywordflow">switch</span> (<a class="code" href="classDirectLighting.html#r0">strategy</a>) {
00096                                 <span class="keywordflow">case</span> <a class="code" href="directlighting_8cpp.html#a4a0">SAMPLE_ALL_UNIFORM</a>:
00097                                         L += <a class="code" href="transport_8h.html#a0">UniformSampleAllLights</a>(scene, p, n, wo, bsdf,
00098                                                 sample, <a class="code" href="classDirectLighting.html#r3">lightSampleOffset</a>, <a class="code" href="classDirectLighting.html#r5">bsdfSampleOffset</a>,
00099                                                 <a class="code" href="classDirectLighting.html#r6">bsdfComponentOffset</a>);
00100                                         <span class="keywordflow">break</span>;
00101                                 <span class="keywordflow">case</span> <a class="code" href="directlighting_8cpp.html#a4a1">SAMPLE_ONE_UNIFORM</a>:
00102                                         L += <a class="code" href="transport_8h.html#a1">UniformSampleOneLight</a>(scene, p, n, wo, bsdf,
00103                                                 sample, <a class="code" href="classDirectLighting.html#r3">lightSampleOffset</a>[0], <a class="code" href="classDirectLighting.html#r4">lightNumOffset</a>,
00104                                                 <a class="code" href="classDirectLighting.html#r5">bsdfSampleOffset</a>[0], <a class="code" href="classDirectLighting.html#r6">bsdfComponentOffset</a>[0]);
00105                                         <span class="keywordflow">break</span>;
00106                                 <span class="keywordflow">case</span> <a class="code" href="directlighting_8cpp.html#a4a2">SAMPLE_ONE_WEIGHTED</a>:
00107                                         L += <a class="code" href="transport_8h.html#a2">WeightedSampleOneLight</a>(scene, p, n, wo, bsdf,
00108                                                 sample, <a class="code" href="classDirectLighting.html#r3">lightSampleOffset</a>[0], <a class="code" href="classDirectLighting.html#r4">lightNumOffset</a>,
00109                                                 <a class="code" href="classDirectLighting.html#r5">bsdfSampleOffset</a>[0], <a class="code" href="classDirectLighting.html#r6">bsdfComponentOffset</a>[0], <a class="code" href="classDirectLighting.html#r7">avgY</a>,
00110                                                 <a class="code" href="classDirectLighting.html#r8">avgYsample</a>, <a class="code" href="classDirectLighting.html#r9">cdf</a>, <a class="code" href="classDirectLighting.html#r10">overallAvgY</a>);
00111                                         <span class="keywordflow">break</span>;
00112                         }
00113                 }
00114                 <span class="keywordflow">if</span> (<a class="code" href="classDirectLighting.html#r1">rayDepth</a>++ &lt; <a class="code" href="classDirectLighting.html#r2">maxDepth</a>) {
00115                         <a class="code" href="classVector.html">Vector</a> wi;
00116                         <span class="comment">// Trace rays for specular reflection and refraction</span>
00117                         <a class="code" href="classSpectrum.html">Spectrum</a> f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi,
00118                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a> | <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>));
00119                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00120                                 <span class="comment">// Compute ray differential _rd_ for specular reflection</span>
00121                                 <a class="code" href="classRayDifferential.html">RayDifferential</a> rd(p, wi);
00122                                 rd.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00123                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o9">dpdx</a>;
00124                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o10">dpdy</a>;
00125                                 <span class="comment">// Compute differential reflected directions</span>
00126                                 <a class="code" href="classNormal.html">Normal</a> dndx = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o11">dudx</a> +
00127                                         bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o12">dvdx</a>;
00128                                 <a class="code" href="classNormal.html">Normal</a> dndy = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o13">dudy</a> +
00129                                         bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o14">dvdy</a>;
00130                                 <a class="code" href="classVector.html">Vector</a> dwodx = -ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> - wo, dwody = -ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> - wo;
00131                                 <span class="keywordtype">float</span> dDNdx = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwodx, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndx);
00132                                 <span class="keywordtype">float</span> dDNdy = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwody, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndy);
00133                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> = wi -
00134                                           dwodx + 2 * <a class="code" href="classVector.html">Vector</a>(<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) * dndx +
00135                                                   dDNdx * n);
00136                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> = wi -
00137                                           dwody + 2 * Vector(<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) * dndy +
00138                                                   dDNdy * n);
00139                                 L += scene-&gt;<a class="code" href="classScene.html#a6">Li</a>(rd, sample) * f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n);
00140                         }
00141                         f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi,
00142                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a3">BSDF_TRANSMISSION</a> | <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>));
00143                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00144                                 <span class="comment">// Compute ray differential _rd_ for specular transmission</span>
00145                                 <a class="code" href="classRayDifferential.html">RayDifferential</a> rd(p, wi);
00146                                 rd.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00147                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o9">dpdx</a>;
00148                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o10">dpdy</a>;
00149                                 
00150                                 <span class="keywordtype">float</span> eta = bsdf-&gt;<a class="code" href="classBSDF.html#o1">eta</a>;
00151                                 <a class="code" href="classVector.html">Vector</a> w = -wo;
00152                                 <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) &lt; 0) eta = 1.f / eta;
00153                                 
00154                                 <a class="code" href="classNormal.html">Normal</a> dndx = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o11">dudx</a> + bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o12">dvdx</a>;
00155                                 <a class="code" href="classNormal.html">Normal</a> dndy = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o13">dudy</a> + bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o14">dvdy</a>;
00156                                 
00157                                 <a class="code" href="classVector.html">Vector</a> dwodx = -ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> - wo, dwody = -ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> - wo;
00158                                 <span class="keywordtype">float</span> dDNdx = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwodx, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndx);
00159                                 <span class="keywordtype">float</span> dDNdy = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwody, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndy);
00160                                 
00161                                 <span class="keywordtype">float</span> mu = eta * <a class="code" href="geometry_8h.html#a17">Dot</a>(w, n) - <a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n);
00162                                 <span class="keywordtype">float</span> dmudx = (eta - (eta*eta*<a class="code" href="geometry_8h.html#a17">Dot</a>(w,n))/<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n)) * dDNdx;
00163                                 <span class="keywordtype">float</span> dmudy = (eta - (eta*eta*<a class="code" href="geometry_8h.html#a17">Dot</a>(w,n))/<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n)) * dDNdy;
00164                                 
00165                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> = wi + eta * dwodx - <a class="code" href="classVector.html">Vector</a>(mu * dndx + dmudx * n);
00166                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> = wi + eta * dwody - Vector(mu * dndy + dmudy * n);
00167                                 L += scene-&gt;<a class="code" href="classScene.html#a6">Li</a>(rd, sample) * f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n);
00168                         }
00169                 }
00170                 --<a class="code" href="classDirectLighting.html#r1">rayDepth</a>;
00171         }
00172         <span class="keywordflow">else</span> {
00173                 <span class="comment">// Handle ray with no intersection</span>
00174                 <span class="keywordflow">if</span> (alpha) *alpha = 0.;
00175                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size(); ++i)
00176                         L += scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i]-&gt;Le(ray);
00177                 <span class="keywordflow">if</span> (alpha &amp;&amp; !L.<a class="code" href="classSpectrum.html#a15">Black</a>()) *alpha = 1.;
00178                 <span class="keywordflow">return</span> L;
00179         }
00180         <span class="keywordflow">return</span> L;
00181 }
<a name="l00182"></a><a class="code" href="directlighting_8cpp.html#a3">00182</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> *<a class="code" href="whitted_8cpp.html#a0">CreateSurfaceIntegrator</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params) {
00183         <span class="keywordtype">int</span> maxDepth = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"maxdepth"</span>, 5);
00184         <a class="code" href="directlighting_8cpp.html#a4">LightStrategy</a> strategy;
00185         string st = params.<a class="code" href="classParamSet.html#a28">FindOneString</a>(<span class="stringliteral">"strategy"</span>, <span class="stringliteral">"all"</span>);
00186         <span class="keywordflow">if</span> (st == <span class="stringliteral">"one"</span>) strategy = <a class="code" href="directlighting_8cpp.html#a4a1">SAMPLE_ONE_UNIFORM</a>;
00187         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (st == <span class="stringliteral">"all"</span>) strategy = <a class="code" href="directlighting_8cpp.html#a4a0">SAMPLE_ALL_UNIFORM</a>;
00188         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (st == <span class="stringliteral">"weighted"</span>) strategy = <a class="code" href="directlighting_8cpp.html#a4a2">SAMPLE_ONE_WEIGHTED</a>;
00189         <span class="keywordflow">else</span> {
00190                 <a class="code" href="util_8cpp.html#a15">Warning</a>(<span class="stringliteral">"Strategy \"%s\" for direct lighting unknown. "</span>
00191                         <span class="stringliteral">"Using \"all\"."</span>, st.c_str());
00192                 strategy = <a class="code" href="directlighting_8cpp.html#a4a0">SAMPLE_ALL_UNIFORM</a>;
00193         }
00194         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classDirectLighting.html">DirectLighting</a>(strategy, maxDepth);
00195 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:20 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
