<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: shape.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>shape.h</h1><a href="shape_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#ifndef PBRT_SHAPE_H</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define PBRT_SHAPE_H</span>
00013 <span class="preprocessor"></span><span class="comment">// shape.h*</span>
00014 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="geometry_8h.html">geometry.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="transform_8h.html">transform.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
00018 <span class="comment">// DifferentialGeometry Declarations</span>
<a name="l00019"></a><a class="code" href="structDifferentialGeometry.html">00019</a> <span class="keyword">struct </span><a class="code" href="pbrt_8h.html#a1">COREDLL</a> DifferentialGeometry {
<a name="l00020"></a><a class="code" href="structDifferentialGeometry.html#a0">00020</a>         DifferentialGeometry() { u = v = 0.; shape = NULL; }
00021         <span class="comment">// DifferentialGeometry Public Methods</span>
00022         DifferentialGeometry(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;DPDU,
00023                         <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;DPDV, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;DNDU,
00024                         <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;DNDV, <span class="keywordtype">float</span> uu, <span class="keywordtype">float</span> vv,
00025                         <span class="keyword">const</span> <a class="code" href="classShape.html">Shape</a> *sh);
00026         <span class="keywordtype">void</span> ComputeDifferentials(<span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;r) <span class="keyword">const</span>;
00027         <span class="comment">// DifferentialGeometry Public Data</span>
<a name="l00028"></a><a class="code" href="structDifferentialGeometry.html#o0">00028</a>         <a class="code" href="classPoint.html">Point</a> p;
<a name="l00029"></a><a class="code" href="structDifferentialGeometry.html#o1">00029</a>         <a class="code" href="classNormal.html">Normal</a> nn;
<a name="l00030"></a><a class="code" href="structDifferentialGeometry.html#o3">00030</a>         <span class="keywordtype">float</span> u, v;
<a name="l00031"></a><a class="code" href="structDifferentialGeometry.html#o4">00031</a>         <span class="keyword">const</span> <a class="code" href="classShape.html">Shape</a> *shape;
<a name="l00032"></a><a class="code" href="structDifferentialGeometry.html#o6">00032</a>         <a class="code" href="classVector.html">Vector</a> dpdu, dpdv;
<a name="l00033"></a><a class="code" href="structDifferentialGeometry.html#o8">00033</a>         <a class="code" href="classNormal.html">Normal</a> dndu, dndv;
<a name="l00034"></a><a class="code" href="structDifferentialGeometry.html#o10">00034</a>         <span class="keyword">mutable</span> <a class="code" href="classVector.html">Vector</a> dpdx, dpdy;
<a name="l00035"></a><a class="code" href="structDifferentialGeometry.html#o14">00035</a>         <span class="keyword">mutable</span> <span class="keywordtype">float</span> dudx, dvdx, dudy, dvdy;
00036 };
00037 <span class="comment">// Shape Declarations</span>
<a name="l00038"></a><a class="code" href="classShape.html">00038</a> <span class="keyword">class </span><a class="code" href="pbrt_8h.html#a1">COREDLL</a> Shape : <span class="keyword">public</span> <a class="code" href="classReferenceCounted.html">ReferenceCounted</a> {
00039 <span class="keyword">public</span>:
00040         <span class="comment">// Shape Interface</span>
00041         Shape(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro);
<a name="l00042"></a><a class="code" href="classShape.html#a1">00042</a>         <span class="keyword">virtual</span> ~Shape() { }
00043         <span class="keyword">virtual</span> <a class="code" href="classBBox.html">BBox</a> ObjectBound() const = 0;
<a name="l00044"></a><a class="code" href="classShape.html#a3">00044</a>         virtual <a class="code" href="classBBox.html">BBox</a> WorldBound()<span class="keyword"> const </span>{
00045                 <span class="keywordflow">return</span> ObjectToWorld(ObjectBound());
00046         }
<a name="l00047"></a><a class="code" href="classShape.html#a4">00047</a>         <span class="keyword">virtual</span> <span class="keywordtype">bool</span> CanIntersect()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="keyword">true</span>; }
00048         <span class="keyword">virtual</span> <span class="keywordtype">void</span>
<a name="l00049"></a><a class="code" href="classShape.html#a5">00049</a>                 Refine(vector&lt;<a class="code" href="classReference.html">Reference&lt;Shape&gt;</a> &gt; &amp;refined)<span class="keyword"> const </span>{
00050                 <a class="code" href="util_8cpp.html#a17">Severe</a>(<span class="stringliteral">"Unimplemented Shape::Refine() method called"</span>);
00051         }
<a name="l00052"></a><a class="code" href="classShape.html#a6">00052</a>         <span class="keyword">virtual</span> <span class="keywordtype">bool</span> Intersect(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keywordtype">float</span> *tHit,
00053                         DifferentialGeometry *dg)<span class="keyword"> const </span>{
00054                 <a class="code" href="util_8cpp.html#a17">Severe</a>(<span class="stringliteral">"Unimplemented Shape::Intersect()"</span>
00055                    <span class="stringliteral">"method called"</span>);
00056                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00057         }
<a name="l00058"></a><a class="code" href="classShape.html#a7">00058</a>         <span class="keyword">virtual</span> <span class="keywordtype">bool</span> IntersectP(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray)<span class="keyword"> const </span>{
00059                 <a class="code" href="util_8cpp.html#a17">Severe</a>(<span class="stringliteral">"Unimplemented Shape::IntersectP()"</span>
00060                    <span class="stringliteral">"method called"</span>);
00061                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00062         }
<a name="l00063"></a><a class="code" href="classShape.html#a8">00063</a>         <span class="keyword">virtual</span> <span class="keywordtype">void</span> GetShadingGeometry(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;obj2world,
00064                         <span class="keyword">const</span> DifferentialGeometry &amp;dg,
00065                         DifferentialGeometry *dgShading)<span class="keyword"> const </span>{
00066                 *dgShading = dg;
00067         }
<a name="l00068"></a><a class="code" href="classShape.html#a9">00068</a>         <span class="keyword">virtual</span> <span class="keywordtype">float</span> Area()<span class="keyword"> const </span>{
00069                 <a class="code" href="util_8cpp.html#a17">Severe</a>(<span class="stringliteral">"Unimplemented Shape::Area() method called"</span>);
00070                 <span class="keywordflow">return</span> 0.;
00071         }
<a name="l00072"></a><a class="code" href="classShape.html#a10">00072</a>         <span class="keyword">virtual</span> <a class="code" href="classPoint.html">Point</a> <a class="code" href="structSample.html">Sample</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <a class="code" href="classNormal.html">Normal</a> *Ns)<span class="keyword"> const </span>{
00073                 <a class="code" href="util_8cpp.html#a17">Severe</a>(<span class="stringliteral">"Unimplemented Shape::Sample method called"</span>);
00074                 <span class="keywordflow">return</span> <a class="code" href="classPoint.html">Point</a>();
00075         }
<a name="l00076"></a><a class="code" href="classShape.html#a11">00076</a>         <span class="keyword">virtual</span> <span class="keywordtype">float</span> Pdf(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;Pshape)<span class="keyword"> const </span>{
00077                 <span class="keywordflow">return</span> 1.f / Area();
00078         }
<a name="l00079"></a><a class="code" href="classShape.html#a12">00079</a>         <span class="keyword">virtual</span> <a class="code" href="classPoint.html">Point</a> Sample(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P,
00080                         <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <a class="code" href="classNormal.html">Normal</a> *Ns)<span class="keyword"> const </span>{
00081                 <span class="keywordflow">return</span> Sample(u1, u2, Ns);
00082         }
<a name="l00083"></a><a class="code" href="classShape.html#a13">00083</a>         <span class="keyword">virtual</span> <span class="keywordtype">float</span> Pdf(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
00084                 <span class="comment">// Intersect sample ray with area light geometry</span>
00085                 DifferentialGeometry dgLight;
00086                 <a class="code" href="classRay.html">Ray</a> ray(p, wi);
00087                 <span class="keywordtype">float</span> thit;
00088                 <span class="keywordflow">if</span> (!Intersect(ray, &amp;thit, &amp;dgLight)) <span class="keywordflow">return</span> 0.;
00089                 <span class="comment">// Convert light sample weight to solid angle measure</span>
00090                 <span class="keywordtype">float</span> pdf = <a class="code" href="geometry_8h.html#a10">DistanceSquared</a>(p, ray(thit)) /
00091                         (<a class="code" href="geometry_8h.html#a20">AbsDot</a>(dgLight.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>, -wi) * Area());
00092                 <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a20">AbsDot</a>(dgLight.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>, -wi) == 0.f) pdf = <a class="code" href="pbrt_8h.html#a9">INFINITY</a>; <span class="comment">// NOBOOK</span>
00093                 <span class="keywordflow">return</span> pdf;
00094         }
00095         <span class="comment">// Shape Public Data</span>
<a name="l00096"></a><a class="code" href="classShape.html#o1">00096</a>         <span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> ObjectToWorld, WorldToObject;
<a name="l00097"></a><a class="code" href="classShape.html#o3">00097</a>         <span class="keyword">const</span> <span class="keywordtype">bool</span> reverseOrientation, transformSwapsHandedness;
00098 };
<a name="l00099"></a><a class="code" href="classShapeSet.html">00099</a> <span class="keyword">class </span><a class="code" href="classShapeSet.html">ShapeSet</a> : <span class="keyword">public</span> Shape {
00100 <span class="keyword">public</span>:
00101         <span class="comment">// ShapeSet Public Methods</span>
<a name="l00102"></a><a class="code" href="classShapeSet.html#a0">00102</a>         <a class="code" href="classPoint.html">Point</a> <a class="code" href="structSample.html">Sample</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <a class="code" href="classNormal.html">Normal</a> *Ns)<span class="keyword"> const </span>{
00103                 <span class="keywordtype">float</span> ls = <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>();
00104                 <a class="code" href="pbrt_8h.html#a51">u_int</a> sn;
00105                 <span class="keywordflow">for</span> (sn = 0; sn &lt; <a class="code" href="classShapeSet.html#r2">shapes</a>.size()-1; ++sn)
00106                         <span class="keywordflow">if</span> (ls &lt; <a class="code" href="classShapeSet.html#r1">areaCDF</a>[sn]) <span class="keywordflow">break</span>;
00107                 <span class="keywordflow">return</span> <a class="code" href="classShapeSet.html#r2">shapes</a>[sn]-&gt;Sample(u1, u2, Ns);
00108         }
<a name="l00109"></a><a class="code" href="classShapeSet.html#a1">00109</a>         <a class="code" href="classShapeSet.html">ShapeSet</a>(<span class="keyword">const</span> vector&lt;<a class="code" href="classReference.html">Reference&lt;Shape&gt;</a> &gt; &amp;s,
00110                 <span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro)
00111                 : Shape(o2w, ro) {
00112                 <a class="code" href="classShapeSet.html#r2">shapes</a> = s;
00113                 <a class="code" href="classShapeSet.html#r0">area</a> = 0;
00114                 vector&lt;float&gt; areas;
00115                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classShapeSet.html#r2">shapes</a>.size(); ++i) {
00116                         <span class="keywordtype">float</span> a = <a class="code" href="classShapeSet.html#r2">shapes</a>[i]-&gt;Area();
00117                         <a class="code" href="classShapeSet.html#r0">area</a> += a;
00118                         areas.push_back(a);
00119                 }
00120                 <span class="keywordtype">float</span> prevCDF = 0;
00121                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classShapeSet.html#r2">shapes</a>.size(); ++i) {
00122                         <a class="code" href="classShapeSet.html#r1">areaCDF</a>.push_back(prevCDF + areas[i] / <a class="code" href="classShapeSet.html#r0">area</a>);
00123                         prevCDF = <a class="code" href="classShapeSet.html#r1">areaCDF</a>[i];
00124                 }
00125         }
<a name="l00126"></a><a class="code" href="classShapeSet.html#a2">00126</a>         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classShapeSet.html#a2">ObjectBound</a>()<span class="keyword"> const </span>{
00127                 <a class="code" href="classBBox.html">BBox</a> ob;
00128                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classShapeSet.html#r2">shapes</a>.size(); ++i)
00129                         ob = <a class="code" href="geometry_8cpp.html#a1">Union</a>(ob, <a class="code" href="classShapeSet.html#r2">shapes</a>[i]-&gt;<a class="code" href="classShapeSet.html#a2">ObjectBound</a>());
00130                 <span class="keywordflow">return</span> ob;
00131         }
<a name="l00132"></a><a class="code" href="classShapeSet.html#a3">00132</a>         <span class="keywordtype">bool</span> <a class="code" href="classShapeSet.html#a3">CanIntersect</a>()<span class="keyword"> const </span>{
00133                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classShapeSet.html#r2">shapes</a>.size(); ++i)
00134                         <span class="keywordflow">if</span> (!<a class="code" href="classShapeSet.html#r2">shapes</a>[i]-&gt;CanIntersect()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00135                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00136         }
<a name="l00137"></a><a class="code" href="classShapeSet.html#a4">00137</a>         <span class="keywordtype">bool</span> <a class="code" href="classShapeSet.html#a4">Intersect</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keywordtype">float</span> *t_hitp,
00138                         DifferentialGeometry *dg)<span class="keyword"> const </span>{
00139                 <span class="keywordtype">bool</span> anyHit = <span class="keyword">false</span>;
00140                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classShapeSet.html#r2">shapes</a>.size(); ++i)
00141                         <span class="keywordflow">if</span> (<a class="code" href="classShapeSet.html#r2">shapes</a>[i]-&gt;Intersect(ray, t_hitp, dg)) anyHit = <span class="keyword">true</span>;
00142                 <span class="keywordflow">return</span> anyHit;
00143         }
<a name="l00144"></a><a class="code" href="classShapeSet.html#a5">00144</a>         <span class="keywordtype">void</span> <a class="code" href="classShapeSet.html#a5">Refine</a>(vector&lt;<a class="code" href="classReference.html">Reference&lt;Shape&gt;</a> &gt; &amp;refined)<span class="keyword"> const </span>{
00145                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classShapeSet.html#r2">shapes</a>.size(); ++i) {
00146                         <span class="keywordflow">if</span> (<a class="code" href="classShapeSet.html#r2">shapes</a>[i]-&gt;CanIntersect())
00147                                 refined.push_back(<a class="code" href="classShapeSet.html#r2">shapes</a>[i]);
00148                         <span class="keywordflow">else</span> <a class="code" href="classShapeSet.html#r2">shapes</a>[i]-&gt;Refine(refined);
00149                 }
00150         
00151         }
<a name="l00152"></a><a class="code" href="classShapeSet.html#a6">00152</a>         <span class="keywordtype">float</span> <a class="code" href="classShapeSet.html#a6">Area</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classShapeSet.html#r0">area</a>; }
00153 <span class="keyword">private</span>:
00154         <span class="comment">// ShapeSet Private Data</span>
<a name="l00155"></a><a class="code" href="classShapeSet.html#r0">00155</a>         <span class="keywordtype">float</span> <a class="code" href="classShapeSet.html#r0">area</a>;
<a name="l00156"></a><a class="code" href="classShapeSet.html#r1">00156</a>         vector&lt;float&gt; <a class="code" href="classShapeSet.html#r1">areaCDF</a>;
<a name="l00157"></a><a class="code" href="classShapeSet.html#r2">00157</a>         vector&lt;Reference&lt;Shape&gt; &gt; <a class="code" href="classShapeSet.html#r2">shapes</a>;
00158 };
00159 <span class="preprocessor">#endif // PBRT_SHAPE_H</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:24 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
