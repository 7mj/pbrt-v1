<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: trianglemesh.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>trianglemesh.cpp</h1><a href="trianglemesh_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// trianglemesh.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="shape_8h.html">shape.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
00014 <span class="comment">// TriangleMesh Declarations</span>
<a name="l00015"></a><a class="code" href="classTriangleMesh.html">00015</a> <span class="keyword">class </span><a class="code" href="classTriangleMesh.html">TriangleMesh</a> : <span class="keyword">public</span> <a class="code" href="classShape.html">Shape</a> {
00016 <span class="keyword">public</span>:
00017         <span class="comment">// TriangleMesh Public Methods</span>
00018         <a class="code" href="classTriangleMesh.html">TriangleMesh</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro,
00019                      <span class="keywordtype">int</span> <a class="code" href="classTriangleMesh.html#p0">ntris</a>, <span class="keywordtype">int</span> <a class="code" href="classTriangleMesh.html#p1">nverts</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> *vptr,
00020                                  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> *P, <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> *<a class="code" href="util_8cpp.html#a3">N</a>,
00021                                  <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> *S, <span class="keyword">const</span> <span class="keywordtype">float</span> *uv);
00022         <a class="code" href="classTriangleMesh.html#a1">~TriangleMesh</a>();
00023         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangleMesh.html#a2">ObjectBound</a>() <span class="keyword">const</span>;
00024         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangleMesh.html#a3">WorldBound</a>() <span class="keyword">const</span>;
<a name="l00025"></a><a class="code" href="classTriangleMesh.html#a4">00025</a>         <span class="keywordtype">bool</span> <a class="code" href="classTriangleMesh.html#a4">CanIntersect</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="keyword">false</span>; }
00026         <span class="keywordtype">void</span> Refine(vector&lt;<a class="code" href="classReference.html">Reference&lt;Shape&gt;</a> &gt; &amp;refined) <span class="keyword">const</span>;
00027         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classTriangle.html">Triangle</a>;
00028         <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">friend</span> <span class="keyword">class </span>VertexTexture;
00029 <span class="keyword">protected</span>:
00030         <span class="comment">// TriangleMesh Data</span>
<a name="l00031"></a><a class="code" href="classTriangleMesh.html#p1">00031</a>         <span class="keywordtype">int</span> ntris, nverts;
<a name="l00032"></a><a class="code" href="classTriangleMesh.html#p2">00032</a>         <span class="keywordtype">int</span> *<a class="code" href="classTriangleMesh.html#p2">vertexIndex</a>;
<a name="l00033"></a><a class="code" href="classTriangleMesh.html#p3">00033</a>         <a class="code" href="classPoint.html">Point</a> *<a class="code" href="classTriangleMesh.html#p3">p</a>;
<a name="l00034"></a><a class="code" href="classTriangleMesh.html#p4">00034</a>         <a class="code" href="classNormal.html">Normal</a> *<a class="code" href="classTriangleMesh.html#p4">n</a>;
<a name="l00035"></a><a class="code" href="classTriangleMesh.html#p5">00035</a>         <a class="code" href="classVector.html">Vector</a> *<a class="code" href="classTriangleMesh.html#p5">s</a>;
<a name="l00036"></a><a class="code" href="classTriangleMesh.html#p6">00036</a>         <span class="keywordtype">float</span> *<a class="code" href="classTriangleMesh.html#p6">uvs</a>;
00037 };
<a name="l00038"></a><a class="code" href="classTriangle.html">00038</a> <span class="keyword">class </span><a class="code" href="classTriangle.html">Triangle</a> : <span class="keyword">public</span> <a class="code" href="classShape.html">Shape</a> {
00039 <span class="keyword">public</span>:
00040         <span class="comment">// Triangle Public Methods</span>
<a name="l00041"></a><a class="code" href="classTriangle.html#a0">00041</a>         <a class="code" href="classTriangle.html">Triangle</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro,
00042                  <a class="code" href="classTriangleMesh.html">TriangleMesh</a> *m, <span class="keywordtype">int</span> n)
00043                         : <a class="code" href="classShape.html">Shape</a>(o2w, ro) {
00044                 <a class="code" href="classTriangle.html#r0">mesh</a> = m;
00045                 <a class="code" href="classTriangle.html#r1">v</a> = &amp;<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;vertexIndex[3*n];
00046                 <span class="comment">// Update created triangles stats</span>
00047                 <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> trisMade(<span class="stringliteral">"Geometry"</span>,
00048                                              <span class="stringliteral">"Triangles created"</span>);
00049                 ++trisMade;
00050         }
00051         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangle.html#a1">ObjectBound</a>() const;
00052         <a class="code" href="classBBox.html">BBox</a> WorldBound() const;
00053         <span class="keywordtype">bool</span> Intersect(const <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keywordtype">float</span> *tHit,
00054                        <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> *dg) const;
00055         <span class="keywordtype">bool</span> IntersectP(const <a class="code" href="classRay.html">Ray</a> &amp;ray) const;
00056         <span class="keywordtype">void</span> GetUVs(<span class="keywordtype">float</span> uv[3][2]) const;
00057         <span class="keywordtype">float</span> Area() const;
<a name="l00058"></a><a class="code" href="classTriangle.html#a7">00058</a>         virtual <span class="keywordtype">void</span> GetShadingGeometry(const <a class="code" href="classTransform.html">Transform</a> &amp;obj2world,
00059                         const <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> &amp;dg,
00060                         <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> *dgShading)<span class="keyword"> const </span>{
00061                 <span class="keywordflow">if</span> (!<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n &amp;&amp; !<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;s) {
00062                         *dgShading = dg;
00063                         <span class="keywordflow">return</span>;
00064                 }
00065                 <span class="comment">// Initialize _Triangle_ shading geometry with _n_ and _s_</span>
00066                 <span class="comment">// Compute barycentric coordinates for point</span>
00067                 <span class="keywordtype">float</span> b[3];
00068                 <span class="comment">// Initialize _A_ and _C_ matrices for barycentrics</span>
00069                 <span class="keywordtype">float</span> uv[3][2];
00070                 <a class="code" href="classTriangle.html#a5">GetUVs</a>(uv);
00071                 <span class="keywordtype">float</span> A[2][2] =
00072                     { { uv[1][0] - uv[0][0], uv[2][0] - uv[0][0] },
00073                       { uv[1][1] - uv[0][1], uv[2][1] - uv[0][1] } };
00074                 <span class="keywordtype">float</span> C[2] = { dg.u - uv[0][0], dg.v - uv[0][1] };
00075                 <span class="keywordflow">if</span> (!<a class="code" href="util_8cpp.html#a18">SolveLinearSystem2x2</a>(A, C, &amp;b[1])) {
00076                         <span class="comment">// Handle degenerate parametric mapping</span>
00077                         b[0] = b[1] = b[2] = 1.f/3.f;
00078                 }
00079                 <span class="keywordflow">else</span>
00080                         b[0] = 1.f - b[1] - b[2];
00081                 <span class="comment">// Use _n_ and _s_ to compute shading tangents for triangle, _ss_ and _ts_</span>
00082                 <a class="code" href="classNormal.html">Normal</a> ns;
00083                 <a class="code" href="classVector.html">Vector</a> ss, ts;
00084                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n) ns = <a class="code" href="geometry_8h.html#a14">Normalize</a>(obj2world(b[0] * <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n[<a class="code" href="classTriangle.html#r1">v</a>[0]] +
00085                         b[1] * <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n[<a class="code" href="classTriangle.html#r1">v</a>[1]] + b[2] * <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n[<a class="code" href="classTriangle.html#r1">v</a>[2]]));
00086                 <span class="keywordflow">else</span>   ns = dg.nn;
00087                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;s) ss = <a class="code" href="geometry_8h.html#a14">Normalize</a>(obj2world(b[0] * <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;s[v[0]] +
00088                         b[1] * <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;s[v[1]] + b[2] * <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;s[v[2]]));
00089                 <span class="keywordflow">else</span>   ss = <a class="code" href="geometry_8h.html#a14">Normalize</a>(dg.dpdu);
00090                 ts = <a class="code" href="geometry_8h.html#a14">Normalize</a>(<a class="code" href="geometry_8h.html#a6">Cross</a>(ss, ns));
00091                 ss = <a class="code" href="geometry_8h.html#a6">Cross</a>(ts, ns);
00092                 <a class="code" href="classVector.html">Vector</a> dndu, dndv;
00093                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n) {
00094                         <span class="comment">// Compute \dndu and \dndv for triangle shading geometry</span>
00095                         <span class="keywordtype">float</span> uvs[3][2];
00096                         <a class="code" href="classTriangle.html#a5">GetUVs</a>(uvs);
00097                         <span class="comment">// Compute deltas for triangle partial derivatives of normal</span>
00098                         <span class="keywordtype">float</span> du1 = uvs[0][0] - uvs[2][0];
00099                         <span class="keywordtype">float</span> du2 = uvs[1][0] - uvs[2][0];
00100                         <span class="keywordtype">float</span> dv1 = uvs[0][1] - uvs[2][1];
00101                         <span class="keywordtype">float</span> dv2 = uvs[1][1] - uvs[2][1];
00102                         <a class="code" href="classVector.html">Vector</a> dn1 = <a class="code" href="classVector.html">Vector</a>(<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n[v[0]] - <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n[v[2]]);
00103                         Vector dn2 = Vector(<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n[v[1]] - <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;n[v[2]]);
00104                         <span class="keywordtype">float</span> determinant = du1 * dv2 - dv1 * du2;
00105                         <span class="keywordflow">if</span> (determinant == 0)
00106                                 dndu = dndv = Vector(0,0,0);
00107                         <span class="keywordflow">else</span> {
00108                                 <span class="keywordtype">float</span> invdet = 1.f / determinant;
00109                                 dndu = ( dv2 * dn1 - dv1 * dn2) * invdet;
00110                                 dndv = (-du2 * dn1 + du1 * dn2) * invdet;
00111                         }
00112                 }
00113                 <span class="keywordflow">else</span>
00114                         dndu = dndv = <a class="code" href="classVector.html">Vector</a>(0,0,0);
00115                 *dgShading = <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a>(dg.p, ss, ts,
00116                         dndu, dndv, dg.u, dg.v, dg.shape);
00117                 dgShading-&gt;dudx = dg.dudx;  dgShading-&gt;dvdx = dg.dvdx; <span class="comment">// NOBOOK</span>
00118                 dgShading-&gt;dudy = dg.dudy;  dgShading-&gt;dvdy = dg.dvdy; <span class="comment">// NOBOOK</span>
00119                 dgShading-&gt;dpdx = dg.dpdx;  dgShading-&gt;dpdy = dg.dpdy; <span class="comment">// NOBOOK</span>
00120         }
00121         <a class="code" href="classPoint.html">Point</a> <a class="code" href="structSample.html">Sample</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <a class="code" href="classNormal.html">Normal</a> *Ns) <span class="keyword">const</span>;
00122 <span class="keyword">private</span>:
00123         <span class="comment">// Triangle Data</span>
<a name="l00124"></a><a class="code" href="classTriangle.html#r0">00124</a>         <a class="code" href="classReference.html">Reference&lt;TriangleMesh&gt;</a> <a class="code" href="classTriangle.html#r0">mesh</a>;
<a name="l00125"></a><a class="code" href="classTriangle.html#r1">00125</a>         <span class="keywordtype">int</span> *<a class="code" href="classTriangle.html#r1">v</a>;
00126 };
00127 <span class="comment">// TriangleMesh Method Definitions</span>
<a name="l00128"></a><a class="code" href="classTriangleMesh.html#a0">00128</a> <a class="code" href="classTriangleMesh.html#a0">TriangleMesh::TriangleMesh</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro,
00129                 <span class="keywordtype">int</span> nt, <span class="keywordtype">int</span> nv, <span class="keyword">const</span> <span class="keywordtype">int</span> *vi, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> *P,
00130                 <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> *N, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> *S, <span class="keyword">const</span> <span class="keywordtype">float</span> *uv)
00131         : <a class="code" href="classShape.html">Shape</a>(o2w, ro) {
00132         <a class="code" href="classTriangleMesh.html#p0">ntris</a> = nt;
00133         <a class="code" href="classTriangleMesh.html#p1">nverts</a> = nv;
00134         <a class="code" href="classTriangleMesh.html#p2">vertexIndex</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[3 * <a class="code" href="classTriangleMesh.html#p0">ntris</a>];
00135         <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>(<a class="code" href="classTriangleMesh.html#p2">vertexIndex</a>, vi, 3 * <a class="code" href="classTriangleMesh.html#p0">ntris</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00136         <span class="comment">// Copy _uv_, _N_, and _S_ vertex data, if present</span>
00137         <span class="keywordflow">if</span> (uv) {
00138                 <a class="code" href="classTriangleMesh.html#p6">uvs</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[2*<a class="code" href="classTriangleMesh.html#p1">nverts</a>];
00139                 <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>(<a class="code" href="classTriangleMesh.html#p6">uvs</a>, uv, 2*<a class="code" href="classTriangleMesh.html#p1">nverts</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00140         }
00141         <span class="keywordflow">else</span> <a class="code" href="classTriangleMesh.html#p6">uvs</a> = NULL;
00142         <a class="code" href="classTriangleMesh.html#p3">p</a> = <span class="keyword">new</span> <a class="code" href="classPoint.html">Point</a>[<a class="code" href="classTriangleMesh.html#p1">nverts</a>];
00143         <span class="keywordflow">if</span> (<a class="code" href="util_8cpp.html#a3">N</a>) {
00144                 <a class="code" href="classTriangleMesh.html#p4">n</a> = <span class="keyword">new</span> <a class="code" href="classNormal.html">Normal</a>[<a class="code" href="classTriangleMesh.html#p1">nverts</a>];
00145                 <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>(<a class="code" href="classTriangleMesh.html#p4">n</a>, <a class="code" href="util_8cpp.html#a3">N</a>, <a class="code" href="classTriangleMesh.html#p1">nverts</a>*<span class="keyword">sizeof</span>(Normal));
00146         }
00147         <span class="keywordflow">else</span> <a class="code" href="classTriangleMesh.html#p4">n</a> = NULL;
00148         <span class="keywordflow">if</span> (S) {
00149                 <a class="code" href="classTriangleMesh.html#p5">s</a> = <span class="keyword">new</span> <a class="code" href="classVector.html">Vector</a>[<a class="code" href="classTriangleMesh.html#p1">nverts</a>];
00150                 <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>(<a class="code" href="classTriangleMesh.html#p5">s</a>, S, <a class="code" href="classTriangleMesh.html#p1">nverts</a>*<span class="keyword">sizeof</span>(Vector));
00151         }
00152         <span class="keywordflow">else</span> <a class="code" href="classTriangleMesh.html#p5">s</a> = NULL;
00153         <span class="comment">// Transform mesh vertices to world space</span>
00154         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i  = 0; i &lt; <a class="code" href="classTriangleMesh.html#p1">nverts</a>; ++i)
00155                 <a class="code" href="classTriangleMesh.html#p3">p</a>[i] = ObjectToWorld(P[i]);
00156 }
<a name="l00157"></a><a class="code" href="classTriangleMesh.html#a1">00157</a> <a class="code" href="classTriangleMesh.html#a1">TriangleMesh::~TriangleMesh</a>() {
00158         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#p2">vertexIndex</a>;
00159         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#p3">p</a>;
00160         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#p5">s</a>;
00161         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#p4">n</a>;
00162         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#p6">uvs</a>;
00163 }
<a name="l00164"></a><a class="code" href="classTriangleMesh.html#a2">00164</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangleMesh.html#a2">TriangleMesh::ObjectBound</a>()<span class="keyword"> const </span>{
00165         <a class="code" href="classBBox.html">BBox</a> bobj;
00166         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classTriangleMesh.html#p1">nverts</a>; i++)
00167                 bobj = <a class="code" href="geometry_8cpp.html#a1">Union</a>(bobj, WorldToObject(<a class="code" href="classTriangleMesh.html#p3">p</a>[i]));
00168         <span class="keywordflow">return</span> bobj;
00169 }
<a name="l00170"></a><a class="code" href="classTriangleMesh.html#a3">00170</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangleMesh.html#a3">TriangleMesh::WorldBound</a>()<span class="keyword"> const </span>{
00171         <a class="code" href="classBBox.html">BBox</a> worldBounds;
00172         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classTriangleMesh.html#p1">nverts</a>; i++)
00173                 worldBounds = <a class="code" href="geometry_8cpp.html#a1">Union</a>(worldBounds, <a class="code" href="classTriangleMesh.html#p3">p</a>[i]);
00174         <span class="keywordflow">return</span> worldBounds;
00175 }
00176 <span class="keywordtype">void</span>
<a name="l00177"></a><a class="code" href="classTriangleMesh.html#a5">00177</a> <a class="code" href="classTriangleMesh.html#a5">TriangleMesh::Refine</a>(vector&lt;<a class="code" href="classReference.html">Reference&lt;Shape&gt;</a> &gt; &amp;refined)<span class="keyword"></span>
00178 <span class="keyword">const </span>{
00179         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classTriangleMesh.html#p0">ntris</a>; ++i)
00180                 refined.push_back(<span class="keyword">new</span> <a class="code" href="classTriangle.html">Triangle</a>(ObjectToWorld,
00181                                                reverseOrientation,
00182                                        (<a class="code" href="classTriangleMesh.html">TriangleMesh</a> *)<span class="keyword">this</span>,
00183                                                                            i));
00184 }
<a name="l00185"></a><a class="code" href="classTriangle.html#a1">00185</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangle.html#a1">Triangle::ObjectBound</a>()<span class="keyword"> const </span>{
00186         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
00187         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[0]];
00188         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[1]];
00189         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[2]];
00190         <span class="keywordflow">return</span> <a class="code" href="geometry_8cpp.html#a1">Union</a>(<a class="code" href="classBBox.html">BBox</a>(WorldToObject(p1), WorldToObject(p2)),
00191                 WorldToObject(p3));
00192 }
<a name="l00193"></a><a class="code" href="classTriangle.html#a2">00193</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangle.html#a2">Triangle::WorldBound</a>()<span class="keyword"> const </span>{
00194         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
00195         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[0]];
00196         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[1]];
00197         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[2]];
00198         <span class="keywordflow">return</span> <a class="code" href="geometry_8cpp.html#a1">Union</a>(<a class="code" href="classBBox.html">BBox</a>(p1, p2), p3);
00199 }
<a name="l00200"></a><a class="code" href="classTriangle.html#a3">00200</a> <span class="keywordtype">bool</span> <a class="code" href="classTriangle.html#a3">Triangle::Intersect</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keywordtype">float</span> *tHit,
00201                 <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> *dg)<span class="keyword"> const </span>{
00202         <span class="comment">// Initialize triangle intersection statistics</span>
00203         <span class="keyword">static</span>
00204         <a class="code" href="classStatsPercentage.html">StatsPercentage</a> triangleHits(<span class="stringliteral">"Geometry"</span>,
00205                                      <span class="stringliteral">"Triangle Ray Intersections"</span>);
00206         <span class="comment">// Update triangle tests count</span>
00207         triangleHits.<a class="code" href="classStatsPercentage.html#a0">Add</a>(0, 1);
00208         <span class="comment">// Compute $\VEC{s}_1$</span>
00209         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
00210         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[0]];
00211         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[1]];
00212         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[2]];
00213         <a class="code" href="classVector.html">Vector</a> e1 = p2 - p1;
00214         <a class="code" href="classVector.html">Vector</a> e2 = p3 - p1;
00215         <a class="code" href="classVector.html">Vector</a> s1 = <a class="code" href="geometry_8h.html#a6">Cross</a>(ray.<a class="code" href="classRay.html#o1">d</a>, e2);
00216         <span class="keywordtype">float</span> divisor = <a class="code" href="geometry_8h.html#a17">Dot</a>(s1, e1);
00217         <span class="keywordflow">if</span> (divisor == 0.)
00218                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00219         <span class="keywordtype">float</span> invDivisor = 1.f / divisor;
00220         <span class="comment">// Compute first barycentric coordinate</span>
00221         <a class="code" href="classVector.html">Vector</a> d = ray.<a class="code" href="classRay.html#o0">o</a> - p1;
00222         <span class="keywordtype">float</span> b1 = <a class="code" href="geometry_8h.html#a17">Dot</a>(d, s1) * invDivisor;
00223         <span class="keywordflow">if</span> (b1 &lt; 0. || b1 &gt; 1.)
00224                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00225         <span class="comment">// Compute second barycentric coordinate</span>
00226         <a class="code" href="classVector.html">Vector</a> s2 = <a class="code" href="geometry_8h.html#a6">Cross</a>(d, e1);
00227         <span class="keywordtype">float</span> b2 = <a class="code" href="geometry_8h.html#a17">Dot</a>(ray.<a class="code" href="classRay.html#o1">d</a>, s2) * invDivisor;
00228         <span class="keywordflow">if</span> (b2 &lt; 0. || b1 + b2 &gt; 1.)
00229                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00230         <span class="comment">// Compute _t_ to intersection point</span>
00231         <span class="keywordtype">float</span> t = <a class="code" href="geometry_8h.html#a17">Dot</a>(e2, s2) * invDivisor;
00232         <span class="keywordflow">if</span> (t &lt; ray.<a class="code" href="classRay.html#o2">mint</a> || t &gt; ray.<a class="code" href="classRay.html#o3">maxt</a>)
00233                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00234         triangleHits.<a class="code" href="classStatsPercentage.html#a0">Add</a>(1, 0); <span class="comment">//NOBOOK</span>
00235         <span class="comment">// Fill in _DifferentialGeometry_ from triangle hit</span>
00236         <span class="comment">// Compute triangle partial derivatives</span>
00237         <a class="code" href="classVector.html">Vector</a> dpdu, dpdv;
00238         <span class="keywordtype">float</span> uvs[3][2];
00239         <a class="code" href="classTriangle.html#a5">GetUVs</a>(uvs);
00240         <span class="comment">// Compute deltas for triangle partial derivatives</span>
00241         <span class="keywordtype">float</span> du1 = uvs[0][0] - uvs[2][0];
00242         <span class="keywordtype">float</span> du2 = uvs[1][0] - uvs[2][0];
00243         <span class="keywordtype">float</span> dv1 = uvs[0][1] - uvs[2][1];
00244         <span class="keywordtype">float</span> dv2 = uvs[1][1] - uvs[2][1];
00245         <a class="code" href="classVector.html">Vector</a> dp1 = p1 - p3, dp2 = p2 - p3;
00246         <span class="keywordtype">float</span> determinant = du1 * dv2 - dv1 * du2;
00247         <span class="keywordflow">if</span> (determinant == 0.f) {
00248                 <span class="comment">// Handle zero determinant for triangle partial derivative matrix</span>
00249                 <a class="code" href="geometry_8h.html#a8">CoordinateSystem</a>(<a class="code" href="geometry_8h.html#a14">Normalize</a>(<a class="code" href="geometry_8h.html#a6">Cross</a>(e2, e1)), &amp;dpdu, &amp;dpdv);
00250         }
00251         <span class="keywordflow">else</span> {
00252                 <span class="keywordtype">float</span> invdet = 1.f / determinant;
00253                 dpdu = ( dv2 * dp1 - dv1 * dp2) * invdet;
00254                 dpdv = (-du2 * dp1 + du1 * dp2) * invdet;
00255         }
00256         <span class="comment">// Interpolate $(u,v)$ triangle parametric coordinates</span>
00257         <span class="keywordtype">float</span> b0 = 1 - b1 - b2;
00258         <span class="keywordtype">float</span> tu = b0*uvs[0][0] + b1*uvs[1][0] + b2*uvs[2][0];
00259         <span class="keywordtype">float</span> tv = b0*uvs[0][1] + b1*uvs[1][1] + b2*uvs[2][1];
00260         *dg = <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a>(ray(t), dpdu, dpdv,
00261                                    <a class="code" href="classVector.html">Vector</a>(0,0,0), <a class="code" href="classVector.html">Vector</a>(0,0,0),
00262                                                            tu, tv, <span class="keyword">this</span>);
00263         *tHit = t;
00264         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00265 }
<a name="l00266"></a><a class="code" href="classTriangle.html#a4">00266</a> <span class="keywordtype">bool</span> <a class="code" href="classTriangle.html#a4">Triangle::IntersectP</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray)<span class="keyword"> const </span>{
00267         <span class="comment">// Initialize triangle intersection statistics</span>
00268         <span class="keyword">static</span>
00269         <a class="code" href="classStatsPercentage.html">StatsPercentage</a> triangleHits(<span class="stringliteral">"Geometry"</span>,
00270                                      <span class="stringliteral">"Triangle Ray Intersections"</span>);
00271         <span class="comment">// Update triangle tests count</span>
00272         triangleHits.<a class="code" href="classStatsPercentage.html#a0">Add</a>(0, 1);
00273         <span class="comment">// Compute $\VEC{s}_1$</span>
00274         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
00275         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[0]];
00276         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[1]];
00277         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[2]];
00278         <a class="code" href="classVector.html">Vector</a> e1 = p2 - p1;
00279         <a class="code" href="classVector.html">Vector</a> e2 = p3 - p1;
00280         <a class="code" href="classVector.html">Vector</a> s1 = <a class="code" href="geometry_8h.html#a6">Cross</a>(ray.<a class="code" href="classRay.html#o1">d</a>, e2);
00281         <span class="keywordtype">float</span> divisor = <a class="code" href="geometry_8h.html#a17">Dot</a>(s1, e1);
00282         <span class="keywordflow">if</span> (divisor == 0.)
00283                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00284         <span class="keywordtype">float</span> invDivisor = 1.f / divisor;
00285         <span class="comment">// Compute first barycentric coordinate</span>
00286         <a class="code" href="classVector.html">Vector</a> d = ray.<a class="code" href="classRay.html#o0">o</a> - p1;
00287         <span class="keywordtype">float</span> b1 = <a class="code" href="geometry_8h.html#a17">Dot</a>(d, s1) * invDivisor;
00288         <span class="keywordflow">if</span> (b1 &lt; 0. || b1 &gt; 1.)
00289                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00290         <span class="comment">// Compute second barycentric coordinate</span>
00291         <a class="code" href="classVector.html">Vector</a> s2 = <a class="code" href="geometry_8h.html#a6">Cross</a>(d, e1);
00292         <span class="keywordtype">float</span> b2 = <a class="code" href="geometry_8h.html#a17">Dot</a>(ray.<a class="code" href="classRay.html#o1">d</a>, s2) * invDivisor;
00293         <span class="keywordflow">if</span> (b2 &lt; 0. || b1 + b2 &gt; 1.)
00294                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00295         <span class="comment">// Compute _t_ to intersection point</span>
00296         <span class="keywordtype">float</span> t = <a class="code" href="geometry_8h.html#a17">Dot</a>(e2, s2) * invDivisor;
00297         <span class="keywordflow">if</span> (t &lt; ray.<a class="code" href="classRay.html#o2">mint</a> || t &gt; ray.<a class="code" href="classRay.html#o3">maxt</a>)
00298                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00299         triangleHits.<a class="code" href="classStatsPercentage.html#a0">Add</a>(1, 0); <span class="comment">//NOBOOK</span>
00300         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00301 }
<a name="l00302"></a><a class="code" href="classTriangle.html#a5">00302</a> <span class="keywordtype">void</span> <a class="code" href="classTriangle.html#a5">Triangle::GetUVs</a>(<span class="keywordtype">float</span> uv[3][2])<span class="keyword"> const </span>{
00303         <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#r0">mesh</a>-&gt;uvs) {
00304                 uv[0][0] = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#r1">v</a>[0]];
00305                 uv[0][1] = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#r1">v</a>[0]+1];
00306                 uv[1][0] = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#r1">v</a>[1]];
00307                 uv[1][1] = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#r1">v</a>[1]+1];
00308                 uv[2][0] = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#r1">v</a>[2]];
00309                 uv[2][1] = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#r1">v</a>[2]+1];
00310         } <span class="keywordflow">else</span> {
00311                 uv[0][0] = 0.; uv[0][1] = 0.;
00312                 uv[1][0] = 1.; uv[1][1] = 0.;
00313                 uv[2][0] = 1.; uv[2][1] = 1.;
00314         }
00315 }
<a name="l00316"></a><a class="code" href="classTriangle.html#a6">00316</a> <span class="keywordtype">float</span> <a class="code" href="classTriangle.html#a6">Triangle::Area</a>()<span class="keyword"> const </span>{
00317         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
00318         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[0]];
00319         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[1]];
00320         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[2]];
00321         <span class="keywordflow">return</span> 0.5f * <a class="code" href="geometry_8h.html#a6">Cross</a>(p2-p1, p3-p1).<a class="code" href="classVector.html#a15">Length</a>();
00322 }
<a name="l00323"></a><a class="code" href="classTriangle.html#a8">00323</a> <a class="code" href="classPoint.html">Point</a> <a class="code" href="classTriangle.html#a8">Triangle::Sample</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
00324                 <a class="code" href="classNormal.html">Normal</a> *Ns)<span class="keyword"> const </span>{
00325         <span class="keywordtype">float</span> b1, b2;
00326         <a class="code" href="pbrt_8h.html#a92">UniformSampleTriangle</a>(u1, u2, &amp;b1, &amp;b2);
00327         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
00328         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[0]];
00329         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[1]];
00330         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#r0">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#r1">v</a>[2]];
00331         <a class="code" href="classPoint.html">Point</a> p = b1 * p1 + b2 * p2 + (1.f - b1 - b2) * p3;
00332         <a class="code" href="classNormal.html">Normal</a> n = <a class="code" href="classNormal.html">Normal</a>(<a class="code" href="geometry_8h.html#a6">Cross</a>(p2-p1, p3-p1));
00333         *Ns = <a class="code" href="geometry_8h.html#a14">Normalize</a>(n);
00334         <span class="keywordflow">if</span> (reverseOrientation) *Ns *= -1.f;
00335         <span class="keywordflow">return</span> p;
00336 }
<a name="l00337"></a><a class="code" href="trianglemesh_8cpp.html#a0">00337</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classShape.html">Shape</a> *<a class="code" href="trianglemesh_8cpp.html#a0">CreateShape</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w,
00338                 <span class="keywordtype">bool</span> reverseOrientation, <span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params) {
00339         <span class="keywordtype">int</span> nvi, npi, nuvi, nsi, nni;
00340         <span class="keyword">const</span> <span class="keywordtype">int</span> *vi = params.<a class="code" href="classParamSet.html#a31">FindInt</a>(<span class="stringliteral">"indices"</span>, &amp;nvi);
00341         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> *P = params.<a class="code" href="classParamSet.html#a33">FindPoint</a>(<span class="stringliteral">"P"</span>, &amp;npi);
00342         <span class="keyword">const</span> <span class="keywordtype">float</span> *uvs = params.<a class="code" href="classParamSet.html#a30">FindFloat</a>(<span class="stringliteral">"uv"</span>, &amp;nuvi);
00343         <span class="keywordflow">if</span> (!uvs) uvs = params.<a class="code" href="classParamSet.html#a30">FindFloat</a>(<span class="stringliteral">"st"</span>, &amp;nuvi);
00344         <span class="comment">// XXX should complain if uvs aren't an array of 2...</span>
00345         <span class="keywordflow">if</span> (!vi || !P) <span class="keywordflow">return</span> NULL;
00346         <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> *S = params.<a class="code" href="classParamSet.html#a34">FindVector</a>(<span class="stringliteral">"S"</span>, &amp;nsi);
00347         <span class="keywordflow">if</span> (S &amp;&amp; nsi != npi) {
00348                 <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"Number of \"S\"s for triangle mesh must match \"P\"s"</span>);
00349                 S = NULL;
00350         }
00351         <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> *<a class="code" href="util_8cpp.html#a3">N</a> = params.<a class="code" href="classParamSet.html#a35">FindNormal</a>(<span class="stringliteral">"N"</span>, &amp;nni);
00352         <span class="keywordflow">if</span> (<a class="code" href="util_8cpp.html#a3">N</a> &amp;&amp; nni != npi) {
00353                 <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"Number of \"N\"s for triangle mesh must match \"P\"s"</span>);
00354                 <a class="code" href="util_8cpp.html#a3">N</a> = NULL;
00355         }
00356         <span class="keywordflow">if</span> (uvs &amp;&amp; <a class="code" href="util_8cpp.html#a3">N</a>) {
00357                 <span class="comment">// if there are normals, check for bad uv's that</span>
00358                 <span class="comment">// give degenerate mappings; discard them if so</span>
00359                 <span class="keyword">const</span> <span class="keywordtype">int</span> *vp = vi;
00360                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nvi; i += 3, vp += 3) {
00361                         <span class="keywordtype">float</span> area = .5f * <a class="code" href="geometry_8h.html#a6">Cross</a>(P[vp[0]]-P[vp[1]], P[vp[2]]-P[vp[1]]).<a class="code" href="classVector.html#a15">Length</a>();
00362                         <span class="keywordflow">if</span> (area &lt; 1e-7) <span class="keywordflow">continue</span>; <span class="comment">// ignore degenerate tris.</span>
00363                         <span class="keywordflow">if</span> ((uvs[2*vp[0]] == uvs[2*vp[1]] &amp;&amp;
00364                                 uvs[2*vp[0]+1] == uvs[2*vp[1]+1]) ||
00365                                 (uvs[2*vp[1]] == uvs[2*vp[2]] &amp;&amp;
00366                                 uvs[2*vp[1]+1] == uvs[2*vp[2]+1]) ||
00367                                 (uvs[2*vp[2]] == uvs[2*vp[0]] &amp;&amp;
00368                                 uvs[2*vp[2]+1] == uvs[2*vp[0]+1])) {
00369                                 <a class="code" href="util_8cpp.html#a15">Warning</a>(<span class="stringliteral">"Degenerate uv coordinates in triangle mesh.  Discarding all uvs."</span>);
00370                                 uvs = NULL;
00371                                 <span class="keywordflow">break</span>;
00372                         }
00373                 }
00374         }
00375         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nvi; ++i)
00376                 <span class="keywordflow">if</span> (vi[i] &gt;= npi) {
00377                         <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"trianglemesh has out of-bounds vertex index %d (%d \"P\" values were given"</span>,
00378                                 vi[i], npi);
00379                         <span class="keywordflow">return</span> NULL;
00380                 }
00381         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classTriangleMesh.html">TriangleMesh</a>(o2w, reverseOrientation, nvi/3, npi, vi, P,
00382                 <a class="code" href="util_8cpp.html#a3">N</a>, S, uvs);
00383 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:25 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
