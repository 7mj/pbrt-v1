<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: tifftoexr.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>tifftoexr.cpp</h1><a href="tifftoexr_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment"> g++ -g -Wall tifftoexr.cpp -I../../src/tangled_code/OpenEXR/include -ltiff -L../../src/tangled_code/OpenEXR/lib-linux -lIlmImf -lImath -lIex -lHalf  </span>
00003 <span class="comment"></span>
00004 <span class="comment">*/</span>
00005 
00006 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00007 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00008 <span class="preprocessor">#include &lt;tiffio.h&gt;</span>
00009 <span class="preprocessor">#include &lt;ImfOutputFile.h&gt;</span>
00010 <span class="preprocessor">#include &lt;ImfChannelList.h&gt;</span>
00011 <span class="preprocessor">#include &lt;ImfFrameBuffer.h&gt;</span>
00012 <span class="preprocessor">#include &lt;half.h&gt;</span>
00013 
00014 <span class="keyword">using</span> <span class="keyword">namespace </span>Imf;
00015 <span class="keyword">using</span> <span class="keyword">namespace </span>Imath;
00016 
<a name="l00017"></a><a class="code" href="tifftoexr_8cpp.html#a0">00017</a> <span class="preprocessor">#define INV_255 .00392156862745098039f</span>
00018 <span class="preprocessor"></span>
00019 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tifftoexr_8cpp.html#a1">WriteEXR</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">float</span> *rgba, <span class="keywordtype">int</span> xRes, <span class="keywordtype">int</span> yRes, <span class="keywordtype">bool</span> hasAlpha);
00020 <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="tifftoexr_8cpp.html#a2">ReadTIFF</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">float</span> *&amp;rgba, <span class="keywordtype">int</span> &amp;xRes, <span class="keywordtype">int</span> &amp;yRes, <span class="keywordtype">bool</span> &amp;hasAlpha);
00021 
<a name="l00022"></a><a class="code" href="tifftoexr_8cpp.html#a3">00022</a> <span class="keywordtype">int</span> <a class="code" href="core_2samplepat_8cpp.html#a11">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) 
00023 {
00024     <span class="keywordflow">if</span> (argc != 3) {
00025         fprintf(stderr, <span class="stringliteral">"usage: tifftoexr [foo.tiff] [foo.exr]\n"</span>);
00026         <span class="keywordflow">return</span> 1;
00027     }
00028 
00029     <span class="keywordtype">float</span> *rgba;
00030     <span class="keywordtype">int</span> xRes, yRes;
00031     <span class="keywordtype">bool</span> hasAlpha;
00032     <span class="keywordflow">if</span> (<a class="code" href="tifftoexr_8cpp.html#a2">ReadTIFF</a>(argv[1], rgba, xRes, yRes, hasAlpha))
00033         <a class="code" href="tifftoexr_8cpp.html#a1">WriteEXR</a>(argv[2], rgba, xRes, yRes, hasAlpha);
00034     <span class="keywordflow">return</span> 0;
00035 }
00036 
<a name="l00037"></a><a class="code" href="tifftoexr_8cpp.html#a1">00037</a> <span class="keywordtype">void</span> <a class="code" href="tifftoexr_8cpp.html#a1">WriteEXR</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">float</span> *frgba, <span class="keywordtype">int</span> xRes, <span class="keywordtype">int</span> yRes, <span class="keywordtype">bool</span> hasAlpha) 
00038 {
00039     Header header(xRes, yRes);
00040     header.channels().insert(<span class="stringliteral">"R"</span>, Channel (HALF));
00041     header.channels().insert(<span class="stringliteral">"G"</span>, Channel (HALF));
00042     header.channels().insert(<span class="stringliteral">"B"</span>, Channel (HALF));
00043     <span class="keywordflow">if</span> (hasAlpha)
00044         header.channels().insert(<span class="stringliteral">"A"</span>, Channel (HALF));
00045     <span class="keywordtype">int</span> stride = hasAlpha ? 4 : 3;
00046 
00047     half *rgba = <span class="keyword">new</span> half[xRes*yRes * stride];
00048     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; xRes*yRes * stride; ++i)
00049         rgba[i] = frgba[i];
00050 
00051     FrameBuffer fb;
00052     fb.insert(<span class="stringliteral">"R"</span>, Slice(HALF, (<span class="keywordtype">char</span> *)rgba, stride*<span class="keyword">sizeof</span>(half),
00053                          stride*xRes*<span class="keyword">sizeof</span>(half)));
00054     fb.insert(<span class="stringliteral">"G"</span>, Slice(HALF, (<span class="keywordtype">char</span> *)rgba+<span class="keyword">sizeof</span>(half), stride*<span class="keyword">sizeof</span>(half),
00055                          stride*xRes*<span class="keyword">sizeof</span>(half)));
00056     fb.insert(<span class="stringliteral">"B"</span>, Slice(HALF, (<span class="keywordtype">char</span> *)rgba+2*<span class="keyword">sizeof</span>(half), stride*<span class="keyword">sizeof</span>(half),
00057                          stride*xRes*<span class="keyword">sizeof</span>(half)));
00058     <span class="keywordflow">if</span> (hasAlpha)
00059         fb.insert(<span class="stringliteral">"A"</span>, Slice(HALF, (<span class="keywordtype">char</span> *)rgba+3*<span class="keyword">sizeof</span>(half), stride*<span class="keyword">sizeof</span>(half),
00060                              stride*xRes*<span class="keyword">sizeof</span>(half)));
00061 
00062     OutputFile file(name, header);
00063     file.setFrameBuffer(fb);
00064     file.writePixels(yRes);
00065 }
00066 
<a name="l00067"></a><a class="code" href="tifftoexr_8cpp.html#a2">00067</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="tifftoexr_8cpp.html#a2">ReadTIFF</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">float</span> *&amp;rgba, <span class="keywordtype">int</span> &amp;xRes, <span class="keywordtype">int</span> &amp;yRes,
00068                      <span class="keywordtype">bool</span> &amp;hasAlpha)
00069 {
00070     <span class="comment">// Try to open TIFF file</span>
00071     TIFF *tiff = TIFFOpen(name, <span class="stringliteral">"r"</span>);
00072     <span class="keywordflow">if</span> (!tiff) {
00073         fprintf(stderr, <span class="stringliteral">"Unable to open TIFF %s"</span>, name);
00074         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00075     }
00076     <span class="comment">// Get basic information from TIFF header</span>
00077     <span class="keywordtype">short</span> <span class="keywordtype">int</span> nSamples;
00078     <span class="keywordtype">int</span> xSize, ySize;
00079     TIFFGetField(tiff, TIFFTAG_IMAGEWIDTH, &amp;xSize);
00080     TIFFGetField(tiff, TIFFTAG_IMAGELENGTH, &amp;ySize);
00081     TIFFGetField(tiff, TIFFTAG_SAMPLESPERPIXEL, &amp;nSamples);
00082     <span class="keywordflow">if</span> (nSamples != 3 &amp;&amp; nSamples != 4) {
00083         fprintf(stderr, <span class="stringliteral">"Sorry, only handle 3 and 4 sample TIFFs...\n"</span>);
00084         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00085     }
00086     hasAlpha = (nSamples == 4);
00087     xRes = xSize;
00088     yRes = ySize;
00089 
00090     <span class="comment">// Make sure this is a TIFF we can read</span>
00091     <span class="keywordtype">short</span> <span class="keywordtype">int</span> bitsPerSample, sampleFormat = SAMPLEFORMAT_UINT;
00092     <span class="keywordflow">if</span> (!TIFFGetField(tiff, TIFFTAG_BITSPERSAMPLE, &amp;bitsPerSample)) {
00093         fprintf(stderr, <span class="stringliteral">"TIFFRead: bits per sample not set in TIFF"</span>);
00094         TIFFClose(tiff);
00095         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00096     }
00097 
00098     <span class="keywordflow">if</span> (!TIFFGetField(tiff, TIFFTAG_SAMPLEFORMAT, &amp;sampleFormat)) {
00099         <span class="keywordflow">if</span> (bitsPerSample == 32)
00100             sampleFormat = SAMPLEFORMAT_IEEEFP;
00101         <span class="keywordflow">else</span>
00102             sampleFormat = SAMPLEFORMAT_UINT;
00103     }
00104         
00105     <span class="keywordflow">if</span> (bitsPerSample == 32) {
00106         <span class="keywordflow">if</span> (sampleFormat != SAMPLEFORMAT_IEEEFP) {
00107             fprintf(stderr, <span class="stringliteral">"TIFFRead: 32 bit TIFF not stored in floating point format"</span>);
00108             TIFFClose(tiff);
00109             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00110         }
00111     }
00112     <span class="keywordflow">else</span> {
00113         <span class="keywordflow">if</span> (bitsPerSample != 8 &amp;&amp; bitsPerSample != 32) {
00114             fprintf(stderr, <span class="stringliteral">"TIFFRead: only 8 and 32 bits per sample supported"</span>);
00115             TIFFClose(tiff);
00116             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00117         }
00118         <span class="keywordflow">if</span> (sampleFormat != SAMPLEFORMAT_UINT) {
00119             fprintf(stderr, <span class="stringliteral">"TIFFRead: 8 bit TIFFs must be stored as unsigned ints"</span>);
00120             TIFFClose(tiff);
00121             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00122         }
00123     }
00124 
00125     <span class="keywordtype">int</span> bytesPerSample = bitsPerSample / 8;
00126     <span class="keywordflow">if</span> (nSamples * xRes * bytesPerSample != TIFFScanlineSize(tiff)) {
00127         fprintf(stderr, <span class="stringliteral">"TIFFRead: RGB not interleaved in TIFF %s"</span>, name);
00128         TIFFClose(tiff);
00129         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00130     }
00131 
00132     <span class="comment">// Allocate space for [[pixels]] and buffers</span>
00133     rgba = <span class="keyword">new</span> <span class="keywordtype">float</span>[nSamples * xRes * yRes];
00134     <span class="keywordtype">float</span> *p = rgba;
00135     <a class="code" href="pbrt_8h.html#a49">u_char</a> *ubuf = NULL;
00136     <span class="keywordflow">if</span> (bitsPerSample == 8) ubuf = <span class="keyword">new</span> <a class="code" href="pbrt_8h.html#a49">u_char</a>[nSamples * xRes];
00137 
00138     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; yRes; ++y) {
00139         <span class="keywordflow">if</span> (ubuf) {
00140             <span class="comment">// Read 8-bit TIFF scanline</span>
00141             <span class="keywordflow">if</span> (TIFFReadScanline(tiff, ubuf, y, 1) == -1) {
00142                 TIFFClose(tiff);
00143                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00144             }
00145             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; nSamples*xRes; ++x)
00146                 *p++ = ubuf[x] * <a class="code" href="tifftoexr_8cpp.html#a0">INV_255</a>;
00147         }
00148         <span class="keywordflow">else</span> {
00149             <span class="comment">// Read floating point TIFF scanline</span>
00150             <span class="keywordflow">if</span> (TIFFReadScanline(tiff, p, y, 1) == -1) {
00151                 TIFFClose(tiff);
00152                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00153             }
00154             p += nSamples * xRes;
00155         }
00156     }
00157 
00158     <span class="keyword">delete</span>[] ubuf;
00159     TIFFClose(tiff);
00160     <span class="keywordflow">return</span> rgba;
00161 }
00162 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:25 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
