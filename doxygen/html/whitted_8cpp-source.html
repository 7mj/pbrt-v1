<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: whitted.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>whitted.cpp</h1><a href="whitted_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// whitted.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="transport_8h.html">transport.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="scene_8h.html">scene.h</a>"</span>
00015 <span class="comment">// WhittedIntegrator Declarations</span>
<a name="l00016"></a><a class="code" href="classWhittedIntegrator.html">00016</a> <span class="keyword">class </span><a class="code" href="classWhittedIntegrator.html">WhittedIntegrator</a> : <span class="keyword">public</span> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> {
00017 <span class="keyword">public</span>:
00018         <span class="comment">// WhittedIntegrator Public Methods</span>
00019         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classWhittedIntegrator.html#a0">Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray,
00020                         <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keywordtype">float</span> *alpha) <span class="keyword">const</span>;
<a name="l00021"></a><a class="code" href="classWhittedIntegrator.html#a1">00021</a>         <a class="code" href="classWhittedIntegrator.html">WhittedIntegrator</a>(<span class="keywordtype">int</span> md) {
00022                 <a class="code" href="classWhittedIntegrator.html#r0">maxDepth</a> = md;
00023                 <a class="code" href="classWhittedIntegrator.html#r1">rayDepth</a> = 0;
00024         }
00025 <span class="keyword">private</span>:
00026         <span class="comment">// WhittedIntegrator Private Data</span>
<a name="l00027"></a><a class="code" href="classWhittedIntegrator.html#r0">00027</a>         <span class="keywordtype">int</span> <a class="code" href="classWhittedIntegrator.html#r0">maxDepth</a>;
<a name="l00028"></a><a class="code" href="classWhittedIntegrator.html#r1">00028</a>         <span class="keyword">mutable</span> <span class="keywordtype">int</span> <a class="code" href="classWhittedIntegrator.html#r1">rayDepth</a>;
00029 };
00030 <span class="comment">// WhittedIntegrator Method Definitions</span>
<a name="l00031"></a><a class="code" href="classWhittedIntegrator.html#a0">00031</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classWhittedIntegrator.html#a0">WhittedIntegrator::Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene,
00032                 <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray, <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample,
00033                 <span class="keywordtype">float</span> *alpha)<span class="keyword"> const </span>{
00034         <a class="code" href="structIntersection.html">Intersection</a> isect;
00035         <a class="code" href="classSpectrum.html">Spectrum</a> L(0.);
00036         <span class="keywordtype">bool</span> hitSomething;
00037         <span class="comment">// Search for ray-primitive intersection</span>
00038         hitSomething = scene-&gt;<a class="code" href="classScene.html#a3">Intersect</a>(ray, &amp;isect);
00039         <span class="keywordflow">if</span> (!hitSomething) {
00040                 <span class="comment">// Handle ray with no intersection</span>
00041                 <span class="keywordflow">if</span> (alpha) *alpha = 0.;
00042                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size(); ++i)
00043                         L += scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i]-&gt;Le(ray);
00044                 <span class="keywordflow">if</span> (alpha &amp;&amp; !L.<a class="code" href="classSpectrum.html#a15">Black</a>()) *alpha = 1.;
00045                 <span class="keywordflow">return</span> L;
00046         }
00047         <span class="keywordflow">else</span> {
00048                 <span class="comment">// Initialize _alpha_ for ray hit</span>
00049                 <span class="keywordflow">if</span> (alpha) *alpha = 1.;
00050                 <span class="comment">// Compute emitted and reflected light at ray intersection point</span>
00051                 <span class="comment">// Evaluate BSDF at hit point</span>
00052                 <a class="code" href="classBSDF.html">BSDF</a> *bsdf = isect.<a class="code" href="structIntersection.html#a1">GetBSDF</a>(ray);
00053                 <span class="comment">// Initialize common variables for Whitted integrator</span>
00054                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o0">p</a>;
00055                 <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00056                 <a class="code" href="classVector.html">Vector</a> wo = -ray.<a class="code" href="classRay.html#o1">d</a>;
00057                 <span class="comment">// Compute emitted light if ray hit an area light source</span>
00058                 L += isect.<a class="code" href="structIntersection.html#a2">Le</a>(wo);
00059                 <span class="comment">// Add contribution of each light source</span>
00060                 <a class="code" href="classVector.html">Vector</a> wi;
00061                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size(); ++i) {
00062                         <a class="code" href="structVisibilityTester.html">VisibilityTester</a> visibility;
00063                         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classWhittedIntegrator.html#a0">Li</a> = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i]-&gt;Sample_L(p, &amp;wi, &amp;visibility);
00064                         <span class="keywordflow">if</span> (Li.<a class="code" href="classSpectrum.html#a15">Black</a>()) <span class="keywordflow">continue</span>;
00065                         <a class="code" href="classSpectrum.html">Spectrum</a> f = bsdf-&gt;<a class="code" href="classBSDF.html#a10">f</a>(wo, wi);
00066                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>() &amp;&amp; visibility.<a class="code" href="structVisibilityTester.html#a2">Unoccluded</a>(scene))
00067                                 L += f * Li * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n) * visibility.<a class="code" href="structVisibilityTester.html#a3">Transmittance</a>(scene);
00068                 }
00069                 <span class="keywordflow">if</span> (<a class="code" href="classWhittedIntegrator.html#r1">rayDepth</a>++ &lt; <a class="code" href="classWhittedIntegrator.html#r0">maxDepth</a>) {
00070                         <span class="comment">// Trace rays for specular reflection and refraction</span>
00071                         <a class="code" href="classSpectrum.html">Spectrum</a> f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi,
00072                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a> | <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>));
00073                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00074                                 <span class="comment">// Compute ray differential _rd_ for specular reflection</span>
00075                                 <a class="code" href="classRayDifferential.html">RayDifferential</a> rd(p, wi);
00076                                 rd.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00077                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o9">dpdx</a>;
00078                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o10">dpdy</a>;
00079                                 <span class="comment">// Compute differential reflected directions</span>
00080                                 <a class="code" href="classNormal.html">Normal</a> dndx = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o11">dudx</a> +
00081                                         bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o12">dvdx</a>;
00082                                 <a class="code" href="classNormal.html">Normal</a> dndy = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o13">dudy</a> +
00083                                         bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o14">dvdy</a>;
00084                                 <a class="code" href="classVector.html">Vector</a> dwodx = -ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> - wo, dwody = -ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> - wo;
00085                                 <span class="keywordtype">float</span> dDNdx = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwodx, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndx);
00086                                 <span class="keywordtype">float</span> dDNdy = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwody, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndy);
00087                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> = wi -
00088                                           dwodx + 2 * <a class="code" href="classVector.html">Vector</a>(<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) * dndx +
00089                                                   dDNdx * n);
00090                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> = wi -
00091                                           dwody + 2 * Vector(<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) * dndy +
00092                                                   dDNdy * n);
00093                                 L += scene-&gt;<a class="code" href="classScene.html#a6">Li</a>(rd, sample) * f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n);
00094                         }
00095                         f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi,
00096                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a3">BSDF_TRANSMISSION</a> | <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>));
00097                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00098                                 <span class="comment">// Compute ray differential _rd_ for specular transmission</span>
00099                                 <a class="code" href="classRayDifferential.html">RayDifferential</a> rd(p, wi);
00100                                 rd.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00101                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o9">dpdx</a>;
00102                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o10">dpdy</a>;
00103                                 
00104                                 <span class="keywordtype">float</span> eta = bsdf-&gt;<a class="code" href="classBSDF.html#o1">eta</a>;
00105                                 <a class="code" href="classVector.html">Vector</a> w = -wo;
00106                                 <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) &lt; 0) eta = 1.f / eta;
00107                                 
00108                                 <a class="code" href="classNormal.html">Normal</a> dndx = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o11">dudx</a> + bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o12">dvdx</a>;
00109                                 <a class="code" href="classNormal.html">Normal</a> dndy = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o13">dudy</a> + bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o14">dvdy</a>;
00110                                 
00111                                 <a class="code" href="classVector.html">Vector</a> dwodx = -ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> - wo, dwody = -ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> - wo;
00112                                 <span class="keywordtype">float</span> dDNdx = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwodx, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndx);
00113                                 <span class="keywordtype">float</span> dDNdy = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwody, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndy);
00114                                 
00115                                 <span class="keywordtype">float</span> mu = eta * <a class="code" href="geometry_8h.html#a17">Dot</a>(w, n) - <a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n);
00116                                 <span class="keywordtype">float</span> dmudx = (eta - (eta*eta*<a class="code" href="geometry_8h.html#a17">Dot</a>(w,n))/<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n)) * dDNdx;
00117                                 <span class="keywordtype">float</span> dmudy = (eta - (eta*eta*<a class="code" href="geometry_8h.html#a17">Dot</a>(w,n))/<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n)) * dDNdy;
00118                                 
00119                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> = wi + eta * dwodx - <a class="code" href="classVector.html">Vector</a>(mu * dndx + dmudx * n);
00120                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> = wi + eta * dwody - Vector(mu * dndy + dmudy * n);
00121                                 L += scene-&gt;<a class="code" href="classScene.html#a6">Li</a>(rd, sample) * f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n);
00122                         }
00123                 }
00124                 --<a class="code" href="classWhittedIntegrator.html#r1">rayDepth</a>;
00125         }
00126         <span class="keywordflow">return</span> L;
00127 }
<a name="l00128"></a><a class="code" href="whitted_8cpp.html#a0">00128</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> *<a class="code" href="whitted_8cpp.html#a0">CreateSurfaceIntegrator</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params)
00129 {
00130         <span class="keywordtype">int</span> maxDepth = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"maxdepth"</span>, 5);
00131         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classWhittedIntegrator.html">WhittedIntegrator</a>(maxDepth);
00132 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:26 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
