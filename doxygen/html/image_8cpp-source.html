<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: image.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>image.cpp</h1><a href="image_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// image.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="film_8h.html">film.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="color_8h.html">color.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="tonemap_8h.html">tonemap.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="sampling_8h.html">sampling.h</a>"</span>
00018 <span class="comment">// ImageFilm Declarations</span>
<a name="l00019"></a><a class="code" href="classImageFilm.html">00019</a> <span class="keyword">class </span><a class="code" href="classImageFilm.html">ImageFilm</a> : <span class="keyword">public</span> <a class="code" href="classFilm.html">Film</a> {
00020 <span class="keyword">public</span>:
00021         <span class="comment">// ImageFilm Public Methods</span>
00022         <a class="code" href="classImageFilm.html#a0">ImageFilm::ImageFilm</a>(<span class="keywordtype">int</span> xres, <span class="keywordtype">int</span> yres,
00023                              <a class="code" href="classFilter.html">Filter</a> *filt, <span class="keyword">const</span> <span class="keywordtype">float</span> crop[4],
00024                                      <span class="keyword">const</span> string &amp;<a class="code" href="classImageFilm.html#r3">filename</a>, <span class="keywordtype">bool</span> premult,
00025                                      <span class="keywordtype">int</span> wf);
<a name="l00026"></a><a class="code" href="classImageFilm.html#a1">00026</a>         <a class="code" href="classImageFilm.html#a1">~ImageFilm</a>() {
00027                 <span class="keyword">delete</span> <a class="code" href="classImageFilm.html#r10">pixels</a>;
00028                 <span class="keyword">delete</span> <a class="code" href="classImageFilm.html#r0">filter</a>;
00029                 <span class="keyword">delete</span>[] <a class="code" href="classImageFilm.html#r11">filterTable</a>;
00030         }
00031         <span class="keywordtype">void</span> AddSample(<span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> &amp;sample, <span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray,
00032                        <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;L, <span class="keywordtype">float</span> alpha);
00033         <span class="keywordtype">void</span> GetSampleExtent(<span class="keywordtype">int</span> *xstart, <span class="keywordtype">int</span> *xend,
00034                              <span class="keywordtype">int</span> *ystart, <span class="keywordtype">int</span> *yend) <span class="keyword">const</span>;
00035         <span class="keywordtype">void</span> <a class="code" href="classImageFilm.html#a4">WriteImage</a>();
00036 <span class="keyword">private</span>:
00037         <span class="comment">// ImageFilm Private Data</span>
<a name="l00038"></a><a class="code" href="classImageFilm.html#r0">00038</a>         <a class="code" href="classFilter.html">Filter</a> *<a class="code" href="classImageFilm.html#r0">filter</a>;
<a name="l00039"></a><a class="code" href="classImageFilm.html#r1">00039</a>         <span class="keywordtype">int</span> <a class="code" href="classImageFilm.html#r1">writeFrequency</a>, <a class="code" href="classImageFilm.html#r2">sampleCount</a>;
<a name="l00040"></a><a class="code" href="classImageFilm.html#r3">00040</a>         string filename;
<a name="l00041"></a><a class="code" href="classImageFilm.html#r4">00041</a>         <span class="keywordtype">bool</span> <a class="code" href="classImageFilm.html#r4">premultiplyAlpha</a>;
<a name="l00042"></a><a class="code" href="classImageFilm.html#r5">00042</a>         <span class="keywordtype">float</span> <a class="code" href="classImageFilm.html#r5">cropWindow</a>[4];
<a name="l00043"></a><a class="code" href="classImageFilm.html#r7">00043</a>         <span class="keywordtype">int</span> <a class="code" href="classImageFilm.html#r6">xPixelStart</a>, <a class="code" href="classImageFilm.html#r7">yPixelStart</a>, <a class="code" href="classImageFilm.html#r8">xPixelCount</a>, <a class="code" href="classImageFilm.html#r9">yPixelCount</a>;
<a name="l00044"></a><a class="code" href="structImageFilm_1_1Pixel.html">00044</a>         <span class="keyword">struct </span><a class="code" href="structImageFilm_1_1Pixel.html">Pixel</a> {
<a name="l00045"></a><a class="code" href="structImageFilm_1_1Pixel.html#a0">00045</a>                 <a class="code" href="structImageFilm_1_1Pixel.html#a0">Pixel</a>() : <a class="code" href="structImageFilm_1_1Pixel.html#o0">L</a>(0.f) {
00046                         <a class="code" href="structImageFilm_1_1Pixel.html#o1">alpha</a> = 0.f;
00047                         <a class="code" href="structImageFilm_1_1Pixel.html#o2">weightSum</a> = 0.f;
00048                 }
<a name="l00049"></a><a class="code" href="structImageFilm_1_1Pixel.html#o0">00049</a>                 <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="structImageFilm_1_1Pixel.html#o0">L</a>;
<a name="l00050"></a><a class="code" href="structImageFilm_1_1Pixel.html#o2">00050</a>                 <span class="keywordtype">float</span> <a class="code" href="structImageFilm_1_1Pixel.html#o1">alpha</a>, <a class="code" href="structImageFilm_1_1Pixel.html#o2">weightSum</a>;
00051         };
<a name="l00052"></a><a class="code" href="classImageFilm.html#r10">00052</a>         <a class="code" href="classBlockedArray.html">BlockedArray&lt;Pixel&gt;</a> *<a class="code" href="classImageFilm.html#r10">pixels</a>;
<a name="l00053"></a><a class="code" href="classImageFilm.html#r11">00053</a>         <span class="keywordtype">float</span> *<a class="code" href="classImageFilm.html#r11">filterTable</a>;
00054 };
00055 <span class="comment">// ImageFilm Method Definitions</span>
<a name="l00056"></a><a class="code" href="classImageFilm.html#a0">00056</a> <a class="code" href="classImageFilm.html#a0">ImageFilm::ImageFilm</a>(<span class="keywordtype">int</span> xres, <span class="keywordtype">int</span> yres,
00057                      <a class="code" href="classFilter.html">Filter</a> *filt, <span class="keyword">const</span> <span class="keywordtype">float</span> crop[4],
00058                              <span class="keyword">const</span> string &amp;fn, <span class="keywordtype">bool</span> premult, <span class="keywordtype">int</span> wf)
00059         : <a class="code" href="classFilm.html">Film</a>(xres, yres) {
00060         <a class="code" href="classImageFilm.html#r0">filter</a> = filt;
00061         <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>(<a class="code" href="classImageFilm.html#r5">cropWindow</a>, crop, 4 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00062         <a class="code" href="classImageFilm.html#r3">filename</a> = fn;
00063         <a class="code" href="classImageFilm.html#r4">premultiplyAlpha</a> = premult;
00064         <a class="code" href="classImageFilm.html#r1">writeFrequency</a> = <a class="code" href="classImageFilm.html#r2">sampleCount</a> = wf;
00065         <span class="comment">// Compute film image extent</span>
00066         <a class="code" href="classImageFilm.html#r6">xPixelStart</a> = <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a>(xResolution * <a class="code" href="classImageFilm.html#r5">cropWindow</a>[0]);
00067         <a class="code" href="classImageFilm.html#r8">xPixelCount</a> =
00068                 max(1, <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a>(xResolution * cropWindow[1]) - <a class="code" href="classImageFilm.html#r6">xPixelStart</a>);
00069         <a class="code" href="classImageFilm.html#r7">yPixelStart</a> =
00070                 <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a>(yResolution * cropWindow[2]);
00071         <a class="code" href="classImageFilm.html#r9">yPixelCount</a> =
00072                 max(1, <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a>(yResolution * cropWindow[3]) - <a class="code" href="classImageFilm.html#r7">yPixelStart</a>);
00073         <span class="comment">// Allocate film image storage</span>
00074         <a class="code" href="classImageFilm.html#r10">pixels</a> = <span class="keyword">new</span> <a class="code" href="classBlockedArray.html">BlockedArray&lt;Pixel&gt;</a>(<a class="code" href="classImageFilm.html#r8">xPixelCount</a>, <a class="code" href="classImageFilm.html#r9">yPixelCount</a>);
00075         <span class="comment">// Precompute filter weight table</span>
00076 <span class="preprocessor">        #define FILTER_TABLE_SIZE 16</span>
00077 <span class="preprocessor"></span>        <a class="code" href="classImageFilm.html#r11">filterTable</a> =
00078                 <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a> * <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>];
00079         <span class="keywordtype">float</span> *ftp = <a class="code" href="classImageFilm.html#r11">filterTable</a>;
00080         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>; ++y) {
00081                 <span class="keywordtype">float</span> fy = ((<span class="keywordtype">float</span>)y + .5f) * <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o1">yWidth</a> /
00082                         <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>;
00083                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>; ++x) {
00084                         <span class="keywordtype">float</span> fx = ((<span class="keywordtype">float</span>)x + .5f) * <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o0">xWidth</a> /
00085                                 <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>;
00086                         *ftp++ = <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#a2">Evaluate</a>(fx, fy);
00087                 }
00088         }
00089 }
<a name="l00090"></a><a class="code" href="classImageFilm.html#a2">00090</a> <span class="keywordtype">void</span> <a class="code" href="classImageFilm.html#a2">ImageFilm::AddSample</a>(<span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> &amp;sample,
00091                 <span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;L, <span class="keywordtype">float</span> alpha) {
00092         <span class="comment">// Compute sample's raster extent</span>
00093         <span class="keywordtype">float</span> dImageX = sample.<a class="code" href="structSample.html#o0">imageX</a> - 0.5f;
00094         <span class="keywordtype">float</span> dImageY = sample.<a class="code" href="structSample.html#o1">imageY</a> - 0.5f;
00095         <span class="keywordtype">int</span> x0 = <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a> (dImageX - <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o0">xWidth</a>);
00096         <span class="keywordtype">int</span> x1 = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(dImageX + <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o0">xWidth</a>);
00097         <span class="keywordtype">int</span> y0 = <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a> (dImageY - <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o1">yWidth</a>);
00098         <span class="keywordtype">int</span> y1 = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(dImageY + <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o1">yWidth</a>);
00099         x0 = max(x0, <a class="code" href="classImageFilm.html#r6">xPixelStart</a>);
00100         x1 = min(x1, <a class="code" href="classImageFilm.html#r6">xPixelStart</a> + <a class="code" href="classImageFilm.html#r8">xPixelCount</a> - 1);
00101         y0 = max(y0, <a class="code" href="classImageFilm.html#r7">yPixelStart</a>);
00102         y1 = min(y1, <a class="code" href="classImageFilm.html#r7">yPixelStart</a> + <a class="code" href="classImageFilm.html#r9">yPixelCount</a> - 1);
00103         <span class="comment">// Loop over filter support and add sample to pixel arrays</span>
00104         <span class="comment">// Precompute $x$ and $y$ filter table offsets</span>
00105         <span class="keywordtype">int</span> *ifx = (<span class="keywordtype">int</span> *)alloca((x1-x0+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00106         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = x0; x &lt;= x1; ++x) {
00107                 <span class="keywordtype">float</span> fx = fabsf((x - dImageX) *
00108                                  <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o2">invXWidth</a> * <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>);
00109                 ifx[x-x0] = min(<a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(fx), <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>-1);
00110         }
00111         <span class="keywordtype">int</span> *ify = (<span class="keywordtype">int</span> *)alloca((y1-y0+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00112         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = y0; y &lt;= y1; ++y) {
00113                 <span class="keywordtype">float</span> fy = fabsf((y - dImageY) *
00114                                  <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o3">invYWidth</a> * <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>);
00115                 ify[y-y0] = min(<a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(fy), <a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a>-1);
00116         }
00117         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = y0; y &lt;= y1; ++y)
00118                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = x0; x &lt;= x1; ++x) {
00119                         <span class="comment">// Evaluate filter value at $(x,y)$ pixel</span>
00120                         <span class="keywordtype">int</span> offset = ify[y-y0]*<a class="code" href="image_8cpp.html#a0">FILTER_TABLE_SIZE</a> + ifx[x-x0];
00121                         <span class="keywordtype">float</span> filterWt = <a class="code" href="classImageFilm.html#r11">filterTable</a>[offset];
00122                         <span class="comment">// Update pixel values with filtered sample contribution</span>
00123                         <a class="code" href="structImageFilm_1_1Pixel.html">Pixel</a> &amp;pixel = (*pixels)(x - <a class="code" href="classImageFilm.html#r6">xPixelStart</a>, y - <a class="code" href="classImageFilm.html#r7">yPixelStart</a>);
00124                         pixel.<a class="code" href="structImageFilm_1_1Pixel.html#o0">L</a>.<a class="code" href="classSpectrum.html#a12">AddWeighted</a>(filterWt, L);
00125                         pixel.<a class="code" href="structImageFilm_1_1Pixel.html#o1">alpha</a> += alpha * filterWt;
00126                         pixel.<a class="code" href="structImageFilm_1_1Pixel.html#o2">weightSum</a> += filterWt;
00127                 }
00128         <span class="comment">// Possibly write out in-progress image</span>
00129         <span class="keywordflow">if</span> (--<a class="code" href="classImageFilm.html#r2">sampleCount</a> == 0) {
00130                 <a class="code" href="classImageFilm.html#a4">WriteImage</a>();
00131                 <a class="code" href="classImageFilm.html#r2">sampleCount</a> = <a class="code" href="classImageFilm.html#r1">writeFrequency</a>;
00132         }
00133 }
<a name="l00134"></a><a class="code" href="classImageFilm.html#a3">00134</a> <span class="keywordtype">void</span> <a class="code" href="classImageFilm.html#a3">ImageFilm::GetSampleExtent</a>(<span class="keywordtype">int</span> *xstart,
00135                 <span class="keywordtype">int</span> *xend, <span class="keywordtype">int</span> *ystart, <span class="keywordtype">int</span> *yend)<span class="keyword"> const </span>{
00136         *xstart = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(<a class="code" href="classImageFilm.html#r6">xPixelStart</a> + .5f - <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o0">xWidth</a>);
00137         *xend   = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(<a class="code" href="classImageFilm.html#r6">xPixelStart</a> + .5f + <a class="code" href="classImageFilm.html#r8">xPixelCount</a>  +
00138                 <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o0">xWidth</a>);
00139         *ystart = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(<a class="code" href="classImageFilm.html#r7">yPixelStart</a> + .5f - <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o1">yWidth</a>);
00140         *yend   = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(<a class="code" href="classImageFilm.html#r7">yPixelStart</a> + .5f + <a class="code" href="classImageFilm.html#r9">yPixelCount</a> +
00141                 <a class="code" href="classImageFilm.html#r0">filter</a>-&gt;<a class="code" href="classFilter.html#o1">yWidth</a>);
00142 }
<a name="l00143"></a><a class="code" href="classImageFilm.html#a4">00143</a> <span class="keywordtype">void</span> <a class="code" href="classImageFilm.html#a4">ImageFilm::WriteImage</a>() {
00144         <span class="comment">// Convert image to RGB and compute final pixel values</span>
00145         <span class="keywordtype">int</span> nPix = <a class="code" href="classImageFilm.html#r8">xPixelCount</a> * <a class="code" href="classImageFilm.html#r9">yPixelCount</a>;
00146         <span class="keywordtype">float</span> *rgb = <span class="keyword">new</span> <span class="keywordtype">float</span>[3*nPix], *alpha = <span class="keyword">new</span> <span class="keywordtype">float</span>[nPix];
00147         <span class="keywordtype">int</span> offset = 0;
00148         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; yPixelCount; ++y) {
00149                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="classImageFilm.html#r8">xPixelCount</a>; ++x) {
00150                         <span class="comment">// Convert pixel spectral radiance to RGB</span>
00151                         <span class="keywordtype">float</span> xyz[3];
00152                         (*pixels)(x, y).L.XYZ(xyz);
00153                         <span class="keyword">const</span> <span class="keywordtype">float</span>
00154                                 rWeight[3] = { 3.240479f, -1.537150f, -0.498535f };
00155                         <span class="keyword">const</span> <span class="keywordtype">float</span>
00156                                 gWeight[3] = {-0.969256f,  1.875991f,  0.041556f };
00157                         <span class="keyword">const</span> <span class="keywordtype">float</span>
00158                                 bWeight[3] = { 0.055648f, -0.204043f,  1.057311f };
00159                         rgb[3*offset  ] = rWeight[0]*xyz[0] +
00160                                           rWeight[1]*xyz[1] +
00161                                               rWeight[2]*xyz[2];
00162                         rgb[3*offset+1] = gWeight[0]*xyz[0] +
00163                                           gWeight[1]*xyz[1] +
00164                                               gWeight[2]*xyz[2];
00165                         rgb[3*offset+2] = bWeight[0]*xyz[0] +
00166                                           bWeight[1]*xyz[1] +
00167                                               bWeight[2]*xyz[2];
00168                         alpha[offset] = (*pixels)(x, y).alpha;
00169                         <span class="comment">// Normalize pixel with weight sum</span>
00170                         <span class="keywordtype">float</span> weightSum = (*pixels)(x, y).weightSum;
00171                         <span class="keywordflow">if</span> (weightSum != 0.f) {
00172                                 <span class="keywordtype">float</span> invWt = 1.f / weightSum;
00173                                 rgb[3*offset  ] =
00174                                         <a class="code" href="pbrt_8h.html#a96">Clamp</a>(rgb[3*offset  ] * invWt, 0.f, <a class="code" href="pbrt_8h.html#a9">INFINITY</a>);
00175                                 rgb[3*offset+1] =
00176                                         <a class="code" href="pbrt_8h.html#a96">Clamp</a>(rgb[3*offset+1] * invWt, 0.f, <a class="code" href="pbrt_8h.html#a9">INFINITY</a>);
00177                                 rgb[3*offset+2] =
00178                                         <a class="code" href="pbrt_8h.html#a96">Clamp</a>(rgb[3*offset+2] * invWt, 0.f, <a class="code" href="pbrt_8h.html#a9">INFINITY</a>);
00179                                 alpha[offset] = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(alpha[offset] * invWt, 0.f, 1.f);
00180                         }
00181                         <span class="comment">// Compute premultiplied alpha color</span>
00182                         <span class="keywordflow">if</span> (<a class="code" href="classImageFilm.html#r4">premultiplyAlpha</a>) {
00183                                 rgb[3*offset  ] *= alpha[offset];
00184                                 rgb[3*offset+1] *= alpha[offset];
00185                                 rgb[3*offset+2] *= alpha[offset];
00186                         }
00187                         ++offset;
00188                 }
00189         }
00190         <span class="comment">// Write RGBA image</span>
00191         <a class="code" href="pbrt_8h.html#a71">WriteRGBAImage</a>(<a class="code" href="classImageFilm.html#r3">filename</a>, rgb, alpha,
00192                 <a class="code" href="classImageFilm.html#r8">xPixelCount</a>, yPixelCount,
00193                 xResolution, yResolution,
00194                 <a class="code" href="classImageFilm.html#r6">xPixelStart</a>, <a class="code" href="classImageFilm.html#r7">yPixelStart</a>);
00195         <span class="comment">// Release temporary image memory</span>
00196         <span class="keyword">delete</span>[] alpha;
00197         <span class="keyword">delete</span>[] rgb;
00198 }
<a name="l00199"></a><a class="code" href="image_8cpp.html#a1">00199</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classFilm.html">Film</a> *<a class="code" href="image_8cpp.html#a1">CreateFilm</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params, <a class="code" href="classFilter.html">Filter</a> *filter)
00200 {
00201         string filename = params.<a class="code" href="classParamSet.html#a28">FindOneString</a>(<span class="stringliteral">"filename"</span>, <span class="stringliteral">"pbrt.exr"</span>);
00202         <span class="keywordtype">bool</span> premultiplyAlpha = params.<a class="code" href="classParamSet.html#a23">FindOneBool</a>(<span class="stringliteral">"premultiplyalpha"</span>, <span class="keyword">true</span>);
00203 
00204         <span class="keywordtype">int</span> xres = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"xresolution"</span>, 640);
00205         <span class="keywordtype">int</span> yres = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"yresolution"</span>, 480);
00206         <span class="keywordtype">float</span> crop[4] = { 0, 1, 0, 1 };
00207         <span class="keywordtype">int</span> cwi;
00208         <span class="keyword">const</span> <span class="keywordtype">float</span> *cr = params.<a class="code" href="classParamSet.html#a30">FindFloat</a>(<span class="stringliteral">"cropwindow"</span>, &amp;cwi);
00209         <span class="keywordflow">if</span> (cr &amp;&amp; cwi == 4) {
00210                 crop[0] = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(min(cr[0], cr[1]), 0., 1.);
00211                 crop[1] = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(max(cr[0], cr[1]), 0., 1.);
00212                 crop[2] = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(min(cr[2], cr[3]), 0., 1.);
00213                 crop[3] = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(max(cr[2], cr[3]), 0., 1.);
00214         }
00215         <span class="keywordtype">int</span> writeFrequency = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"writefrequency"</span>, -1);
00216 
00217         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classImageFilm.html">ImageFilm</a>(xres, yres, filter, crop,
00218                 filename, premultiplyAlpha, writeFrequency);
00219 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:21 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
