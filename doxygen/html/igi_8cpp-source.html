<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: igi.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>igi.cpp</h1><a href="igi_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// igi.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="transport_8h.html">transport.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="scene_8h.html">scene.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="mc_8h.html">mc.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="sampling_8h.html">sampling.h</a>"</span>
00017 
00018 <span class="comment">// IGI Local Structures</span>
<a name="l00019"></a><a class="code" href="structVirtualLight.html">00019</a> <span class="keyword">struct </span><a class="code" href="structVirtualLight.html">VirtualLight</a> {
<a name="l00020"></a><a class="code" href="structVirtualLight.html#a0">00020</a>         <a class="code" href="structVirtualLight.html#a0">VirtualLight</a>() { }
<a name="l00021"></a><a class="code" href="structVirtualLight.html#a1">00021</a>         <a class="code" href="structVirtualLight.html#a0">VirtualLight</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;pp, <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;nn, <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;le)
00022                 : <a class="code" href="structVirtualLight.html#o0">p</a>(pp), <a class="code" href="structVirtualLight.html#o1">n</a>(nn), <a class="code" href="structVirtualLight.html#o2">Le</a>(le) { }
<a name="l00023"></a><a class="code" href="structVirtualLight.html#o0">00023</a>         <a class="code" href="classPoint.html">Point</a> <a class="code" href="structVirtualLight.html#o0">p</a>;
<a name="l00024"></a><a class="code" href="structVirtualLight.html#o1">00024</a>         <a class="code" href="classNormal.html">Normal</a> <a class="code" href="structVirtualLight.html#o1">n</a>;
<a name="l00025"></a><a class="code" href="structVirtualLight.html#o2">00025</a>         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="structVirtualLight.html#o2">Le</a>;
00026 };
00027 
<a name="l00028"></a><a class="code" href="classIGIIntegrator.html">00028</a> <span class="keyword">class </span><a class="code" href="classIGIIntegrator.html">IGIIntegrator</a> : <span class="keyword">public</span> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> {
00029 <span class="keyword">public</span>:
00030         <span class="comment">// IGIIntegrator Public Methods</span>
00031         <a class="code" href="classIGIIntegrator.html">IGIIntegrator</a>(<span class="keywordtype">int</span> nl, <span class="keywordtype">int</span> ns, <span class="keywordtype">float</span> md, <span class="keywordtype">float</span> rrt, <span class="keywordtype">float</span> is);
00032         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classIGIIntegrator.html#a1">Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray,
00033                 <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keywordtype">float</span> *alpha) <span class="keyword">const</span>;
00034         <span class="keywordtype">void</span> <a class="code" href="classIGIIntegrator.html#a2">RequestSamples</a>(<a class="code" href="structSample.html">Sample</a> *sample, <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene);
00035         <span class="keywordtype">void</span> <a class="code" href="classIGIIntegrator.html#a3">Preprocess</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *);
00036 
00037 <span class="keyword">private</span>:
00038         <span class="comment">// IGI Private Data</span>
<a name="l00039"></a><a class="code" href="classIGIIntegrator.html#r1">00039</a>         <a class="code" href="pbrt_8h.html#a51">u_int</a> <a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a>, <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>;
<a name="l00040"></a><a class="code" href="classIGIIntegrator.html#r2">00040</a>         vector&lt;VirtualLight&gt; *<a class="code" href="classIGIIntegrator.html#r2">virtualLights</a>;
<a name="l00041"></a><a class="code" href="classIGIIntegrator.html#r3">00041</a>         <span class="keyword">mutable</span> <span class="keywordtype">int</span> <a class="code" href="classIGIIntegrator.html#r3">specularDepth</a>;
<a name="l00042"></a><a class="code" href="classIGIIntegrator.html#r4">00042</a>         <span class="keywordtype">int</span> <a class="code" href="classIGIIntegrator.html#r4">maxSpecularDepth</a>;
<a name="l00043"></a><a class="code" href="classIGIIntegrator.html#r6">00043</a>         <span class="keywordtype">float</span> <a class="code" href="classIGIIntegrator.html#r5">minDist2</a>, <a class="code" href="classIGIIntegrator.html#r6">rrThreshold</a>, <a class="code" href="classIGIIntegrator.html#r7">indirectScale</a>;
<a name="l00044"></a><a class="code" href="classIGIIntegrator.html#r8">00044</a>         <span class="keywordtype">int</span> <a class="code" href="classIGIIntegrator.html#r8">vlSetOffset</a>;
00045 
<a name="l00046"></a><a class="code" href="classIGIIntegrator.html#r9">00046</a>         <span class="keywordtype">int</span> *<a class="code" href="classIGIIntegrator.html#r9">lightSampleOffset</a>, <a class="code" href="classIGIIntegrator.html#r10">lightNumOffset</a>;
<a name="l00047"></a><a class="code" href="classIGIIntegrator.html#r11">00047</a>         <span class="keywordtype">int</span> *<a class="code" href="classIGIIntegrator.html#r11">bsdfSampleOffset</a>, *<a class="code" href="classIGIIntegrator.html#r12">bsdfComponentOffset</a>;
00048 };
00049 
00050 <span class="comment">// IGIIntegrator Implementation</span>
<a name="l00051"></a><a class="code" href="classIGIIntegrator.html#a0">00051</a> <a class="code" href="classIGIIntegrator.html#a0">IGIIntegrator::IGIIntegrator</a>(<span class="keywordtype">int</span> nl, <span class="keywordtype">int</span> ns, <span class="keywordtype">float</span> md,
00052                 <span class="keywordtype">float</span> rrt, <span class="keywordtype">float</span> is) {
00053         <a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a> = <a class="code" href="pbrt_8h.html#a103">RoundUpPow2</a>((<a class="code" href="pbrt_8h.html#a51">u_int</a>)nl);
00054         <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a> = <a class="code" href="pbrt_8h.html#a103">RoundUpPow2</a>((<a class="code" href="pbrt_8h.html#a51">u_int</a>)ns);
00055         <a class="code" href="classIGIIntegrator.html#r5">minDist2</a> = md * md;
00056         <a class="code" href="classIGIIntegrator.html#r6">rrThreshold</a> = rrt;
00057         <a class="code" href="classIGIIntegrator.html#r7">indirectScale</a> = is;
00058         <a class="code" href="classIGIIntegrator.html#r4">maxSpecularDepth</a> = 5;
00059         <a class="code" href="classIGIIntegrator.html#r3">specularDepth</a> = 0;
00060         <a class="code" href="classIGIIntegrator.html#r2">virtualLights</a> = <span class="keyword">new</span> vector&lt;VirtualLight&gt;[<a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>];
00061 }
<a name="l00062"></a><a class="code" href="classIGIIntegrator.html#a2">00062</a> <span class="keywordtype">void</span> <a class="code" href="classIGIIntegrator.html#a2">IGIIntegrator::RequestSamples</a>(<a class="code" href="structSample.html">Sample</a> *sample,
00063                                    <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene) {
00064         <span class="comment">// Request samples for area light sampling</span>
00065         <a class="code" href="pbrt_8h.html#a51">u_int</a> nLights = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size();
00066         <a class="code" href="classIGIIntegrator.html#r9">lightSampleOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00067         <a class="code" href="classIGIIntegrator.html#r11">bsdfSampleOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00068         <a class="code" href="classIGIIntegrator.html#r12">bsdfComponentOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00069         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; nLights; ++i) {
00070                 <span class="keyword">const</span> <a class="code" href="classLight.html">Light</a> *light = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i];
00071                 <span class="keywordtype">int</span> lightSamples =
00072                         scene-&gt;<a class="code" href="classScene.html#o6">sampler</a>-&gt;<a class="code" href="classSampler.html#a4">RoundSize</a>(light-&gt;<a class="code" href="classLight.html#o0">nSamples</a>);
00073                 <a class="code" href="classIGIIntegrator.html#r9">lightSampleOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(lightSamples);
00074                 <a class="code" href="classIGIIntegrator.html#r11">bsdfSampleOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(lightSamples);
00075                 <a class="code" href="classIGIIntegrator.html#r12">bsdfComponentOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(lightSamples);
00076         }
00077         <a class="code" href="classIGIIntegrator.html#r10">lightNumOffset</a> = -1;
00078         <a class="code" href="classIGIIntegrator.html#r8">vlSetOffset</a> = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(1);
00079 }
<a name="l00080"></a><a class="code" href="classIGIIntegrator.html#a3">00080</a> <span class="keywordtype">void</span> <a class="code" href="classIGIIntegrator.html#a3">IGIIntegrator::Preprocess</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene) {
00081         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size() == 0) <span class="keywordflow">return</span>;
00082         <span class="comment">// Compute samples for emitted rays from lights</span>
00083         <span class="keywordtype">float</span> *lightNum = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a> * <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>];
00084         <span class="keywordtype">float</span> *lightSamp0 = <span class="keyword">new</span> <span class="keywordtype">float</span>[2 * <a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a> * <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>];
00085         <span class="keywordtype">float</span> *lightSamp1 = <span class="keyword">new</span> <span class="keywordtype">float</span>[2 * <a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a> * <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>];
00086         <a class="code" href="sampling_8h.html#a10">LDShuffleScrambled1D</a>(<a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a>, <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>, lightNum);
00087         <a class="code" href="sampling_8h.html#a11">LDShuffleScrambled2D</a>(<a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a>, <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>, lightSamp0);
00088         <a class="code" href="sampling_8h.html#a11">LDShuffleScrambled2D</a>(<a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a>, <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>, lightSamp1);
00089         <span class="comment">// Precompute information for light sampling densities</span>
00090         <span class="keywordtype">int</span> nLights = int(scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size());
00091         <span class="keywordtype">float</span> *lightPower = (<span class="keywordtype">float</span> *)alloca(nLights * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00092         <span class="keywordtype">float</span> *lightCDF = (<span class="keywordtype">float</span> *)alloca((nLights+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00093         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nLights; ++i)
00094                 lightPower[i] = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i]-&gt;Power(scene).y();
00095         <span class="keywordtype">float</span> totalPower;
00096         <a class="code" href="pbrt_8h.html#a89">ComputeStep1dCDF</a>(lightPower, nLights, &amp;totalPower, lightCDF);
00097         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> s = 0; s &lt; <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>; ++s) {
00098                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classIGIIntegrator.html#r0">nLightPaths</a>; ++i) {
00099                         <span class="comment">// Follow path _i_ from light to create virtual lights</span>
00100                         <span class="keywordtype">int</span> sampOffset = s*nLightPaths + i;
00101                         <span class="comment">// Choose light source to trace path from</span>
00102                         <span class="keywordtype">float</span> lightPdf;
00103                         <span class="keywordtype">int</span> lNum = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(<a class="code" href="pbrt_8h.html#a90">SampleStep1d</a>(lightPower, lightCDF,
00104                                 totalPower, nLights, lightNum[sampOffset], &amp;lightPdf) * nLights);
00105                         fprintf(stderr, <span class="stringliteral">"samp %f -&gt; num %d\n"</span>, lightNum[sampOffset], lNum);
00106                         <a class="code" href="classLight.html">Light</a> *light = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[lNum];
00107                         <span class="comment">// Sample ray leaving light source</span>
00108                         <a class="code" href="classRayDifferential.html">RayDifferential</a> ray;
00109                         <span class="keywordtype">float</span> pdf;
00110                         <a class="code" href="classSpectrum.html">Spectrum</a> alpha =
00111                                 light-&gt;<a class="code" href="classLight.html#a2">Sample_L</a>(scene, lightSamp0[2*sampOffset],
00112                                                 lightSamp0[2*sampOffset+1],
00113                                                 lightSamp1[2*sampOffset],
00114                                                 lightSamp1[2*sampOffset+1],
00115                                                 &amp;ray, &amp;pdf);
00116                         <span class="keywordflow">if</span> (pdf == 0.f || alpha.<a class="code" href="classSpectrum.html#a15">Black</a>()) <span class="keywordflow">continue</span>;
00117                         alpha /= pdf * lightPdf;
00118                         fprintf(stderr, <span class="stringliteral">"initial alpha %f, light # %d\n"</span>, alpha.<a class="code" href="classSpectrum.html#a23">y</a>(), lNum);
00119                         <a class="code" href="structIntersection.html">Intersection</a> isect;
00120                         <span class="keywordtype">int</span> nIntersections = 0;
00121                         <span class="keywordflow">while</span> (scene-&gt;<a class="code" href="classScene.html#a3">Intersect</a>(ray, &amp;isect) &amp;&amp; !alpha.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00122                                 ++nIntersections;
00123                                 alpha *= scene-&gt;<a class="code" href="classScene.html#a7">Transmittance</a>(ray);
00124                                 <a class="code" href="classVector.html">Vector</a> wo = -ray.<a class="code" href="classRay.html#o1">d</a>;
00125                                 <a class="code" href="classBSDF.html">BSDF</a> *bsdf = isect.<a class="code" href="structIntersection.html#a1">GetBSDF</a>(ray);
00126                                 <span class="comment">// Create virtual light at ray intersection point</span>
00127                                 <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> vls(<span class="stringliteral">"IGI Integrator"</span>, <span class="stringliteral">"Virtual Lights Created"</span>); <span class="comment">//NOBOOK</span>
00128                                 ++vls; <span class="comment">//NOBOOK</span>
00129                                 <a class="code" href="classSpectrum.html">Spectrum</a> Le = alpha * bsdf-&gt;<a class="code" href="classBSDF.html#a11">rho</a>(wo) / <a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00130                                 fprintf(stderr, <span class="stringliteral">"\tmade light with le y %f\n"</span>, Le.<a class="code" href="classSpectrum.html#a23">y</a>());
00131                                 <a class="code" href="classIGIIntegrator.html#r2">virtualLights</a>[s].push_back(<a class="code" href="structVirtualLight.html">VirtualLight</a>(isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o0">p</a>, isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>, Le));
00132                                 <span class="comment">// Sample new ray direction and update weight</span>
00133                                 <a class="code" href="classVector.html">Vector</a> wi;
00134                                 <span class="keywordtype">float</span> pdf;
00135                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a> flags;
00136                                 <a class="code" href="classSpectrum.html">Spectrum</a> fr = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi, <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(),
00137                                                                  <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(), <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(),
00138                                                                  &amp;pdf, <a class="code" href="reflection_8h.html#a17a10">BSDF_ALL</a>, &amp;flags);
00139                                 <span class="keywordflow">if</span> (fr.<a class="code" href="classSpectrum.html#a15">Black</a>() || pdf == 0.f)
00140                                         <span class="keywordflow">break</span>;
00141                                 <a class="code" href="classSpectrum.html">Spectrum</a> anew = alpha * fr * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>) / pdf;
00142                                 <span class="keywordtype">float</span> r = anew.<a class="code" href="classSpectrum.html#a23">y</a>() / alpha.<a class="code" href="classSpectrum.html#a23">y</a>();
00143                                 fprintf(stderr, <span class="stringliteral">"\tr = %f\n"</span>, r);
00144                                 <span class="keywordflow">if</span> (<a class="code" href="pbrt_8h.html#a108">RandomFloat</a>() &gt; r)
00145                                         <span class="keywordflow">break</span>;
00146                                 alpha = anew / r;
00147                                 fprintf(stderr, <span class="stringliteral">"\tnew alpha %f\n"</span>, alpha.<a class="code" href="classSpectrum.html#a23">y</a>());
00148                                 ray = <a class="code" href="classRayDifferential.html">RayDifferential</a>(isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o0">p</a>, wi);
00149                         }
00150                         <a class="code" href="classBSDF.html#e1">BSDF::FreeAll</a>();
00151                 }
00152         }
00153         <span class="keyword">delete</span>[] lightNum; <span class="comment">// NOBOOK</span>
00154         <span class="keyword">delete</span>[] lightSamp0; <span class="comment">// NOBOOK</span>
00155         <span class="keyword">delete</span>[] lightSamp1; <span class="comment">// NOBOOK</span>
00156 }
<a name="l00157"></a><a class="code" href="classIGIIntegrator.html#a1">00157</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classIGIIntegrator.html#a1">IGIIntegrator::Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene,
00158                 <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray, <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample,
00159                    <span class="keywordtype">float</span> *alpha)<span class="keyword"> const </span>{
00160         <a class="code" href="classSpectrum.html">Spectrum</a> L(0.);
00161         <a class="code" href="structIntersection.html">Intersection</a> isect;
00162         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="classScene.html#a3">Intersect</a>(ray, &amp;isect)) {
00163                 <span class="keywordflow">if</span> (alpha) *alpha = 1.;
00164                 <a class="code" href="classVector.html">Vector</a> wo = -ray.<a class="code" href="classRay.html#o1">d</a>;
00165                 <span class="comment">// Compute emitted light if ray hit an area light source</span>
00166                 L += isect.<a class="code" href="structIntersection.html#a2">Le</a>(wo);
00167                 <span class="comment">// Evaluate BSDF at hit point</span>
00168                 <a class="code" href="classBSDF.html">BSDF</a> *bsdf = isect.<a class="code" href="structIntersection.html#a1">GetBSDF</a>(ray);
00169                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o0">p</a>;
00170                 <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00171                 L += <a class="code" href="transport_8h.html#a0">UniformSampleAllLights</a>(scene, p, n,
00172                                             wo, bsdf, sample,
00173                                             <a class="code" href="classIGIIntegrator.html#r9">lightSampleOffset</a>, <a class="code" href="classIGIIntegrator.html#r11">bsdfSampleOffset</a>,
00174                                             <a class="code" href="classIGIIntegrator.html#r12">bsdfComponentOffset</a>);
00175                 <span class="comment">// Compute indirect illumination with virtual lights</span>
00176                 <a class="code" href="pbrt_8h.html#a51">u_int</a> lSet = min(<a class="code" href="pbrt_8h.html#a51">u_int</a>(sample-&gt;<a class="code" href="structSample.html#o7">oneD</a>[<a class="code" href="classIGIIntegrator.html#r8">vlSetOffset</a>][0] * <a class="code" href="classIGIIntegrator.html#r1">nLightSets</a>),
00177                                  nLightSets-1);
00178                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classIGIIntegrator.html#r2">virtualLights</a>[lSet].size(); ++i) {
00179                         <span class="keyword">const</span> <a class="code" href="structVirtualLight.html">VirtualLight</a> &amp;vl = virtualLights[lSet][i];
00180                         <span class="comment">// Add contribution from _VirtualLight_ _vl_</span>
00181                         <span class="comment">// Ignore light if it's too close to current point</span>
00182                         <span class="keywordtype">float</span> d2 = <a class="code" href="geometry_8h.html#a10">DistanceSquared</a>(p, vl.<a class="code" href="structVirtualLight.html#o0">p</a>);
00183                         <span class="comment">//if (d2 &lt; .8 * minDist2) continue;</span>
00184                         <span class="keywordtype">float</span> distScale = <a class="code" href="pbrt_8h.html#a111">SmoothStep</a>(.8 * <a class="code" href="classIGIIntegrator.html#r5">minDist2</a>, 1.2 * <a class="code" href="classIGIIntegrator.html#r5">minDist2</a>, d2);
00185                         <span class="comment">// Compute virtual light's tentative contribution _Llight_</span>
00186                         <a class="code" href="classVector.html">Vector</a> wi = <a class="code" href="geometry_8h.html#a14">Normalize</a>(vl.<a class="code" href="structVirtualLight.html#o0">p</a> - p);
00187                         <a class="code" href="classSpectrum.html">Spectrum</a> f = distScale * bsdf-&gt;<a class="code" href="classBSDF.html#a10">f</a>(wo, wi);
00188                         <span class="keywordflow">if</span> (f.<a class="code" href="classSpectrum.html#a15">Black</a>()) <span class="keywordflow">continue</span>;
00189                         <span class="keywordtype">float</span> G = <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n) * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, vl.<a class="code" href="structVirtualLight.html#o1">n</a>) / d2;
00190                         <a class="code" href="classSpectrum.html">Spectrum</a> Llight = <a class="code" href="classIGIIntegrator.html#r7">indirectScale</a> * f * G * vl.<a class="code" href="structVirtualLight.html#o2">Le</a> /
00191                                 virtualLights[lSet].size();
00192                         Llight *= scene-&gt;<a class="code" href="classScene.html#a7">Transmittance</a>(<a class="code" href="classRay.html">Ray</a>(p, vl.<a class="code" href="structVirtualLight.html#o0">p</a> - p));
00193                         <span class="comment">// Possibly skip shadow ray with Russian roulette</span>
00194                         <span class="keywordflow">if</span> (Llight.<a class="code" href="classSpectrum.html#a23">y</a>() &lt; <a class="code" href="classIGIIntegrator.html#r6">rrThreshold</a>) {
00195                                 <span class="keywordtype">float</span> continueProbability = .1f;
00196                                 <span class="keywordflow">if</span> (<a class="code" href="pbrt_8h.html#a108">RandomFloat</a>() &gt; continueProbability)
00197                                         <span class="keywordflow">continue</span>;
00198                                 Llight /= continueProbability;
00199                         }
00200                         <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> vlsr(<span class="stringliteral">"IGI Integrator"</span>, <span class="stringliteral">"Shadow Rays to Virtual Lights"</span>); <span class="comment">//NOBOOK</span>
00201                         ++vlsr; <span class="comment">//NOBOOK</span>
00202                         <span class="keywordflow">if</span> (!scene-&gt;<a class="code" href="classScene.html#a4">IntersectP</a>(<a class="code" href="classRay.html">Ray</a>(p, vl.<a class="code" href="structVirtualLight.html#o0">p</a> - p, <a class="code" href="pbrt_8h.html#a11">RAY_EPSILON</a>,
00203                                         1.f - <a class="code" href="pbrt_8h.html#a11">RAY_EPSILON</a>)))
00204                                 L += Llight;
00205                 }
00206                 <span class="comment">// Trace rays for specular reflection and refraction</span>
00207                 <span class="keywordflow">if</span> (<a class="code" href="classIGIIntegrator.html#r3">specularDepth</a>++ &lt; <a class="code" href="classIGIIntegrator.html#r4">maxSpecularDepth</a>) {
00208                         <a class="code" href="classVector.html">Vector</a> wi;
00209                         <span class="comment">// Trace rays for specular reflection and refraction</span>
00210                         <a class="code" href="classSpectrum.html">Spectrum</a> f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi,
00211                                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a> | <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>));
00212                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00213                                 <span class="comment">// Compute ray differential _rd_ for specular reflection</span>
00214                                 <a class="code" href="classRayDifferential.html">RayDifferential</a> rd(p, wi);
00215                                 rd.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00216                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o9">dpdx</a>;
00217                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o10">dpdy</a>;
00218                                 <span class="comment">// Compute differential reflected directions</span>
00219                                 <a class="code" href="classNormal.html">Normal</a> dndx = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o11">dudx</a> +
00220                                         bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o12">dvdx</a>;
00221                                 <a class="code" href="classNormal.html">Normal</a> dndy = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o13">dudy</a> +
00222                                         bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o14">dvdy</a>;
00223                                 <a class="code" href="classVector.html">Vector</a> dwodx = -ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> - wo, dwody = -ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> - wo;
00224                                 <span class="keywordtype">float</span> dDNdx = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwodx, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndx);
00225                                 <span class="keywordtype">float</span> dDNdy = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwody, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndy);
00226                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> = wi -
00227                                         dwodx + 2 * <a class="code" href="classVector.html">Vector</a>(<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) * dndx +
00228                                                  dDNdx * n);
00229                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> = wi -
00230                                         dwody + 2 * Vector(<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) * dndy +
00231                                                  dDNdy * n);
00232                                 L += scene-&gt;<a class="code" href="classScene.html#a6">Li</a>(rd, sample) * f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n);
00233                         }
00234                         f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi,
00235                                            <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a3">BSDF_TRANSMISSION</a> | <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>));
00236                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00237                                 <span class="comment">// Compute ray differential _rd_ for specular transmission</span>
00238                                 <a class="code" href="classRayDifferential.html">RayDifferential</a> rd(p, wi);
00239                                 rd.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00240                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o9">dpdx</a>;
00241                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o10">dpdy</a>;
00242 
00243                                 <span class="keywordtype">float</span> eta = bsdf-&gt;<a class="code" href="classBSDF.html#o1">eta</a>;
00244                                 <a class="code" href="classVector.html">Vector</a> w = -wo;
00245                                 <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) &lt; 0) eta = 1.f / eta;
00246 
00247                                 <a class="code" href="classNormal.html">Normal</a> dndx = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o11">dudx</a> + bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o12">dvdx</a>;
00248                                 <a class="code" href="classNormal.html">Normal</a> dndy = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o13">dudy</a> + bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o14">dvdy</a>;
00249 
00250                                 <a class="code" href="classVector.html">Vector</a> dwodx = -ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> - wo, dwody = -ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> - wo;
00251                                 <span class="keywordtype">float</span> dDNdx = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwodx, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndx);
00252                                 <span class="keywordtype">float</span> dDNdy = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwody, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndy);
00253 
00254                                 <span class="keywordtype">float</span> mu = eta * <a class="code" href="geometry_8h.html#a17">Dot</a>(w, n) - <a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n);
00255                                 <span class="keywordtype">float</span> dmudx = (eta - (eta*eta*<a class="code" href="geometry_8h.html#a17">Dot</a>(w,n))/<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n)) * dDNdx;
00256                                 <span class="keywordtype">float</span> dmudy = (eta - (eta*eta*<a class="code" href="geometry_8h.html#a17">Dot</a>(w,n))/<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n)) * dDNdy;
00257 
00258                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> = wi + eta * dwodx - <a class="code" href="classVector.html">Vector</a>(mu * dndx + dmudx * n);
00259                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> = wi + eta * dwody - Vector(mu * dndy + dmudy * n);
00260                                 L += scene-&gt;<a class="code" href="classScene.html#a6">Li</a>(rd, sample) * f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n);
00261                         }
00262                 }
00263                 --<a class="code" href="classIGIIntegrator.html#r3">specularDepth</a>;
00264         }
00265         <span class="keywordflow">else</span> {
00266                 <span class="comment">// Handle ray with no intersection</span>
00267                 <span class="keywordflow">if</span> (alpha) *alpha = 0.;
00268                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size(); ++i)
00269                         L += scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i]-&gt;Le(ray);
00270                 <span class="keywordflow">if</span> (alpha &amp;&amp; !L.<a class="code" href="classSpectrum.html#a15">Black</a>()) *alpha = 1.;
00271                 <span class="keywordflow">return</span> L;
00272         }
00273         <span class="keywordflow">return</span> L;
00274 }
<a name="l00275"></a><a class="code" href="igi_8cpp.html#a0">00275</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> *<a class="code" href="whitted_8cpp.html#a0">CreateSurfaceIntegrator</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params)
00276 {
00277         <span class="keywordtype">int</span> nLightPaths = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"nlights"</span>, 64);
00278         <span class="keywordtype">int</span> nLightSets = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"nsets"</span>, 4);
00279         <span class="keywordtype">float</span> minDist = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"mindist"</span>, .1f);
00280         <span class="keywordtype">float</span> rrThresh = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"rrthreshold"</span>, .05f);
00281         <span class="keywordtype">float</span> is = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"indirectscale"</span>, 1.f);
00282         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classIGIIntegrator.html">IGIIntegrator</a>(nLightPaths, nLightSets, minDist, rrThresh, is);
00283 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:21 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
