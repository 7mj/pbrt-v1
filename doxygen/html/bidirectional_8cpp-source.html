<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: bidirectional.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>bidirectional.cpp</h1><a href="bidirectional_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// bidirectional.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="transport_8h.html">transport.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="scene_8h.html">scene.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="mc_8h.html">mc.h</a>"</span>
00016 <span class="comment">// Bidirectional Local Declarations</span>
00017 <span class="keyword">struct </span><a class="code" href="structBidirVertex.html">BidirVertex</a>;
<a name="l00018"></a><a class="code" href="classBidirIntegrator.html">00018</a> <span class="keyword">class </span><a class="code" href="classBidirIntegrator.html">BidirIntegrator</a> : <span class="keyword">public</span> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> {
00019 <span class="keyword">public</span>:
00020         <span class="comment">// BidirIntegrator Public Methods</span>
00021         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBidirIntegrator.html#a0">Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray, <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keywordtype">float</span> *alpha) <span class="keyword">const</span>;
00022         <span class="keywordtype">void</span> <a class="code" href="classBidirIntegrator.html#a1">RequestSamples</a>(<a class="code" href="structSample.html">Sample</a> *sample, <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene);
00023 <span class="keyword">private</span>:
00024         <span class="comment">// BidirIntegrator Private Methods</span>
00025         <span class="keywordtype">int</span> <a class="code" href="classBidirIntegrator.html#d0">generatePath</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;r, <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample,
00026                 <span class="keyword">const</span> <span class="keywordtype">int</span> *bsdfOffset, <span class="keyword">const</span> <span class="keywordtype">int</span> *bsdfCompOffset,
00027                 <a class="code" href="structBidirVertex.html">BidirVertex</a> *vertices, <span class="keywordtype">int</span> maxVerts) <span class="keyword">const</span>;
00028         <span class="keywordtype">float</span> <a class="code" href="classBidirIntegrator.html#d1">weightPath</a>(<a class="code" href="structBidirVertex.html">BidirVertex</a> *eye, <span class="keywordtype">int</span> nEye, <a class="code" href="structBidirVertex.html">BidirVertex</a> *light, <span class="keywordtype">int</span> nLight) <span class="keyword">const</span>;
00029         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBidirIntegrator.html#d2">evalPath</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <a class="code" href="structBidirVertex.html">BidirVertex</a> *eye, <span class="keywordtype">int</span> nEye,
00030         <a class="code" href="structBidirVertex.html">BidirVertex</a> *light, <span class="keywordtype">int</span> nLight) <span class="keyword">const</span>;
00031         <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="classBidirIntegrator.html#h0">G</a>(<span class="keyword">const</span> <a class="code" href="structBidirVertex.html">BidirVertex</a> &amp;v0, <span class="keyword">const</span> <a class="code" href="structBidirVertex.html">BidirVertex</a> &amp;v1);
00032         <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="classBidirIntegrator.html#h1">visible</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P0, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P1);
00033         <span class="comment">// BidirIntegrator Data</span>
<a name="l00034"></a><a class="code" href="bidirectional_8cpp.html#a0">00034</a> <span class="preprocessor">        #define MAX_VERTS 4</span>
<a name="l00035"></a><a class="code" href="classBidirIntegrator.html#r0">00035</a> <span class="preprocessor"></span>        <span class="keywordtype">int</span> <a class="code" href="classBidirIntegrator.html#r0">eyeBSDFOffset</a>[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>], <a class="code" href="classBidirIntegrator.html#r1">eyeBSDFCompOffset</a>[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>];
<a name="l00036"></a><a class="code" href="classBidirIntegrator.html#r2">00036</a>         <span class="keywordtype">int</span> <a class="code" href="classBidirIntegrator.html#r2">lightBSDFOffset</a>[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>], <a class="code" href="classBidirIntegrator.html#r3">lightBSDFCompOffset</a>[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>];
<a name="l00037"></a><a class="code" href="classBidirIntegrator.html#r4">00037</a>         <span class="keywordtype">int</span> <a class="code" href="classBidirIntegrator.html#r4">directLightOffset</a>[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>], <a class="code" href="classBidirIntegrator.html#r5">directLightNumOffset</a>[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>];
<a name="l00038"></a><a class="code" href="classBidirIntegrator.html#r6">00038</a>         <span class="keywordtype">int</span> <a class="code" href="classBidirIntegrator.html#r6">directBSDFOffset</a>[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>], <a class="code" href="classBidirIntegrator.html#r7">directBSDFCompOffset</a>[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>];
<a name="l00039"></a><a class="code" href="classBidirIntegrator.html#r9">00039</a>         <span class="keywordtype">int</span> <a class="code" href="classBidirIntegrator.html#r8">lightNumOffset</a>, <a class="code" href="classBidirIntegrator.html#r9">lightPosOffset</a>, <a class="code" href="classBidirIntegrator.html#r10">lightDirOffset</a>;
00040 };
<a name="l00041"></a><a class="code" href="structBidirVertex.html">00041</a> <span class="keyword">struct </span><a class="code" href="structBidirVertex.html">BidirVertex</a> {
<a name="l00042"></a><a class="code" href="structBidirVertex.html#a0">00042</a>         <a class="code" href="structBidirVertex.html#a0">BidirVertex</a>() { <a class="code" href="structBidirVertex.html#o6">bsdfWeight</a> = <a class="code" href="structBidirVertex.html#o7">dAWeight</a> = 0.; <a class="code" href="structBidirVertex.html#o8">rrWeight</a> = 1.;
00043                 <a class="code" href="structBidirVertex.html#o9">flags</a> = <a class="code" href="reflection_8h.html#a17">BxDFType</a>(0); <a class="code" href="structBidirVertex.html#o0">bsdf</a> = NULL; }
<a name="l00044"></a><a class="code" href="structBidirVertex.html#o0">00044</a>         <a class="code" href="classBSDF.html">BSDF</a> *<a class="code" href="structBidirVertex.html#o0">bsdf</a>;
<a name="l00045"></a><a class="code" href="structBidirVertex.html#o1">00045</a>         <a class="code" href="classPoint.html">Point</a> <a class="code" href="structBidirVertex.html#o1">p</a>;
<a name="l00046"></a><a class="code" href="structBidirVertex.html#o3">00046</a>         <a class="code" href="classNormal.html">Normal</a> <a class="code" href="structBidirVertex.html#o2">ng</a>, <a class="code" href="structBidirVertex.html#o3">ns</a>;
<a name="l00047"></a><a class="code" href="structBidirVertex.html#o5">00047</a>         <a class="code" href="classVector.html">Vector</a> <a class="code" href="structBidirVertex.html#o4">wi</a>, <a class="code" href="structBidirVertex.html#o5">wo</a>;
<a name="l00048"></a><a class="code" href="structBidirVertex.html#o8">00048</a>         <span class="keywordtype">float</span> <a class="code" href="structBidirVertex.html#o6">bsdfWeight</a>, <a class="code" href="structBidirVertex.html#o7">dAWeight</a>, <a class="code" href="structBidirVertex.html#o8">rrWeight</a>;
<a name="l00049"></a><a class="code" href="structBidirVertex.html#o9">00049</a>         <a class="code" href="reflection_8h.html#a17">BxDFType</a> <a class="code" href="structBidirVertex.html#o9">flags</a>;
00050 };
00051 <span class="comment">// Bidirectional Method Definitions</span>
<a name="l00052"></a><a class="code" href="classBidirIntegrator.html#a1">00052</a> <span class="keywordtype">void</span> <a class="code" href="classBidirIntegrator.html#a1">BidirIntegrator::RequestSamples</a>(<a class="code" href="structSample.html">Sample</a> *sample, <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene) {
00053         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>; ++i) {
00054                 <a class="code" href="classBidirIntegrator.html#r0">eyeBSDFOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00055                 <a class="code" href="classBidirIntegrator.html#r1">eyeBSDFCompOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(1);
00056                 <a class="code" href="classBidirIntegrator.html#r2">lightBSDFOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00057                 <a class="code" href="classBidirIntegrator.html#r3">lightBSDFCompOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(1);
00058                 <a class="code" href="classBidirIntegrator.html#r4">directLightOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00059                 <a class="code" href="classBidirIntegrator.html#r5">directLightNumOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(1);
00060                 <a class="code" href="classBidirIntegrator.html#r6">directBSDFOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00061                 <a class="code" href="classBidirIntegrator.html#r7">directBSDFCompOffset</a>[i]  = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(1);
00062         }
00063         <a class="code" href="classBidirIntegrator.html#r8">lightNumOffset</a> = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(1);
00064         <a class="code" href="classBidirIntegrator.html#r9">lightPosOffset</a> = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00065         <a class="code" href="classBidirIntegrator.html#r10">lightDirOffset</a> = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(1);
00066 }
<a name="l00067"></a><a class="code" href="classBidirIntegrator.html#a0">00067</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBidirIntegrator.html#a0">BidirIntegrator::Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene,
00068                 <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray,
00069                 <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keywordtype">float</span> *alpha)<span class="keyword"> const </span>{
00070         <a class="code" href="classSpectrum.html">Spectrum</a> L(0.);
00071         <span class="comment">// Generate eye and light sub-paths</span>
00072         <a class="code" href="structBidirVertex.html">BidirVertex</a> eyePath[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>], lightPath[<a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>];
00073         <span class="keywordtype">int</span> nEye = <a class="code" href="classBidirIntegrator.html#d0">generatePath</a>(scene, ray, sample, <a class="code" href="classBidirIntegrator.html#r0">eyeBSDFOffset</a>,
00074                 <a class="code" href="classBidirIntegrator.html#r1">eyeBSDFCompOffset</a>, eyePath, <a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>);
00075         <span class="keywordflow">if</span> (nEye == 0) {
00076                 *alpha = 0.;
00077                 <span class="keywordflow">return</span> L;
00078         }
00079         *alpha = 1;
00080         <span class="comment">// Choose light for bidirectional path</span>
00081         <span class="keywordtype">int</span> lightNum = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(sample-&gt;<a class="code" href="structSample.html#o7">oneD</a>[<a class="code" href="classBidirIntegrator.html#r8">lightNumOffset</a>][0] *
00082                 scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size());
00083         lightNum = min(lightNum, (<span class="keywordtype">int</span>)scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size() - 1);
00084         <a class="code" href="classLight.html">Light</a> *light = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[lightNum];
00085         <span class="keywordtype">float</span> lightWeight = float(scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size());
00086         <span class="comment">// Sample ray from light source to start light path</span>
00087         <a class="code" href="classRay.html">Ray</a> lightRay;
00088         <span class="keywordtype">float</span> lightPdf;
00089         <span class="keywordtype">float</span> u[4];
00090         u[0] = sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[<a class="code" href="classBidirIntegrator.html#r9">lightPosOffset</a>][0];
00091         u[1] = sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[<a class="code" href="classBidirIntegrator.html#r9">lightPosOffset</a>][1];
00092         u[2] = sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[<a class="code" href="classBidirIntegrator.html#r10">lightDirOffset</a>][0];
00093         u[3] = sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[<a class="code" href="classBidirIntegrator.html#r10">lightDirOffset</a>][1];
00094         <a class="code" href="classSpectrum.html">Spectrum</a> Le = light-&gt;<a class="code" href="classLight.html#a2">Sample_L</a>(scene, u[0], u[1], u[2], u[3],
00095                 &amp;lightRay, &amp;lightPdf);
00096         <span class="keywordflow">if</span> (lightPdf == 0.) <span class="keywordflow">return</span> 0.f;
00097         Le = lightWeight / lightPdf;
00098         <span class="keywordtype">int</span> nLight = generatePath(scene, lightRay, sample, <a class="code" href="classBidirIntegrator.html#r2">lightBSDFOffset</a>,
00099                 <a class="code" href="classBidirIntegrator.html#r3">lightBSDFCompOffset</a>, lightPath, <a class="code" href="bidirectional_8cpp.html#a0">MAX_VERTS</a>);
00100         <span class="comment">// Connect bidirectional path prefixes and evaluate throughput</span>
00101         <a class="code" href="classSpectrum.html">Spectrum</a> directWt(1.0);
00102         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= nEye; ++i) {
00103                 <span class="comment">// Handle direct lighting for bidirectional integrator</span>
00104                 directWt /= eyePath[i-1].<a class="code" href="structBidirVertex.html#o8">rrWeight</a>;
00105                 L += directWt *
00106                         <a class="code" href="transport_8h.html#a1">UniformSampleOneLight</a>(scene, eyePath[i-1].p, eyePath[i-1].ng, eyePath[i-1].wi,
00107                         eyePath[i-1].bsdf, sample, <a class="code" href="classBidirIntegrator.html#r4">directLightOffset</a>[i-1], <a class="code" href="classBidirIntegrator.html#r5">directLightNumOffset</a>[i-1],
00108                         <a class="code" href="classBidirIntegrator.html#r6">directBSDFOffset</a>[i-1], <a class="code" href="classBidirIntegrator.html#r7">directBSDFCompOffset</a>[i-1]) /
00109                         <a class="code" href="classBidirIntegrator.html#d1">weightPath</a>(eyePath, i, lightPath, 0);
00110                 directWt *= eyePath[i-1].<a class="code" href="structBidirVertex.html#o0">bsdf</a>-&gt;<a class="code" href="classBSDF.html#a10">f</a>(eyePath[i-1].wi, eyePath[i-1].wo) *
00111                         <a class="code" href="geometry_8h.html#a20">AbsDot</a>(eyePath[i-1].wo, eyePath[i-1].ng) /
00112                         eyePath[i-1].bsdfWeight;
00113                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt;= nLight; ++j)
00114                         L += Le * <a class="code" href="classBidirIntegrator.html#d2">evalPath</a>(scene, eyePath, i, lightPath, j) /
00115                                 <a class="code" href="classBidirIntegrator.html#d1">weightPath</a>(eyePath, i, lightPath, j);
00116         }
00117         <span class="keywordflow">return</span> L;
00118 }
<a name="l00119"></a><a class="code" href="classBidirIntegrator.html#d0">00119</a> <span class="keywordtype">int</span> <a class="code" href="classBidirIntegrator.html#d0">BidirIntegrator::generatePath</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;r,
00120                 <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keyword">const</span> <span class="keywordtype">int</span> *bsdfOffset,
00121                 <span class="keyword">const</span> <span class="keywordtype">int</span> *bsdfCompOffset,
00122                 <a class="code" href="structBidirVertex.html">BidirVertex</a> *vertices, <span class="keywordtype">int</span> maxVerts)<span class="keyword"> const </span>{
00123         <span class="keywordtype">int</span> nVerts = 0;
00124         <a class="code" href="classRayDifferential.html">RayDifferential</a> ray(r.<a class="code" href="classRay.html#o0">o</a>, r.<a class="code" href="classRay.html#o1">d</a>);
00125         <span class="keywordflow">while</span> (nVerts &lt; maxVerts) {
00126                 <span class="comment">// Find next vertex in path and initialize _vertices_</span>
00127                 <a class="code" href="structIntersection.html">Intersection</a> isect;
00128                 <span class="keywordflow">if</span> (!scene-&gt;<a class="code" href="classScene.html#a3">Intersect</a>(ray, &amp;isect))
00129                         <span class="keywordflow">break</span>;
00130                 <a class="code" href="structBidirVertex.html">BidirVertex</a> &amp;v = vertices[nVerts];
00131                 v.<a class="code" href="structBidirVertex.html#o0">bsdf</a> = isect.<a class="code" href="structIntersection.html#a1">GetBSDF</a>(ray); <span class="comment">// do before Ns is set!</span>
00132                 v.<a class="code" href="structBidirVertex.html#o1">p</a> = isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o0">p</a>;
00133                 v.<a class="code" href="structBidirVertex.html#o2">ng</a> = isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00134                 v.<a class="code" href="structBidirVertex.html#o3">ns</a> = v.<a class="code" href="structBidirVertex.html#o0">bsdf</a>-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00135                 v.<a class="code" href="structBidirVertex.html#o4">wi</a> = -ray.<a class="code" href="classRay.html#o1">d</a>;
00136                 ++nVerts;
00137                 <span class="comment">// Possibly terminate bidirectional path sampling</span>
00138                 <span class="keywordflow">if</span> (nVerts &gt; 2) {
00139                         <span class="keywordtype">float</span> rrProb = .2f;
00140                         <span class="keywordflow">if</span> (<a class="code" href="pbrt_8h.html#a108">RandomFloat</a>() &gt; rrProb)
00141                                 <span class="keywordflow">break</span>;
00142                         v.<a class="code" href="structBidirVertex.html#o8">rrWeight</a> = 1.f / rrProb;
00143                 }
00144                 <span class="comment">// Initialize _ray_ for next segment of path</span>
00145                 <span class="keywordtype">float</span> u1 = sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[bsdfOffset[nVerts-1]][0];
00146                 <span class="keywordtype">float</span> u2 = sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[bsdfOffset[nVerts-1]][1];
00147                 <span class="keywordtype">float</span> u3 = sample-&gt;<a class="code" href="structSample.html#o7">oneD</a>[bsdfCompOffset[nVerts-1]][0];
00148                 <a class="code" href="classSpectrum.html">Spectrum</a> fr = v.<a class="code" href="structBidirVertex.html#o0">bsdf</a>-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(v.<a class="code" href="structBidirVertex.html#o4">wi</a>, &amp;v.<a class="code" href="structBidirVertex.html#o5">wo</a>, u1, u2, u3,
00149                          &amp;v.<a class="code" href="structBidirVertex.html#o6">bsdfWeight</a>, <a class="code" href="reflection_8h.html#a17a10">BSDF_ALL</a>, &amp;v.<a class="code" href="structBidirVertex.html#o9">flags</a>);
00150                 <span class="keywordflow">if</span> (fr.<a class="code" href="classSpectrum.html#a15">Black</a>() &amp;&amp; v.<a class="code" href="structBidirVertex.html#o6">bsdfWeight</a> == 0.f)
00151                         <span class="keywordflow">break</span>;
00152                 ray = <a class="code" href="classRayDifferential.html">RayDifferential</a>(v.<a class="code" href="structBidirVertex.html#o1">p</a>, v.<a class="code" href="structBidirVertex.html#o5">wo</a>);
00153         }
00154         <span class="comment">// Initialize additional values in _vertices_</span>
00155         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nVerts-1; ++i)
00156                 vertices[i].<a class="code" href="structBidirVertex.html#o7">dAWeight</a> = vertices[i].<a class="code" href="structBidirVertex.html#o6">bsdfWeight</a> *
00157                         <a class="code" href="geometry_8h.html#a20">AbsDot</a>(-vertices[i].wo, vertices[i+1].ng) /
00158                         <a class="code" href="geometry_8h.html#a10">DistanceSquared</a>(vertices[i].p, vertices[i+1].p);
00159         <span class="keywordflow">return</span> nVerts;
00160 }
00161 
<a name="l00162"></a><a class="code" href="classBidirIntegrator.html#d1">00162</a> <span class="keywordtype">float</span> <a class="code" href="classBidirIntegrator.html#d1">BidirIntegrator::weightPath</a>(<a class="code" href="structBidirVertex.html">BidirVertex</a> *eye, <span class="keywordtype">int</span> nEye,
00163                 <a class="code" href="structBidirVertex.html">BidirVertex</a> *light, <span class="keywordtype">int</span> nLight)<span class="keyword"> const </span>{
00164         <span class="keywordflow">return</span> float(nEye + nLight);
00165 }
<a name="l00166"></a><a class="code" href="classBidirIntegrator.html#d2">00166</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBidirIntegrator.html#d2">BidirIntegrator::evalPath</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <a class="code" href="structBidirVertex.html">BidirVertex</a> *eye, <span class="keywordtype">int</span> nEye,
00167                 <a class="code" href="structBidirVertex.html">BidirVertex</a> *light, <span class="keywordtype">int</span> nLight)<span class="keyword"> const </span>{
00168         <a class="code" href="classSpectrum.html">Spectrum</a> L(1.);
00169         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nEye-1; ++i)
00170                 L *= eye[i].<a class="code" href="structBidirVertex.html#o0">bsdf</a>-&gt;<a class="code" href="classBSDF.html#a10">f</a>(eye[i].wi, eye[i].wo) *
00171                         <a class="code" href="geometry_8h.html#a20">AbsDot</a>(eye[i].wo, eye[i].ng) /
00172                         (eye[i].bsdfWeight * eye[i].rrWeight);
00173         <a class="code" href="classVector.html">Vector</a> w = light[nLight-1].<a class="code" href="structBidirVertex.html#o1">p</a> - eye[nEye-1].p;
00174         L *= eye[nEye-1].bsdf-&gt;f(eye[nEye-1].wi, w) *
00175                 <a class="code" href="classBidirIntegrator.html#h0">G</a>(eye[nEye-1], light[nLight-1]) *
00176                 light[nLight-1].bsdf-&gt;f(-w, light[nLight-1].wi) /
00177                 (eye[nEye-1].rrWeight * light[nLight-1].rrWeight);
00178         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = nLight-2; i &gt;= 0; --i)
00179                 L *= light[i].bsdf-&gt;f(light[i].wi, light[i].wo) *
00180                         <a class="code" href="geometry_8h.html#a20">AbsDot</a>(light[i].wo, light[i].ng) /
00181                         (light[i].bsdfWeight * light[i].rrWeight);
00182         <span class="keywordflow">if</span> (L.<a class="code" href="classSpectrum.html#a15">Black</a>())
00183                 <span class="keywordflow">return</span> L;
00184         <span class="keywordflow">if</span> (!<a class="code" href="classBidirIntegrator.html#h1">visible</a>(scene, eye[nEye-1].p, light[nLight-1].p))
00185                 <span class="keywordflow">return</span> 0.;
00186         <span class="keywordflow">return</span> L;
00187 }
<a name="l00188"></a><a class="code" href="classBidirIntegrator.html#h0">00188</a> <span class="keywordtype">float</span> <a class="code" href="classBidirIntegrator.html#h0">BidirIntegrator::G</a>(<span class="keyword">const</span> <a class="code" href="structBidirVertex.html">BidirVertex</a> &amp;v0, <span class="keyword">const</span> <a class="code" href="structBidirVertex.html">BidirVertex</a> &amp;v1) {
00189         <a class="code" href="classVector.html">Vector</a> w = <a class="code" href="geometry_8h.html#a14">Normalize</a>(v1.<a class="code" href="structBidirVertex.html#o1">p</a> - v0.<a class="code" href="structBidirVertex.html#o1">p</a>);
00190         <span class="keywordflow">return</span> <a class="code" href="geometry_8h.html#a20">AbsDot</a>(v0.<a class="code" href="structBidirVertex.html#o2">ng</a>, w) * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(v1.<a class="code" href="structBidirVertex.html#o2">ng</a>, -w) /
00191                 <a class="code" href="geometry_8h.html#a10">DistanceSquared</a>(v0.<a class="code" href="structBidirVertex.html#o1">p</a>, v1.<a class="code" href="structBidirVertex.html#o1">p</a>);
00192 }
<a name="l00193"></a><a class="code" href="classBidirIntegrator.html#h1">00193</a> <span class="keywordtype">bool</span> <a class="code" href="classBidirIntegrator.html#h1">BidirIntegrator::visible</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P0,
00194                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P1) {
00195         <a class="code" href="classRay.html">Ray</a> ray(P0, P1-P0, <a class="code" href="pbrt_8h.html#a11">RAY_EPSILON</a>, 1.f - <a class="code" href="pbrt_8h.html#a11">RAY_EPSILON</a>);
00196         <span class="keywordflow">return</span> !scene-&gt;<a class="code" href="classScene.html#a4">IntersectP</a>(ray);
00197 }
<a name="l00198"></a><a class="code" href="bidirectional_8cpp.html#a1">00198</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> *<a class="code" href="whitted_8cpp.html#a0">CreateSurfaceIntegrator</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params) {
00199         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classBidirIntegrator.html">BidirIntegrator</a>;
00200 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:19 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
