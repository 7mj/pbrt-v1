<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: irradiancecache.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>irradiancecache.cpp</h1><a href="irradiancecache_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// irradiancecache.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="transport_8h.html">transport.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="scene_8h.html">scene.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="mc_8h.html">mc.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="octree_8h.html">octree.h</a>"</span>
00017 <span class="comment">// IrradianceCache Forward Declarations</span>
00018 <span class="keyword">struct </span><a class="code" href="structIrradianceSample.html">IrradianceSample</a>;
00019 <span class="keyword">struct </span><a class="code" href="structIrradProcess.html">IrradProcess</a>;
00020 <span class="comment">// IrradianceCache Declarations</span>
<a name="l00021"></a><a class="code" href="classIrradianceCache.html">00021</a> <span class="keyword">class </span><a class="code" href="classIrradianceCache.html">IrradianceCache</a> : <span class="keyword">public</span> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> {
00022 <span class="keyword">public</span>:
00023         <span class="comment">// IrradianceCache Public Methods</span>
00024         <a class="code" href="classIrradianceCache.html">IrradianceCache</a>(<span class="keywordtype">int</span> maxspec, <span class="keywordtype">int</span> maxind, <span class="keywordtype">float</span> maxerr, <span class="keywordtype">int</span> nsamples);
00025         <a class="code" href="classIrradianceCache.html#a1">~IrradianceCache</a>();
00026         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classIrradianceCache.html#a2">Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray, <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keywordtype">float</span> *alpha) <span class="keyword">const</span>;
00027         <span class="keywordtype">void</span> <a class="code" href="classIrradianceCache.html#a3">RequestSamples</a>(<a class="code" href="structSample.html">Sample</a> *sample, <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene);
00028         <span class="keywordtype">void</span> <a class="code" href="classIrradianceCache.html#a4">Preprocess</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *);
00029 <span class="keyword">private</span>:
00030         <span class="comment">// IrradianceCache Data</span>
<a name="l00031"></a><a class="code" href="classIrradianceCache.html#r0">00031</a>         <span class="keywordtype">float</span> <a class="code" href="classIrradianceCache.html#r0">maxError</a>;
<a name="l00032"></a><a class="code" href="classIrradianceCache.html#r1">00032</a>         <span class="keywordtype">int</span> <a class="code" href="classIrradianceCache.html#r1">nSamples</a>;
<a name="l00033"></a><a class="code" href="classIrradianceCache.html#r2">00033</a>         <span class="keywordtype">int</span> <a class="code" href="classIrradianceCache.html#r2">maxSpecularDepth</a>, <a class="code" href="classIrradianceCache.html#r3">maxIndirectDepth</a>;
<a name="l00034"></a><a class="code" href="classIrradianceCache.html#r4">00034</a>         <span class="keyword">mutable</span> <span class="keywordtype">int</span> <a class="code" href="classIrradianceCache.html#r4">specularDepth</a>;
00035         <span class="comment">// Declare sample parameters for light source sampling</span>
<a name="l00036"></a><a class="code" href="classIrradianceCache.html#r5">00036</a>         <span class="keywordtype">int</span> *<a class="code" href="classIrradianceCache.html#r5">lightSampleOffset</a>, <a class="code" href="classIrradianceCache.html#r6">lightNumOffset</a>;
<a name="l00037"></a><a class="code" href="classIrradianceCache.html#r7">00037</a>         <span class="keywordtype">int</span> *<a class="code" href="classIrradianceCache.html#r7">bsdfSampleOffset</a>, *<a class="code" href="classIrradianceCache.html#r8">bsdfComponentOffset</a>;
<a name="l00038"></a><a class="code" href="classIrradianceCache.html#r9">00038</a>         <span class="keyword">mutable</span> <a class="code" href="classOctree.html">Octree&lt;IrradianceSample, IrradProcess&gt;</a> *<a class="code" href="classIrradianceCache.html#r9">octree</a>;
00039         <span class="comment">// IrradianceCache Private Methods</span>
00040         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classIrradianceCache.html#d0">IndirectLo</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n,
00041                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classBSDF.html">BSDF</a> *bsdf, BxDFType flags,
00042                 <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene) <span class="keyword">const</span>;
00043         <span class="keywordtype">bool</span> <a class="code" href="classIrradianceCache.html#d1">InterpolateIrradiance</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene,
00044                         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n, <a class="code" href="classSpectrum.html">Spectrum</a> *E) <span class="keyword">const</span>;
00045 };
<a name="l00046"></a><a class="code" href="structIrradianceSample.html">00046</a> <span class="keyword">struct </span><a class="code" href="structIrradianceSample.html">IrradianceSample</a> {
00047         <span class="comment">// IrradianceSample Constructor</span>
<a name="l00048"></a><a class="code" href="structIrradianceSample.html#a0">00048</a>         <a class="code" href="structIrradianceSample.html#a0">IrradianceSample</a>() { }
<a name="l00049"></a><a class="code" href="structIrradianceSample.html#a1">00049</a>         <a class="code" href="structIrradianceSample.html#a0">IrradianceSample</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;e, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P, <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;N,
00050                 <span class="keywordtype">float</span> md) : <a class="code" href="structIrradianceSample.html#o0">E</a>(e), <a class="code" href="structIrradianceSample.html#o1">n</a>(<a class="code" href="util_8cpp.html#a3">N</a>), <a class="code" href="structIrradianceSample.html#o2">p</a>(P) {
00051                 <a class="code" href="structIrradianceSample.html#o3">maxDist</a> = md;
00052         }
<a name="l00053"></a><a class="code" href="structIrradianceSample.html#o0">00053</a>         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="structIrradianceSample.html#o0">E</a>;
<a name="l00054"></a><a class="code" href="structIrradianceSample.html#o1">00054</a>         <a class="code" href="classNormal.html">Normal</a> <a class="code" href="structIrradianceSample.html#o1">n</a>;
<a name="l00055"></a><a class="code" href="structIrradianceSample.html#o2">00055</a>         <a class="code" href="classPoint.html">Point</a> <a class="code" href="structIrradianceSample.html#o2">p</a>;
<a name="l00056"></a><a class="code" href="structIrradianceSample.html#o3">00056</a>         <span class="keywordtype">float</span> <a class="code" href="structIrradianceSample.html#o3">maxDist</a>;
00057 };
<a name="l00058"></a><a class="code" href="structIrradProcess.html">00058</a> <span class="keyword">struct </span><a class="code" href="structIrradProcess.html">IrradProcess</a> {
00059         <span class="comment">// IrradProcess Public Methods</span>
<a name="l00060"></a><a class="code" href="structIrradProcess.html#a0">00060</a>         <a class="code" href="structIrradProcess.html">IrradProcess</a>(<span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;N, <span class="keywordtype">float</span> me) {
00061                 <a class="code" href="structIrradProcess.html#o0">n</a> = <a class="code" href="util_8cpp.html#a3">N</a>;
00062                 <a class="code" href="structIrradProcess.html#o1">maxError</a> = me;
00063                 <a class="code" href="structIrradProcess.html#o2">nFound</a> = <a class="code" href="structIrradProcess.html#o3">samplesChecked</a> = 0;
00064                 <a class="code" href="structIrradProcess.html#o4">sumWt</a> = 0.;
00065                 <a class="code" href="structIrradProcess.html#o5">E</a> = 0.;
00066         }
00067         <span class="keywordtype">void</span> operator()(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P, <span class="keyword">const</span> <a class="code" href="structIrradianceSample.html">IrradianceSample</a> &amp;sample) <span class="keyword">const</span>;
<a name="l00068"></a><a class="code" href="structIrradProcess.html#a2">00068</a>         <span class="keywordtype">bool</span> <a class="code" href="structIrradProcess.html#a2">Successful</a>() {
00069                 <span class="keywordflow">return</span> (<a class="code" href="structIrradProcess.html#o4">sumWt</a> &gt; 0. &amp;&amp; <a class="code" href="structIrradProcess.html#o2">nFound</a> &gt; 0);
00070         }
<a name="l00071"></a><a class="code" href="structIrradProcess.html#a3">00071</a>         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="structIrradProcess.html#a3">GetIrradiance</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="structIrradProcess.html#o5">E</a> / <a class="code" href="structIrradProcess.html#o4">sumWt</a>; }
<a name="l00072"></a><a class="code" href="structIrradProcess.html#o0">00072</a>         <a class="code" href="classNormal.html">Normal</a> <a class="code" href="structIrradProcess.html#o0">n</a>;
<a name="l00073"></a><a class="code" href="structIrradProcess.html#o1">00073</a>         <span class="keywordtype">float</span> <a class="code" href="structIrradProcess.html#o1">maxError</a>;
<a name="l00074"></a><a class="code" href="structIrradProcess.html#o3">00074</a>         <span class="keyword">mutable</span> <span class="keywordtype">int</span> <a class="code" href="structIrradProcess.html#o2">nFound</a>, <a class="code" href="structIrradProcess.html#o3">samplesChecked</a>;
<a name="l00075"></a><a class="code" href="structIrradProcess.html#o4">00075</a>         <span class="keyword">mutable</span> <span class="keywordtype">float</span> <a class="code" href="structIrradProcess.html#o4">sumWt</a>;
<a name="l00076"></a><a class="code" href="structIrradProcess.html#o5">00076</a>         <span class="keyword">mutable</span> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="structIrradProcess.html#o5">E</a>;
00077 };
00078 <span class="comment">// IrradianceCache Method Definitions</span>
<a name="l00079"></a><a class="code" href="classIrradianceCache.html#a0">00079</a> <a class="code" href="classIrradianceCache.html#a0">IrradianceCache::IrradianceCache</a>(<span class="keywordtype">int</span> maxspec, <span class="keywordtype">int</span> maxind,
00080                 <span class="keywordtype">float</span> maxerr, <span class="keywordtype">int</span> ns) {
00081         <a class="code" href="classIrradianceCache.html#r0">maxError</a> = maxerr;
00082         <a class="code" href="classIrradianceCache.html#r1">nSamples</a> = ns;
00083         <a class="code" href="classIrradianceCache.html#r2">maxSpecularDepth</a> = maxspec;
00084         <a class="code" href="classIrradianceCache.html#r3">maxIndirectDepth</a> = maxind;
00085         <a class="code" href="classIrradianceCache.html#r4">specularDepth</a> = 0;
00086 }
<a name="l00087"></a><a class="code" href="classIrradianceCache.html#a3">00087</a> <span class="keywordtype">void</span> <a class="code" href="classIrradianceCache.html#a3">IrradianceCache::RequestSamples</a>(<a class="code" href="structSample.html">Sample</a> *sample,
00088                 <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene) {
00089         <span class="comment">// Allocate and request samples for sampling all lights</span>
00090         <a class="code" href="pbrt_8h.html#a51">u_int</a> nLights = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size();
00091         <a class="code" href="classIrradianceCache.html#r5">lightSampleOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00092         <a class="code" href="classIrradianceCache.html#r7">bsdfSampleOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00093         <a class="code" href="classIrradianceCache.html#r8">bsdfComponentOffset</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[nLights];
00094         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; nLights; ++i) {
00095                 <span class="keyword">const</span> <a class="code" href="classLight.html">Light</a> *light = scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i];
00096                 <span class="keywordtype">int</span> lightSamples =
00097                         scene-&gt;<a class="code" href="classScene.html#o6">sampler</a>-&gt;<a class="code" href="classSampler.html#a4">RoundSize</a>(light-&gt;<a class="code" href="classLight.html#o0">nSamples</a>);
00098                 <a class="code" href="classIrradianceCache.html#r5">lightSampleOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(lightSamples);
00099                 <a class="code" href="classIrradianceCache.html#r7">bsdfSampleOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a2">Add2D</a>(lightSamples);
00100                 <a class="code" href="classIrradianceCache.html#r8">bsdfComponentOffset</a>[i] = sample-&gt;<a class="code" href="structSample.html#a1">Add1D</a>(lightSamples);
00101         }
00102         <a class="code" href="classIrradianceCache.html#r6">lightNumOffset</a> = -1;
00103 }
<a name="l00104"></a><a class="code" href="classIrradianceCache.html#a2">00104</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classIrradianceCache.html#a2">IrradianceCache::Li</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray,
00105                 <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keywordtype">float</span> *alpha)<span class="keyword"> const </span>{
00106         <a class="code" href="structIntersection.html">Intersection</a> isect;
00107         <a class="code" href="classSpectrum.html">Spectrum</a> L(0.);
00108         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="classScene.html#a3">Intersect</a>(ray, &amp;isect)) {
00109                 <span class="keywordflow">if</span> (alpha) *alpha = 1.;
00110                 <span class="comment">// Evaluate BSDF at hit point</span>
00111                 <a class="code" href="classBSDF.html">BSDF</a> *bsdf = isect.<a class="code" href="structIntersection.html#a1">GetBSDF</a>(ray);
00112                 <a class="code" href="classVector.html">Vector</a> wo = -ray.<a class="code" href="classRay.html#o1">d</a>;
00113                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o0">p</a>;
00114                 <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00115                 <span class="comment">// Compute direct lighting for irradiance cache</span>
00116                 L += isect.<a class="code" href="structIntersection.html#a2">Le</a>(wo);
00117                 L += <a class="code" href="transport_8h.html#a0">UniformSampleAllLights</a>(scene, p, n, wo, bsdf, sample,
00118                         <a class="code" href="classIrradianceCache.html#r5">lightSampleOffset</a>, <a class="code" href="classIrradianceCache.html#r7">bsdfSampleOffset</a>,
00119                         <a class="code" href="classIrradianceCache.html#r8">bsdfComponentOffset</a>);
00120                 <span class="comment">// Compute indirect lighting for irradiance cache</span>
00121                 <span class="keywordflow">if</span> (<a class="code" href="classIrradianceCache.html#r4">specularDepth</a>++ &lt; <a class="code" href="classIrradianceCache.html#r2">maxSpecularDepth</a>) {
00122                         <a class="code" href="classVector.html">Vector</a> wi;
00123                         <span class="comment">// Trace rays for specular reflection and refraction</span>
00124                         <a class="code" href="classSpectrum.html">Spectrum</a> f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi,
00125                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a> | <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>));
00126                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00127                                 <span class="comment">// Compute ray differential _rd_ for specular reflection</span>
00128                                 <a class="code" href="classRayDifferential.html">RayDifferential</a> rd(p, wi);
00129                                 rd.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00130                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o9">dpdx</a>;
00131                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o10">dpdy</a>;
00132                                 <span class="comment">// Compute differential reflected directions</span>
00133                                 <a class="code" href="classNormal.html">Normal</a> dndx = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o11">dudx</a> +
00134                                         bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o12">dvdx</a>;
00135                                 <a class="code" href="classNormal.html">Normal</a> dndy = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o13">dudy</a> +
00136                                         bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o14">dvdy</a>;
00137                                 <a class="code" href="classVector.html">Vector</a> dwodx = -ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> - wo, dwody = -ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> - wo;
00138                                 <span class="keywordtype">float</span> dDNdx = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwodx, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndx);
00139                                 <span class="keywordtype">float</span> dDNdy = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwody, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndy);
00140                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> = wi -
00141                                           dwodx + 2 * <a class="code" href="classVector.html">Vector</a>(<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) * dndx +
00142                                                   dDNdx * n);
00143                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> = wi -
00144                                           dwody + 2 * Vector(<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) * dndy +
00145                                                   dDNdy * n);
00146                                 L += scene-&gt;<a class="code" href="classScene.html#a6">Li</a>(rd, sample) * f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n);
00147                         }
00148                         f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi,
00149                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a3">BSDF_TRANSMISSION</a> | <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>));
00150                         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a15">Black</a>()) {
00151                                 <span class="comment">// Compute ray differential _rd_ for specular transmission</span>
00152                                 <a class="code" href="classRayDifferential.html">RayDifferential</a> rd(p, wi);
00153                                 rd.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00154                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o9">dpdx</a>;
00155                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> = p + isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o10">dpdy</a>;
00156                                 
00157                                 <span class="keywordtype">float</span> eta = bsdf-&gt;<a class="code" href="classBSDF.html#o1">eta</a>;
00158                                 <a class="code" href="classVector.html">Vector</a> w = -wo;
00159                                 <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, n) &lt; 0) eta = 1.f / eta;
00160                                 
00161                                 <a class="code" href="classNormal.html">Normal</a> dndx = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o11">dudx</a> + bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o12">dvdx</a>;
00162                                 <a class="code" href="classNormal.html">Normal</a> dndy = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o7">dndu</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o13">dudy</a> + bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o8">dndv</a> * bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o14">dvdy</a>;
00163                                 
00164                                 <a class="code" href="classVector.html">Vector</a> dwodx = -ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> - wo, dwody = -ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> - wo;
00165                                 <span class="keywordtype">float</span> dDNdx = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwodx, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndx);
00166                                 <span class="keywordtype">float</span> dDNdy = <a class="code" href="geometry_8h.html#a17">Dot</a>(dwody, n) + <a class="code" href="geometry_8h.html#a17">Dot</a>(wo, dndy);
00167                                 
00168                                 <span class="keywordtype">float</span> mu = eta * <a class="code" href="geometry_8h.html#a17">Dot</a>(w, n) - <a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n);
00169                                 <span class="keywordtype">float</span> dmudx = (eta - (eta*eta*<a class="code" href="geometry_8h.html#a17">Dot</a>(w,n))/<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n)) * dDNdx;
00170                                 <span class="keywordtype">float</span> dmudy = (eta - (eta*eta*<a class="code" href="geometry_8h.html#a17">Dot</a>(w,n))/<a class="code" href="geometry_8h.html#a17">Dot</a>(wi, n)) * dDNdy;
00171                                 
00172                                 rd.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a> = wi + eta * dwodx - <a class="code" href="classVector.html">Vector</a>(mu * dndx + dmudx * n);
00173                                 rd.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a> = wi + eta * dwody - Vector(mu * dndy + dmudy * n);
00174                                 L += scene-&gt;<a class="code" href="classScene.html#a6">Li</a>(rd, sample) * f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n);
00175                         }
00176                 }
00177                 --<a class="code" href="classIrradianceCache.html#r4">specularDepth</a>;
00178                 <span class="comment">// Estimate indirect lighting with irradiance cache</span>
00179                 <a class="code" href="classNormal.html">Normal</a> ng = isect.<a class="code" href="structIntersection.html#o0">dg</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00180                 <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(wo, ng) &lt; 0.f) ng = -ng;
00181                 <a class="code" href="reflection_8h.html#a17">BxDFType</a> flags = <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a2">BSDF_REFLECTION</a> |
00182                                           <a class="code" href="reflection_8h.html#a17a4">BSDF_DIFFUSE</a> |
00183                                                                   <a class="code" href="reflection_8h.html#a17a5">BSDF_GLOSSY</a>);
00184                 L += <a class="code" href="classIrradianceCache.html#d0">IndirectLo</a>(p, ng, wo, bsdf, flags, sample, scene);
00185                 flags = <a class="code" href="reflection_8h.html#a17">BxDFType</a>(<a class="code" href="reflection_8h.html#a17a3">BSDF_TRANSMISSION</a> |
00186                                  <a class="code" href="reflection_8h.html#a17a4">BSDF_DIFFUSE</a> |
00187                                                  <a class="code" href="reflection_8h.html#a17a5">BSDF_GLOSSY</a>);
00188                 L += IndirectLo(p, -ng, wo, bsdf, flags, sample, scene);
00189         }
00190         <span class="keywordflow">else</span> {
00191                 <span class="comment">// Handle ray with no intersection</span>
00192                 <span class="keywordflow">if</span> (alpha) *alpha = 0.;
00193                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; scene-&gt;<a class="code" href="classScene.html#o1">lights</a>.size(); ++i)
00194                         L += scene-&gt;<a class="code" href="classScene.html#o1">lights</a>[i]-&gt;Le(ray);
00195                 <span class="keywordflow">if</span> (alpha &amp;&amp; !L.<a class="code" href="classSpectrum.html#a15">Black</a>()) *alpha = 1.;
00196                 <span class="keywordflow">return</span> L;
00197         }
00198         <span class="keywordflow">return</span> L;
00199 }
<a name="l00200"></a><a class="code" href="classIrradianceCache.html#d0">00200</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classIrradianceCache.html#d0">IrradianceCache::IndirectLo</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p,
00201                 <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classBSDF.html">BSDF</a> *bsdf,
00202                 BxDFType flags, <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample,
00203                 <span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene)<span class="keyword"> const </span>{
00204         <span class="keywordflow">if</span> (bsdf-&gt;<a class="code" href="classBSDF.html#a5">NumComponents</a>(flags) == 0)
00205                 <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.);
00206         <a class="code" href="classSpectrum.html">Spectrum</a> E;
00207         <span class="keywordflow">if</span> (!<a class="code" href="classIrradianceCache.html#d1">InterpolateIrradiance</a>(scene, p, n, &amp;E)) {
00208                 <span class="comment">// Compute irradiance at current point</span>
00209                 <a class="code" href="pbrt_8h.html#a51">u_int</a> scramble[2] = { <a class="code" href="pbrt_8h.html#a109">RandomUInt</a>(), <a class="code" href="pbrt_8h.html#a109">RandomUInt</a>() };
00210                 <span class="keywordtype">float</span> sumInvDists = 0.;
00211                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classIrradianceCache.html#r1">nSamples</a>; ++i) {
00212                         <span class="comment">// Trace ray to sample radiance for irradiance estimate</span>
00213                         <span class="comment">// Update irradiance statistics for rays traced</span>
00214                         <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> nIrradiancePaths(<span class="stringliteral">"Irradiance Cache"</span>,
00215                                 <span class="stringliteral">"Paths followed for irradiance estimates"</span>);
00216                         ++nIrradiancePaths;
00217                         <span class="keywordtype">float</span> u[2];
00218                         <a class="code" href="sampling_8h.html#a9">Sample02</a>(i, scramble, u);
00219                         <a class="code" href="classVector.html">Vector</a> w = <a class="code" href="mc_8h.html#a9">CosineSampleHemisphere</a>(u[0], u[1]);
00220                         <a class="code" href="classRayDifferential.html">RayDifferential</a> r(p, bsdf-&gt;<a class="code" href="classBSDF.html#a9">LocalToWorld</a>(w));
00221                         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(r.<a class="code" href="classRay.html#o1">d</a>, n) &lt; 0) r.<a class="code" href="classRay.html#o1">d</a> = -r.<a class="code" href="classRay.html#o1">d</a>;
00222                         <a class="code" href="classSpectrum.html">Spectrum</a> L(0.);
00223                         <span class="comment">// Do path tracing to compute radiance along ray for estimate</span>
00224                         {
00225                         <span class="comment">// Declare common path integration variables</span>
00226                         <a class="code" href="classSpectrum.html">Spectrum</a> pathThroughput = 1.;
00227                         <a class="code" href="classRayDifferential.html">RayDifferential</a> ray(r);
00228                         <span class="keywordtype">bool</span> specularBounce = <span class="keyword">false</span>;
00229                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> pathLength = 0; ; ++pathLength) {
00230                                 <span class="comment">// Find next vertex of path</span>
00231                                 <a class="code" href="structIntersection.html">Intersection</a> isect;
00232                                 <span class="keywordflow">if</span> (!scene-&gt;<a class="code" href="classScene.html#a3">Intersect</a>(ray, &amp;isect))
00233                                         <span class="keywordflow">break</span>;
00234                                 <span class="keywordflow">if</span> (pathLength == 0)
00235                                         r.<a class="code" href="classRay.html#o3">maxt</a> = ray.<a class="code" href="classRay.html#o3">maxt</a>;
00236                                 pathThroughput *= scene-&gt;<a class="code" href="classScene.html#a7">Transmittance</a>(ray);
00237                                 <span class="comment">// Possibly add emitted light at path vertex</span>
00238                                 <span class="keywordflow">if</span> (specularBounce)
00239                                         L += pathThroughput * isect.<a class="code" href="structIntersection.html#a2">Le</a>(-ray.<a class="code" href="classRay.html#o1">d</a>);
00240                                 <span class="comment">// Evaluate BSDF at hit point</span>
00241                                 <a class="code" href="classBSDF.html">BSDF</a> *bsdf = isect.<a class="code" href="structIntersection.html#a1">GetBSDF</a>(ray);
00242                                 <span class="comment">// Sample illumination from lights to find path contribution</span>
00243                                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o0">p</a>;
00244                                 <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n = bsdf-&gt;<a class="code" href="classBSDF.html#o0">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#o1">nn</a>;
00245                                 <a class="code" href="classVector.html">Vector</a> wo = -ray.<a class="code" href="classRay.html#o1">d</a>;
00246                                 L += pathThroughput *
00247                                         <a class="code" href="transport_8h.html#a1">UniformSampleOneLight</a>(scene, p, n, wo, bsdf, sample);
00248                                 <span class="keywordflow">if</span> (pathLength+1 == <a class="code" href="classIrradianceCache.html#r3">maxIndirectDepth</a>) <span class="keywordflow">break</span>;
00249                                 <span class="comment">// Sample BSDF to get new path direction</span>
00250                                 <span class="comment">// Get random numbers for sampling new direction, \mono{bs1}, \mono{bs2}, and \mono{bcs}</span>
00251                                 <span class="keywordtype">float</span> bs1 = <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(), bs2 = <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(), bcs = <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>();
00252                                 <a class="code" href="classVector.html">Vector</a> wi;
00253                                 <span class="keywordtype">float</span> pdf;
00254                                 <a class="code" href="reflection_8h.html#a17">BxDFType</a> flags;
00255                                 <a class="code" href="classSpectrum.html">Spectrum</a> f = bsdf-&gt;<a class="code" href="classBSDF.html#a0">Sample_f</a>(wo, &amp;wi, bs1, bs2, bcs,
00256                                         &amp;pdf, <a class="code" href="reflection_8h.html#a17a10">BSDF_ALL</a>, &amp;flags);
00257                                 <span class="keywordflow">if</span> (f.<a class="code" href="classSpectrum.html#a15">Black</a>() || pdf == 0.)
00258                                         <span class="keywordflow">break</span>;
00259                                 specularBounce = (flags &amp; <a class="code" href="reflection_8h.html#a17a6">BSDF_SPECULAR</a>) != 0;
00260                                 pathThroughput *= f * <a class="code" href="geometry_8h.html#a20">AbsDot</a>(wi, n) / pdf;
00261                                 ray = <a class="code" href="classRayDifferential.html">RayDifferential</a>(p, wi);
00262                                 <span class="comment">// Possibly terminate the path</span>
00263                                 <span class="keywordflow">if</span> (pathLength &gt; 3) {
00264                                         <span class="keywordtype">float</span> continueProbability = .5f;
00265                                         <span class="keywordflow">if</span> (<a class="code" href="pbrt_8h.html#a108">RandomFloat</a>() &gt; continueProbability)
00266                                                 <span class="keywordflow">break</span>;
00267                                         pathThroughput /= continueProbability;
00268                                 }
00269                         }
00270                         }
00271                         E += L;
00272                         <span class="keywordtype">float</span> dist = r.<a class="code" href="classRay.html#o3">maxt</a> * r.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#a15">Length</a>();
00273                         sumInvDists += 1.f / dist;
00274                 }
00275                 E *= <a class="code" href="pbrt_8h.html#a6">M_PI</a> / float(nSamples);
00276                 <span class="comment">// Add computed irradiance value to cache</span>
00277                 <span class="comment">// Update statistics for new irradiance sample</span>
00278                 <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> nSamplesComputed(<span class="stringliteral">"Irradiance Cache"</span>,
00279                         <span class="stringliteral">"Irradiance estimates computed"</span>);
00280                 ++nSamplesComputed;
00281                 <span class="comment">// Compute bounding box of irradiance sample's contribution region</span>
00282                 <span class="keyword">static</span> <span class="keywordtype">float</span> minMaxDist =
00283                         .001f * powf(scene-&gt;<a class="code" href="classScene.html#a5">WorldBound</a>().<a class="code" href="classBBox.html#a6">Volume</a>(), 1.f/3.f);
00284                 <span class="keyword">static</span> <span class="keywordtype">float</span> maxMaxDist =
00285                         .125f * powf(scene-&gt;<a class="code" href="classScene.html#a5">WorldBound</a>().<a class="code" href="classBBox.html#a6">Volume</a>(), 1.f/3.f);
00286                 <span class="keywordtype">float</span> maxDist = nSamples / sumInvDists;
00287                 <span class="keywordflow">if</span> (minMaxDist &gt; 0.f)
00288                         maxDist = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(maxDist, minMaxDist, maxMaxDist);
00289                 maxDist *= <a class="code" href="classIrradianceCache.html#r0">maxError</a>;
00290                 <a class="code" href="classBBox.html">BBox</a> sampleExtent(p);
00291                 sampleExtent.<a class="code" href="classBBox.html#a5">Expand</a>(maxDist);
00292                 <a class="code" href="classIrradianceCache.html#r9">octree</a>-&gt;<a class="code" href="classOctree.html#a1">Add</a>(<a class="code" href="structIrradianceSample.html">IrradianceSample</a>(E, p, n, maxDist),
00293                         sampleExtent);
00294         }
00295         <span class="keywordflow">return</span> .5f * bsdf-&gt;<a class="code" href="classBSDF.html#a11">rho</a>(wo, flags) * E;
00296 }
<a name="l00297"></a><a class="code" href="classIrradianceCache.html#a4">00297</a> <span class="keywordtype">void</span> <a class="code" href="classIrradianceCache.html#a4">IrradianceCache::Preprocess</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene) {
00298         <a class="code" href="classBBox.html">BBox</a> wb = scene-&gt;<a class="code" href="classScene.html#a5">WorldBound</a>();
00299         <a class="code" href="classVector.html">Vector</a> delta = .01f * (wb.<a class="code" href="classBBox.html#o1">pMax</a> - wb.<a class="code" href="classBBox.html#o0">pMin</a>);
00300         wb.<a class="code" href="classBBox.html#o0">pMin</a> -= delta;
00301         wb.<a class="code" href="classBBox.html#o1">pMax</a> += delta;
00302         <a class="code" href="classIrradianceCache.html#r9">octree</a> = <span class="keyword">new</span> <a class="code" href="classOctree.html">Octree&lt;IrradianceSample, IrradProcess&gt;</a>(wb);
00303 }
<a name="l00304"></a><a class="code" href="classIrradianceCache.html#a1">00304</a> <a class="code" href="classIrradianceCache.html#a1">IrradianceCache::~IrradianceCache</a>() {
00305         <span class="keyword">delete</span> <a class="code" href="classIrradianceCache.html#r9">octree</a>;
00306 }
00307 <span class="keywordtype">bool</span>
<a name="l00308"></a><a class="code" href="classIrradianceCache.html#d1">00308</a> <a class="code" href="classIrradianceCache.html#d1">IrradianceCache::InterpolateIrradiance</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene,
00309                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;n, <a class="code" href="classSpectrum.html">Spectrum</a> *E)<span class="keyword"> const </span>{
00310         <span class="keywordflow">if</span> (!<a class="code" href="classIrradianceCache.html#r9">octree</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00311         <a class="code" href="structIrradProcess.html">IrradProcess</a> proc(n, <a class="code" href="classIrradianceCache.html#r0">maxError</a>);
00312         <a class="code" href="classIrradianceCache.html#r9">octree</a>-&gt;<a class="code" href="classOctree.html#a2">Lookup</a>(p, proc);
00313         <span class="comment">// Update irradiance cache lookup statistics</span>
00314         <span class="keyword">static</span> <a class="code" href="classStatsPercentage.html">StatsPercentage</a> nSuccessfulLookups(<span class="stringliteral">"Irradiance Cache"</span>,
00315                 <span class="stringliteral">"Successful irradiance cache lookups"</span>);
00316         <span class="keyword">static</span> <a class="code" href="classStatsRatio.html">StatsRatio</a> nSamplesFound(<span class="stringliteral">"Irradiance Cache"</span>,
00317                 <span class="stringliteral">"Irradiance samples found per successful lookup"</span>);
00318         <span class="keyword">static</span> <a class="code" href="classStatsRatio.html">StatsRatio</a> nSamplesChecked(<span class="stringliteral">"Irradiance Cache"</span>,
00319                 <span class="stringliteral">"Irradiance samples checked per lookup"</span>);
00320         nSuccessfulLookups.<a class="code" href="classStatsPercentage.html#a0">Add</a>(proc.<a class="code" href="structIrradProcess.html#a2">Successful</a>() ? 1 : 0, 1);
00321         nSamplesFound.<a class="code" href="classStatsRatio.html#a1">Add</a>(proc.<a class="code" href="structIrradProcess.html#o2">nFound</a>, 1);
00322         nSamplesChecked.<a class="code" href="classStatsRatio.html#a1">Add</a>(proc.<a class="code" href="structIrradProcess.html#o3">samplesChecked</a>, 1);
00323         <span class="keywordflow">if</span> (!proc.<a class="code" href="structIrradProcess.html#a2">Successful</a>()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00324         *E = proc.<a class="code" href="structIrradProcess.html#a3">GetIrradiance</a>();
00325         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00326 }
<a name="l00327"></a><a class="code" href="structIrradProcess.html#a1">00327</a> <span class="keywordtype">void</span> <a class="code" href="structIrradProcess.html#a1">IrradProcess::operator()</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p,
00328                 <span class="keyword">const</span> <a class="code" href="structIrradianceSample.html">IrradianceSample</a> &amp;sample)<span class="keyword"> const </span>{
00329         ++<a class="code" href="structIrradProcess.html#o3">samplesChecked</a>;
00330         <span class="comment">// Skip irradiance sample if surface normals are too different</span>
00331         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="structIrradProcess.html#o0">n</a>, sample.<a class="code" href="structIrradianceSample.html#o1">n</a>) &lt; 0.01f)
00332                 <span class="keywordflow">return</span>;
00333         <span class="comment">// Skip irradiance sample if it's too far from the sample point</span>
00334         <span class="keywordtype">float</span> d2 = <a class="code" href="geometry_8h.html#a10">DistanceSquared</a>(p, sample.<a class="code" href="structIrradianceSample.html#o2">p</a>);
00335         <span class="keywordflow">if</span> (d2 &gt; sample.<a class="code" href="structIrradianceSample.html#o3">maxDist</a> * sample.<a class="code" href="structIrradianceSample.html#o3">maxDist</a>)
00336                 <span class="keywordflow">return</span>;
00337         <span class="comment">// Skip irradiance sample if it's in front of point being shaded</span>
00338         <a class="code" href="classNormal.html">Normal</a> navg = sample.<a class="code" href="structIrradianceSample.html#o1">n</a> + <a class="code" href="structIrradProcess.html#o0">n</a>;
00339         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#a17">Dot</a>(p - sample.<a class="code" href="structIrradianceSample.html#o2">p</a>, navg) &lt; -.01f)
00340                 <span class="keywordflow">return</span>;
00341         <span class="comment">// Compute estimate error term and possibly use sample</span>
00342         <span class="keywordtype">float</span> err = sqrtf(d2) / (sample.<a class="code" href="structIrradianceSample.html#o3">maxDist</a> * <a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="structIrradProcess.html#o0">n</a>, sample.<a class="code" href="structIrradianceSample.html#o1">n</a>));
00343         <span class="keywordflow">if</span> (err &lt; 1.) {
00344                 ++<a class="code" href="structIrradProcess.html#o2">nFound</a>;
00345                 <span class="keywordtype">float</span> wt = (1.f - err) * (1.f - err);
00346                 <a class="code" href="structIrradProcess.html#o5">E</a> += wt * sample.<a class="code" href="structIrradianceSample.html#o0">E</a>;
00347                 <a class="code" href="structIrradProcess.html#o4">sumWt</a> += wt;
00348         }
00349 }
<a name="l00350"></a><a class="code" href="irradiancecache_8cpp.html#a0">00350</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> *<a class="code" href="whitted_8cpp.html#a0">CreateSurfaceIntegrator</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params) {
00351         <span class="keywordtype">float</span> maxError = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"maxerror"</span>, .2f);
00352         <span class="keywordtype">int</span> maxSpecularDepth = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"maxspeculardepth"</span>, 5);
00353         <span class="keywordtype">int</span> maxIndirectDepth = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"maxindirectdepth"</span>, 3);
00354         <span class="keywordtype">int</span> nSamples = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"nsamples"</span>, 4096);
00355         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classIrradianceCache.html">IrradianceCache</a>(maxSpecularDepth, maxIndirectDepth,
00356                 maxError, nSamples);
00357 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:21 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
