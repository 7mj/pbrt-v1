<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: infinitesample.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>infinitesample.cpp</h1><a href="infinitesample_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// infinitesample.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="light_8h.html">light.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="texture_8h.html">texture.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="shape_8h.html">shape.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="scene_8h.html">scene.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="mipmap_8h.html">mipmap.h</a>"</span>
00018 <span class="comment">// Utility Classes and Functions</span>
<a name="l00019"></a><a class="code" href="structDistribution1D.html">00019</a> <span class="keyword">struct </span><a class="code" href="structDistribution1D.html">Distribution1D</a> {
00020         <span class="comment">// Distribution1D Methods</span>
<a name="l00021"></a><a class="code" href="structDistribution1D.html#a0">00021</a>         <a class="code" href="structDistribution1D.html">Distribution1D</a>(<span class="keywordtype">float</span> *f, <span class="keywordtype">int</span> n) {
00022                 <a class="code" href="structDistribution1D.html#o0">func</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[n];
00023                 <a class="code" href="structDistribution1D.html#o1">cdf</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[n+1];
00024                 <a class="code" href="structDistribution1D.html#o5">count</a> = n;
00025                 <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>(<a class="code" href="structDistribution1D.html#o0">func</a>, f, n*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00026                 <a class="code" href="pbrt_8h.html#a89">ComputeStep1dCDF</a>(<a class="code" href="structDistribution1D.html#o0">func</a>, n, &amp;<a class="code" href="structDistribution1D.html#o2">funcInt</a>, <a class="code" href="structDistribution1D.html#o1">cdf</a>);
00027                 <a class="code" href="structDistribution1D.html#o3">invFuncInt</a> = 1.f / <a class="code" href="structDistribution1D.html#o2">funcInt</a>;
00028                 <a class="code" href="structDistribution1D.html#o4">invCount</a> = 1.f / <a class="code" href="structDistribution1D.html#o5">count</a>;
00029         }
<a name="l00030"></a><a class="code" href="structDistribution1D.html#a1">00030</a>         <span class="keywordtype">float</span> <a class="code" href="structSample.html">Sample</a>(<span class="keywordtype">float</span> u, <span class="keywordtype">float</span> *pdf) {
00031                 <span class="comment">// Find surrounding cdf segments</span>
00032                 <span class="keywordtype">float</span> *ptr = std::lower_bound(<a class="code" href="structDistribution1D.html#o1">cdf</a>, <a class="code" href="structDistribution1D.html#o1">cdf</a>+<a class="code" href="structDistribution1D.html#o5">count</a>+1, u);
00033                 <span class="keywordtype">int</span> offset = (<span class="keywordtype">int</span>) (ptr-<a class="code" href="structDistribution1D.html#o1">cdf</a>-1);
00034                 <span class="comment">// Return offset along current cdf segment</span>
00035                 u = (u - <a class="code" href="structDistribution1D.html#o1">cdf</a>[offset]) / (cdf[offset+1] - cdf[offset]);
00036                 *pdf = <a class="code" href="structDistribution1D.html#o0">func</a>[offset] * <a class="code" href="structDistribution1D.html#o3">invFuncInt</a>;
00037                 <span class="keywordflow">return</span> offset + u;
00038         }
00039         <span class="comment">// Distribution1D Data</span>
<a name="l00040"></a><a class="code" href="structDistribution1D.html#o0">00040</a>         <span class="keywordtype">float</span> *<a class="code" href="structDistribution1D.html#o0">func</a>, *<a class="code" href="structDistribution1D.html#o1">cdf</a>;
<a name="l00041"></a><a class="code" href="structDistribution1D.html#o3">00041</a>         <span class="keywordtype">float</span> <a class="code" href="structDistribution1D.html#o2">funcInt</a>, <a class="code" href="structDistribution1D.html#o3">invFuncInt</a>, <a class="code" href="structDistribution1D.html#o4">invCount</a>;
<a name="l00042"></a><a class="code" href="structDistribution1D.html#o5">00042</a>         <span class="keywordtype">int</span> <a class="code" href="structDistribution1D.html#o5">count</a>;
00043 };
00044 <span class="comment">// InfiniteAreaLightIS Definitions</span>
<a name="l00045"></a><a class="code" href="classInfiniteAreaLightIS.html">00045</a> <span class="keyword">class </span><a class="code" href="classInfiniteAreaLightIS.html">InfiniteAreaLightIS</a> : <span class="keyword">public</span> <a class="code" href="classLight.html">Light</a> {
00046 <span class="keyword">public</span>:
00047         <span class="comment">// InfiniteAreaLightIS Public Methods</span>
00048         <a class="code" href="classInfiniteAreaLightIS.html">InfiniteAreaLightIS</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;light2world,       <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;power, <span class="keywordtype">int</span> ns,
00049                           <span class="keyword">const</span> string &amp;texmap);
00050         <a class="code" href="classInfiniteAreaLightIS.html#a1">~InfiniteAreaLightIS</a>();
<a name="l00051"></a><a class="code" href="classInfiniteAreaLightIS.html#a2">00051</a>         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classInfiniteAreaLightIS.html#a2">Power</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene)<span class="keyword"> const </span>{
00052                 <a class="code" href="classPoint.html">Point</a> worldCenter;
00053                 <span class="keywordtype">float</span> worldRadius;
00054                 scene-&gt;<a class="code" href="classScene.html#a5">WorldBound</a>().<a class="code" href="classBBox.html#a8">BoundingSphere</a>(&amp;worldCenter,
00055                         &amp;worldRadius);
00056                 <span class="keywordflow">return</span> <a class="code" href="classInfiniteAreaLightIS.html#r0">Lbase</a> * <a class="code" href="classInfiniteAreaLightIS.html#r1">radianceMap</a>-&gt;<a class="code" href="classMIPMap.html#a2">Lookup</a>(.5f, .5f, .5f) *
00057                         <a class="code" href="pbrt_8h.html#a6">M_PI</a> * worldRadius * worldRadius;
00058         }
<a name="l00059"></a><a class="code" href="classInfiniteAreaLightIS.html#a3">00059</a>         <span class="keywordtype">bool</span> <a class="code" href="classInfiniteAreaLightIS.html#a3">IsDeltaLight</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="keyword">false</span>; }
00060         <a class="code" href="classSpectrum.html">Spectrum</a> Le(<span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;r) <span class="keyword">const</span>;
00061         <a class="code" href="classSpectrum.html">Spectrum</a> Sample_L(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <a class="code" href="classVector.html">Vector</a> *wi, <span class="keywordtype">float</span> *pdf,
00062                 <a class="code" href="structVisibilityTester.html">VisibilityTester</a> *visibility) <span class="keyword">const</span>;
00063         <a class="code" href="classSpectrum.html">Spectrum</a> Sample_L(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene, <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
00064                         <span class="keywordtype">float</span> u3, <span class="keywordtype">float</span> u4, <a class="code" href="classRay.html">Ray</a> *ray, <span class="keywordtype">float</span> *pdf) <span class="keyword">const</span>;
00065         <span class="keywordtype">float</span> Pdf(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;) const;
00066         <a class="code" href="classSpectrum.html">Spectrum</a> Sample_L(const <a class="code" href="classPoint.html">Point</a> &amp;P, <a class="code" href="classVector.html">Vector</a> *w, <a class="code" href="structVisibilityTester.html">VisibilityTester</a> *visibility) const;
00067 
00068 private:
00069         <span class="comment">// InfiniteAreaLightIS Private Data</span>
<a name="l00070"></a><a class="code" href="classInfiniteAreaLightIS.html#r0">00070</a>         <a class="code" href="classSpectrum.html">Spectrum</a> Lbase;
<a name="l00071"></a><a class="code" href="classInfiniteAreaLightIS.html#r1">00071</a>         <a class="code" href="classMIPMap.html">MIPMap</a>&lt;<a class="code" href="classSpectrum.html">Spectrum</a>&gt; *radianceMap;
<a name="l00072"></a><a class="code" href="classInfiniteAreaLightIS.html#r3">00072</a>         <a class="code" href="structDistribution1D.html">Distribution1D</a> *uDistrib, **vDistribs;
00073 };
00074 
00075 <span class="comment">// InfiniteAreaLightIS Method Definitions</span>
<a name="l00076"></a><a class="code" href="classInfiniteAreaLightIS.html#a1">00076</a> <a class="code" href="classInfiniteAreaLightIS.html">InfiniteAreaLightIS</a>::~<a class="code" href="classInfiniteAreaLightIS.html">InfiniteAreaLightIS</a>() {
00077         <span class="keyword">delete</span> radianceMap;
00078 }
00079 InfiniteAreaLightIS
<a name="l00080"></a><a class="code" href="classInfiniteAreaLightIS.html#a0">00080</a>         ::InfiniteAreaLightIS(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;light2world,
00081                                 <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;L, <span class="keywordtype">int</span> ns,
00082                                 <span class="keyword">const</span> string &amp;texmap)
00083         : <a class="code" href="classLight.html">Light</a>(light2world, ns)
00084 {
00085         <a class="code" href="classInfiniteAreaLightIS.html#r1">radianceMap</a> = NULL;
00086         <span class="keywordflow">if</span> (texmap != <span class="stringliteral">""</span>) {
00087         <span class="keywordtype">int</span> width, height;
00088         <a class="code" href="classSpectrum.html">Spectrum</a> *texels =
00089                 <a class="code" href="pbrt_8h.html#a70">ReadImage</a>(texmap, &amp;width, &amp;height);
00090         <span class="keywordflow">if</span> (texels)
00091                 <a class="code" href="classInfiniteAreaLightIS.html#r1">radianceMap</a> =
00092                 <span class="keyword">new</span> <a class="code" href="classMIPMap.html">MIPMap&lt;Spectrum&gt;</a>(width, height, texels);
00093         <span class="comment">// Compute scalar-valued image from environment map</span>
00094         <span class="keywordtype">float</span> filter = 1.f / max(width, height);
00095         <span class="keywordtype">int</span> nu = width, nv = height;
00096         <span class="keywordtype">float</span> *img = <span class="keyword">new</span> <span class="keywordtype">float</span>[width*height];
00097         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; nu; ++x) {
00098                 <span class="keywordtype">float</span> xp = (<span class="keywordtype">float</span>)x / (<span class="keywordtype">float</span>)nu;
00099                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; nv; ++y) {
00100                         <span class="keywordtype">float</span> yp = (<span class="keywordtype">float</span>)y / (<span class="keywordtype">float</span>)nv;
00101                         img[y+x*nv] = <a class="code" href="classInfiniteAreaLightIS.html#r1">radianceMap</a>-&gt;<a class="code" href="classMIPMap.html#a2">Lookup</a>(xp, yp, filter).<a class="code" href="classSpectrum.html#a23">y</a>();
00102                 }
00103         }
00104         <span class="comment">// Initialize sampling PDFs for infinite area light</span>
00105         <span class="keywordtype">float</span> *func = (<span class="keywordtype">float</span> *)alloca(max(nu, nv) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00106         <span class="keywordtype">float</span> *sinVals = (<span class="keywordtype">float</span> *)alloca(nv * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00107         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nv; ++i)
00108                 sinVals[i] = sin(<a class="code" href="pbrt_8h.html#a6">M_PI</a> * <span class="keywordtype">float</span>(i+.5)/<span class="keywordtype">float</span>(nv));
00109         <a class="code" href="classInfiniteAreaLightIS.html#r3">vDistribs</a> = <span class="keyword">new</span> <a class="code" href="structDistribution1D.html">Distribution1D</a> *[nu];
00110         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> u = 0; u &lt; nu; ++u) {
00111                 <span class="comment">// Compute sampling distribution for column _u_</span>
00112                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> v = 0; v &lt; nv; ++v)
00113                         func[v] = img[u*nv+v] *= sinVals[v];
00114                 <a class="code" href="classInfiniteAreaLightIS.html#r3">vDistribs</a>[u] = <span class="keyword">new</span> Distribution1D(func, nv);
00115         }
00116         <span class="comment">// Compute sampling distribution for columns of image</span>
00117         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> u = 0; u &lt; nu; ++u)
00118                 func[u] = <a class="code" href="classInfiniteAreaLightIS.html#r3">vDistribs</a>[u]-&gt;<a class="code" href="structDistribution1D.html#o2">funcInt</a>;
00119         <a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a> = <span class="keyword">new</span> Distribution1D(func, nu);
00120         <span class="keyword">delete</span>[] img;
00121         <span class="keyword">delete</span>[] texels;
00122         }
00123         <a class="code" href="classInfiniteAreaLightIS.html#r0">Lbase</a> = L;
00124 }
00125 <a class="code" href="classSpectrum.html">Spectrum</a>
<a name="l00126"></a><a class="code" href="classInfiniteAreaLightIS.html#a4">00126</a>         <a class="code" href="classInfiniteAreaLightIS.html#a4">InfiniteAreaLightIS::Le</a>(<span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;r)<span class="keyword"> const </span>{
00127         <a class="code" href="classVector.html">Vector</a> w = r.<a class="code" href="classRay.html#o1">d</a>;
00128         <span class="comment">// Compute infinite light radiance for direction</span>
00129         <a class="code" href="classSpectrum.html">Spectrum</a> L = <a class="code" href="classInfiniteAreaLightIS.html#r0">Lbase</a>;
00130         <span class="keywordflow">if</span> (<a class="code" href="classInfiniteAreaLightIS.html#r1">radianceMap</a> != NULL) {
00131                 <a class="code" href="classVector.html">Vector</a> wh = <a class="code" href="geometry_8h.html#a14">Normalize</a>(WorldToLight(w));
00132                 <span class="keywordtype">float</span> s = <a class="code" href="geometry_8h.html#a27">SphericalPhi</a>(wh) * <a class="code" href="pbrt_8h.html#a8">INV_TWOPI</a>;
00133                 <span class="keywordtype">float</span> t = <a class="code" href="geometry_8h.html#a26">SphericalTheta</a>(wh) * <a class="code" href="pbrt_8h.html#a7">INV_PI</a>;
00134                 L *= <a class="code" href="classInfiniteAreaLightIS.html#r1">radianceMap</a>-&gt;<a class="code" href="classMIPMap.html#a2">Lookup</a>(s, t);
00135         }
00136         <span class="keywordflow">return</span> L;
00137 }
<a name="l00138"></a><a class="code" href="classInfiniteAreaLightIS.html#a5">00138</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classInfiniteAreaLightIS.html#a5">InfiniteAreaLightIS::Sample_L</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keywordtype">float</span> u1,
00139                 <span class="keywordtype">float</span> u2, <a class="code" href="classVector.html">Vector</a> *wi, <span class="keywordtype">float</span> *pdf,
00140                 <a class="code" href="structVisibilityTester.html">VisibilityTester</a> *visibility)<span class="keyword"> const </span>{
00141         <span class="comment">// Find floating-point $(u,v)$ sample coordinates</span>
00142         <span class="keywordtype">float</span> pdfs[2];
00143         <span class="keywordtype">float</span> fu = <a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a>-&gt;<a class="code" href="structDistribution1D.html#a1">Sample</a>(u1, &amp;pdfs[0]);
00144         <span class="keywordtype">int</span> u = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(<a class="code" href="pbrt_8h.html#a105">Float2Int</a>(fu), 0, <a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a>-&gt;<a class="code" href="structDistribution1D.html#o5">count</a>-1);
00145         <span class="keywordtype">float</span> fv = <a class="code" href="classInfiniteAreaLightIS.html#r3">vDistribs</a>[u]-&gt;<a class="code" href="structDistribution1D.html#a1">Sample</a>(u2, &amp;pdfs[1]);
00146         <span class="comment">// Convert sample point to direction on the unit sphere</span>
00147         <span class="keywordtype">float</span> theta = fv * vDistribs[u]-&gt;invCount * <a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00148         <span class="keywordtype">float</span> phi = fu * <a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a>-&gt;<a class="code" href="structDistribution1D.html#o4">invCount</a> * 2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>;
00149         <span class="keywordtype">float</span> costheta = cos(theta), sintheta = sin(theta);
00150         <span class="keywordtype">float</span> sinphi = sin(phi), cosphi = cos(phi);
00151         *wi = LightToWorld(<a class="code" href="classVector.html">Vector</a>(sintheta * cosphi, sintheta * sinphi,
00152                                   costheta));
00153         <span class="comment">// Compute PDF for sampled direction</span>
00154         *pdf = (pdfs[0] * pdfs[1]) / (2. * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * sintheta);
00155         <span class="comment">// Return radiance value for direction</span>
00156         visibility-&gt;<a class="code" href="structVisibilityTester.html#a1">SetRay</a>(p, *wi);
00157         <span class="keywordflow">return</span> <a class="code" href="classInfiniteAreaLightIS.html#r0">Lbase</a> * <a class="code" href="classInfiniteAreaLightIS.html#r1">radianceMap</a>-&gt;<a class="code" href="classMIPMap.html#a2">Lookup</a>(fu * <a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a>-&gt;<a class="code" href="structDistribution1D.html#o4">invCount</a>,
00158                 fv * vDistribs[u]-&gt;invCount);
00159 }
<a name="l00160"></a><a class="code" href="classInfiniteAreaLightIS.html#a7">00160</a> <span class="keywordtype">float</span> <a class="code" href="classInfiniteAreaLightIS.html#a7">InfiniteAreaLightIS::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;,
00161                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w)<span class="keyword"> const </span>{
00162         <a class="code" href="classVector.html">Vector</a> wi = WorldToLight(w);
00163         <span class="keywordtype">float</span> theta = <a class="code" href="geometry_8h.html#a26">SphericalTheta</a>(wi), phi = <a class="code" href="geometry_8h.html#a27">SphericalPhi</a>(wi);
00164         <span class="keywordtype">int</span> u = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(<a class="code" href="pbrt_8h.html#a105">Float2Int</a>(phi * <a class="code" href="pbrt_8h.html#a8">INV_TWOPI</a> * <a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a>-&gt;<a class="code" href="structDistribution1D.html#o5">count</a>),
00165                   0, <a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a>-&gt;<a class="code" href="structDistribution1D.html#o5">count</a>-1);
00166         <span class="keywordtype">int</span> v = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(<a class="code" href="pbrt_8h.html#a105">Float2Int</a>(theta * <a class="code" href="pbrt_8h.html#a7">INV_PI</a> * <a class="code" href="classInfiniteAreaLightIS.html#r3">vDistribs</a>[u]-&gt;count),
00167                   0, <a class="code" href="classInfiniteAreaLightIS.html#r3">vDistribs</a>[u]-&gt;count-1);
00168         <span class="keywordflow">return</span> (<a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a>-&gt;<a class="code" href="structDistribution1D.html#o0">func</a>[u] * <a class="code" href="classInfiniteAreaLightIS.html#r3">vDistribs</a>[u]-&gt;<a class="code" href="structDistribution1D.html#o0">func</a>[v]) /
00169            (<a class="code" href="classInfiniteAreaLightIS.html#r2">uDistrib</a>-&gt;<a class="code" href="structDistribution1D.html#o2">funcInt</a> * <a class="code" href="classInfiniteAreaLightIS.html#r3">vDistribs</a>[u]-&gt;<a class="code" href="structDistribution1D.html#o2">funcInt</a>) *
00170            1.f / (2.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * sin(theta));
00171 }
<a name="l00172"></a><a class="code" href="classInfiniteAreaLightIS.html#a6">00172</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classInfiniteAreaLightIS.html#a5">InfiniteAreaLightIS::Sample_L</a>(<span class="keyword">const</span> <a class="code" href="classScene.html">Scene</a> *scene,
00173                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> u3, <span class="keywordtype">float</span> u4,
00174                 <a class="code" href="classRay.html">Ray</a> *ray, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
00175         <span class="comment">// Choose two points _p1_ and _p2_ on scene bounding sphere</span>
00176         <a class="code" href="classPoint.html">Point</a> worldCenter;
00177         <span class="keywordtype">float</span> worldRadius;
00178         scene-&gt;<a class="code" href="classScene.html#a5">WorldBound</a>().<a class="code" href="classBBox.html#a8">BoundingSphere</a>(&amp;worldCenter,
00179                 &amp;worldRadius);
00180         worldRadius *= 1.01f;
00181         <a class="code" href="classPoint.html">Point</a> p1 = worldCenter + worldRadius *
00182                 <a class="code" href="mc_8h.html#a3">UniformSampleSphere</a>(u1, u2);
00183         <a class="code" href="classPoint.html">Point</a> p2 = worldCenter + worldRadius *
00184                 <a class="code" href="mc_8h.html#a3">UniformSampleSphere</a>(u3, u4);
00185         <span class="comment">// Construct ray between _p1_ and _p2_</span>
00186         ray-&gt;<a class="code" href="classRay.html#o0">o</a> = p1;
00187         ray-&gt;<a class="code" href="classRay.html#o1">d</a> = <a class="code" href="geometry_8h.html#a14">Normalize</a>(p2-p1);
00188         <span class="comment">// Compute _InfiniteAreaLightIS_ ray weight</span>
00189         <a class="code" href="classVector.html">Vector</a> to_center = <a class="code" href="geometry_8h.html#a14">Normalize</a>(worldCenter - p1);
00190         <span class="keywordtype">float</span> costheta = <a class="code" href="geometry_8h.html#a20">AbsDot</a>(to_center,ray-&gt;<a class="code" href="classRay.html#o1">d</a>);
00191         *pdf =
00192                 costheta / ((4.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a> * worldRadius * worldRadius));
00193         <span class="keywordflow">return</span> Le(<a class="code" href="classRayDifferential.html">RayDifferential</a>(ray-&gt;<a class="code" href="classRay.html#o0">o</a>, -ray-&gt;<a class="code" href="classRay.html#o1">d</a>));
00194 }
<a name="l00195"></a><a class="code" href="classInfiniteAreaLightIS.html#a8">00195</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classInfiniteAreaLightIS.html#a5">InfiniteAreaLightIS::Sample_L</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p,
00196                 <a class="code" href="classVector.html">Vector</a> *wi, <a class="code" href="structVisibilityTester.html">VisibilityTester</a> *visibility)<span class="keyword"> const </span>{
00197         <span class="keywordtype">float</span> pdf;
00198         <a class="code" href="classSpectrum.html">Spectrum</a> L = Sample_L(p, <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(), <a class="code" href="pbrt_8h.html#a108">RandomFloat</a>(),
00199                 wi, &amp;pdf, visibility);
00200         <span class="keywordflow">if</span> (pdf == 0.) <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.);
00201         <span class="keywordflow">return</span> L / pdf;
00202 }
00203 
<a name="l00204"></a><a class="code" href="infinitesample_8cpp.html#a0">00204</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classLight.html">Light</a> *<a class="code" href="spot_8cpp.html#a0">CreateLight</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;light2world,
00205                 <span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;paramSet) {
00206         <a class="code" href="classSpectrum.html">Spectrum</a> L = paramSet.<a class="code" href="classParamSet.html#a27">FindOneSpectrum</a>(<span class="stringliteral">"L"</span>, <a class="code" href="classSpectrum.html">Spectrum</a>(1.0));
00207         string texmap = paramSet.<a class="code" href="classParamSet.html#a28">FindOneString</a>(<span class="stringliteral">"mapname"</span>, <span class="stringliteral">""</span>);
00208         <span class="keywordtype">int</span> nSamples = paramSet.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"nsamples"</span>, 1);
00209 
00210         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classInfiniteAreaLightIS.html">InfiniteAreaLightIS</a>(light2world, L, nSamples, texmap);
00211 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:21 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
