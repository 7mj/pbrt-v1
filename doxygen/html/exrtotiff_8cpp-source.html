<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: exrtotiff.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>exrtotiff.cpp</h1><a href="exrtotiff_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment"> * exrtoiff.cpp</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> * $Id: exrtotiff.cpp,v 1.1 2004/05/14 01:23:50 mmp Exp $</span>
00005 <span class="comment"> */</span>
00006 
00007 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00008 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00009 <span class="preprocessor">#include &lt;tiffio.h&gt;</span>
00010 <span class="preprocessor">#include &lt;ImfInputFile.h&gt;</span>
00011 <span class="preprocessor">#include &lt;ImfChannelList.h&gt;</span>
00012 <span class="preprocessor">#include &lt;ImfFrameBuffer.h&gt;</span>
00013 <span class="preprocessor">#include &lt;half.h&gt;</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="film_8h.html">film.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
00018 
00019 <span class="keyword">using</span> <span class="keyword">namespace </span>Imf;
00020 <span class="keyword">using</span> <span class="keyword">namespace </span>Imath;
00021 
00022 <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="exrtotiff_8cpp.html#a1">ReadEXR</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">float</span> *&amp;rgba, <span class="keywordtype">int</span> &amp;xRes, <span class="keywordtype">int</span> &amp;yRes, <span class="keywordtype">bool</span> &amp;hasAlpha);
00023 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="exrtotiff_8cpp.html#a2">WriteTIFF</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">float</span> *rgba, <span class="keywordtype">int</span> xRes, <span class="keywordtype">int</span> yRes, <span class="keywordtype">bool</span> hasAlpha);
00024 
<a name="l00025"></a><a class="code" href="exrtotiff_8cpp.html#a3">00025</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="exrtotiff_8cpp.html#a3">usage</a>() {
00026   fprintf( stderr, <span class="stringliteral">"usage: exrtotiff [options] &lt;input.exr&gt; &lt;output.tiff&gt;\n"</span> );
00027   fprintf( stderr, <span class="stringliteral">"Supported options:\n"</span>);
00028   fprintf( stderr, <span class="stringliteral">"\t-scale scale\n"</span> );
00029   fprintf( stderr, <span class="stringliteral">"\t-gamma gamma\n"</span> );
00030   fprintf( stderr, <span class="stringliteral">"\t-tonemap mapname\n"</span> );
00031   fprintf( stderr, <span class="stringliteral">"\t-param name value (set tone map parameter)\n"</span> );
00032   fprintf( stderr, <span class="stringliteral">"\t-bloomRadius radius\n"</span> );
00033   fprintf( stderr, <span class="stringliteral">"\t-bloomWeight weight\n"</span> );
00034   fprintf( stderr, <span class="stringliteral">"\t-bg bg-grey color\n"</span>);
00035   exit(1);
00036 }
00037 
<a name="l00038"></a><a class="code" href="exrtotiff_8cpp.html#a4">00038</a> <span class="keywordtype">int</span> <a class="code" href="core_2samplepat_8cpp.html#a11">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) 
00039 {
00040     <span class="keywordtype">float</span> scale = 1.f, gamma = 2.2f;
00041     <span class="keywordtype">float</span> bloomRadius = 0.f, bloomWeight = .2f;
00042     <span class="keywordtype">float</span> bggray = -1.f;
00043     <span class="keywordtype">char</span> *toneMap = NULL;
00044     <a class="code" href="classParamSet.html">ParamSet</a> toneMapParams;
00045 
00046     <span class="keywordtype">int</span> argNum = 1;
00047     <span class="keywordflow">while</span> (argNum &lt; argc &amp;&amp; argv[argNum][0] == <span class="charliteral">'-'</span>) {
00048 <span class="preprocessor">#define ARG(name, var) \</span>
00049 <span class="preprocessor">      else if (!strcmp(argv[argNum], "-" name)) { \</span>
00050 <span class="preprocessor">        if (argNum+1 == argc) \</span>
00051 <span class="preprocessor">          usage(); \</span>
00052 <span class="preprocessor">        var = atof(argv[argNum+1]); \</span>
00053 <span class="preprocessor">        ++argNum; \</span>
00054 <span class="preprocessor">      }</span>
00055 <span class="preprocessor"></span>
00056         <span class="keywordflow">if</span> (!strcmp(argv[argNum], <span class="stringliteral">"-tonemap"</span>)) {
00057             <span class="keywordflow">if</span> (argNum+1 == argc)
00058                 <a class="code" href="exrtotiff_8cpp.html#a3">usage</a>();
00059             toneMap = argv[argNum+1];
00060             ++argNum;
00061         }
00062         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(argv[argNum], <span class="stringliteral">"-param"</span>)) {
00063             <span class="keywordflow">if</span> (argNum+2 &gt;= argc)
00064                 <a class="code" href="exrtotiff_8cpp.html#a3">usage</a>();
00065             <span class="keywordtype">float</span> val = atof(argv[argNum+2]);
00066             toneMapParams.<a class="code" href="classParamSet.html#a3">AddFloat</a>(argv[argNum+1], &amp;val);
00067             argNum += 2;
00068         }
00069         <a class="code" href="exrtotiff_8cpp.html#a0">ARG</a>(<span class="stringliteral">"scale"</span>, scale)
00070         <a class="code" href="exrtotiff_8cpp.html#a0">ARG</a>(<span class="stringliteral">"gamma"</span>, gamma)
00071         <a class="code" href="exrtotiff_8cpp.html#a0">ARG</a>(<span class="stringliteral">"bg"</span>, bggray)
00072         <a class="code" href="exrtotiff_8cpp.html#a0">ARG</a>(<span class="stringliteral">"bloomRadius"</span>, bloomRadius)
00073         <a class="code" href="exrtotiff_8cpp.html#a0">ARG</a>(<span class="stringliteral">"bloomWeight"</span>, bloomWeight)
00074         <span class="keywordflow">else</span> 
00075             <a class="code" href="exrtotiff_8cpp.html#a3">usage</a>();
00076       ++argNum;
00077 
00078     }
00079     <span class="keywordflow">if</span> (argNum + 2 &gt; argc) <a class="code" href="exrtotiff_8cpp.html#a3">usage</a>();
00080 
00081     <span class="keywordtype">char</span> *inFile = argv[argNum], *outFile = argv[argNum+1];       
00082     <span class="keywordtype">float</span> *rgba;
00083     <span class="keywordtype">int</span> xRes, yRes;
00084     <span class="keywordtype">bool</span> hasAlpha;
00085     <a class="code" href="api_8cpp.html#a13">pbrtInit</a>();
00086 
00087     <span class="keywordflow">if</span> (<a class="code" href="exrtotiff_8cpp.html#a1">ReadEXR</a>(inFile, rgba, xRes, yRes, hasAlpha)) {
00088         <span class="keywordtype">float</span> *rgb = <span class="keyword">new</span> <span class="keywordtype">float</span>[xRes*yRes*3];
00089         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; xRes*yRes; ++i) {
00090             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 3; ++j) {
00091                 rgb[3*i+j] = scale * rgba[4*i+j];
00092 <span class="comment">//CO            if (rgba[4*i+3] != 0.f)</span>
00093 <span class="comment">//CO                rgb[3*i+j] /= rgba[4*i+3];</span>
00094                 <span class="keywordflow">if</span> (bggray &gt; 0)
00095                     rgb[3*i+j] = rgba[4*i+3] * rgb[3*i+j] + (1.f - rgba[4*i+3]) * bggray;
00096             }
00097             <span class="keywordflow">if</span> (bggray &gt; 0)
00098                 rgba[4*i+3] = 1.f;
00099         }
00100 
00101         <a class="code" href="film_8h.html#a0">ApplyImagingPipeline</a>(rgb, xRes, yRes, NULL, bloomRadius,
00102                              bloomWeight, toneMap, &amp;toneMapParams,
00103                              gamma, 0.f, 255);
00104 
00105         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; xRes*yRes; ++i) {
00106             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 3; ++j) {
00107                 rgba[4*i+j] = rgb[3*i+j];
00108                 <span class="keywordflow">if</span> (rgba[4*i+3] != 0.f)
00109                     rgba[4*i+j] /= rgba[4*i+3];
00110             }
00111             rgba[4*i+3] *= 255.f;
00112         }
00113 
00114         <a class="code" href="exrtotiff_8cpp.html#a2">WriteTIFF</a>(outFile, rgba, xRes, yRes, hasAlpha);
00115     }
00116     <a class="code" href="api_8cpp.html#a14">pbrtCleanup</a>();
00117     <span class="keywordflow">return</span> 0;
00118 }
00119 
<a name="l00120"></a><a class="code" href="exrtotiff_8cpp.html#a2">00120</a> <span class="keywordtype">void</span> <a class="code" href="exrtotiff_8cpp.html#a2">WriteTIFF</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">float</span> *rgba, <span class="keywordtype">int</span> XRes, <span class="keywordtype">int</span> YRes, <span class="keywordtype">bool</span> hasAlpha) 
00121 {
00122     <span class="comment">// Open 8-bit TIFF file for writing</span>
00123     TIFF *tiff = TIFFOpen(name, <span class="stringliteral">"w"</span>);
00124     <span class="keywordflow">if</span> (!tiff) {
00125         fprintf(stderr, <span class="stringliteral">"Unable to open TIFF %s for writing"</span>, name);
00126         <span class="keywordflow">return</span>;
00127     }
00128 
00129     <span class="keywordtype">int</span> nChannels = hasAlpha ? 4 : 3;
00130     TIFFSetField(tiff, TIFFTAG_SAMPLESPERPIXEL, nChannels);
00131     <span class="keywordflow">if</span> (hasAlpha) {
00132         <span class="keywordtype">short</span> <span class="keywordtype">int</span> extra[] = { EXTRASAMPLE_ASSOCALPHA };
00133         TIFFSetField(tiff, TIFFTAG_EXTRASAMPLES, (<span class="keywordtype">short</span>)1, extra);
00134     }
00135     <span class="comment">// Write image resolution information</span>
00136     TIFFSetField(tiff, TIFFTAG_IMAGEWIDTH, XRes);
00137     TIFFSetField(tiff, TIFFTAG_IMAGELENGTH, YRes);
00138     TIFFSetField(tiff, TIFFTAG_BITSPERSAMPLE, 8);
00139     TIFFSetField(tiff, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_RGB);
00140     <span class="comment">// Set Generic TIFF Fields</span>
00141     TIFFSetField(tiff, TIFFTAG_ROWSPERSTRIP, 1);
00142     TIFFSetField(tiff, TIFFTAG_XRESOLUTION, 1.f);
00143     TIFFSetField(tiff, TIFFTAG_YRESOLUTION, 1.f);
00144     TIFFSetField(tiff, TIFFTAG_RESOLUTIONUNIT, (<span class="keywordtype">short</span>)1);
00145     TIFFSetField(tiff, TIFFTAG_COMPRESSION, COMPRESSION_NONE);
00146     TIFFSetField(tiff, TIFFTAG_PLANARCONFIG, PLANARCONFIG_CONTIG);
00147     TIFFSetField(tiff, TIFFTAG_ORIENTATION, (<span class="keywordtype">int</span>)ORIENTATION_TOPLEFT);
00148     <span class="comment">// Write 8-bit scanlines</span>
00149     <a class="code" href="pbrt_8h.html#a49">u_char</a> *buf = <span class="keyword">new</span> <a class="code" href="pbrt_8h.html#a49">u_char</a>[nChannels * XRes];
00150     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; YRes; ++y) {
00151         <a class="code" href="pbrt_8h.html#a49">u_char</a> *bufp = buf;
00152         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; XRes; ++x) {
00153             <span class="comment">// Pack 8-bit pixels samples into buf</span>
00154             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; nChannels; ++s)
00155                 *bufp++ = (<a class="code" href="pbrt_8h.html#a49">u_char</a>)*rgba++;
00156         }
00157         TIFFWriteScanline(tiff, buf, y, 1);
00158     }
00159     <span class="comment">// Close 8-bit TIFF file</span>
00160     <span class="keyword">delete</span>[] buf;
00161     TIFFClose(tiff);
00162 }
00163 
<a name="l00164"></a><a class="code" href="exrtotiff_8cpp.html#a1">00164</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="exrtotiff_8cpp.html#a1">ReadEXR</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">float</span> *&amp;rgba, <span class="keywordtype">int</span> &amp;xRes, <span class="keywordtype">int</span> &amp;yRes, <span class="keywordtype">bool</span> &amp;hasAlpha)
00165 {
00166     InputFile file(name);
00167     Box2i dw = file.header().dataWindow();
00168     xRes = dw.max.x - dw.min.x + 1;
00169     yRes = dw.max.y - dw.min.y + 1;
00170 
00171     half *hrgba = <span class="keyword">new</span> half[4 * xRes * yRes];
00172 
00173     <span class="comment">// for now...</span>
00174     hasAlpha = <span class="keyword">true</span>;
00175     <span class="keywordtype">int</span> nChannels = 4;
00176 
00177     half *hp = hrgba - nChannels * (dw.min.x + dw.min.y * xRes);
00178 
00179     FrameBuffer frameBuffer;
00180     frameBuffer.insert(<span class="stringliteral">"R"</span>, Slice(HALF, (<span class="keywordtype">char</span> *)hp,
00181                                   4*<span class="keyword">sizeof</span>(half), xRes * 4 * <span class="keyword">sizeof</span>(half), 1, 1, 0.0));
00182     frameBuffer.insert(<span class="stringliteral">"G"</span>, Slice(HALF, (<span class="keywordtype">char</span> *)hp+<span class="keyword">sizeof</span>(half),
00183                                   4*<span class="keyword">sizeof</span>(half), xRes * 4 * <span class="keyword">sizeof</span>(half), 1, 1, 0.0));
00184     frameBuffer.insert(<span class="stringliteral">"B"</span>, Slice(HALF, (<span class="keywordtype">char</span> *)hp+2*<span class="keyword">sizeof</span>(half),
00185                                   4*<span class="keyword">sizeof</span>(half), xRes * 4 * <span class="keyword">sizeof</span>(half), 1, 1, 0.0));
00186     frameBuffer.insert(<span class="stringliteral">"A"</span>, Slice(HALF, (<span class="keywordtype">char</span> *)hp+3*<span class="keyword">sizeof</span>(half),
00187                                   4*<span class="keyword">sizeof</span>(half), xRes * 4 * <span class="keyword">sizeof</span>(half), 1, 1, 1.0));
00188 
00189     file.setFrameBuffer(frameBuffer);
00190     file.readPixels(dw.min.y, dw.max.y);
00191 
00192     rgba = <span class="keyword">new</span> <span class="keywordtype">float</span>[nChannels * xRes * yRes];
00193     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nChannels * xRes * yRes; ++i)
00194         rgba[i] = hrgba[i];
00195     <span class="keyword">delete</span>[] hrgba;
00196 
00197     <span class="keywordflow">return</span> rgba;
00198 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:20 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
