<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: lowdiscrepancy.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>lowdiscrepancy.cpp</h1><a href="lowdiscrepancy_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// lowdiscrepancy.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="sampling_8h.html">sampling.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="film_8h.html">film.h</a>"</span>
00015 <span class="comment">// LDSampler Declarations</span>
<a name="l00016"></a><a class="code" href="classLDSampler.html">00016</a> <span class="keyword">class </span><a class="code" href="classLDSampler.html">LDSampler</a> : <span class="keyword">public</span> <a class="code" href="classSampler.html">Sampler</a> {
00017 <span class="keyword">public</span>:
00018         <span class="comment">// LDSampler Public Methods</span>
00019         <a class="code" href="classLDSampler.html">LDSampler</a>(<span class="keywordtype">int</span> xstart, <span class="keywordtype">int</span> xend,
00020                   <span class="keywordtype">int</span> ystart, <span class="keywordtype">int</span> yend,
00021                           <span class="keywordtype">int</span> nsamp);
<a name="l00022"></a><a class="code" href="classLDSampler.html#a1">00022</a>         <a class="code" href="classLDSampler.html#a1">~LDSampler</a>() {
00023                 <span class="keyword">delete</span>[] <a class="code" href="classLDSampler.html#r4">imageSamples</a>;
00024                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classLDSampler.html#r9">n1D</a>; ++i)
00025                         <span class="keyword">delete</span>[] <a class="code" href="classLDSampler.html#r7">oneDSamples</a>[i];
00026                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classLDSampler.html#r10">n2D</a>; ++i)
00027                         <span class="keyword">delete</span>[] <a class="code" href="classLDSampler.html#r8">twoDSamples</a>[i];
00028                 <span class="keyword">delete</span>[] <a class="code" href="classLDSampler.html#r7">oneDSamples</a>;
00029                 <span class="keyword">delete</span>[] <a class="code" href="classLDSampler.html#r8">twoDSamples</a>;
00030         }
<a name="l00031"></a><a class="code" href="classLDSampler.html#a2">00031</a>         <span class="keywordtype">int</span> <a class="code" href="classLDSampler.html#a2">RoundSize</a>(<span class="keywordtype">int</span> size)<span class="keyword"> const </span>{
00032                 <span class="keywordflow">return</span> <a class="code" href="pbrt_8h.html#a103">RoundUpPow2</a>(size);
00033         }
00034         <span class="keywordtype">bool</span> GetNextSample(<a class="code" href="structSample.html">Sample</a> *sample);
00035 <span class="keyword">private</span>:
00036         <span class="comment">// LDSampler Private Data</span>
<a name="l00037"></a><a class="code" href="classLDSampler.html#r1">00037</a>         <span class="keywordtype">int</span> <a class="code" href="classLDSampler.html#r0">xPos</a>, <a class="code" href="classLDSampler.html#r1">yPos</a>, <a class="code" href="classLDSampler.html#r2">pixelSamples</a>;
<a name="l00038"></a><a class="code" href="classLDSampler.html#r3">00038</a>         <span class="keywordtype">int</span> <a class="code" href="classLDSampler.html#r3">samplePos</a>;
<a name="l00039"></a><a class="code" href="classLDSampler.html#r6">00039</a>         <span class="keywordtype">float</span> *<a class="code" href="classLDSampler.html#r4">imageSamples</a>, *<a class="code" href="classLDSampler.html#r5">lensSamples</a>, *<a class="code" href="classLDSampler.html#r6">timeSamples</a>;
<a name="l00040"></a><a class="code" href="classLDSampler.html#r8">00040</a>         <span class="keywordtype">float</span> **<a class="code" href="classLDSampler.html#r7">oneDSamples</a>, **<a class="code" href="classLDSampler.html#r8">twoDSamples</a>;
<a name="l00041"></a><a class="code" href="classLDSampler.html#r10">00041</a>         <span class="keywordtype">int</span> <a class="code" href="classLDSampler.html#r9">n1D</a>, <a class="code" href="classLDSampler.html#r10">n2D</a>;
00042 };
00043 <span class="comment">// LDSampler Method Definitions</span>
<a name="l00044"></a><a class="code" href="classLDSampler.html#a0">00044</a> <a class="code" href="classLDSampler.html#a0">LDSampler::LDSampler</a>(<span class="keywordtype">int</span> xstart, <span class="keywordtype">int</span> xend,
00045                 <span class="keywordtype">int</span> ystart, <span class="keywordtype">int</span> yend, <span class="keywordtype">int</span> ps)
00046         : <a class="code" href="classSampler.html">Sampler</a>(xstart, xend, ystart, yend, <a class="code" href="pbrt_8h.html#a103">RoundUpPow2</a>(ps)) {
00047         <a class="code" href="classLDSampler.html#r0">xPos</a> = xPixelStart - 1;
00048         <a class="code" href="classLDSampler.html#r1">yPos</a> = yPixelStart;
00049         <span class="keywordflow">if</span> (!<a class="code" href="pbrt_8h.html#a102">IsPowerOf2</a>(ps)) {
00050                 <a class="code" href="util_8cpp.html#a15">Warning</a>(<span class="stringliteral">"Pixel samples being"</span>
00051                         <span class="stringliteral">"rounded up to power of 2"</span>);
00052                 <a class="code" href="classLDSampler.html#r2">pixelSamples</a> = <a class="code" href="pbrt_8h.html#a103">RoundUpPow2</a>(ps);
00053         }
00054         <span class="keywordflow">else</span>
00055                 <a class="code" href="classLDSampler.html#r2">pixelSamples</a> = ps;
00056         <a class="code" href="classLDSampler.html#r3">samplePos</a> = <a class="code" href="classLDSampler.html#r2">pixelSamples</a>;
00057         <a class="code" href="classLDSampler.html#r7">oneDSamples</a> = <a class="code" href="classLDSampler.html#r8">twoDSamples</a> = NULL;
00058         <a class="code" href="classLDSampler.html#r4">imageSamples</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[5*pixelSamples];
00059         <a class="code" href="classLDSampler.html#r5">lensSamples</a> = <a class="code" href="classLDSampler.html#r4">imageSamples</a> + 2*pixelSamples;
00060         <a class="code" href="classLDSampler.html#r6">timeSamples</a> = <a class="code" href="classLDSampler.html#r4">imageSamples</a> + 4*pixelSamples;
00061 }
<a name="l00062"></a><a class="code" href="classLDSampler.html#a3">00062</a> <span class="keywordtype">bool</span> <a class="code" href="classLDSampler.html#a3">LDSampler::GetNextSample</a>(<a class="code" href="structSample.html">Sample</a> *sample) {
00063         <span class="keywordflow">if</span> (!<a class="code" href="classLDSampler.html#r7">oneDSamples</a>) {
00064                 <span class="comment">// Allocate space for pixel's low-discrepancy sample tables</span>
00065                 <a class="code" href="classLDSampler.html#r7">oneDSamples</a> = <span class="keyword">new</span> <span class="keywordtype">float</span> *[sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size()];
00066                 <a class="code" href="classLDSampler.html#r9">n1D</a> = sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size();
00067                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size(); ++i)
00068                         <a class="code" href="classLDSampler.html#r7">oneDSamples</a>[i] = <span class="keyword">new</span> <span class="keywordtype">float</span>[sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>[i] *
00069                                                <a class="code" href="classLDSampler.html#r2">pixelSamples</a>];
00070                 <a class="code" href="classLDSampler.html#r8">twoDSamples</a> = <span class="keyword">new</span> <span class="keywordtype">float</span> *[sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size()];
00071                 <a class="code" href="classLDSampler.html#r10">n2D</a> = sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size();
00072                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size(); ++i)
00073                         <a class="code" href="classLDSampler.html#r8">twoDSamples</a>[i] = <span class="keyword">new</span> <span class="keywordtype">float</span>[2 * sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>[i] *
00074                                                <a class="code" href="classLDSampler.html#r2">pixelSamples</a>];
00075         }
00076         <span class="keywordflow">if</span> (<a class="code" href="classLDSampler.html#r3">samplePos</a> == <a class="code" href="classLDSampler.html#r2">pixelSamples</a>) {
00077                 <span class="comment">// Advance to next pixel for low-discrepancy sampling</span>
00078                 <span class="keywordflow">if</span> (++<a class="code" href="classLDSampler.html#r0">xPos</a> == xPixelEnd) {
00079                         <a class="code" href="classLDSampler.html#r0">xPos</a> = xPixelStart;
00080                         ++<a class="code" href="classLDSampler.html#r1">yPos</a>;
00081                 }
00082                 <span class="keywordflow">if</span> (<a class="code" href="classLDSampler.html#r1">yPos</a> == yPixelEnd)
00083                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00084                 <a class="code" href="classLDSampler.html#r3">samplePos</a> = 0;
00085                 <span class="comment">// Generate low-discrepancy samples for pixel</span>
00086                 <a class="code" href="sampling_8h.html#a11">LDShuffleScrambled2D</a>(1, <a class="code" href="classLDSampler.html#r2">pixelSamples</a>, <a class="code" href="classLDSampler.html#r4">imageSamples</a>);
00087                 <a class="code" href="sampling_8h.html#a11">LDShuffleScrambled2D</a>(1, <a class="code" href="classLDSampler.html#r2">pixelSamples</a>, <a class="code" href="classLDSampler.html#r5">lensSamples</a>);
00088                 <a class="code" href="sampling_8h.html#a10">LDShuffleScrambled1D</a>(1, <a class="code" href="classLDSampler.html#r2">pixelSamples</a>, <a class="code" href="classLDSampler.html#r6">timeSamples</a>);
00089                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size(); ++i)
00090                         <a class="code" href="sampling_8h.html#a10">LDShuffleScrambled1D</a>(sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>[i], <a class="code" href="classLDSampler.html#r2">pixelSamples</a>,
00091                                 <a class="code" href="classLDSampler.html#r7">oneDSamples</a>[i]);
00092                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size(); ++i)
00093                         <a class="code" href="sampling_8h.html#a11">LDShuffleScrambled2D</a>(sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>[i], <a class="code" href="classLDSampler.html#r2">pixelSamples</a>,
00094                                 <a class="code" href="classLDSampler.html#r8">twoDSamples</a>[i]);
00095         }
00096         <span class="comment">// Copy low-discrepancy samples from tables</span>
00097         sample-&gt;<a class="code" href="structSample.html#o0">imageX</a> = <a class="code" href="classLDSampler.html#r0">xPos</a> + <a class="code" href="classLDSampler.html#r4">imageSamples</a>[2*<a class="code" href="classLDSampler.html#r3">samplePos</a>];
00098         sample-&gt;<a class="code" href="structSample.html#o1">imageY</a> = <a class="code" href="classLDSampler.html#r1">yPos</a> + imageSamples[2*<a class="code" href="classLDSampler.html#r3">samplePos</a>+1];
00099         sample-&gt;<a class="code" href="structSample.html#o4">time</a> = <a class="code" href="classLDSampler.html#r6">timeSamples</a>[<a class="code" href="classLDSampler.html#r3">samplePos</a>];
00100         sample-&gt;<a class="code" href="structSample.html#o2">lensU</a> = <a class="code" href="classLDSampler.html#r5">lensSamples</a>[2*<a class="code" href="classLDSampler.html#r3">samplePos</a>];
00101         sample-&gt;<a class="code" href="structSample.html#o3">lensV</a> = <a class="code" href="classLDSampler.html#r5">lensSamples</a>[2*<a class="code" href="classLDSampler.html#r3">samplePos</a>+1];
00102         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>.size(); ++i) {
00103                 <span class="keywordtype">int</span> startSamp = sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>[i] * <a class="code" href="classLDSampler.html#r3">samplePos</a>;
00104                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> j = 0; j &lt; sample-&gt;<a class="code" href="structSample.html#o5">n1D</a>[i]; ++j)
00105                         sample-&gt;<a class="code" href="structSample.html#o7">oneD</a>[i][j] = <a class="code" href="classLDSampler.html#r7">oneDSamples</a>[i][startSamp+j];
00106         }
00107         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>.size(); ++i) {
00108                 <span class="keywordtype">int</span> startSamp = 2 * sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>[i] * <a class="code" href="classLDSampler.html#r3">samplePos</a>;
00109                 <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> j = 0; j &lt; 2*sample-&gt;<a class="code" href="structSample.html#o6">n2D</a>[i]; ++j)
00110                         sample-&gt;<a class="code" href="structSample.html#o8">twoD</a>[i][j] = <a class="code" href="classLDSampler.html#r8">twoDSamples</a>[i][startSamp+j];
00111         }
00112         ++<a class="code" href="classLDSampler.html#r3">samplePos</a>;
00113         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00114 }
<a name="l00115"></a><a class="code" href="lowdiscrepancy_8cpp.html#a0">00115</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classSampler.html">Sampler</a> *<a class="code" href="stratified_8cpp.html#a0">CreateSampler</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params, <span class="keyword">const</span> <a class="code" href="classFilm.html">Film</a> *film) {
00116         <span class="comment">// Initialize common sampler parameters</span>
00117         <span class="keywordtype">int</span> xstart, xend, ystart, yend;
00118         film-&gt;<a class="code" href="classFilm.html#a4">GetSampleExtent</a>(&amp;xstart, &amp;xend, &amp;ystart, &amp;yend);
00119         <span class="keywordtype">int</span> nsamp = params.<a class="code" href="classParamSet.html#a22">FindOneInt</a>(<span class="stringliteral">"pixelsamples"</span>, 4);
00120         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classLDSampler.html">LDSampler</a>(xstart, xend, ystart, yend, nsamp);
00121 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:22 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
