<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: perspective.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>perspective.cpp</h1><a href="perspective_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// perspective.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="camera_8h.html">camera.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="film_8h.html">film.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
00015 <span class="comment">// PerspectiveCamera Declarations</span>
<a name="l00016"></a><a class="code" href="classPerspectiveCamera.html">00016</a> <span class="keyword">class </span><a class="code" href="classPerspectiveCamera.html">PerspectiveCamera</a> : <span class="keyword">public</span> <a class="code" href="classProjectiveCamera.html">ProjectiveCamera</a> {
00017 <span class="keyword">public</span>:
00018         <span class="comment">// PerspectiveCamera Public Methods</span>
00019         <a class="code" href="classPerspectiveCamera.html">PerspectiveCamera</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;world2cam,
00020                 <span class="keyword">const</span> <span class="keywordtype">float</span> Screen[4], <span class="keywordtype">float</span> hither, <span class="keywordtype">float</span> yon,
00021                 <span class="keywordtype">float</span> sopen, <span class="keywordtype">float</span> sclose,
00022                 <span class="keywordtype">float</span> lensr, <span class="keywordtype">float</span> focald, <span class="keywordtype">float</span> fov,
00023                 <a class="code" href="classFilm.html">Film</a> *film);
00024         <span class="keywordtype">float</span> <a class="code" href="classPerspectiveCamera.html#a1">GenerateRay</a>(<span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> &amp;sample, <a class="code" href="classRay.html">Ray</a> *) <span class="keyword">const</span>;
00025 };
00026 <span class="comment">// PerspectiveCamera Method Definitions</span>
00027 PerspectiveCamera::
<a name="l00028"></a><a class="code" href="classPerspectiveCamera.html#a0">00028</a>     PerspectiveCamera(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;world2cam,
00029                 <span class="keyword">const</span> <span class="keywordtype">float</span> Screen[4], <span class="keywordtype">float</span> hither, <span class="keywordtype">float</span> yon,
00030                 <span class="keywordtype">float</span> sopen, <span class="keywordtype">float</span> sclose,
00031                 <span class="keywordtype">float</span> lensr, <span class="keywordtype">float</span> focald,
00032                 <span class="keywordtype">float</span> fov, <a class="code" href="classFilm.html">Film</a> *f)
00033         : <a class="code" href="classProjectiveCamera.html">ProjectiveCamera</a>(world2cam,
00034             <a class="code" href="pbrt_8h.html#a82">Perspective</a>(fov, hither, yon),
00035                 Screen, hither, yon, sopen, sclose,
00036                 lensr, focald, f) {
00037 }
<a name="l00038"></a><a class="code" href="classPerspectiveCamera.html#a1">00038</a> <span class="keywordtype">float</span> <a class="code" href="classPerspectiveCamera.html#a1">PerspectiveCamera::GenerateRay</a>(<span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> &amp;sample,
00039                 <a class="code" href="classRay.html">Ray</a> *ray)<span class="keyword"> const </span>{
00040         <span class="comment">// Generate raster and camera samples</span>
00041         <a class="code" href="classPoint.html">Point</a> Pras(sample.<a class="code" href="structSample.html#o0">imageX</a>, sample.<a class="code" href="structSample.html#o1">imageY</a>, 0);
00042         <a class="code" href="classPoint.html">Point</a> Pcamera;
00043         RasterToCamera(Pras, &amp;Pcamera);
00044         ray-&gt;<a class="code" href="classRay.html#o0">o</a> = Pcamera;
00045         ray-&gt;<a class="code" href="classRay.html#o1">d</a> = <a class="code" href="classVector.html">Vector</a>(Pcamera.<a class="code" href="classPoint.html#o0">x</a>, Pcamera.<a class="code" href="classPoint.html#o1">y</a>, Pcamera.<a class="code" href="classPoint.html#o2">z</a>);
00046         <span class="comment">// Set ray time value</span>
00047         ray-&gt;<a class="code" href="classRay.html#o4">time</a> = <a class="code" href="pbrt_8h.html#a94">Lerp</a>(sample.<a class="code" href="structSample.html#o4">time</a>, ShutterOpen, ShutterClose);
00048         <span class="comment">// Modify ray for depth of field</span>
00049         <span class="keywordflow">if</span> (LensRadius &gt; 0.) {
00050                 <span class="comment">// Sample point on lens</span>
00051                 <span class="keywordtype">float</span> lensU, lensV;
00052                 <a class="code" href="pbrt_8h.html#a91">ConcentricSampleDisk</a>(sample.<a class="code" href="structSample.html#o2">lensU</a>, sample.<a class="code" href="structSample.html#o3">lensV</a>,
00053                                      &amp;lensU, &amp;lensV);
00054                 lensU *= LensRadius;
00055                 lensV *= LensRadius;
00056                 <span class="comment">// Compute point on plane of focus</span>
00057                 <span class="keywordtype">float</span> ft = (FocalDistance - ClipHither) / ray-&gt;<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o2">z</a>;
00058                 <a class="code" href="classPoint.html">Point</a> Pfocus = (*ray)(ft);
00059                 <span class="comment">// Update ray for effect of lens</span>
00060                 ray-&gt;<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o0">x</a> += lensU;
00061                 ray-&gt;<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o1">y</a> += lensV;
00062                 ray-&gt;<a class="code" href="classRay.html#o1">d</a> = Pfocus - ray-&gt;<a class="code" href="classRay.html#o0">o</a>;
00063         }
00064         ray-&gt;<a class="code" href="classRay.html#o1">d</a> = <a class="code" href="geometry_8h.html#a14">Normalize</a>(ray-&gt;<a class="code" href="classRay.html#o1">d</a>);
00065         ray-&gt;<a class="code" href="classRay.html#o2">mint</a> = 0.;
00066         ray-&gt;<a class="code" href="classRay.html#o3">maxt</a> = (ClipYon - ClipHither) / ray-&gt;<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#o2">z</a>;
00067         CameraToWorld(*ray, ray);
00068         <span class="keywordflow">return</span> 1.f;
00069 }
<a name="l00070"></a><a class="code" href="perspective_8cpp.html#a0">00070</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#a2">DLLEXPORT</a> <a class="code" href="classCamera.html">Camera</a> *<a class="code" href="perspective_8cpp.html#a0">CreateCamera</a>(<span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params,
00071                 <span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;world2cam, <a class="code" href="classFilm.html">Film</a> *film) {
00072         <span class="comment">// Extract common camera parameters from _ParamSet_</span>
00073         <span class="keywordtype">float</span> hither = max(1e-4f, params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"hither"</span>, 1e-3f));
00074         <span class="keywordtype">float</span> yon = min(params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"yon"</span>, 1e30f), 1e30f);
00075         <span class="keywordtype">float</span> shutteropen = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"shutteropen"</span>, 0.f);
00076         <span class="keywordtype">float</span> shutterclose = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"shutterclose"</span>, 1.f);
00077         <span class="keywordtype">float</span> lensradius = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"lensradius"</span>, 0.f);
00078         <span class="keywordtype">float</span> focaldistance = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"focaldistance"</span>, 1e30f);
00079         <span class="keywordtype">float</span> frame = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"frameaspectratio"</span>,
00080                 <span class="keywordtype">float</span>(film-&gt;<a class="code" href="classFilm.html#o0">xResolution</a>)/<span class="keywordtype">float</span>(film-&gt;<a class="code" href="classFilm.html#o1">yResolution</a>));
00081         <span class="keywordtype">float</span> screen[4];
00082         <span class="keywordflow">if</span> (frame &gt; 1.f) {
00083                 screen[0] = -frame;
00084                 screen[1] =  frame;
00085                 screen[2] = -1.f;
00086                 screen[3] =  1.f;
00087         }
00088         <span class="keywordflow">else</span> {
00089                 screen[0] = -1.f;
00090                 screen[1] =  1.f;
00091                 screen[2] = -1.f / frame;
00092                 screen[3] =  1.f / frame;
00093         }
00094         <span class="keywordtype">int</span> swi;
00095         <span class="keyword">const</span> <span class="keywordtype">float</span> *sw = params.<a class="code" href="classParamSet.html#a30">FindFloat</a>(<span class="stringliteral">"screenwindow"</span>, &amp;swi);
00096         <span class="keywordflow">if</span> (sw &amp;&amp; swi == 4)
00097                 <a class="code" href="pbrtparse_8y.html#a40">memcpy</a>(screen, sw, 4*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00098         <span class="keywordtype">float</span> fov = params.<a class="code" href="classParamSet.html#a21">FindOneFloat</a>(<span class="stringliteral">"fov"</span>, 90.);
00099         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classPerspectiveCamera.html">PerspectiveCamera</a>(world2cam, screen, hither, yon,
00100                 shutteropen, shutterclose, lensradius, focaldistance,
00101                 fov, film);
00102 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:23 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
