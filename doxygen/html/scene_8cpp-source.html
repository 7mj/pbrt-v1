<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: scene.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>scene.cpp</h1><a href="scene_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// scene.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="scene_8h.html">scene.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="camera_8h.html">camera.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="film_8h.html">film.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="sampling_8h.html">sampling.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="dynload_8h.html">dynload.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="volume_8h.html">volume.h</a>"</span>
00018 <span class="comment">// Scene Methods</span>
<a name="l00019"></a><a class="code" href="classScene.html#a0">00019</a> <span class="keywordtype">void</span> <a class="code" href="classScene.html#a0">Scene::Render</a>() {
00020         <span class="comment">// Allocate and initialize _sample_</span>
00021         <a class="code" href="structSample.html">Sample</a> *sample = <span class="keyword">new</span> <a class="code" href="structSample.html">Sample</a>(<a class="code" href="classScene.html#o4">surfaceIntegrator</a>,
00022                                     <a class="code" href="classScene.html#o5">volumeIntegrator</a>,
00023                                     <span class="keyword">this</span>);
00024         <span class="comment">// Allow integrators to do pre-processing for the scene</span>
00025         <a class="code" href="classScene.html#o4">surfaceIntegrator</a>-&gt;<a class="code" href="classIntegrator.html#a2">Preprocess</a>(<span class="keyword">this</span>);
00026         <a class="code" href="classScene.html#o5">volumeIntegrator</a>-&gt;<a class="code" href="classIntegrator.html#a2">Preprocess</a>(<span class="keyword">this</span>);
00027         <span class="comment">// Trace rays: The main loop</span>
00028         <a class="code" href="structProgressReporter.html">ProgressReporter</a> progress(<a class="code" href="classScene.html#o6">sampler</a>-&gt;<a class="code" href="classSampler.html#a3">TotalSamples</a>(), <span class="stringliteral">"Rendering"</span>);
00029         <span class="keywordflow">while</span> (<a class="code" href="classScene.html#o6">sampler</a>-&gt;<a class="code" href="classSampler.html#a2">GetNextSample</a>(sample)) {
00030                 <span class="comment">// Find camera ray for _sample_</span>
00031                 <a class="code" href="classRayDifferential.html">RayDifferential</a> ray;
00032                 <span class="keywordtype">float</span> rayWeight = <a class="code" href="classScene.html#o2">camera</a>-&gt;<a class="code" href="classCamera.html#a0">GenerateRay</a>(*sample, &amp;ray);
00033                 <span class="comment">// Generate ray differentials for camera ray</span>
00034                 ++(sample-&gt;<a class="code" href="structSample.html#o0">imageX</a>);
00035                 <a class="code" href="classScene.html#o2">camera</a>-&gt;<a class="code" href="classCamera.html#a0">GenerateRay</a>(*sample, &amp;ray.<a class="code" href="classRayDifferential.html#o1">rx</a>);
00036                 --(sample-&gt;<a class="code" href="structSample.html#o0">imageX</a>);
00037                 ++(sample-&gt;<a class="code" href="structSample.html#o1">imageY</a>);
00038                 <a class="code" href="classScene.html#o2">camera</a>-&gt;<a class="code" href="classCamera.html#a0">GenerateRay</a>(*sample, &amp;ray.<a class="code" href="classRayDifferential.html#o2">ry</a>);
00039                 ray.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a> = <span class="keyword">true</span>;
00040                 --(sample-&gt;<a class="code" href="structSample.html#o1">imageY</a>);
00041                 <span class="comment">// Evaluate radiance along camera ray</span>
00042                 <span class="keywordtype">float</span> alpha;
00043                 <a class="code" href="classSpectrum.html">Spectrum</a> Ls = 0.f;
00044                 <span class="keywordflow">if</span> (rayWeight &gt; 0.f)
00045                         Ls = rayWeight * <a class="code" href="classScene.html#a6">Li</a>(ray, sample, &amp;alpha);
00046                 <span class="comment">// Issue warning if unexpected radiance value returned</span>
00047                 <span class="keywordflow">if</span> (Ls.<a class="code" href="classSpectrum.html#a20">IsNaN</a>()) {
00048                         <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"Not-a-number radiance value returned "</span>
00049                           <span class="stringliteral">"for image sample.  Setting to black."</span>);
00050                         Ls = <a class="code" href="classSpectrum.html">Spectrum</a>(0.f);
00051                 }
00052                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Ls.<a class="code" href="classSpectrum.html#a23">y</a>() &lt; -1e-5) {
00053                         <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"Negative luminance value, %g, returned "</span>
00054                           <span class="stringliteral">"for image sample.  Setting to black."</span>, Ls.<a class="code" href="classSpectrum.html#a23">y</a>());
00055                         Ls = <a class="code" href="classSpectrum.html">Spectrum</a>(0.f);
00056                 }
00057                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isinf(Ls.<a class="code" href="classSpectrum.html#a23">y</a>())) {
00058                         <a class="code" href="util_8cpp.html#a16">Error</a>(<span class="stringliteral">"Infinite luminance value returned "</span>
00059                           <span class="stringliteral">"for image sample.  Setting to black."</span>);
00060                         Ls = <a class="code" href="classSpectrum.html">Spectrum</a>(0.f);
00061                 }
00062                 <span class="comment">// Add sample contribution to image</span>
00063                 <a class="code" href="classScene.html#o2">camera</a>-&gt;<a class="code" href="classCamera.html#o0">film</a>-&gt;<a class="code" href="classFilm.html#a2">AddSample</a>(*sample, ray, Ls, alpha);
00064                 <span class="comment">// Free BSDF memory from computing image sample value</span>
00065                 <a class="code" href="classBSDF.html#e1">BSDF::FreeAll</a>();
00066                 <span class="comment">// Report rendering progress</span>
00067                 <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> cameraRaysTraced(<span class="stringliteral">"Camera"</span>, <span class="stringliteral">"Camera Rays Traced"</span>);
00068                 ++cameraRaysTraced;
00069                 progress.<a class="code" href="structProgressReporter.html#a2">Update</a>();
00070         }
00071         <span class="comment">// Clean up after rendering and store final image</span>
00072         <span class="keyword">delete</span> sample;
00073         progress.<a class="code" href="structProgressReporter.html#a3">Done</a>();
00074         <a class="code" href="classScene.html#o2">camera</a>-&gt;<a class="code" href="classCamera.html#o0">film</a>-&gt;<a class="code" href="classFilm.html#a3">WriteImage</a>();
00075 }
<a name="l00076"></a><a class="code" href="classScene.html#a2">00076</a> <a class="code" href="classScene.html#a2">Scene::~Scene</a>() {
00077         <span class="keyword">delete</span> <a class="code" href="classScene.html#o2">camera</a>;
00078         <span class="keyword">delete</span> <a class="code" href="classScene.html#o6">sampler</a>;
00079         <span class="keyword">delete</span> <a class="code" href="classScene.html#o4">surfaceIntegrator</a>;
00080         <span class="keyword">delete</span> <a class="code" href="classScene.html#o5">volumeIntegrator</a>;
00081         <span class="keyword">delete</span> <a class="code" href="classScene.html#o0">aggregate</a>;
00082         <span class="keyword">delete</span> <a class="code" href="classScene.html#o3">volumeRegion</a>;
00083         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classScene.html#o1">lights</a>.size(); ++i)
00084                 <span class="keyword">delete</span> <a class="code" href="classScene.html#o1">lights</a>[i];
00085 }
<a name="l00086"></a><a class="code" href="classScene.html#a1">00086</a> <a class="code" href="classScene.html#a1">Scene::Scene</a>(<a class="code" href="classCamera.html">Camera</a> *cam, <a class="code" href="classSurfaceIntegrator.html">SurfaceIntegrator</a> *si,
00087              <a class="code" href="classVolumeIntegrator.html">VolumeIntegrator</a> *vi, <a class="code" href="classSampler.html">Sampler</a> *s,
00088              <a class="code" href="classPrimitive.html">Primitive</a> *accel, <span class="keyword">const</span> vector&lt;Light *&gt; &amp;lts,
00089              <a class="code" href="classVolumeRegion.html">VolumeRegion</a> *vr) {
00090         <a class="code" href="classScene.html#o1">lights</a> = lts;
00091         <a class="code" href="classScene.html#o0">aggregate</a> = accel;
00092         <a class="code" href="classScene.html#o2">camera</a> = cam;
00093         <a class="code" href="classScene.html#o6">sampler</a> = s;
00094         <a class="code" href="classScene.html#o4">surfaceIntegrator</a> = si;
00095         <a class="code" href="classScene.html#o5">volumeIntegrator</a> = vi;
00096         <a class="code" href="classScene.html#o3">volumeRegion</a> = vr;
00097         <span class="keywordflow">if</span> (lts.size() == 0)
00098                 <a class="code" href="util_8cpp.html#a15">Warning</a>(<span class="stringliteral">"No light sources defined in scene; "</span>
00099                         <span class="stringliteral">"possibly rendering a black image."</span>);
00100         <span class="comment">// Scene Constructor Implementation</span>
00101         <a class="code" href="classScene.html#o7">bound</a> = <a class="code" href="classScene.html#o0">aggregate</a>-&gt;<a class="code" href="classPrimitive.html#a1">WorldBound</a>();
00102         <span class="keywordflow">if</span> (<a class="code" href="classScene.html#o3">volumeRegion</a>) <a class="code" href="classScene.html#o7">bound</a> = <a class="code" href="geometry_8cpp.html#a1">Union</a>(<a class="code" href="classScene.html#o7">bound</a>, <a class="code" href="classScene.html#o3">volumeRegion</a>-&gt;<a class="code" href="classVolumeRegion.html#a1">WorldBound</a>());
00103 }
<a name="l00104"></a><a class="code" href="classScene.html#a5">00104</a> <span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;<a class="code" href="classScene.html#a5">Scene::WorldBound</a>()<span class="keyword"> const </span>{
00105         <span class="keywordflow">return</span> <a class="code" href="classScene.html#o7">bound</a>;
00106 }
<a name="l00107"></a><a class="code" href="classScene.html#a6">00107</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classScene.html#a6">Scene::Li</a>(<span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray,
00108                 <span class="keyword">const</span> <a class="code" href="structSample.html">Sample</a> *sample, <span class="keywordtype">float</span> *alpha)<span class="keyword"> const </span>{
00109         <a class="code" href="classSpectrum.html">Spectrum</a> Lo = <a class="code" href="classScene.html#o4">surfaceIntegrator</a>-&gt;<a class="code" href="classIntegrator.html#a1">Li</a>(<span class="keyword">this</span>, ray, sample, alpha);
00110         <a class="code" href="classSpectrum.html">Spectrum</a> T = <a class="code" href="classScene.html#o5">volumeIntegrator</a>-&gt;<a class="code" href="classVolumeIntegrator.html#a0">Transmittance</a>(<span class="keyword">this</span>, ray, sample, alpha);
00111         <a class="code" href="classSpectrum.html">Spectrum</a> Lv = <a class="code" href="classScene.html#o5">volumeIntegrator</a>-&gt;<a class="code" href="classIntegrator.html#a1">Li</a>(<span class="keyword">this</span>, ray, sample, alpha);
00112         <span class="keywordflow">return</span> T * Lo + Lv;
00113 }
<a name="l00114"></a><a class="code" href="classScene.html#a7">00114</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classScene.html#a7">Scene::Transmittance</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray)<span class="keyword"> const </span>{
00115         <span class="keywordflow">return</span> <a class="code" href="classScene.html#o5">volumeIntegrator</a>-&gt;<a class="code" href="classVolumeIntegrator.html#a0">Transmittance</a>(<span class="keyword">this</span>, ray, NULL, NULL);
00116 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:24 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
