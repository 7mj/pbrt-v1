<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: volume.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>volume.cpp</h1><a href="volume_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// volume.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="volume_8h.html">volume.h</a>"</span>
00013 <span class="comment">// Volume Scattering Definitions</span>
00014 <a class="code" href="pbrt_8h.html#a1">COREDLL</a>
<a name="l00015"></a><a class="code" href="volume_8h.html#a0">00015</a> <span class="keywordtype">float</span> <a class="code" href="volume_8h.html#a0">PhaseIsotropic</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;) {
00016         <span class="keywordflow">return</span> 1.f / (4.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>);
00017 }
<a name="l00018"></a><a class="code" href="volume_8h.html#a1">00018</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">float</span> <a class="code" href="volume_8h.html#a1">PhaseRayleigh</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wp) {
00019         <span class="keywordtype">float</span> costheta = <a class="code" href="geometry_8h.html#a17">Dot</a>(w, wp);
00020         <span class="keywordflow">return</span>  3.f/(16.f*<a class="code" href="pbrt_8h.html#a6">M_PI</a>) * (1 + costheta * costheta);
00021 }
<a name="l00022"></a><a class="code" href="volume_8h.html#a2">00022</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">float</span> <a class="code" href="volume_8h.html#a2">PhaseMieHazy</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wp) {
00023         <span class="keywordtype">float</span> costheta = <a class="code" href="geometry_8h.html#a17">Dot</a>(w, wp);
00024         <span class="keywordflow">return</span> 9.f/(4.f*<a class="code" href="pbrt_8h.html#a6">M_PI</a>) * powf(1.f + costheta*costheta, 8.f);
00025 }
<a name="l00026"></a><a class="code" href="volume_8h.html#a3">00026</a> <a class="code" href="pbrt_8h.html#a1">COREDLL</a> <span class="keywordtype">float</span> <a class="code" href="volume_8h.html#a3">PhaseMieMurky</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wp) {
00027         <span class="keywordtype">float</span> costheta = <a class="code" href="geometry_8h.html#a17">Dot</a>(w, wp);
00028         <span class="keywordflow">return</span> 50.f/(4.f*<a class="code" href="pbrt_8h.html#a6">M_PI</a>) * powf(1.f + costheta*costheta, 32.f);
00029 }
00030 <a class="code" href="pbrt_8h.html#a1">COREDLL</a>
<a name="l00031"></a><a class="code" href="volume_8h.html#a4">00031</a> <span class="keywordtype">float</span> <a class="code" href="volume_8h.html#a4">PhaseHG</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wp, <span class="keywordtype">float</span> g) {
00032         <span class="keywordtype">float</span> costheta = <a class="code" href="geometry_8h.html#a17">Dot</a>(w, wp);
00033         <span class="keywordflow">return</span> 1.f / (4.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>) * (1.f - g*g) /
00034                 powf(1.f + g*g - 2.f * g * costheta, 1.5f);
00035 }
00036 <a class="code" href="pbrt_8h.html#a1">COREDLL</a>
<a name="l00037"></a><a class="code" href="volume_8h.html#a5">00037</a> <span class="keywordtype">float</span> <a class="code" href="volume_8h.html#a5">PhaseSchlick</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w,
00038                    <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wp, <span class="keywordtype">float</span> g) {
00039         <span class="keywordtype">float</span> k = 1.55f * g - .55f * g * g * g;
00040         <span class="keywordtype">float</span> kcostheta = k * <a class="code" href="geometry_8h.html#a17">Dot</a>(w, wp);
00041         <span class="keywordflow">return</span> 1.f / (4.f * <a class="code" href="pbrt_8h.html#a6">M_PI</a>) * (1.f - k*k) /
00042                 ((1.f - kcostheta) * (1.f - kcostheta));
00043 }
<a name="l00044"></a><a class="code" href="classVolumeRegion.html#a7">00044</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classVolumeRegion.html#a7">VolumeRegion::sigma_t</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p,
00045                                <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w)<span class="keyword"> const </span>{
00046         <span class="keywordflow">return</span> <a class="code" href="classVolumeRegion.html#a3">sigma_a</a>(p, w) + <a class="code" href="classVolumeRegion.html#a4">sigma_s</a>(p, w);
00047 }
<a name="l00048"></a><a class="code" href="classDensityRegion.html#a0">00048</a> <a class="code" href="classDensityRegion.html#a0">DensityRegion::DensityRegion</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;sa,
00049                 <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;ss, <span class="keywordtype">float</span> gg,
00050                 <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;emit,
00051                 <span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;VolumeToWorld)
00052         : sig_a(sa), sig_s(ss), le(emit), g(gg)  {
00053         <a class="code" href="classDensityRegion.html#p0">WorldToVolume</a> = VolumeToWorld.<a class="code" href="classTransform.html#a4">GetInverse</a>();
00054 }
00055 AggregateVolume::
<a name="l00056"></a><a class="code" href="classAggregateVolume.html#a0">00056</a>         AggregateVolume(<span class="keyword">const</span> vector&lt;VolumeRegion *&gt; &amp;r) {
00057         <a class="code" href="classAggregateVolume.html#r0">regions</a> = r;
00058         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i)
00059                 <a class="code" href="classAggregateVolume.html#r1">bound</a> = <a class="code" href="geometry_8cpp.html#a1">Union</a>(<a class="code" href="classAggregateVolume.html#r1">bound</a>, <a class="code" href="classAggregateVolume.html#r0">regions</a>[i]-&gt;<a class="code" href="classAggregateVolume.html#a2">WorldBound</a>());
00060 }
<a name="l00061"></a><a class="code" href="classAggregateVolume.html#a4">00061</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classAggregateVolume.html#a4">AggregateVolume::sigma_a</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p,
00062                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w)<span class="keyword"> const </span>{
00063         <a class="code" href="classSpectrum.html">Spectrum</a> s(0.);
00064         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i)
00065                 s += <a class="code" href="classAggregateVolume.html#r0">regions</a>[i]-&gt;sigma_a(p, w);
00066         <span class="keywordflow">return</span> s;
00067 }
<a name="l00068"></a><a class="code" href="classAggregateVolume.html#a5">00068</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classAggregateVolume.html#a5">AggregateVolume::sigma_s</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w)<span class="keyword"> const </span>{
00069         <a class="code" href="classSpectrum.html">Spectrum</a> s(0.);
00070         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i)
00071                 s += <a class="code" href="classAggregateVolume.html#r0">regions</a>[i]-&gt;sigma_s(p, w);
00072         <span class="keywordflow">return</span> s;
00073 }
<a name="l00074"></a><a class="code" href="classAggregateVolume.html#a6">00074</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classAggregateVolume.html#a6">AggregateVolume::Lve</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w)<span class="keyword"> const </span>{
00075         <a class="code" href="classSpectrum.html">Spectrum</a> L(0.);
00076         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i)
00077                 L += <a class="code" href="classAggregateVolume.html#r0">regions</a>[i]-&gt;Lve(p, w);
00078         <span class="keywordflow">return</span> L;
00079 }
<a name="l00080"></a><a class="code" href="classAggregateVolume.html#a7">00080</a> <span class="keywordtype">float</span> <a class="code" href="classAggregateVolume.html#a7">AggregateVolume::p</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wp)<span class="keyword"> const </span>{
00081         <span class="keywordtype">float</span> ph = 0, sumWt = 0;
00082         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i) {
00083                 <span class="keywordtype">float</span> sigt = <a class="code" href="classAggregateVolume.html#r0">regions</a>[i]-&gt;sigma_t(p, w).y();
00084                 <span class="keywordflow">if</span> (sigt != 0.f) {
00085                         <span class="keywordtype">float</span> wt = regions[i]-&gt;sigma_s(p, w).y() / sigt;
00086                         sumWt += wt;
00087                         ph += wt * regions[i]-&gt;p(p, w, wp);
00088                 }
00089         }
00090         <span class="keywordflow">return</span> ph / sumWt;
00091 }
<a name="l00092"></a><a class="code" href="classAggregateVolume.html#a8">00092</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classAggregateVolume.html#a8">AggregateVolume::sigma_t</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w)<span class="keyword"> const </span>{
00093         <a class="code" href="classSpectrum.html">Spectrum</a> s(0.);
00094         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i)
00095                 s += <a class="code" href="classAggregateVolume.html#r0">regions</a>[i]-&gt;sigma_t(p, w);
00096         <span class="keywordflow">return</span> s;
00097 }
<a name="l00098"></a><a class="code" href="classAggregateVolume.html#a9">00098</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classAggregateVolume.html#a9">AggregateVolume::Tau</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keywordtype">float</span> step, <span class="keywordtype">float</span> offset)<span class="keyword"> const </span>{
00099         <a class="code" href="classSpectrum.html">Spectrum</a> t(0.);
00100         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i)
00101                 t += <a class="code" href="classAggregateVolume.html#r0">regions</a>[i]-&gt;Tau(ray, step, offset);
00102         <span class="keywordflow">return</span> t;
00103 }
<a name="l00104"></a><a class="code" href="classAggregateVolume.html#a3">00104</a> <span class="keywordtype">bool</span> <a class="code" href="classAggregateVolume.html#a3">AggregateVolume::IntersectP</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray,
00105                 <span class="keywordtype">float</span> *t0, <span class="keywordtype">float</span> *t1)<span class="keyword"> const </span>{
00106         *t0 = <a class="code" href="pbrt_8h.html#a9">INFINITY</a>;
00107         *t1 = -<a class="code" href="pbrt_8h.html#a9">INFINITY</a>;
00108         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i) {
00109                 <span class="keywordtype">float</span> tr0, tr1;
00110                 <span class="keywordflow">if</span> (<a class="code" href="classAggregateVolume.html#r0">regions</a>[i]-&gt;IntersectP(ray, &amp;tr0, &amp;tr1)) {
00111                         *t0 = min(*t0, tr0);
00112                         *t1 = max(*t1, tr1);
00113                 }
00114         }
00115         <span class="keywordflow">return</span> (*t0 &lt; *t1);
00116 }
<a name="l00117"></a><a class="code" href="classAggregateVolume.html#a1">00117</a> <a class="code" href="classAggregateVolume.html#a1">AggregateVolume::~AggregateVolume</a>() {
00118         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; <a class="code" href="classAggregateVolume.html#r0">regions</a>.size(); ++i)
00119                 <span class="keyword">delete</span> <a class="code" href="classAggregateVolume.html#r0">regions</a>[i];
00120 }
<a name="l00121"></a><a class="code" href="classAggregateVolume.html#a2">00121</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classAggregateVolume.html#a2">AggregateVolume::WorldBound</a>()<span class="keyword"> const </span>{
00122         <span class="keywordflow">return</span> <a class="code" href="classAggregateVolume.html#r1">bound</a>;
00123 }
<a name="l00124"></a><a class="code" href="classDensityRegion.html#a7">00124</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classDensityRegion.html#a7">DensityRegion::Tau</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;r,
00125                 <span class="keywordtype">float</span> stepSize, <span class="keywordtype">float</span> u)<span class="keyword"> const </span>{
00126         <span class="keywordtype">float</span> t0, t1;
00127         <span class="keywordtype">float</span> length = r.<a class="code" href="classRay.html#o1">d</a>.<a class="code" href="classVector.html#a15">Length</a>();
00128         <span class="keywordflow">if</span> (length == 0.f) <span class="keywordflow">return</span> 0.f;
00129         <a class="code" href="classRay.html">Ray</a> rn(r.<a class="code" href="classRay.html#o0">o</a>, r.<a class="code" href="classRay.html#o1">d</a> / length,
00130                r.<a class="code" href="classRay.html#o2">mint</a> * length,
00131                    r.<a class="code" href="classRay.html#o3">maxt</a> * length);
00132         <span class="keywordflow">if</span> (!IntersectP(rn, &amp;t0, &amp;t1)) <span class="keywordflow">return</span> 0.;
00133         <a class="code" href="classSpectrum.html">Spectrum</a> tau(0.);
00134         t0 += u * stepSize;
00135         <span class="keywordflow">while</span> (t0 &lt; t1) {
00136                 tau += <a class="code" href="classDensityRegion.html#a4">sigma_t</a>(rn(t0), -rn.<a class="code" href="classRay.html#o1">d</a>);
00137                 t0 += stepSize;
00138         }
00139         <span class="keywordflow">return</span> tau * stepSize;
00140 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:26 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
