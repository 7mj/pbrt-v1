<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: octree.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>octree.h</h1><a href="octree_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#ifndef PBRT_OCTREE_H</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define PBRT_OCTREE_H</span>
00013 <span class="preprocessor"></span><span class="comment">// octree.h*</span>
00014 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="geometry_8h.html">geometry.h</a>"</span>
00016 <span class="comment">// Octree Declarations</span>
<a name="l00017"></a><a class="code" href="structOctNode.html">00017</a> <span class="keyword">template</span> &lt;<span class="keyword">class</span> NodeData&gt; <span class="keyword">struct </span><a class="code" href="structOctNode.html">OctNode</a> {
<a name="l00018"></a><a class="code" href="structOctNode.html#a0">00018</a>         <a class="code" href="structOctNode.html#a0">OctNode</a>() {
00019                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 8; ++i)
00020                         children[i] = NULL;
00021         }
<a name="l00022"></a><a class="code" href="structOctNode.html#a1">00022</a>         <a class="code" href="structOctNode.html#a1">~OctNode</a>() {
00023                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 8; ++i)
00024                         <span class="keyword">delete</span> children[i];
00025         }
<a name="l00026"></a><a class="code" href="structOctNode.html#o0">00026</a>         <a class="code" href="structOctNode.html">OctNode</a> *children[8];
<a name="l00027"></a><a class="code" href="structOctNode.html#o1">00027</a>         vector&lt;NodeData&gt; data;
00028 };
<a name="l00029"></a><a class="code" href="classOctree.html">00029</a> <span class="keyword">template</span> &lt;<span class="keyword">class</span> NodeData, <span class="keyword">class</span> LookupProc&gt; <span class="keyword">class </span><a class="code" href="classOctree.html">Octree</a> {
00030 <span class="keyword">public</span>:
00031         <span class="comment">// Octree Public Methods</span>
<a name="l00032"></a><a class="code" href="classOctree.html#a0">00032</a>         <a class="code" href="classOctree.html">Octree</a>(<span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;b, <span class="keywordtype">int</span> md = 16)
00033                 : bound(b) {
00034                 maxDepth = md;
00035         }
<a name="l00036"></a><a class="code" href="classOctree.html#a1">00036</a>         <span class="keywordtype">void</span> Add(<span class="keyword">const</span> NodeData &amp;dataItem, <span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;dataBound) {
00037                 addPrivate(&amp;root, bound, dataItem, dataBound,
00038                         <a class="code" href="geometry_8h.html#a10">DistanceSquared</a>(dataBound.<a class="code" href="classBBox.html#o0">pMin</a>, dataBound.<a class="code" href="classBBox.html#o1">pMax</a>));
00039         }
<a name="l00040"></a><a class="code" href="classOctree.html#a2">00040</a>         <span class="keywordtype">void</span> Lookup(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> LookupProc &amp;process) {
00041                 <span class="keywordflow">if</span> (!bound.<a class="code" href="classBBox.html#a4">Inside</a>(p)) <span class="keywordflow">return</span>;
00042                 lookupPrivate(&amp;root, bound, p, process);
00043         }
00044 <span class="keyword">private</span>:
00045         <span class="comment">// Octree Private Methods</span>
00046         <span class="keywordtype">void</span> addPrivate(<a class="code" href="structOctNode.html">OctNode&lt;NodeData&gt;</a> *node, <span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;nodeBound,
00047                 <span class="keyword">const</span> NodeData &amp;dataItem, <span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;dataBound, <span class="keywordtype">float</span> diag2,
00048                 <span class="keywordtype">int</span> depth = 0);
00049         <span class="keywordtype">void</span> lookupPrivate(<a class="code" href="structOctNode.html">OctNode&lt;NodeData&gt;</a> *node, <span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;nodeBound, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P,
00050                         <span class="keyword">const</span> LookupProc &amp;process);
00051         <span class="comment">// Octree Private Data</span>
<a name="l00052"></a><a class="code" href="classOctree.html#r0">00052</a>         <span class="keywordtype">int</span> maxDepth;
<a name="l00053"></a><a class="code" href="classOctree.html#r1">00053</a>         <a class="code" href="classBBox.html">BBox</a> bound;
<a name="l00054"></a><a class="code" href="classOctree.html#r2">00054</a>         <a class="code" href="structOctNode.html">OctNode&lt;NodeData&gt;</a> root;
00055 };
00056 <span class="comment">// Octree Method Definitions</span>
00057 <span class="keyword">template</span> &lt;<span class="keyword">class</span> NodeData, <span class="keyword">class</span> LookupProc&gt;
<a name="l00058"></a><a class="code" href="classOctree.html#d0">00058</a> <span class="keywordtype">void</span> <a class="code" href="classOctree.html">Octree&lt;NodeData, LookupProc&gt;::addPrivate</a>(
00059                 <a class="code" href="structOctNode.html">OctNode&lt;NodeData&gt;</a> *node, <span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;nodeBound,
00060                 <span class="keyword">const</span> NodeData &amp;dataItem, <span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;dataBound,
00061                 <span class="keywordtype">float</span> diag2, <span class="keywordtype">int</span> depth) {
00062         <span class="comment">// Possibly add data item to current octree node</span>
00063         <span class="keywordflow">if</span> (depth == <a class="code" href="classOctree.html#r0">maxDepth</a> ||
00064                 <a class="code" href="geometry_8h.html#a10">DistanceSquared</a>(nodeBound.<a class="code" href="classBBox.html#o0">pMin</a>,
00065                                 nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>) &lt; diag2) {
00066                 node-&gt;<a class="code" href="structOctNode.html#o1">data</a>.push_back(dataItem);
00067                 <span class="keywordflow">return</span>;
00068         }
00069         <span class="comment">// Otherwise add data item to octree children</span>
00070         <a class="code" href="classPoint.html">Point</a> pMid = .5 * nodeBound.<a class="code" href="classBBox.html#o0">pMin</a> + .5 * nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>;
00071         <span class="comment">// Determine which children the item overlaps</span>
00072         <span class="keywordtype">bool</span> over[8];
00073         over[0] = over[1] =
00074                           over[2] =
00075                           over[3] = (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o0">x</a> &lt;= pMid.<a class="code" href="classPoint.html#o0">x</a>);
00076         over[4] = over[5] =
00077                           over[6] =
00078                           over[7] = (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o0">x</a>  &gt; pMid.<a class="code" href="classPoint.html#o0">x</a>);
00079         over[0] &amp;= (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o1">y</a> &lt;= pMid.<a class="code" href="classPoint.html#o1">y</a>);
00080         over[1] &amp;= (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o1">y</a> &lt;= pMid.<a class="code" href="classPoint.html#o1">y</a>);
00081         over[4] &amp;= (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o1">y</a> &lt;= pMid.<a class="code" href="classPoint.html#o1">y</a>);
00082         over[5] &amp;= (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o1">y</a> &lt;= pMid.<a class="code" href="classPoint.html#o1">y</a>);
00083         over[2] &amp;= (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o1">y</a>  &gt; pMid.<a class="code" href="classPoint.html#o1">y</a>);
00084         over[3] &amp;= (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o1">y</a>  &gt; pMid.<a class="code" href="classPoint.html#o1">y</a>);
00085         over[6] &amp;= (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o1">y</a>  &gt; pMid.<a class="code" href="classPoint.html#o1">y</a>);
00086         over[7] &amp;= (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o1">y</a>  &gt; pMid.<a class="code" href="classPoint.html#o1">y</a>);
00087         over[0] &amp;= (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o2">z</a> &lt;= pMid.<a class="code" href="classPoint.html#o2">z</a>);
00088         over[2] &amp;= (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o2">z</a> &lt;= pMid.<a class="code" href="classPoint.html#o2">z</a>);
00089         over[4] &amp;= (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o2">z</a> &lt;= pMid.<a class="code" href="classPoint.html#o2">z</a>);
00090         over[6] &amp;= (dataBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o2">z</a> &lt;= pMid.<a class="code" href="classPoint.html#o2">z</a>);
00091         over[1] &amp;= (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o2">z</a>  &gt; pMid.<a class="code" href="classPoint.html#o2">z</a>);
00092         over[3] &amp;= (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o2">z</a>  &gt; pMid.<a class="code" href="classPoint.html#o2">z</a>);
00093         over[5] &amp;= (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o2">z</a>  &gt; pMid.<a class="code" href="classPoint.html#o2">z</a>);
00094         over[7] &amp;= (dataBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o2">z</a>  &gt; pMid.<a class="code" href="classPoint.html#o2">z</a>);
00095         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> child = 0; child &lt; 8; ++child) {
00096                 <span class="keywordflow">if</span> (!over[child]) <span class="keywordflow">continue</span>;
00097                 <span class="keywordflow">if</span> (!node-&gt;<a class="code" href="structOctNode.html#o0">children</a>[child])
00098                         node-&gt;<a class="code" href="structOctNode.html#o0">children</a>[child] = <span class="keyword">new</span> <a class="code" href="structOctNode.html">OctNode&lt;NodeData&gt;</a>;
00099                 <span class="comment">// Compute _childBound_ for octree child _child_</span>
00100                 <a class="code" href="classBBox.html">BBox</a> childBound;
00101                 childBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o0">x</a> = (child &amp; 4) ? pMid.<a class="code" href="classPoint.html#o0">x</a> : nodeBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o0">x</a>;
00102                 childBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o0">x</a> = (child &amp; 4) ? nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o0">x</a> : pMid.<a class="code" href="classPoint.html#o0">x</a>;
00103                 childBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o1">y</a> = (child &amp; 2) ? pMid.<a class="code" href="classPoint.html#o1">y</a> : nodeBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o1">y</a>;
00104                 childBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o1">y</a> = (child &amp; 2) ? nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o1">y</a> : pMid.<a class="code" href="classPoint.html#o1">y</a>;
00105                 childBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o2">z</a> = (child &amp; 1) ? pMid.<a class="code" href="classPoint.html#o2">z</a> : nodeBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o2">z</a>;
00106                 childBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o2">z</a> = (child &amp; 1) ? nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o2">z</a> : pMid.<a class="code" href="classPoint.html#o2">z</a>;
00107                 <a class="code" href="classOctree.html#d0">addPrivate</a>(node-&gt;<a class="code" href="structOctNode.html#o0">children</a>[child], childBound,
00108                            dataItem, dataBound, diag2, depth+1);
00109         }
00110 }
00111 <span class="keyword">template</span> &lt;<span class="keyword">class</span> NodeData, <span class="keyword">class</span> LookupProc&gt;
<a name="l00112"></a><a class="code" href="classOctree.html#d1">00112</a> <span class="keywordtype">void</span> <a class="code" href="classOctree.html">Octree&lt;NodeData, LookupProc&gt;::lookupPrivate</a>(
00113                 <a class="code" href="structOctNode.html">OctNode&lt;NodeData&gt;</a> *node, <span class="keyword">const</span> <a class="code" href="classBBox.html">BBox</a> &amp;nodeBound,
00114                 <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p, <span class="keyword">const</span> LookupProc &amp;process) {
00115         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#a51">u_int</a> i = 0; i &lt; node-&gt;<a class="code" href="structOctNode.html#o1">data</a>.size(); ++i)
00116                 process(p, node-&gt;<a class="code" href="structOctNode.html#o1">data</a>[i]);
00117         <span class="comment">// Determine which octree child node _p_ is inside</span>
00118         <a class="code" href="classPoint.html">Point</a> pMid = .5f * nodeBound.<a class="code" href="classBBox.html#o0">pMin</a> + .5f * nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>;
00119         <span class="keywordtype">int</span> child = (p.<a class="code" href="classPoint.html#o0">x</a> &gt; pMid.<a class="code" href="classPoint.html#o0">x</a> ? 4 : 0) +
00120                 (p.<a class="code" href="classPoint.html#o1">y</a> &gt; pMid.<a class="code" href="classPoint.html#o1">y</a> ? 2 : 0) + (p.<a class="code" href="classPoint.html#o2">z</a> &gt; pMid.<a class="code" href="classPoint.html#o2">z</a> ? 1 : 0);
00121         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="structOctNode.html#o0">children</a>[child]) {
00122                 <span class="comment">// Compute _childBound_ for octree child _child_</span>
00123                 <a class="code" href="classBBox.html">BBox</a> childBound;
00124                 childBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o0">x</a> = (child &amp; 4) ? pMid.<a class="code" href="classPoint.html#o0">x</a> : nodeBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o0">x</a>;
00125                 childBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o0">x</a> = (child &amp; 4) ? nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o0">x</a> : pMid.<a class="code" href="classPoint.html#o0">x</a>;
00126                 childBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o1">y</a> = (child &amp; 2) ? pMid.<a class="code" href="classPoint.html#o1">y</a> : nodeBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o1">y</a>;
00127                 childBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o1">y</a> = (child &amp; 2) ? nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o1">y</a> : pMid.<a class="code" href="classPoint.html#o1">y</a>;
00128                 childBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o2">z</a> = (child &amp; 1) ? pMid.<a class="code" href="classPoint.html#o2">z</a> : nodeBound.<a class="code" href="classBBox.html#o0">pMin</a>.<a class="code" href="classPoint.html#o2">z</a>;
00129                 childBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o2">z</a> = (child &amp; 1) ? nodeBound.<a class="code" href="classBBox.html#o1">pMax</a>.<a class="code" href="classPoint.html#o2">z</a> : pMid.<a class="code" href="classPoint.html#o2">z</a>;
00130                 <a class="code" href="classOctree.html#d1">lookupPrivate</a>(node-&gt;<a class="code" href="structOctNode.html#o0">children</a>[child], childBound, p,
00131                         process);
00132         }
00133 }
00134 <span class="preprocessor">#endif // PBRT_OCTREE_H</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:22 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
