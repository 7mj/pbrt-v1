<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: shape.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>shape.cpp</h1><a href="shape_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="comment">// shape.cpp*</span>
00012 <span class="preprocessor">#include "<a class="code" href="shape_8h.html">shape.h</a>"</span>
00013 <span class="comment">// Shape Method Definitions</span>
<a name="l00014"></a><a class="code" href="classShape.html#a0">00014</a> <a class="code" href="classShape.html#a0">Shape::Shape</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro)
00015         : ObjectToWorld(o2w), WorldToObject(o2w.GetInverse()),
00016         reverseOrientation(ro),
00017         transformSwapsHandedness(o2w.SwapsHandedness()) {
00018         <span class="comment">// Update shape creation statistics</span>
00019         <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> nShapesMade(<span class="stringliteral">"Geometry"</span>,
00020                                         <span class="stringliteral">"Total shapes created"</span>);
00021         ++nShapesMade;
00022 }
00023 <span class="comment">// DifferentialGeometry Method Definitions</span>
<a name="l00024"></a><a class="code" href="structDifferentialGeometry.html#a1">00024</a> <a class="code" href="structDifferentialGeometry.html#a0">DifferentialGeometry::DifferentialGeometry</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;P,
00025                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;DPDU, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;DPDV,
00026                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;DNDU, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;DNDV,
00027                 <span class="keywordtype">float</span> uu, <span class="keywordtype">float</span> vv, <span class="keyword">const</span> <a class="code" href="classShape.html">Shape</a> *sh)
00028         : p(P), dpdu(DPDU), dpdv(DPDV), dndu((<a class="code" href="classNormal.html">Normal</a>)DNDU), dndv((<a class="code" href="classNormal.html">Normal</a>)DNDV) {
00029         <span class="comment">// Initialize _DifferentialGeometry_ from parameters</span>
00030         <a class="code" href="structDifferentialGeometry.html#o1">nn</a> = <a class="code" href="classNormal.html">Normal</a>(<a class="code" href="geometry_8h.html#a14">Normalize</a>(<a class="code" href="geometry_8h.html#a6">Cross</a>(<a class="code" href="structDifferentialGeometry.html#o5">dpdu</a>, <a class="code" href="structDifferentialGeometry.html#o6">dpdv</a>)));
00031         <a class="code" href="structDifferentialGeometry.html#o2">u</a> = uu;
00032         <a class="code" href="structDifferentialGeometry.html#o3">v</a> = vv;
00033         <a class="code" href="structDifferentialGeometry.html#o4">shape</a> = sh;
00034         <a class="code" href="structDifferentialGeometry.html#o11">dudx</a> = <a class="code" href="structDifferentialGeometry.html#o12">dvdx</a> = <a class="code" href="structDifferentialGeometry.html#o13">dudy</a> = <a class="code" href="structDifferentialGeometry.html#o14">dvdy</a> = 0;
00035         <span class="comment">// Adjust normal based on orientation and handedness</span>
00036         <span class="keywordflow">if</span> (<a class="code" href="structDifferentialGeometry.html#o4">shape</a>-&gt;<a class="code" href="classShape.html#o2">reverseOrientation</a> ^ <a class="code" href="structDifferentialGeometry.html#o4">shape</a>-&gt;<a class="code" href="classShape.html#o3">transformSwapsHandedness</a>)
00037                 <a class="code" href="structDifferentialGeometry.html#o1">nn</a> *= -1.f;
00038 }
<a name="l00039"></a><a class="code" href="structDifferentialGeometry.html#a2">00039</a> <span class="keywordtype">void</span> <a class="code" href="structDifferentialGeometry.html#a2">DifferentialGeometry::ComputeDifferentials</a>(
00040                 <span class="keyword">const</span> <a class="code" href="classRayDifferential.html">RayDifferential</a> &amp;ray)<span class="keyword"> const </span>{
00041         <span class="keywordflow">if</span> (ray.<a class="code" href="classRayDifferential.html#o0">hasDifferentials</a>) {
00042                 <span class="comment">// Estimate screen-space change in \pt and $(u,v)$</span>
00043                 <span class="comment">// Compute auxiliary intersection points with plane</span>
00044                 <span class="keywordtype">float</span> d = -<a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>, <a class="code" href="classVector.html">Vector</a>(<a class="code" href="structDifferentialGeometry.html#o0">p</a>.<a class="code" href="classPoint.html#o0">x</a>, <a class="code" href="structDifferentialGeometry.html#o0">p</a>.<a class="code" href="classPoint.html#o1">y</a>, <a class="code" href="structDifferentialGeometry.html#o0">p</a>.<a class="code" href="classPoint.html#o2">z</a>));
00045                 <a class="code" href="classVector.html">Vector</a> rxv(ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o0">x</a>, ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o1">y</a>, ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o2">z</a>);
00046                 <span class="keywordtype">float</span> tx = -(<a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>, rxv) + d) / <a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>, ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a>);
00047                 <a class="code" href="classPoint.html">Point</a> px = ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o0">o</a> + tx * ray.<a class="code" href="classRayDifferential.html#o1">rx</a>.<a class="code" href="classRay.html#o1">d</a>;
00048                 <a class="code" href="classVector.html">Vector</a> ryv(ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o0">x</a>, ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o1">y</a>, ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a>.<a class="code" href="classPoint.html#o2">z</a>);
00049                 <span class="keywordtype">float</span> ty = -(<a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>, ryv) + d) / <a class="code" href="geometry_8h.html#a17">Dot</a>(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>, ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a>);
00050                 <a class="code" href="classPoint.html">Point</a> py = ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o0">o</a> + ty * ray.<a class="code" href="classRayDifferential.html#o2">ry</a>.<a class="code" href="classRay.html#o1">d</a>;
00051                 <a class="code" href="structDifferentialGeometry.html#o9">dpdx</a> = px - <a class="code" href="structDifferentialGeometry.html#o0">p</a>;
00052                 <a class="code" href="structDifferentialGeometry.html#o10">dpdy</a> = py - p;
00053                 <span class="comment">// Compute $(u,v)$ offsets at auxiliary points</span>
00054                 <span class="comment">// Initialize _A_, _Bx_, and _By_ matrices for offset computation</span>
00055                 <span class="keywordtype">float</span> A[2][2], Bx[2], By[2], x[2];
00056                 <span class="keywordtype">int</span> axes[2];
00057                 <span class="keywordflow">if</span> (fabsf(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>.<a class="code" href="classNormal.html#o0">x</a>) &gt; fabsf(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>.<a class="code" href="classNormal.html#o1">y</a>) &amp;&amp; fabsf(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>.<a class="code" href="classNormal.html#o0">x</a>) &gt; fabsf(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>.<a class="code" href="classNormal.html#o2">z</a>)) {
00058                         axes[0] = 1; axes[1] = 2;
00059                 }
00060                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fabsf(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>.<a class="code" href="classNormal.html#o1">y</a>) &gt; fabsf(<a class="code" href="structDifferentialGeometry.html#o1">nn</a>.<a class="code" href="classNormal.html#o2">z</a>)) {
00061                         axes[0] = 0; axes[1] = 2;
00062                 }
00063                 <span class="keywordflow">else</span> {
00064                         axes[0] = 0; axes[1] = 1;
00065                 }
00066                 <span class="comment">// Initialize matrices for chosen projection plane</span>
00067                 A[0][0] = <a class="code" href="structDifferentialGeometry.html#o5">dpdu</a>[axes[0]];
00068                 A[0][1] = <a class="code" href="structDifferentialGeometry.html#o6">dpdv</a>[axes[0]];
00069                 A[1][0] = dpdu[axes[1]];
00070                 A[1][1] = dpdv[axes[1]];
00071                 Bx[0] = px[axes[0]] - p[axes[0]];
00072                 Bx[1] = px[axes[1]] - p[axes[1]];
00073                 By[0] = py[axes[0]] - p[axes[0]];
00074                 By[1] = py[axes[1]] - p[axes[1]];
00075                 <span class="keywordflow">if</span> (<a class="code" href="util_8cpp.html#a18">SolveLinearSystem2x2</a>(A, Bx, x)) {
00076                         <a class="code" href="structDifferentialGeometry.html#o11">dudx</a> = x[0]; <a class="code" href="structDifferentialGeometry.html#o12">dvdx</a> = x[1];
00077                 }
00078                 <span class="keywordflow">else</span>  {
00079                         <a class="code" href="structDifferentialGeometry.html#o11">dudx</a> = 1.; <a class="code" href="structDifferentialGeometry.html#o12">dvdx</a> = 0.;
00080                 }
00081                 <span class="keywordflow">if</span> (<a class="code" href="util_8cpp.html#a18">SolveLinearSystem2x2</a>(A, By, x)) {
00082                         <a class="code" href="structDifferentialGeometry.html#o13">dudy</a> = x[0]; <a class="code" href="structDifferentialGeometry.html#o14">dvdy</a> = x[1];
00083                 }
00084                 <span class="keywordflow">else</span> {
00085                         <a class="code" href="structDifferentialGeometry.html#o13">dudy</a> = 0.; <a class="code" href="structDifferentialGeometry.html#o14">dvdy</a> = 1.;
00086                 }
00087         }
00088         <span class="keywordflow">else</span> {
00089                 <a class="code" href="structDifferentialGeometry.html#o11">dudx</a> = <a class="code" href="structDifferentialGeometry.html#o12">dvdx</a> = 0.;
00090                 <a class="code" href="structDifferentialGeometry.html#o13">dudy</a> = <a class="code" href="structDifferentialGeometry.html#o14">dvdy</a> = 0.;
00091                 <a class="code" href="structDifferentialGeometry.html#o9">dpdx</a> = <a class="code" href="structDifferentialGeometry.html#o10">dpdy</a> = <a class="code" href="classVector.html">Vector</a>(0,0,0);
00092         }
00093 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:24 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
