<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pbrt: mipmap.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>mipmap.h</h1><a href="mipmap_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*</span>
00003 <span class="comment"> * pbrt source code Copyright(c) 1998-2005 Matt Pharr and Greg Humphreys</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * All Rights Reserved.</span>
00006 <span class="comment"> * For educational use only; commercial use expressly forbidden.</span>
00007 <span class="comment"> * NO WARRANTY, express or implied, for this software.</span>
00008 <span class="comment"> * (See file License.txt for complete license)</span>
00009 <span class="comment"> */</span>
00010 
00011 <span class="preprocessor">#ifndef PBRT_MIPMAP_H</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define PBRT_MIPMAP_H</span>
00013 <span class="preprocessor"></span><span class="comment">// mipmap.h*</span>
00014 <span class="preprocessor">#include "<a class="code" href="pbrt_8h.html">pbrt.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="color_8h.html">color.h</a>"</span>
00016 <span class="comment">// MIPMap Declarations</span>
<a name="l00017"></a><a class="code" href="mipmap_8h.html#a4">00017</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
00018         <a class="code" href="mipmap_8h.html#a4a1">TEXTURE_REPEAT</a>,
00019         <a class="code" href="mipmap_8h.html#a4a2">TEXTURE_BLACK</a>,
00020         <a class="code" href="mipmap_8h.html#a4a3">TEXTURE_CLAMP</a>
00021 } <a class="code" href="mipmap_8h.html#a4">ImageWrap</a>;
<a name="l00022"></a><a class="code" href="classMIPMap.html">00022</a> <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">class </span><a class="code" href="classMIPMap.html">MIPMap</a> {
00023 <span class="keyword">public</span>:
00024         <span class="comment">// MIPMap Public Methods</span>
00025         <a class="code" href="classMIPMap.html">MIPMap</a>(<span class="keywordtype">int</span> xres, <span class="keywordtype">int</span> yres, <span class="keyword">const</span> T *data, <span class="keywordtype">bool</span> doTri = <span class="keyword">false</span>,
00026                    <span class="keywordtype">float</span> maxAniso = 8.f, <a class="code" href="mipmap_8h.html#a4">ImageWrap</a> <a class="code" href="classMIPMap.html#r2">wrapMode</a> = <a class="code" href="mipmap_8h.html#a4a1">TEXTURE_REPEAT</a>);
00027         <a class="code" href="classMIPMap.html#a1">~MIPMap</a>();
00028         T <a class="code" href="classMIPMap.html#a2">Lookup</a>(<span class="keywordtype">float</span> s, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> width = 0.f) <span class="keyword">const</span>;
00029         T Lookup(<span class="keywordtype">float</span> s, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> ds0, <span class="keywordtype">float</span> dt0,
00030                 <span class="keywordtype">float</span> ds1, <span class="keywordtype">float</span> dt1) <span class="keyword">const</span>;
00031 <span class="keyword">private</span>:
00032         <span class="comment">// MIPMap Private Methods</span>
00033         <span class="keyword">struct </span><a class="code" href="structMIPMap_1_1ResampleWeight.html">ResampleWeight</a>;
<a name="l00034"></a><a class="code" href="classMIPMap.html#d0">00034</a>         ResampleWeight *resampleWeights(<span class="keywordtype">int</span> oldres, <span class="keywordtype">int</span> newres) {
00035                 <a class="code" href="pbrt_8h.html#a14">Assert</a>(newres &gt;= oldres);
00036                 ResampleWeight *wt = <span class="keyword">new</span> ResampleWeight[newres];
00037                 <span class="keywordtype">float</span> filterwidth = 2.f;
00038                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; newres; ++i) {
00039                         <span class="comment">// Compute image resampling weights for _i_th texel</span>
00040                         <span class="keywordtype">float</span> center = (i + .5f) * oldres / newres;
00041                         wt[i].firstTexel = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>((center - filterwidth) + 0.5f);
00042                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 4; ++j) {
00043                                 <span class="keywordtype">float</span> pos = wt[i].firstTexel + j + .5f;
00044                                 wt[i].weight[j] = <a class="code" href="texture_8cpp.html#a8">Lanczos</a>((pos - center) / filterwidth);
00045                         }
00046                         <span class="comment">// Normalize filter weights for texel resampling</span>
00047                         <span class="keywordtype">float</span> invSumWts = 1.f / (wt[i].weight[0] + wt[i].weight[1] +
00048                                 wt[i].weight[2] + wt[i].weight[3]);
00049                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 4; ++j)
00050                                 wt[i].weight[j] *= invSumWts;
00051                 }
00052                 <span class="keywordflow">return</span> wt;
00053         }
<a name="l00054"></a><a class="code" href="classMIPMap.html#d1">00054</a>         <span class="keywordtype">float</span> clamp(<span class="keywordtype">float</span> v) { <span class="keywordflow">return</span> <a class="code" href="pbrt_8h.html#a96">Clamp</a>(v, 0.f, <a class="code" href="pbrt_8h.html#a9">INFINITY</a>); }
<a name="l00055"></a><a class="code" href="classMIPMap.html#d2">00055</a>         <a class="code" href="classSpectrum.html">Spectrum</a> clamp(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;v) { <span class="keywordflow">return</span> v.<a class="code" href="classSpectrum.html#a19">Clamp</a>(0.f, <a class="code" href="pbrt_8h.html#a9">INFINITY</a>); }
00056         <span class="keyword">const</span> T &amp;texel(<span class="keywordtype">int</span> level, <span class="keywordtype">int</span> s, <span class="keywordtype">int</span> t) <span class="keyword">const</span>;
00057         T triangle(<span class="keywordtype">int</span> level, <span class="keywordtype">float</span> s, <span class="keywordtype">float</span> t) <span class="keyword">const</span>;
00058         T EWA(<span class="keywordtype">float</span> s, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> ds0, <span class="keywordtype">float</span> dt0, <span class="keywordtype">float</span> ds1, <span class="keywordtype">float</span> dt1, <span class="keywordtype">int</span> level) <span class="keyword">const</span>;
00059         <span class="comment">// MIPMap Private Data</span>
<a name="l00060"></a><a class="code" href="classMIPMap.html#r0">00060</a>         <span class="keywordtype">bool</span> doTrilinear;
<a name="l00061"></a><a class="code" href="classMIPMap.html#r1">00061</a>         <span class="keywordtype">float</span> maxAnisotropy;
<a name="l00062"></a><a class="code" href="classMIPMap.html#r2">00062</a>         <a class="code" href="mipmap_8h.html#a4">ImageWrap</a> wrapMode;
<a name="l00063"></a><a class="code" href="structMIPMap_1_1ResampleWeight.html">00063</a>         <span class="keyword">struct </span><a class="code" href="structMIPMap_1_1ResampleWeight.html">ResampleWeight</a> {
<a name="l00064"></a><a class="code" href="structMIPMap_1_1ResampleWeight.html#o0">00064</a>                 <span class="keywordtype">int</span> <a class="code" href="structMIPMap_1_1ResampleWeight.html#o0">firstTexel</a>;
<a name="l00065"></a><a class="code" href="structMIPMap_1_1ResampleWeight.html#o1">00065</a>                 <span class="keywordtype">float</span> <a class="code" href="structMIPMap_1_1ResampleWeight.html#o1">weight</a>[4];
00066         };
<a name="l00067"></a><a class="code" href="classMIPMap.html#r3">00067</a>         <a class="code" href="classBlockedArray.html">BlockedArray&lt;T&gt;</a> **pyramid;
<a name="l00068"></a><a class="code" href="classMIPMap.html#r4">00068</a>         <span class="keywordtype">int</span> nLevels;
<a name="l00069"></a><a class="code" href="mipmap_8h.html#a0">00069</a> <span class="preprocessor">        #define WEIGHT_LUT_SIZE 128</span>
<a name="l00070"></a><a class="code" href="classMIPMap.html#v0">00070</a> <span class="preprocessor"></span>        <span class="keyword">static</span> <span class="keywordtype">float</span> *weightLut;
00071 };
00072 <span class="comment">// MIPMap Method Definitions</span>
00073 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00074"></a><a class="code" href="classMIPMap.html#a0">00074</a> <a class="code" href="classMIPMap.html">MIPMap&lt;T&gt;::MIPMap</a>(<span class="keywordtype">int</span> sres, <span class="keywordtype">int</span> tres,
00075                   <span class="keyword">const</span> T *img, <span class="keywordtype">bool</span> doTri,
00076                                   <span class="keywordtype">float</span> maxAniso, ImageWrap wm) {
00077         <a class="code" href="classMIPMap.html#r0">doTrilinear</a> = doTri;
00078         <a class="code" href="classMIPMap.html#r1">maxAnisotropy</a> = maxAniso;
00079         <a class="code" href="classMIPMap.html#r2">wrapMode</a> = wm;
00080         T *resampledImage = NULL;
00081         <span class="keywordflow">if</span> (!<a class="code" href="pbrt_8h.html#a102">IsPowerOf2</a>(sres) || !<a class="code" href="pbrt_8h.html#a102">IsPowerOf2</a>(tres)) {
00082                 <span class="comment">// Resample image to power-of-two resolution</span>
00083                 <span class="keywordtype">int</span> sPow2 = <a class="code" href="pbrt_8h.html#a103">RoundUpPow2</a>(sres), tPow2 = <a class="code" href="pbrt_8h.html#a103">RoundUpPow2</a>(tres);
00084                 <span class="comment">// Resample image in $s$ direction</span>
00085                 <a class="code" href="structMIPMap_1_1ResampleWeight.html">ResampleWeight</a> *sWeights = <a class="code" href="classMIPMap.html#d0">resampleWeights</a>(sres, sPow2);
00086                 resampledImage = <span class="keyword">new</span> T[sPow2 * tPow2];
00087                 <span class="comment">// Apply _sWeights_ to zoom in $s$ direction</span>
00088                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = 0; t &lt; tres; ++t) {
00089                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; sPow2; ++s) {
00090                                 <span class="comment">// Compute texel $(s,t)$ in $s$-zoomed image</span>
00091                                 resampledImage[t*sPow2+s] = 0.;
00092                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 4; ++j) {
00093                                         <span class="keywordtype">int</span> origS = sWeights[s].<a class="code" href="structMIPMap_1_1ResampleWeight.html#o0">firstTexel</a> + j;
00094                                         <span class="keywordflow">if</span> (<a class="code" href="classMIPMap.html#r2">wrapMode</a> == <a class="code" href="mipmap_8h.html#a4a1">TEXTURE_REPEAT</a>)
00095                                                 origS = <a class="code" href="pbrt_8h.html#a97">Mod</a>(origS, sres);
00096                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classMIPMap.html#r2">wrapMode</a> == <a class="code" href="mipmap_8h.html#a4a3">TEXTURE_CLAMP</a>)
00097                                                 origS = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(origS, 0, sres-1);
00098                                         <span class="keywordflow">if</span> (origS &gt;= 0 &amp;&amp; origS &lt; sres)
00099                                                 resampledImage[t*sPow2+s] += sWeights[s].weight[j] *
00100                                                         img[t*sres + origS];
00101                                 }
00102                         }
00103                 }
00104                 <span class="keyword">delete</span>[] sWeights;
00105                 <span class="comment">// Resample image in $t$ direction</span>
00106                 <a class="code" href="structMIPMap_1_1ResampleWeight.html">ResampleWeight</a> *tWeights = resampleWeights(tres, tPow2);
00107                 T *workData = <span class="keyword">new</span> T[tPow2];
00108                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; sPow2; ++s) {
00109                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = 0; t &lt; tPow2; ++t) {
00110                                 workData[t] = 0.;
00111                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; 4; ++j) {
00112                                         <span class="keywordtype">int</span> offset = tWeights[t].<a class="code" href="structMIPMap_1_1ResampleWeight.html#o0">firstTexel</a> + j;
00113                                         <span class="keywordflow">if</span> (<a class="code" href="classMIPMap.html#r2">wrapMode</a> == <a class="code" href="mipmap_8h.html#a4a1">TEXTURE_REPEAT</a>) offset = <a class="code" href="pbrt_8h.html#a97">Mod</a>(offset, tres);
00114                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classMIPMap.html#r2">wrapMode</a> == <a class="code" href="mipmap_8h.html#a4a3">TEXTURE_CLAMP</a>) offset = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(offset, 0, tres-1);
00115                                         <span class="keywordflow">if</span> (offset &gt;= 0 &amp;&amp; offset &lt; tres)
00116                                                 workData[t] += tWeights[t].weight[j] *
00117                                                         resampledImage[offset*sPow2 + s];
00118                                 }
00119                         }
00120                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = 0; t &lt; tPow2; ++t)
00121                                 resampledImage[t*sPow2 + s] = <a class="code" href="classMIPMap.html#d1">clamp</a>(workData[t]);
00122                 }
00123                 <span class="keyword">delete</span>[] workData;
00124                 <span class="keyword">delete</span>[] tWeights;
00125                 img = resampledImage;  <span class="comment">// XXX need to delete resampledImage when done...</span>
00126                 sres = sPow2;
00127                 tres = tPow2;
00128         }
00129         <span class="comment">// Initialize levels of MIPMap from image</span>
00130         <a class="code" href="classMIPMap.html#r4">nLevels</a> = 1 + <a class="code" href="pbrt_8h.html#a101">Log2Int</a>(<span class="keywordtype">float</span>(max(sres, tres)));
00131         <a class="code" href="classMIPMap.html#r3">pyramid</a> = <span class="keyword">new</span> <a class="code" href="classBlockedArray.html">BlockedArray&lt;T&gt;</a> *[<a class="code" href="classMIPMap.html#r4">nLevels</a>];
00132         <span class="comment">// Initialize most detailed level of MIPMap</span>
00133         <a class="code" href="classMIPMap.html#r3">pyramid</a>[0] = <span class="keyword">new</span> BlockedArray&lt;T&gt;(sres, tres, img);
00134         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; <a class="code" href="classMIPMap.html#r4">nLevels</a>; ++i) {
00135                 <span class="comment">// Initialize $i$th MIPMap level from $i-1$st level</span>
00136                 <span class="keywordtype">int</span> sRes = max(1, <a class="code" href="classMIPMap.html#r3">pyramid</a>[i-1]-&gt;uSize()/2);
00137                 <span class="keywordtype">int</span> tRes = max(1, <a class="code" href="classMIPMap.html#r3">pyramid</a>[i-1]-&gt;vSize()/2);
00138                 <a class="code" href="classMIPMap.html#r3">pyramid</a>[i] = <span class="keyword">new</span> BlockedArray&lt;T&gt;(sRes, tRes);
00139                 <span class="comment">// Filter four texels from finer level of pyramid</span>
00140                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = 0; t &lt; tRes; ++t)
00141                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; sRes; ++s)
00142                                 (*<a class="code" href="classMIPMap.html#r3">pyramid</a>[i])(s, t) = .25f * (
00143                                         <a class="code" href="classMIPMap.html#d3">texel</a>(i-1, 2*s, 2*t) +
00144                                         <a class="code" href="classMIPMap.html#d3">texel</a>(i-1, 2*s+1, 2*t) +
00145                                         <a class="code" href="classMIPMap.html#d3">texel</a>(i-1, 2*s, 2*t+1) +
00146                                         <a class="code" href="classMIPMap.html#d3">texel</a>(i-1, 2*s+1, 2*t+1));
00147         }
00148         <span class="keywordflow">if</span> (resampledImage) <span class="keyword">delete</span>[] resampledImage;
00149         <span class="comment">// Initialize EWA filter weights if needed</span>
00150         <span class="keywordflow">if</span> (!<a class="code" href="classMIPMap.html#v0">weightLut</a>) {
00151                 <a class="code" href="classMIPMap.html#v0">weightLut</a> = (<span class="keywordtype">float</span> *)<a class="code" href="util_8cpp.html#a28">AllocAligned</a>(<a class="code" href="mipmap_8h.html#a0">WEIGHT_LUT_SIZE</a> *
00152                         <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00153                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="mipmap_8h.html#a0">WEIGHT_LUT_SIZE</a>; ++i) {
00154                         <span class="keywordtype">float</span> alpha = 2;
00155                         <span class="keywordtype">float</span> r2 = float(i) / float(<a class="code" href="mipmap_8h.html#a0">WEIGHT_LUT_SIZE</a> - 1);
00156                         <a class="code" href="classMIPMap.html#v0">weightLut</a>[i] = expf(-alpha * r2) - expf(-alpha);
00157                 }
00158         }
00159 }
00160 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00161"></a><a class="code" href="classMIPMap.html#d3">00161</a> <span class="keyword">const</span> T &amp;<a class="code" href="classMIPMap.html">MIPMap&lt;T&gt;::texel</a>(<span class="keywordtype">int</span> level, <span class="keywordtype">int</span> s, <span class="keywordtype">int</span> t)<span class="keyword"> const </span>{
00162         <span class="keyword">const</span> <a class="code" href="classBlockedArray.html">BlockedArray&lt;T&gt;</a> &amp;l = *<a class="code" href="classMIPMap.html#r3">pyramid</a>[level];
00163         <span class="comment">// Compute texel $(s,t)$ accounting for boundary conditions</span>
00164         <span class="keywordflow">switch</span> (<a class="code" href="classMIPMap.html#r2">wrapMode</a>) {
00165                 <span class="keywordflow">case</span> <a class="code" href="mipmap_8h.html#a4a1">TEXTURE_REPEAT</a>:
00166                         s = <a class="code" href="pbrt_8h.html#a97">Mod</a>(s, l.<a class="code" href="classBlockedArray.html#a3">uSize</a>());
00167                         t = <a class="code" href="pbrt_8h.html#a97">Mod</a>(t, l.<a class="code" href="classBlockedArray.html#a4">vSize</a>());
00168                         <span class="keywordflow">break</span>;
00169                 <span class="keywordflow">case</span> <a class="code" href="mipmap_8h.html#a4a3">TEXTURE_CLAMP</a>:
00170                         s = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(s, 0, l.<a class="code" href="classBlockedArray.html#a3">uSize</a>() - 1);
00171                         t = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(t, 0, l.<a class="code" href="classBlockedArray.html#a4">vSize</a>() - 1);
00172                         <span class="keywordflow">break</span>;
00173                 <span class="keywordflow">case</span> <a class="code" href="mipmap_8h.html#a4a2">TEXTURE_BLACK</a>: {
00174                         <span class="keyword">static</span> <span class="keyword">const</span> T black = 0.f;
00175                         <span class="keywordflow">if</span> (s &lt; 0 || s &gt;= l.<a class="code" href="classBlockedArray.html#a3">uSize</a>() ||
00176                                 t &lt; 0 || t &gt;= l.<a class="code" href="classBlockedArray.html#a4">vSize</a>())
00177                                 <span class="keywordflow">return</span> black;
00178                         <span class="keywordflow">break</span>;
00179                 }
00180         }
00181         <span class="keywordflow">return</span> l(s, t);
00182 }
00183 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00184"></a><a class="code" href="classMIPMap.html#a1">00184</a> <a class="code" href="classMIPMap.html#a1">MIPMap&lt;T&gt;::~MIPMap</a>() {
00185         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classMIPMap.html#r4">nLevels</a>; ++i)
00186                 <span class="keyword">delete</span> <a class="code" href="classMIPMap.html#r3">pyramid</a>[i];
00187         <span class="keyword">delete</span>[] <a class="code" href="classMIPMap.html#r3">pyramid</a>;
00188 }
00189 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00190"></a><a class="code" href="classMIPMap.html#a2">00190</a> T <a class="code" href="classMIPMap.html">MIPMap&lt;T&gt;::Lookup</a>(<span class="keywordtype">float</span> s, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> width)<span class="keyword"> const </span>{
00191         <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> mipTrilerps(<span class="stringliteral">"Texture"</span>, <span class="comment">// NOBOOK</span>
00192                 <span class="stringliteral">"Trilinear MIPMap lookups"</span>); <span class="comment">// NOBOOK</span>
00193         ++mipTrilerps; <span class="comment">// NOBOOK</span>
00194         <span class="comment">// Compute MIPMap level for trilinear filtering</span>
00195         <span class="keywordtype">float</span> level = <a class="code" href="classMIPMap.html#r4">nLevels</a> - 1 + <a class="code" href="pbrt_8h.html#a100">Log2</a>(max(width, 1e-8f));
00196         <span class="comment">// Perform trilinear interpolation at appropriate MIPMap level</span>
00197         <span class="keywordflow">if</span> (level &lt; 0)
00198                 <span class="keywordflow">return</span> <a class="code" href="classMIPMap.html#d4">triangle</a>(0, s, t);
00199         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (level &gt;= <a class="code" href="classMIPMap.html#r4">nLevels</a> - 1)
00200                 <span class="keywordflow">return</span> <a class="code" href="classMIPMap.html#d3">texel</a>(<a class="code" href="classMIPMap.html#r4">nLevels</a>-1, 0, 0);
00201         <span class="keywordflow">else</span> {
00202                 <span class="keywordtype">int</span> iLevel = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(level);
00203                 <span class="keywordtype">float</span> delta = level - iLevel;
00204                 <span class="keywordflow">return</span> (1.f-delta) * <a class="code" href="classMIPMap.html#d4">triangle</a>(iLevel, s, t) +
00205                         delta * <a class="code" href="classMIPMap.html#d4">triangle</a>(iLevel+1, s, t);
00206         }
00207 }
00208 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00209"></a><a class="code" href="classMIPMap.html#d4">00209</a> T <a class="code" href="classMIPMap.html">MIPMap&lt;T&gt;::triangle</a>(<span class="keywordtype">int</span> level, <span class="keywordtype">float</span> s, <span class="keywordtype">float</span> t)<span class="keyword"> const </span>{
00210         level = <a class="code" href="pbrt_8h.html#a96">Clamp</a>(level, 0, <a class="code" href="classMIPMap.html#r4">nLevels</a>-1);
00211         s = s * <a class="code" href="classMIPMap.html#r3">pyramid</a>[level]-&gt;<a class="code" href="classBlockedArray.html#a3">uSize</a>() - 0.5f;
00212         t = t * pyramid[level]-&gt;vSize() - 0.5f;
00213         <span class="keywordtype">int</span> s0 = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(s), t0 = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(t);
00214         <span class="keywordtype">float</span> ds = s - s0, dt = t - t0;
00215         <span class="keywordflow">return</span> (1.f-ds)*(1.f-dt) * <a class="code" href="classMIPMap.html#d3">texel</a>(level, s0, t0) +
00216                 (1.f-ds)*dt * <a class="code" href="classMIPMap.html#d3">texel</a>(level, s0, t0+1) +
00217                 ds*(1.f-dt) * texel(level, s0+1, t0) +
00218                 ds*dt * texel(level, s0+1, t0+1);
00219 }
00220 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00221"></a><a class="code" href="classMIPMap.html#a3">00221</a> T MIPMap&lt;T&gt;::Lookup(<span class="keywordtype">float</span> s, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> ds0, <span class="keywordtype">float</span> dt0,
00222                 <span class="keywordtype">float</span> ds1, <span class="keywordtype">float</span> dt1)<span class="keyword"> const </span>{
00223         <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> ewaLookups(<span class="stringliteral">"Texture"</span>, <span class="stringliteral">"EWA filter lookups"</span>); <span class="comment">// NOBOOK</span>
00224         ++ewaLookups; <span class="comment">// NOBOOK</span>
00225         <span class="keywordflow">if</span> (<a class="code" href="classMIPMap.html#r0">doTrilinear</a>)
00226                 <span class="keywordflow">return</span> <a class="code" href="classMIPMap.html#a2">Lookup</a>(s, t,
00227                               2.f * max(max(fabsf(ds0),
00228                                                         fabsf(dt0)),
00229                                         max(fabsf(ds1),
00230                                                                     fabsf(dt1))));
00231         <span class="comment">// Compute ellipse minor and major axes</span>
00232         <span class="keywordflow">if</span> (ds0*ds0 + dt0*dt0 &lt; ds1*ds1 + dt1*dt1) {
00233                 swap(ds0, ds1);
00234                 swap(dt0, dt1);
00235         }
00236         <span class="keywordtype">float</span> majorLength = sqrtf(ds0*ds0 + dt0*dt0);
00237         <span class="keywordtype">float</span> minorLength = sqrtf(ds1*ds1 + dt1*dt1);
00238         <span class="comment">// Clamp ellipse eccentricity if too large</span>
00239         <span class="keywordflow">if</span> (minorLength * <a class="code" href="classMIPMap.html#r1">maxAnisotropy</a> &lt; majorLength) {
00240                 <span class="keywordtype">float</span> scale = majorLength /
00241                               (minorLength * <a class="code" href="classMIPMap.html#r1">maxAnisotropy</a>);
00242                 ds1 *= scale;
00243                 dt1 *= scale;
00244                 minorLength *= scale;
00245         }
00246         <span class="comment">// Choose level of detail for EWA lookup and perform EWA filtering</span>
00247         <span class="keywordtype">float</span> lod = max(0.f, <a class="code" href="classMIPMap.html#r4">nLevels</a> - 1.f + <a class="code" href="pbrt_8h.html#a100">Log2</a>(minorLength));
00248         <span class="keywordtype">int</span> ilod = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(lod);
00249         <span class="keywordtype">float</span> d = lod - ilod;
00250         <span class="keywordflow">return</span> (1.f - d) * <a class="code" href="classMIPMap.html#d5">EWA</a>(s, t, ds0, dt0, ds1, dt1, ilod) +
00251                 d * <a class="code" href="classMIPMap.html#d5">EWA</a>(s, t, ds0, dt0, ds1, dt1, ilod+1);
00252 }
00253 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00254"></a><a class="code" href="classMIPMap.html#d5">00254</a> T <a class="code" href="classMIPMap.html">MIPMap&lt;T&gt;::EWA</a>(<span class="keywordtype">float</span> s, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> ds0, <span class="keywordtype">float</span> dt0,
00255                 <span class="keywordtype">float</span> ds1, <span class="keywordtype">float</span> dt1, <span class="keywordtype">int</span> level)<span class="keyword"> const </span>{
00256         <span class="keywordflow">if</span> (level &gt;= <a class="code" href="classMIPMap.html#r4">nLevels</a>) <span class="keywordflow">return</span> <a class="code" href="classMIPMap.html#d3">texel</a>(<a class="code" href="classMIPMap.html#r4">nLevels</a>-1, 0, 0);
00257         <span class="comment">// Convert EWA coordinates to appropriate scale for level</span>
00258         s = s * <a class="code" href="classMIPMap.html#r3">pyramid</a>[level]-&gt;<a class="code" href="classBlockedArray.html#a3">uSize</a>() - 0.5f;
00259         t = t * pyramid[level]-&gt;vSize() - 0.5f;
00260         ds0 *= pyramid[level]-&gt;uSize();
00261         dt0 *= pyramid[level]-&gt;vSize();
00262         ds1 *= pyramid[level]-&gt;uSize();
00263         dt1 *= pyramid[level]-&gt;vSize();
00264         <span class="comment">// Compute ellipse coefficients to bound EWA filter region</span>
00265         <span class="keywordtype">float</span> A = dt0*dt0 + dt1*dt1 + 1;
00266         <span class="keywordtype">float</span> B = -2.f * (ds0*dt0 + ds1*dt1);
00267         <span class="keywordtype">float</span> C = ds0*ds0 + ds1*ds1 + 1;
00268         <span class="keywordtype">float</span> invF = 1.f / (A*C - B*B*0.25f);
00269         A *= invF;
00270         B *= invF;
00271         C *= invF;
00272         <span class="comment">// Compute the ellipse's $(s,t)$ bounding box in texture space</span>
00273         <span class="keywordtype">float</span> det = -B*B + 4.f*A*C;
00274         <span class="keywordtype">float</span> invDet = 1.f / det;
00275         <span class="keywordtype">float</span> uSqrt = sqrtf(det * C), vSqrt = sqrtf(A * det);
00276         <span class="keywordtype">int</span> s0 = <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a> (s - 2.f * invDet * uSqrt);
00277         <span class="keywordtype">int</span> s1 = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(s + 2.f * invDet * uSqrt);
00278         <span class="keywordtype">int</span> t0 = <a class="code" href="pbrt_8h.html#a107">Ceil2Int</a> (t - 2.f * invDet * vSqrt);
00279         <span class="keywordtype">int</span> t1 = <a class="code" href="pbrt_8h.html#a106">Floor2Int</a>(t + 2.f * invDet * vSqrt);
00280         <span class="keyword">static</span> <a class="code" href="classStatsRatio.html">StatsRatio</a> ewaTexels(<span class="stringliteral">"Texture"</span>, <span class="stringliteral">"Texels per EWA lookup"</span>); <span class="comment">// NOBOOK</span>
00281         ewaTexels.<a class="code" href="classStatsRatio.html#a1">Add</a>((1+s1-s0) * (1+t1-t0), 1); <span class="comment">// NOBOOK</span>
00282         <span class="comment">// Scan over ellipse bound and compute quadratic equation</span>
00283         T num(0.);
00284         <span class="keywordtype">float</span> den = 0;
00285         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> it = t0; it &lt;= t1; ++it) {
00286                 <span class="keywordtype">float</span> tt = it - t;
00287                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> is = s0; is &lt;= s1; ++is) {
00288                         <span class="keywordtype">float</span> ss = is - s;
00289                         <span class="comment">// Compute squared radius and filter texel if inside ellipse</span>
00290                         <span class="keywordtype">float</span> r2 = A*ss*ss + B*ss*tt + C*tt*tt;
00291                         <span class="keywordflow">if</span> (r2 &lt; 1.) {
00292                                 <span class="keywordtype">float</span> weight =
00293                                         <a class="code" href="classMIPMap.html#v0">weightLut</a>[min(<a class="code" href="pbrt_8h.html#a105">Float2Int</a>(r2 * <a class="code" href="mipmap_8h.html#a0">WEIGHT_LUT_SIZE</a>),
00294                                         <a class="code" href="mipmap_8h.html#a0">WEIGHT_LUT_SIZE</a>-1)];
00295                                 num += <a class="code" href="classMIPMap.html#d3">texel</a>(level, is, it) * weight;
00296                                 den += weight;
00297                         }
00298                 }
00299         }
00300         <span class="keywordflow">return</span> num / den;
00301 }
<a name="l00302"></a><a class="code" href="classMIPMap.html#v0">00302</a> <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keywordtype">float</span> *<a class="code" href="classMIPMap.html">MIPMap&lt;T&gt;</a>::weightLut = NULL;
00303 <span class="preprocessor">#endif // PBRT_MIPMAP_H</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Apr 25 19:00:22 2005 for pbrt by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
